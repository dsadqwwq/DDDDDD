<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Duel PVP – Enter the Arena</title>
<link rel="icon" type="image/svg+xml" href="duelpvp-logo.svg">
<link rel="apple-touch-icon" href="duelpvp-logo.svg">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
<style>
  :root{
    --gold:#FFD64D;
    --gold-hi:#FFF3A3;
    --bg:#0b0f12;
    --success:#4CAF50;
    --danger:#F44336;

    /* Glow position */
    --glow-x: 80%;
    --glow-y: 32%;
    --glow-w: 211px;
    --glow-h: 366px;
  }
  *{box-sizing:border-box}
  html{
    height:100%;
    margin:0;
    /* Enable smooth scrolling */
    scroll-behavior:smooth;
    /* Optimize text rendering on mobile */
    -webkit-text-size-adjust:100%;
    -webkit-font-smoothing:antialiased;
    -moz-osx-font-smoothing:grayscale;
  }
  body{
    height:100%;
    margin:0;
    background:var(--bg);
    color:#e6ecf1;
    font-family:Inter,system-ui,Segoe UI,Roboto,Arial;
    /* Enable momentum scrolling on iOS */
    -webkit-overflow-scrolling:touch;
    /* Prevent text selection on tap/hold on mobile */
    -webkit-tap-highlight-color:transparent;
  }
  /* Better touch targets for interactive elements */
  button, a, input, select, textarea{
    -webkit-tap-highlight-color:transparent;
  }
  
  /* Background with continuous animation */
  .bg{position:fixed;inset:0;overflow:hidden;z-index:0}
  .bg img{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;image-rendering:pixelated;filter:contrast(1.04) saturate(1.02)}

  /* Enhanced multi-layer lava glow animations */
  @keyframes lavaPulse{
    0%,100% { opacity:.25; filter:brightness(1.0) saturate(1.0); }
    20%     { opacity:.45; filter:brightness(1.25) saturate(1.2); }
    40%     { opacity:.35; filter:brightness(1.15) saturate(1.1); }
    60%     { opacity:.55; filter:brightness(1.35) saturate(1.3); }
    80%     { opacity:.30; filter:brightness(1.1) saturate(1.05); }
  }
  
  @keyframes lavaFlicker{
    0%,100% { opacity:0.3; }
    50%     { opacity:0.7; }
  }

  /* Primary glow layer */
  .bg::after{
    content:""; position:absolute; inset:0; pointer-events:none;
    background:
      /* Core bright glow */
      radial-gradient( circle 220px at var(--glow-x) var(--glow-y),
        rgba(255,180,80,.8), rgba(255,140,60,.4) 30%, rgba(255,100,40,.2) 50%, transparent 70%),
      /* Secondary warm glow */
      radial-gradient( ellipse 280px 400px at var(--glow-x) var(--glow-y),
        rgba(255,200,120,.5), rgba(255,160,80,.25) 40%, rgba(255,120,60,.1) 60%, transparent 80%),
      /* Outer ambient glow */
      radial-gradient( circle 350px at var(--glow-x) var(--glow-y),
        rgba(255,220,180,.2), rgba(255,180,140,.1) 50%, transparent 75%);
    mix-blend-mode: screen;
    animation: lavaPulse 6s ease-in-out infinite;
  }
  
  /* Additional flicker layer for more dynamic effect */
  .bg::before{
    content:""; position:absolute; inset:0; pointer-events:none;
    background:
      radial-gradient( circle 180px at var(--glow-x) var(--glow-y),
        rgba(255,220,180,.6), rgba(255,160,100,.2) 40%, transparent 60%);
    mix-blend-mode: color-dodge;
    animation: lavaFlicker 3s ease-in-out infinite;
  }

  /* Particle system canvas */
  .particles-canvas{
    position:fixed;
    inset:0;
    width:100%;
    height:100%;
    pointer-events:none;
    z-index:2;
  }

  /* CRT Scanlines overlay */
  .scanlines{
    position:fixed;
    inset:0;
    width:100%;
    height:100%;
    pointer-events:none;
    z-index:10;
    background:repeating-linear-gradient(
      0deg,
      rgba(0,0,0,0) 0px,
      rgba(0,0,0,0.08) 1px,
      rgba(0,0,0,0) 2px
    );
    opacity:0.4;
  }

  /* Enhanced brand design */
  .brand{
    position:fixed; 
    left:24px; 
    top:24px; 
    z-index:6;
  }
  
  .brand .title{
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 12px;
    position: relative;
  }

  .brand-logo{
    filter: drop-shadow(2px 2px 0px #000)
            drop-shadow(0 0 20px rgba(255,214,77,.4))
            drop-shadow(0 0 40px rgba(255,214,77,.2));
    flex-shrink: 0;
  }

  .brand-text{
    font-family:'Press Start 2P', monospace;
    font-size:32px;
    letter-spacing:.08em;
    /* Multi-layer text effects */
    background: linear-gradient(180deg, var(--gold-hi) 0%, var(--gold) 50%, #D4A033 100%);
    -webkit-background-clip: text;
    background-clip: text;
    -webkit-text-fill-color: transparent;
    filter: drop-shadow(2px 2px 0px #000)
            drop-shadow(0 0 20px rgba(255,214,77,.4))
            drop-shadow(0 0 40px rgba(255,214,77,.2));
  }

  /* Enhanced slogan with better styling */
  .brand .slogan{
    font-family: Inter, system-ui, Segoe UI, Roboto, Arial;
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.15em;
    color: #ffffff;
    opacity: 0.9;
    animation: sloganFade 8s ease-in-out infinite;
    position: relative;
    padding-left: 2px;
  }
  
  /* Divider dots between slogan parts */
  .slogan-divider{
    display: inline-block;
    width: 4px;
    height: 4px;
    background: var(--gold);
    border-radius: 50%;
    margin: 0 8px 1px;
    opacity: 0.6;
    box-shadow: 0 0 6px rgba(255,214,77,.5);
  }

  @keyframes sloganFade{
    0%, 100% { 
      opacity: 0.4; 
      filter: blur(0.5px);
    }
    50% { 
      opacity: 1; 
      filter: blur(0px) drop-shadow(0 0 8px rgba(255,255,255,.3));
    }
  }

  /* Center aligned for warrior naming screen */
  .page-container.center-aligned{
    align-items:center;
    padding-bottom:20px;
  }

  /* Page container */
  .page-container{position:fixed;inset:0;display:grid;place-items:start center;padding:20px;padding-top:120px;overflow-y:auto; z-index:4}

  /* Bottom-aligned for access code screen */
  .page-container.bottom-aligned{
    place-items:end center;
    padding-bottom:40px;
  }

  /* Modern panel styles matching dashboard */
  .panel{
    position:relative;
    width:min(520px,92vw);
    background:rgba(12,16,20,.10);
    border:2px solid rgba(255,214,77,.3);
    border-radius:12px;
    padding:32px 28px;
    backdrop-filter:blur(8px);
    box-shadow:0 8px 32px rgba(0,0,0,.4), inset 0 1px 0 rgba(255,255,255,.05);
  }

  /* Extra transparent for access code screen */
  .panel-transparent{
    background:rgba(12,16,20,.03);
  }

  .panel-header{
    text-align:center;
    margin-bottom:28px;
    padding-bottom:20px;
    border-bottom:1px solid rgba(255,214,77,.15);
  }

  .sys{
    font-family:'Press Start 2P', monospace;
    font-size:16px;
    color:var(--gold);
    text-shadow:0 0 20px rgba(255,214,77,.5);
    margin-bottom:8px;
  }
  
  .sub-text{
    font-family:Inter,system-ui,Segoe UI,Roboto,Arial;
    font-size:13px;
    color:#a0a8b0;
    margin-top:8px;
  }
  
  /* Continuous blink animation */
  .blink{animation:blinkDot 1s infinite}
  @keyframes blinkDot{0%,50%{opacity:1}50.1%,100%{opacity:0}}

  .input-group{
    margin-bottom:16px;
  }

  .input-label{
    display:block;
    font-family:'Press Start 2P', monospace;
    font-size:10px;
    color:#a0a8b0;
    margin-bottom:8px;
    text-transform:uppercase;
  }

  .bar{display:flex;gap:12px;align-items:stretch;}
  
  .input-field{
    flex:1;
    padding:12px 14px;
    background:rgba(0,0,0,.4);
    border:1px solid rgba(255,214,77,.2);
    border-radius:8px;
    color:#e6ecf1;
    font-family:'Press Start 2P', monospace;
    font-size:11px;
    transition:all 0.2s;
  }
  
  .input-field:focus{
    outline:none;
    border-color:var(--gold);
    background:rgba(0,0,0,.6);
    box-shadow:0 0 0 2px rgba(255,214,77,.1);
  }
  
  .input-field::placeholder{
    color:rgba(160,168,176,.5);
  }

  /* Standardized button sizes */
  .btn-small{
    padding:8px 16px;
    font-size:9px;
  }
  .btn-medium{
    padding:10px 20px;
    font-size:10px;
  }
  .btn-large{
    padding:12px 24px;
    font-size:11px;
  }

  .btn-submit{
    padding:12px 24px;
    background:var(--gold);
    border:2px solid var(--gold);
    border-radius:8px;
    color:#000;
    font-family:'Press Start 2P', monospace;
    font-size:11px;
    font-weight:bold;
    cursor:pointer;
    transition:all 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);
    white-space:nowrap;
    position:relative;
    box-shadow:
      0 1px 2px rgba(0,0,0,.4),
      0 4px 8px rgba(0,0,0,.2),
      inset 0 1px 0 rgba(255,255,255,.3);
  }

  .btn-submit:hover{
    background:var(--gold-hi);
    transform:translateY(-2px);
    box-shadow:
      0 2px 4px rgba(0,0,0,.4),
      0 6px 16px rgba(255,214,77,.4),
      inset 0 1px 0 rgba(255,255,255,.4);
  }

  .btn-submit:active{
    transform:translateY(1px);
    box-shadow:
      0 0 2px rgba(0,0,0,.4),
      0 2px 4px rgba(0,0,0,.2),
      inset 0 2px 4px rgba(0,0,0,.2);
  }

  .helper{
    margin-top:20px;
    text-align:center;
    font-family:Inter,system-ui,Segoe UI,Roboto,Arial;
    font-size:13px;
    color:#a0a8b0;
  }
  
  .helper a{
    color:var(--gold);
    text-decoration:none;
    cursor:pointer;
    transition:color 0.2s;
    font-family:'Press Start 2P', monospace;
    font-size:10px;
  }
  
  .helper a:hover{
    color:var(--gold-hi);
    text-shadow:0 0 8px rgba(255,214,77,.5);
  }
  
  /* Decorative elements */
  .panel::before{
    content:'';
    position:absolute;
    top:-1px;
    left:50%;
    transform:translateX(-50%);
    width:100px;
    height:1px;
    background:linear-gradient(90deg, transparent, var(--gold), transparent);
    opacity:0.8;
  }

  .footer{position:fixed;right:20px;bottom:16px;font-size:12px;opacity:.85; z-index:5; display:flex; align-items:center; gap:12px;}
  .footer a{color:var(--gold); text-decoration:none; transition:all 0.2s; display:flex; align-items:center; gap:4px;}
  .footer a:hover{opacity:1; text-shadow:0 0 8px var(--gold);}

  /* Warrior naming screen */
  .warrior-naming{
    animation: warriorEntrance 0.8s cubic-bezier(0.34, 1.56, 0.64, 1);
  }

  @keyframes warriorEntrance{
    0%{
      opacity:0;
      transform:scale(0.8) translateY(-30px);
      filter:blur(10px);
    }
    50%{
      opacity:0.5;
      transform:scale(1.05) translateY(5px);
      filter:blur(2px);
    }
    100%{
      opacity:1;
      transform:scale(1) translateY(0);
      filter:blur(0);
    }
  }

  .warrior-title{
    font-family:'Press Start 2P', monospace;
    font-size:16px;
    color:var(--gold);
    text-align:center;
    margin-bottom:24px;
    animation:titleGlow 2s ease-in-out infinite;
    text-shadow:0 0 20px rgba(255,214,77,.6);
  }

  @keyframes titleGlow{
    0%,100%{
      text-shadow:0 0 20px rgba(255,214,77,.6), 0 0 30px rgba(255,214,77,.3);
      filter:brightness(1);
    }
    50%{
      text-shadow:0 0 30px rgba(255,214,77,.8), 0 0 50px rgba(255,214,77,.5);
      filter:brightness(1.2);
    }
  }

  .warrior-input{
    width:100%;
    padding:16px;
    background:rgba(0,0,0,.5);
    border:2px solid rgba(255,214,77,.3);
    border-radius:8px;
    color:#e6ecf1;
    font-family:'Press Start 2P', monospace;
    font-size:14px;
    text-align:center;
    transition:all 0.3s;
    margin-bottom:24px;
    letter-spacing:0.1em;
  }

  .warrior-input:focus{
    outline:none;
    border-color:var(--gold);
    background:rgba(0,0,0,.7);
    box-shadow:0 0 0 3px rgba(255,214,77,.2), 0 0 30px rgba(255,214,77,.3);
    transform:scale(1.02);
  }

  .warrior-input::placeholder{
    color:#6b7280;
    font-family:Inter, system-ui, Segoe UI, Roboto, Arial;
    font-size:13px;
    letter-spacing:0.05em;
  }

  /* Dashboard specific styles */
  .dashboard-content{
    display:none;
    width:min(720px,92vw);
    background:rgba(12,16,20,.10);
    border:2px solid rgba(255,214,77,.3);
    border-radius:12px;
    padding:24px;
    backdrop-filter:blur(8px);
  }

  .dashboard-header{
    display:flex;
    justify-content:space-between;
    align-items:center;
    margin-bottom:24px;
    padding-bottom:16px;
    border-bottom:1px solid rgba(255,214,77,.2);
  }

  .user-info{font-family:'Press Start 2P', monospace;}
  .user-name{color:var(--gold);font-size:16px;margin-bottom:4px;}
  .user-stats{color:#a0a8b0;font-size:10px;}

  .logout-btn{
    padding:8px 12px;
    background:rgba(255,214,77,.1);
    border:1px solid var(--gold);
    color:var(--gold);
    font-family:'Press Start 2P', monospace;
    font-size:10px;
    cursor:pointer;
    border-radius:4px;
    transition:all 0.2s;
  }
  .logout-btn:hover{background:rgba(255,214,77,.2);}

  .stats-grid{
    display:grid;
    grid-template-columns:repeat(auto-fit, minmax(200px, 1fr));
    gap:16px;
    margin-bottom:24px;
  }

  .stat-card{
    background:rgba(255,214,77,.05);
    border:1px solid rgba(255,214,77,.2);
    border-radius:8px;
    padding:16px;
    text-align:center;
    transition:all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
    position:relative;
  }

  .stat-card:hover{
    transform:translateY(-3px) scale(1.02);
    border-color:rgba(255,214,77,0.5);
    background:rgba(255,214,77,.08);
    box-shadow:0 8px 24px rgba(255,214,77,0.15), 0 0 0 1px rgba(255,214,77,0.1);
  }

  .stat-label{
    font-family:'Press Start 2P', monospace;
    font-size:10px;
    color:#a0a8b0;
    margin-bottom:8px;
  }

  .stat-value{
    font-family:'Press Start 2P', monospace;
    font-size:18px;
    color:var(--gold);
  }

  /* Card-based dashboard layout */
  .dashboard-cards-row{
    display:grid;
    grid-template-columns:repeat(2, 1fr);
    gap:20px;
    margin-bottom:20px;
  }

  .dashboard-card{
    background:rgba(0,0,0,.3);
    border:1px solid rgba(255,214,77,.2);
    border-radius:8px;
    padding:20px;
    margin-bottom:20px;
    transition:all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
    position:relative;
  }

  .dashboard-card:hover{
    transform:translateY(-2px);
    border-color:rgba(255,214,77,0.4);
    background:rgba(0,0,0,.4);
    box-shadow:0 6px 20px rgba(0,0,0,0.4);
  }

  /* Themed cards */
  .dashboard-card.invest{
    border:2px solid rgba(76,175,80,.4);
    background:rgba(16,24,16,.25);
  }

  .dashboard-card.gamble{
    border:2px solid rgba(244,67,54,.4);
    background:rgba(24,16,16,.25);
  }

  .dashboard-card.invest .card-title{
    color:#4CAF50;
    text-shadow:0 0 10px rgba(76,175,80,.5);
  }

  .dashboard-card.gamble .card-title{
    color:#F44336;
    text-shadow:0 0 10px rgba(244,67,54,.5);
  }

  .btn-invest{
    background:rgba(76,175,80,.2);
    border-color:#4CAF50;
    color:#4CAF50;
  }
  .btn-invest:hover:not(:disabled){
    background:rgba(76,175,80,.35);
    transform:translateY(-2px);
    box-shadow:0 4px 12px rgba(76,175,80,.4);
  }

  .btn-gamble{
    background:rgba(244,67,54,.2);
    border-color:#F44336;
    color:#F44336;
  }
  .btn-gamble:hover:not(:disabled){
    background:rgba(244,67,54,.35);
    transform:translateY(-2px);
    box-shadow:0 4px 12px rgba(244,67,54,.4);
  }

  .card-title{
    font-family:'Press Start 2P', monospace;
    font-size:12px;
    color:var(--gold);
    margin-bottom:16px;
    padding-bottom:12px;
    border-bottom:1px solid rgba(255,214,77,.15);
  }

  .card-content{
    font-size:13px;
    line-height:1.6;
  }

  .recent-matches{
    /* Removed redundant styles - now inside dashboard-card */
  }

  .recent-matches-content{
    filter:blur(2px);
    opacity:0.4;
    pointer-events:none;
  }

  /* Old coming-soon styles removed - now using consistent .coming-soon-wrapper approach */

  .match-list{
    display:flex;
    flex-direction:column;
    gap:8px;
  }

  .match-item{
    display:flex;
    justify-content:space-between;
    align-items:center;
    padding:8px;
    background:rgba(255,214,77,.02);
    border:1px solid rgba(255,214,77,.1);
    border-radius:4px;
    font-family:'Press Start 2P', monospace;
    font-size:10px;
  }

  .match-result{
    padding:2px 6px;
    border-radius:3px;
    font-size:9px;
  }
  .win{background:rgba(76,175,80,.3);color:#4CAF50;}
  .win::before{content:'✓ ';}
  .loss{background:rgba(244,67,54,.3);color:#F44336;}
  .loss::before{content:'✕ ';}

  .dashboard-inventory{
    /* Removed redundant styles - now inside dashboard-card */
  }

  .section-title{
    font-family:'Press Start 2P', monospace;
    font-size:12px;
    color:var(--gold);
    margin-bottom:12px;
  }

  .dashboard-items-grid{
    display:grid;
    grid-template-columns:repeat(4, 1fr);
    gap:8px;
  }

  .dashboard-item-slot{
    position:relative;
    aspect-ratio:1;
    background:rgba(255,214,77,.05);
    border:2px solid rgba(255,214,77,.2);
    border-radius:8px;
    display:flex;
    flex-direction:column;
    align-items:center;
    justify-content:center;
    cursor:pointer;
    transition:all 0.2s;
  }

  .dashboard-item-slot:hover{
    background:rgba(255,214,77,.15);
    border-color:var(--gold);
    transform:translateY(-2px);
  }

  .dashboard-item-slot.empty{
    opacity:0.3;
    cursor:default;
  }

  .dashboard-item-slot.empty:hover{
    background:rgba(255,214,77,.05);
    border-color:rgba(255,214,77,.2);
    transform:none;
  }

  .dashboard-item-icon{
    font-size:24px;
    margin-bottom:4px;
  }

  .dashboard-item-name{
    font-family:'Press Start 2P', monospace;
    font-size:7px;
    color:#e6ecf1;
    text-align:center;
    line-height:1.3;
  }

  .dashboard-item-count{
    position:absolute;
    top:4px;
    right:4px;
    background:rgba(255,214,77,.9);
    color:#000;
    font-family:'Press Start 2P', monospace;
    font-size:8px;
    padding:2px 4px;
    border-radius:3px;
  }

  /* Tooltip for hover */
  .dashboard-item-tooltip{
    position:absolute;
    bottom:calc(100% + 8px);
    left:50%;
    transform:translateX(-50%);
    background:rgba(0,0,0,.95);
    border:2px solid var(--gold);
    border-radius:6px;
    padding:8px 12px;
    min-width:150px;
    z-index:1000;
    pointer-events:none;
    opacity:0;
    transition:opacity 0.2s;
  }

  .dashboard-item-slot:hover .dashboard-item-tooltip{
    opacity:1;
  }

  .tooltip-name{
    font-family:'Press Start 2P', monospace;
    font-size:9px;
    color:var(--gold);
    margin-bottom:4px;
  }

  .tooltip-desc{
    font-family:Inter, system-ui, Arial;
    font-size:11px;
    color:#e6ecf1;
    line-height:1.4;
  }

  .tooltip-type{
    font-family:'Press Start 2P', monospace;
    font-size:8px;
    color:#a0a8b0;
    margin-top:4px;
    text-transform:uppercase;
  }

  .wallet-section{
    /* Removed redundant styles - now inside dashboard-card */
  }

  .wallet-info{
    text-align:center;
  }

  .wallet-status{
    font-family:'Press Start 2P', monospace;
    font-size:11px;
    color:#a0a8b0;
    margin-bottom:8px;
    word-break:break-all;
  }

  .wallet-status.connected{
    color:#4CAF50;
  }

  .action-buttons{
    display:flex;
    gap:12px;
    margin-top:24px;
  }

  .action-btn{
    flex:1;
    padding:10px 20px;
    font-family:'Press Start 2P', monospace;
    font-size:10px;
    border-radius:8px;
    cursor:pointer;
    transition:all 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);
    border:2px solid;
    position:relative;
  }

  .btn-primary{
    background:var(--gold);
    border-color:var(--gold);
    color:#000;
    box-shadow:
      0 1px 2px rgba(0,0,0,.4),
      0 4px 8px rgba(0,0,0,.2),
      inset 0 1px 0 rgba(255,255,255,.3);
  }
  .btn-primary:hover{
    background:var(--gold-hi);
    transform:translateY(-2px);
    box-shadow:
      0 2px 4px rgba(0,0,0,.4),
      0 6px 16px rgba(255,214,77,.4),
      inset 0 1px 0 rgba(255,255,255,.4);
  }
  .btn-primary:active{
    transform:translateY(1px);
    box-shadow:
      0 0 2px rgba(0,0,0,.4),
      0 2px 4px rgba(0,0,0,.2),
      inset 0 2px 4px rgba(0,0,0,.2);
  }

  .btn-secondary{
    background:transparent;
    border-color:rgba(255,214,77,.5);
    color:var(--gold);
    box-shadow:
      0 1px 2px rgba(0,0,0,.3),
      inset 0 1px 0 rgba(255,214,77,.1);
  }
  .btn-secondary:hover{
    background:rgba(255,214,77,.1);
    transform:translateY(-2px);
    box-shadow:
      0 2px 4px rgba(0,0,0,.3),
      0 4px 12px rgba(255,214,77,.15),
      inset 0 1px 0 rgba(255,214,77,.2);
  }
  .btn-secondary:active{
    transform:translateY(1px);
    box-shadow:
      0 0 2px rgba(0,0,0,.3),
      inset 0 1px 3px rgba(0,0,0,.2);
  }

  /* Gold Particle Effects */
  @keyframes goldParticle{
    0%{
      transform:translate(0, 0) scale(1);
      opacity:1;
    }
    100%{
      transform:translate(var(--tx), var(--ty)) scale(0);
      opacity:0;
    }
  }

  .gold-particle{
    position:fixed;
    width:8px;
    height:8px;
    background:radial-gradient(circle, #FFD700 0%, #FFA500 100%);
    border-radius:50%;
    pointer-events:none;
    z-index:9999;
    animation:goldParticle 0.8s cubic-bezier(0.16, 1, 0.3, 1) forwards;
    box-shadow:0 0 10px rgba(255,215,0,0.8), 0 0 20px rgba(255,215,0,0.4);
  }

  /* Loading Skeletons */
  @keyframes shimmer{
    0%{background-position:-1000px 0;}
    100%{background-position:1000px 0;}
  }

  .skeleton{
    background:linear-gradient(90deg, rgba(255,255,255,0.05) 25%, rgba(255,255,255,0.15) 50%, rgba(255,255,255,0.05) 75%);
    background-size:1000px 100%;
    animation:shimmer 2s infinite;
    border-radius:8px;
  }

  .skeleton-text{
    height:14px;
    margin-bottom:8px;
    border-radius:4px;
  }

  .skeleton-title{
    height:24px;
    width:60%;
    margin-bottom:16px;
    border-radius:6px;
  }

  .skeleton-card{
    height:120px;
    border-radius:12px;
    margin-bottom:16px;
  }

  /* Page transitions */
  .fade-in{
    animation: fadeIn 0.4s cubic-bezier(0.16, 1, 0.3, 1);
  }
  @keyframes fadeIn{
    from{
      opacity:0;
      transform:translateY(20px) translateX(-5px) scale(0.96);
      filter:blur(4px);
    }
    to{
      opacity:1;
      transform:translateY(0) translateX(0) scale(1);
      filter:blur(0);
    }
  }

  .fade-in-delayed{
    opacity: 0;
    animation: fadeInDelayed 0.5s cubic-bezier(0.16, 1, 0.3, 1) 0.2s forwards;
  }
  @keyframes fadeInDelayed{
    from{
      opacity:0;
      transform:translateY(30px) translateX(-8px) scale(0.95);
      filter:blur(6px);
    }
    to{
      opacity:1;
      transform:translateY(0) translateX(0) scale(1);
      filter:blur(0);
    }
  }

  .fade-out{
    animation: fadeOut 0.3s cubic-bezier(0.4, 0, 1, 1) forwards;
  }
  @keyframes fadeOut{
    from{
      opacity:1;
      transform:translateY(0) translateX(0) scale(1);
      filter:blur(0);
    }
    to{
      opacity:0;
      transform:translateY(-15px) translateX(5px) scale(0.97);
      filter:blur(3px);
    }
  }

  /* Oven Investment Styles */
  .oven-container{
    display:none;
    width:min(600px,92vw);
    background:rgba(12,16,20,.92);
    border:2px solid rgba(76,175,80,.4);
    border-radius:12px;
    padding:24px;
    backdrop-filter:blur(8px);
  }

  .oven-header{
    display:flex;
    justify-content:space-between;
    align-items:center;
    margin-bottom:24px;
    padding-bottom:16px;
    border-bottom:1px solid rgba(76,175,80,.3);
  }

  .oven-title{
    font-family:'Press Start 2P', monospace;
    font-size:18px;
    color:#4CAF50;
    text-shadow:0 0 20px rgba(76,175,80,.6);
  }

  .oven-stats-row{
    display:grid;
    grid-template-columns:repeat(3, 1fr);
    gap:12px;
    margin-bottom:20px;
  }

  .oven-stat-box{
    background:rgba(76,175,80,.08);
    border:1px solid rgba(76,175,80,.25);
    border-radius:8px;
    padding:14px;
    text-align:center;
  }

  .oven-stat-label{
    font-family:'Press Start 2P', monospace;
    font-size:8px;
    color:#a0a8b0;
    margin-bottom:8px;
    letter-spacing:0.05em;
  }

  .oven-stat-value{
    font-family:'Press Start 2P', monospace;
    font-size:16px;
    color:#e6ecf1;
  }

  .oven-stat-value.highlight{
    color:#4CAF50;
    text-shadow:0 0 10px rgba(76,175,80,.4);
  }

  .oven-timer-box{
    text-align:center;
    font-family:'Press Start 2P', monospace;
    font-size:12px;
    color:#4CAF50;
    padding:16px;
    background:rgba(76,175,80,.1);
    border:1px solid rgba(76,175,80,.3);
    border-radius:8px;
    margin-bottom:24px;
  }

  .oven-action-section{
    margin-bottom:20px;
  }

  .oven-section-title{
    font-family:'Press Start 2P', monospace;
    font-size:10px;
    color:#a0a8b0;
    margin-bottom:10px;
    letter-spacing:0.05em;
  }

  .oven-input-row{
    display:flex;
    gap:10px;
  }

  .oven-button-row{
    display:flex;
    gap:10px;
  }

  .oven-input{
    flex:1;
    padding:12px 14px;
    background:rgba(0,0,0,.4);
    border:1px solid rgba(76,175,80,.3);
    border-radius:8px;
    color:#e6ecf1;
    font-family:'Press Start 2P', monospace;
    font-size:11px;
    transition:all 0.2s;
  }

  .oven-input:focus{
    outline:none;
    border-color:#4CAF50;
    background:rgba(0,0,0,.6);
    box-shadow:0 0 0 2px rgba(76,175,80,.15);
  }

  .oven-info{
    background:rgba(76,175,80,.08);
    border:1px solid rgba(76,175,80,.2);
    border-radius:8px;
    padding:14px;
    font-family:Inter, system-ui, Arial;
    font-size:12px;
    color:#b0b8c0;
    text-align:center;
    line-height:1.6;
  }

  .oven-info strong{
    color:#4CAF50;
  }

  /* Airdrop Farm Styles */
  .farm-button-container{
    display:flex;
    flex-direction:column;
    align-items:center;
    gap:20px;
    margin:32px 0;
  }

  .farm-btn{
    width:200px;
    height:200px;
    border-radius:50%;
    background:linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
    border:4px solid rgba(76,175,80,.6);
    cursor:pointer;
    display:flex;
    align-items:center;
    justify-content:center;
    transition:all 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);
    box-shadow:0 8px 30px rgba(76,175,80,.4), inset 0 2px 4px rgba(255,255,255,.3);
    position:relative;
    overflow:hidden;
  }

  .farm-btn:hover:not(:disabled){
    transform:scale(1.05);
    box-shadow:0 12px 40px rgba(76,175,80,.6), inset 0 2px 4px rgba(255,255,255,.4);
  }

  .farm-btn:active:not(:disabled){
    transform:scale(0.95);
  }

  .farm-btn:disabled{
    opacity:0.5;
    cursor:not-allowed;
    filter:grayscale(0.5);
  }

  .farm-btn-text{
    font-family:'Press Start 2P', monospace;
    font-size:24px;
    color:#fff;
    text-shadow:0 2px 4px rgba(0,0,0,.4);
    z-index:1;
  }

  .farm-cooldown{
    text-align:center;
    width:100%;
    max-width:300px;
  }

  .farm-cooldown-text{
    font-family:Inter, system-ui, Arial;
    font-size:14px;
    color:#b0b8c0;
    margin-bottom:8px;
  }

  .farm-cooldown-text span{
    color:#4CAF50;
    font-weight:700;
  }

  .farm-cooldown-bar{
    width:100%;
    height:8px;
    background:rgba(0,0,0,.4);
    border-radius:4px;
    overflow:hidden;
    border:1px solid rgba(76,175,80,.3);
  }

  .farm-cooldown-fill{
    height:100%;
    background:linear-gradient(90deg, #4CAF50 0%, #45a049 100%);
    transition:width 0.1s linear;
    border-radius:4px;
  }

  .farm-result{
    text-align:center;
    min-height:80px;
    display:flex;
    align-items:center;
    justify-content:center;
    font-family:'Press Start 2P', monospace;
    font-size:32px;
    font-weight:700;
  }

  .farm-result.flash-red{
    animation:flashRed 0.5s ease-out;
    color:#f44336;
  }

  .farm-result.flash-green{
    animation:flashGreen 0.5s ease-out;
    color:#4CAF50;
  }

  .farm-result.flash-gold{
    animation:flashGold 0.8s ease-out;
    color:#FFD700;
  }

  @keyframes flashRed{
    0%{transform:scale(1); opacity:0;}
    20%{transform:scale(1.5); opacity:1;}
    100%{transform:scale(1); opacity:1;}
  }

  @keyframes flashGreen{
    0%{transform:scale(1) rotate(0deg); opacity:0;}
    20%{transform:scale(1.3) rotate(-5deg); opacity:1;}
    40%{transform:scale(1.3) rotate(5deg); opacity:1;}
    100%{transform:scale(1) rotate(0deg); opacity:1;}
  }

  @keyframes flashGold{
    0%{transform:scale(1) rotate(0deg); opacity:0; filter:brightness(1);}
    15%{transform:scale(1.5) rotate(-10deg); opacity:1; filter:brightness(1.5);}
    30%{transform:scale(1.5) rotate(10deg); opacity:1; filter:brightness(2);}
    45%{transform:scale(1.5) rotate(-5deg); opacity:1; filter:brightness(1.5);}
    60%{transform:scale(1.5) rotate(5deg); opacity:1; filter:brightness(2);}
    100%{transform:scale(1) rotate(0deg); opacity:1; filter:brightness(1);}
  }

  /* Campaign Banner Styles */
  .campaign-banner{
    background:linear-gradient(135deg, rgba(255,215,0,0.15) 0%, rgba(255,165,0,0.2) 100%);
    border:2px solid rgba(255,215,0,0.4);
    border-radius:12px;
    padding:20px 24px;
    margin-bottom:24px;
    cursor:pointer;
    opacity:1;
    transition:all 0.3s ease;
    box-shadow:0 4px 20px rgba(255,215,0,0.15);
  }

  .campaign-banner:hover{
    background:linear-gradient(135deg, rgba(255,215,0,0.2) 0%, rgba(255,165,0,0.25) 100%);
    border-color:rgba(255,215,0,0.6);
    box-shadow:0 6px 24px rgba(255,215,0,0.25);
    transform:translateY(-2px);
  }

  .campaign-banner-header{
    display:flex;
    align-items:center;
    justify-content:center;
    gap:12px;
    margin-bottom:16px;
  }

  .campaign-banner-icon{
    font-size:24px;
  }

  .campaign-banner-text{
    font-family:'Press Start 2P', monospace;
    font-size:14px;
    color:#FFD700;
    text-shadow:0 2px 4px rgba(0,0,0,0.4);
    letter-spacing:1px;
  }

  .campaign-banner-info{
    font-size:16px;
    opacity:0.8;
  }

  .campaign-progress{
    margin-bottom:8px;
  }

  .campaign-progress-text{
    font-family:'Press Start 2P', monospace;
    font-size:10px;
    color:#FFD700;
    text-align:center;
    margin-bottom:8px;
  }

  .campaign-progress-bar{
    width:100%;
    height:8px;
    background:rgba(0,0,0,0.3);
    border-radius:4px;
    overflow:hidden;
    position:relative;
  }

  .campaign-progress-fill{
    height:100%;
    background:linear-gradient(90deg, #FFD700, #FFA500);
    border-radius:4px;
    transition:width 0.5s ease;
    box-shadow:0 0 10px rgba(255,215,0,0.5);
  }

  .campaign-time-remaining{
    font-family:Inter, system-ui, Arial;
    font-size:11px;
    color:rgba(255,215,0,0.8);
    text-align:center;
    margin-top:8px;
  }

  /* About Section Styles */
  .about-section{
    width:min(720px,92vw);
    background:linear-gradient(135deg, rgba(12,16,20,0.85) 0%, rgba(20,25,30,0.90) 100%);
    border:2px solid rgba(255,214,77,0.4);
    border-radius:12px;
    margin-bottom:24px;
    overflow:hidden;
    backdrop-filter:blur(12px);
    transition:all 0.3s ease;
  }

  .about-section:hover{
    border-color:rgba(255,214,77,0.6);
    box-shadow:0 4px 20px rgba(255,214,77,0.15);
  }

  .about-header{
    display:flex;
    justify-content:space-between;
    align-items:center;
    padding:20px 24px;
    background:linear-gradient(90deg, rgba(255,215,0,0.1) 0%, rgba(255,165,0,0.05) 100%);
    border-bottom:1px solid rgba(255,214,77,0.2);
    cursor:pointer;
    user-select:none;
  }

  .about-header:hover{
    background:linear-gradient(90deg, rgba(255,215,0,0.15) 0%, rgba(255,165,0,0.08) 100%);
  }

  .about-title{
    font-family:'Press Start 2P', monospace;
    font-size:12px;
    color:#FFD700;
    text-shadow:0 2px 4px rgba(0,0,0,0.5);
    display:flex;
    align-items:center;
    gap:12px;
  }

  .about-toggle{
    font-size:14px;
    color:#FFD700;
    transition:transform 0.3s ease;
  }

  .about-toggle.expanded{
    transform:rotate(180deg);
  }

  .about-content{
    max-height:0;
    overflow:hidden;
    transition:max-height 0.4s ease, padding 0.4s ease;
    padding:0 24px;
  }

  .about-content.expanded{
    max-height:800px;
    padding:24px;
  }

  .about-intro{
    font-family:'Courier New', monospace;
    font-size:15px;
    line-height:1.8;
    color:#e0e8f0;
    margin-bottom:20px;
    text-align:center;
    font-weight:500;
  }

  .about-intro strong{
    color:#FFD700;
    font-weight:700;
  }

  .about-grid{
    display:grid;
    grid-template-columns:repeat(auto-fit, minmax(280px, 1fr));
    gap:16px;
    margin-top:20px;
  }

  .about-card{
    background:rgba(0,0,0,0.4);
    border:1px solid rgba(255,214,77,0.25);
    border-radius:8px;
    padding:20px;
    transition:all 0.3s ease;
  }

  .about-card:hover{
    border-color:rgba(255,214,77,0.5);
    background:rgba(0,0,0,0.5);
    transform:translateY(-2px);
  }

  .about-card-icon{
    font-size:36px;
    margin-bottom:12px;
    display:block;
  }

  .about-card-title{
    font-family:'Press Start 2P', monospace;
    font-size:10px;
    color:#FFD700;
    margin-bottom:12px;
    text-transform:uppercase;
  }

  .about-card-text{
    font-family:'Courier New', monospace;
    font-size:13px;
    line-height:1.6;
    color:#c0c8d0;
  }

  .about-card-text strong{
    color:#FFD700;
  }

  /* Campaign Page Styles */
  .campaign-container{
    display:none;
    width:min(720px,92vw);
    background:rgba(12,16,20,.10);
    border:2px solid rgba(255,214,77,.3);
    border-radius:12px;
    padding:24px;
    backdrop-filter:blur(8px);
  }

  .campaign-header{
    display:flex;
    justify-content:space-between;
    align-items:center;
    margin-bottom:16px;
    padding-bottom:12px;
    border-bottom:1px solid rgba(255,214,77,.2);
  }

  .campaign-title{
    font-family:'Press Start 2P', monospace;
    font-size:14px;
    color:#FFD700;
    text-shadow:0 2px 4px rgba(0,0,0,0.4);
  }

  .campaign-stats-section{
    display:grid;
    grid-template-columns:repeat(2, 1fr);
    gap:16px;
    margin-bottom:24px;
  }

  .campaign-stat-card{
    background:rgba(0,0,0,0.3);
    border:1px solid rgba(255,214,77,0.3);
    border-radius:8px;
    padding:16px;
    display:flex;
    align-items:center;
    gap:12px;
    transition:all 0.3s ease;
  }

  .campaign-stat-card:hover{
    border-color:rgba(255,214,77,0.5);
    background:rgba(0,0,0,0.4);
  }

  .campaign-stat-icon{
    font-size:32px;
  }

  .campaign-stat-info{
    flex:1;
  }

  .campaign-stat-label{
    font-family:'Press Start 2P', monospace;
    font-size:8px;
    color:#a0a8b0;
    margin-bottom:4px;
  }

  .campaign-stat-value{
    font-family:'Press Start 2P', monospace;
    font-size:18px;
    color:#FFD700;
  }

  .campaign-progress-section{
    background:linear-gradient(135deg, rgba(255,215,0,0.08) 0%, rgba(255,165,0,0.12) 100%);
    border:2px solid rgba(255,214,77,0.3);
    border-radius:12px;
    padding:20px;
    margin-bottom:24px;
  }

  .campaign-progress-header{
    display:flex;
    justify-content:space-between;
    align-items:center;
    margin-bottom:12px;
  }

  .campaign-progress-title{
    font-family:'Press Start 2P', monospace;
    font-size:10px;
    color:#FFD700;
  }

  .campaign-progress-percentage{
    font-family:'Press Start 2P', monospace;
    font-size:12px;
    color:#FFD700;
  }

  .campaign-progress-bar-large{
    width:100%;
    height:16px;
    background:rgba(0,0,0,0.4);
    border-radius:8px;
    overflow:hidden;
    position:relative;
    margin-bottom:12px;
  }

  .campaign-progress-fill-large{
    height:100%;
    background:linear-gradient(90deg, #FFD700, #FFA500);
    border-radius:8px;
    transition:width 0.5s ease;
    box-shadow:0 0 15px rgba(255,215,0,0.6);
  }

  .campaign-progress-info{
    font-family:'Press Start 2P', monospace;
    font-size:11px;
    color:#FFD700;
    text-align:center;
  }

  .campaign-info-section{
    background:rgba(0,0,0,0.2);
    border:1px solid rgba(255,214,77,0.2);
    border-radius:12px;
    padding:20px;
    margin-bottom:24px;
  }

  .campaign-info-title{
    font-family:'Press Start 2P', monospace;
    font-size:11px;
    color:#FFD700;
    margin-bottom:16px;
  }

  .campaign-info-content{
    display:flex;
    flex-direction:column;
    gap:12px;
  }

  .campaign-info-item{
    display:flex;
    gap:12px;
    font-family:Inter, system-ui, Arial;
    font-size:13px;
    line-height:1.6;
    color:#e0e0e0;
  }

  .campaign-info-bullet{
    color:#FFD700;
    font-weight:bold;
  }

  .campaign-disclaimer-section{
    background:rgba(244,67,54,0.08);
    border:1px solid rgba(244,67,54,0.2);
    border-radius:8px;
    padding:12px;
    margin-top:16px;
    font-family:Inter, system-ui, Arial;
    font-size:11px;
    color:rgba(244,67,54,0.9);
    text-align:center;
    line-height:1.6;
  }

  .campaign-time-section{
    background:rgba(0,0,0,0.3);
    border:1px solid rgba(255,214,77,0.3);
    border-radius:8px;
    padding:16px;
    text-align:center;
  }

  .campaign-time-label{
    font-family:'Press Start 2P', monospace;
    font-size:9px;
    color:#a0a8b0;
    margin-bottom:8px;
  }

  .campaign-time-value{
    font-family:Inter, system-ui, Arial;
    font-size:14px;
    color:#FFD700;
  }

  .campaign-earn-section{
    margin-top:24px;
  }

  .campaign-earn-title{
    font-family:'Press Start 2P', monospace;
    font-size:11px;
    color:#FFD700;
    margin-bottom:16px;
    text-align:center;
  }

  .campaign-cards-row{
    display:grid;
    grid-template-columns:repeat(2, 1fr);
    gap:16px;
    margin-bottom:16px;
  }

  .campaign-card{
    background:rgba(0,0,0,0.3);
    border:2px solid rgba(255,214,77,0.3);
    border-radius:12px;
    padding:16px;
    transition:all 0.35s cubic-bezier(0.16, 1, 0.3, 1);
    position:relative;
    overflow:hidden;
  }

  .campaign-card:hover{
    border-color:rgba(255,214,77,0.6);
    transform:translateY(-4px) scale(1.01);
    box-shadow:0 8px 24px rgba(0,0,0,0.4), 0 0 0 1px rgba(255,214,77,0.1);
    background:rgba(0,0,0,0.4);
  }

  .campaign-card.invest{
    border-color:rgba(76,175,80,0.3);
  }

  .campaign-card.invest:hover{
    border-color:rgba(76,175,80,0.7);
    box-shadow:0 8px 28px rgba(76,175,80,0.2), 0 0 40px rgba(76,175,80,0.1);
    background:rgba(16,24,16,0.3);
  }

  .campaign-card.gamble{
    border-color:rgba(244,67,54,0.3);
  }

  .campaign-card.gamble:hover{
    border-color:rgba(244,67,54,0.7);
    box-shadow:0 8px 28px rgba(244,67,54,0.2), 0 0 40px rgba(244,67,54,0.1);
    background:rgba(24,16,16,0.3);
  }

  .campaign-card-title{
    font-family:'Press Start 2P', monospace;
    font-size:10px;
    color:#FFD700;
    margin-bottom:12px;
    text-align:center;
  }

  .campaign-card-content{
    display:flex;
    flex-direction:column;
  }

  @media(max-width:600px){
    .campaign-cards-row{
      grid-template-columns:1fr;
    }
  }

  .gambling-disclaimer{
    background:rgba(244,67,54,0.08);
    border:1px solid rgba(244,67,54,0.2);
    border-radius:8px;
    padding:12px;
    margin-top:12px;
    font-family:Inter, system-ui, Arial;
    font-size:10px;
    color:#f44336;
    text-align:center;
    line-height:1.5;
  }

  /* Mines Game Styles */
  .mines-game-area{
    max-width:600px;
    margin:0 auto;
  }

  .mines-bet-section{
    background:rgba(0,0,0,.3);
    border:1px solid rgba(255,214,77,.2);
    border-radius:8px;
    padding:16px;
    margin-bottom:20px;
  }

  .mines-bet-row{
    display:grid;
    grid-template-columns:1fr 1fr;
    gap:12px;
  }

  .mines-input-group{
    display:flex;
    flex-direction:column;
    gap:8px;
  }

  .mines-label{
    font-family:'Press Start 2P', monospace;
    font-size:9px;
    color:#a0a8b0;
    letter-spacing:0.05em;
  }

  .mines-input{
    padding:10px 12px;
    background:rgba(0,0,0,.4);
    border:1px solid rgba(255,214,77,.2);
    border-radius:6px;
    color:#e6ecf1;
    font-family:'Press Start 2P', monospace;
    font-size:11px;
  }

  .mines-input:focus{
    outline:none;
    border-color:var(--gold);
    box-shadow:0 0 0 2px rgba(255,214,77,.1);
  }

  .mines-stats-display{
    display:grid;
    grid-template-columns:repeat(3, 1fr);
    gap:12px;
    margin-bottom:20px;
  }

  .mines-stat{
    background:rgba(0,0,0,.3);
    border:1px solid rgba(255,214,77,.2);
    border-radius:8px;
    padding:12px;
    text-align:center;
  }

  .mines-stat-label{
    font-family:'Press Start 2P', monospace;
    font-size:8px;
    color:#a0a8b0;
    margin-bottom:6px;
  }

  .mines-stat-value{
    font-family:'Press Start 2P', monospace;
    font-size:14px;
    color:var(--gold);
  }

  .mines-grid{
    display:grid;
    grid-template-columns:repeat(5, 1fr);
    gap:8px;
    margin-bottom:20px;
    max-width:400px;
    margin-left:auto;
    margin-right:auto;
  }

  .mines-tile{
    aspect-ratio:1;
    background:rgba(255,214,77,.1);
    border:2px solid rgba(255,214,77,.3);
    border-radius:8px;
    display:flex;
    align-items:center;
    justify-content:center;
    font-size:24px;
    cursor:pointer;
    transition:all 0.2s;
    user-select:none;
  }

  .mines-tile:hover:not(.revealed){
    background:rgba(255,214,77,.2);
    transform:scale(1.05);
  }

  .mines-tile.revealed{
    cursor:default;
    border-color:rgba(76,175,80,.4);
    background:rgba(76,175,80,.15);
  }

  .mines-tile.mine{
    border-color:rgba(244,67,54,.6);
    background:rgba(244,67,54,.2);
    animation:mineExplode 0.5s ease-out;
  }

  @keyframes mineExplode{
    0%{transform:scale(1);}
    50%{transform:scale(1.3);}
    100%{transform:scale(1);}
  }

  .mines-tile.disabled{
    opacity:0.5;
    cursor:not-allowed;
    pointer-events:none;
  }

  .mines-info{
    background:rgba(255,214,77,.05);
    border:1px solid rgba(255,214,77,.15);
    border-radius:8px;
    padding:12px;
    text-align:center;
    font-size:12px;
    color:#a0a8b0;
    font-family:Inter, system-ui, Arial;
  }

  /* Blackjack Game Styles */
  .blackjack-game-area{
    max-width:700px;
    margin:0 auto;
  }

  .blackjack-bet-section{
    background:rgba(0,0,0,.3);
    border:1px solid rgba(255,214,77,.2);
    border-radius:8px;
    padding:16px;
    margin-bottom:20px;
  }

  .blackjack-bet-row{
    display:flex;
    gap:12px;
    align-items:flex-end;
  }

  .blackjack-input-group{
    flex:1;
    display:flex;
    flex-direction:column;
    gap:8px;
  }

  .blackjack-label{
    font-family:'Press Start 2P', monospace;
    font-size:9px;
    color:#a0a8b0;
    letter-spacing:0.05em;
  }

  .blackjack-input{
    padding:10px 12px;
    background:rgba(0,0,0,.4);
    border:1px solid rgba(255,214,77,.2);
    border-radius:6px;
    color:#e6ecf1;
    font-family:'Press Start 2P', monospace;
    font-size:11px;
  }

  .blackjack-input:focus{
    outline:none;
    border-color:var(--gold);
    box-shadow:0 0 0 2px rgba(255,214,77,.1);
  }

  .blackjack-stats-display{
    display:grid;
    grid-template-columns:repeat(3, 1fr);
    gap:12px;
    margin-bottom:20px;
  }

  .blackjack-stat{
    background:rgba(0,0,0,.3);
    border:1px solid rgba(255,214,77,.2);
    border-radius:8px;
    padding:12px;
    text-align:center;
  }

  .blackjack-stat-label{
    font-family:'Press Start 2P', monospace;
    font-size:8px;
    color:#a0a8b0;
    margin-bottom:6px;
  }

  .blackjack-stat-value{
    font-family:'Press Start 2P', monospace;
    font-size:14px;
    color:var(--gold);
  }

  .blackjack-table{
    background:rgba(16,24,16,.3);
    border:2px solid rgba(255,214,77,.2);
    border-radius:12px;
    padding:24px;
    margin-bottom:20px;
    min-height:300px;
  }

  .blackjack-hand-section{
    margin-bottom:24px;
  }

  .blackjack-hand-section.player{
    border-top:1px solid rgba(255,214,77,.1);
    padding-top:24px;
  }

  .blackjack-hand-title{
    font-family:'Press Start 2P', monospace;
    font-size:10px;
    color:#a0a8b0;
    margin-bottom:12px;
    text-align:center;
  }

  .blackjack-cards{
    display:flex;
    gap:10px;
    justify-content:center;
    flex-wrap:wrap;
    min-height:80px;
  }

  .blackjack-card{
    width:60px;
    height:84px;
    background:#fff;
    border:2px solid #333;
    border-radius:8px;
    display:flex;
    flex-direction:column;
    align-items:center;
    justify-content:center;
    font-family:'Press Start 2P', monospace;
    font-size:18px;
    box-shadow:0 4px 8px rgba(0,0,0,.3);
    animation:cardDeal 0.3s ease-out;
  }

  @keyframes cardDeal{
    from{
      opacity:0;
      transform:translateY(-20px) scale(0.8);
    }
    to{
      opacity:1;
      transform:translateY(0) scale(1);
    }
  }

  .blackjack-card.red{
    color:#dc143c;
  }

  .blackjack-card.black{
    color:#000;
  }

  .blackjack-card.hidden{
    background:linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);
    color:#fff;
    font-size:24px;
  }

  .blackjack-card-value{
    font-size:14px;
    margin-top:4px;
  }

  .blackjack-actions{
    display:flex;
    gap:12px;
    margin-bottom:20px;
  }

  .blackjack-actions .action-btn{
    flex:1;
  }

  .blackjack-info{
    background:rgba(255,214,77,.05);
    border:1px solid rgba(255,214,77,.15);
    border-radius:8px;
    padding:12px;
    text-align:center;
    font-size:12px;
    color:#a0a8b0;
    font-family:Inter, system-ui, Arial;
  }

  /* Reaction Game Styles */
  .game-container{
    display:none;
    width:min(900px,92vw);
    background:rgba(12,16,20,.10);
    border:2px solid rgba(255,214,77,.3);
    border-radius:12px;
    padding:20px;
    backdrop-filter:blur(8px);
  }

  .game-header{
    display:flex;
    justify-content:space-between;
    align-items:center;
    margin-bottom:16px;
    padding-bottom:12px;
    border-bottom:1px solid rgba(255,214,77,.2);
  }

  .game-title{
    font-family:'Press Start 2P', monospace;
    font-size:16px;
    color:var(--gold);
  }

  .back-btn{
    padding:8px 16px;
    background:rgba(255,214,77,.1);
    border:1px solid var(--gold);
    color:var(--gold);
    font-family:'Press Start 2P', monospace;
    font-size:9px;
    cursor:pointer;
    border-radius:4px;
    transition:all 0.2s;
  }
  .back-btn:hover{background:rgba(255,214,77,.2);}

  /* Breadcrumb Navigation */
  .breadcrumb{
    padding:12px 0;
    font-family:'Press Start 2P', monospace;
    font-size:9px;
    color:#a0a8b0;
    display:flex;
    align-items:center;
    gap:8px;
    margin-bottom:12px;
  }
  .breadcrumb-item{
    cursor:pointer;
    transition:all 0.2s;
  }
  .breadcrumb-item:hover{
    color:var(--gold-hi);
  }
  .breadcrumb-item.active{
    color:var(--gold);
    cursor:default;
  }
  .breadcrumb-separator{
    color:rgba(255,214,77,.3);
  }

  /* Game Disclaimer Bar */
  .game-disclaimer{
    background:rgba(244,67,54,.15);
    border:1px solid rgba(244,67,54,.3);
    border-radius:6px;
    padding:12px 16px;
    margin-top:16px;
    font-family:Inter,system-ui;
    font-size:11px;
    color:#F44336;
    display:flex;
    align-items:center;
    gap:8px;
  }
  .game-disclaimer.info{
    background:rgba(255,214,77,.1);
    border-color:rgba(255,214,77,.3);
    color:var(--gold);
  }
  .game-disclaimer.success{
    background:rgba(76,175,80,.15);
    border-color:rgba(76,175,80,.3);
    color:#4CAF50;
  }

  /* Empty States */
  .empty-state{
    text-align:center;
    padding:48px 24px;
    color:#a0a8b0;
  }
  .empty-state-icon{
    font-size:48px;
    margin-bottom:16px;
    opacity:0.5;
  }
  .empty-state-title{
    font-family:'Press Start 2P', monospace;
    font-size:12px;
    color:var(--gold);
    margin-bottom:12px;
  }
  .empty-state-message{
    font-family:Inter,system-ui;
    font-size:13px;
    line-height:1.6;
    max-width:400px;
    margin:0 auto;
  }

  /* Consistent Coming Soon Overlay */
  .coming-soon-wrapper{
    position:relative;
  }
  .coming-soon-wrapper.disabled{
    pointer-events:none;
  }
  .coming-soon-overlay{
    position:absolute;
    inset:0;
    background:rgba(11,15,18,.85);
    backdrop-filter:blur(4px);
    border-radius:8px;
    display:flex;
    align-items:center;
    justify-content:center;
    z-index:5;
  }
  .coming-soon-badge{
    background:linear-gradient(135deg, var(--gold), var(--gold-hi));
    color:#000;
    padding:12px 24px;
    border-radius:8px;
    font-family:'Press Start 2P', monospace;
    font-size:11px;
    font-weight:bold;
    box-shadow:0 4px 16px rgba(255,214,77,.4);
    animation:pulse 2s ease-in-out infinite;
  }

  /* GC Animation */
  @keyframes countUp{
    0%{
      opacity:0;
      transform:translateY(10px);
    }
    100%{
      opacity:1;
      transform:translateY(0);
    }
  }
  .gc-change{
    animation:countUp 0.3s ease-out;
  }
  .gc-increase{
    color:#4CAF50;
    text-shadow:0 0 8px rgba(76,175,80,.6);
  }
  .gc-decrease{
    color:#F44336;
    text-shadow:0 0 8px rgba(244,67,54,.6);
  }

  /* Game layout - sidebar + main */
  .game-layout{
    display:grid;
    grid-template-columns:220px 1fr;
    gap:20px;
  }

  .game-sidebar{
    background:rgba(0,0,0,.3);
    border:1px solid rgba(255,214,77,.15);
    border-radius:8px;
    padding:16px;
  }

  .game-main{
    background:rgba(0,0,0,.2);
    border:1px solid rgba(255,214,77,.15);
    border-radius:8px;
    padding:20px;
  }

  .game-area{
    background:rgba(0,0,0,.5);
    border:1px solid rgba(255,214,77,.2);
    border-radius:8px;
    padding:24px;
    margin-bottom:20px;
  }

  .chart-container{
    width:100%;
    height:200px;
    background:rgba(16,20,24,.8);
    border:2px solid rgba(255,214,77,.1);
    border-radius:8px;
    position:relative;
    overflow:hidden;
    margin-bottom:16px;
    transition:all 0.2s;
  }

  .chart-container.green{
    border-color:rgba(76,175,80,.5);
    background:rgba(16,24,16,.8);
  }

  .chart-container.red{
    border-color:rgba(244,67,54,.8);
    background:rgba(24,16,16,.9);
    animation:redPulse 0.5s ease-out;
  }

  @keyframes redPulse{
    0%{box-shadow:0 0 0 0 rgba(244,67,54,.8);}
    100%{box-shadow:0 0 30px 10px rgba(244,67,54,0);}
  }

  .chart-line{
    position:absolute;
    bottom:0;
    left:0;
    right:0;
    height:60%;
    overflow:hidden;
  }

  .price-display{
    position:absolute;
    top:20px;
    right:20px;
    font-family:'Press Start 2P', monospace;
    font-size:18px;
    color:#4CAF50;
    text-shadow:0 0 10px currentColor;
    transition:all 0.2s;
  }

  .red .price-display{
    color:#F44336;
  }

  .sell-button{
    width:100%;
    padding:20px;
    font-family:'Press Start 2P', monospace;
    font-size:16px;
    background:#F44336;
    border:2px solid #D32F2F;
    color:#fff;
    border-radius:8px;
    cursor:pointer;
    transition:all 0.2s;
    text-transform:uppercase;
    letter-spacing:0.1em;
  }

  .sell-button:hover:not(:disabled){
    background:#D32F2F;
    transform:translateY(-2px);
    box-shadow:0 4px 20px rgba(244,67,54,.4);
  }

  .sell-button:active:not(:disabled){
    transform:translateY(0);
  }

  .sell-button:disabled{
    background:rgba(100,100,100,.3);
    border-color:rgba(100,100,100,.2);
    color:rgba(255,255,255,.3);
    cursor:not-allowed;
  }

  .instructions{
    background:rgba(255,214,77,.05);
    border:1px solid rgba(255,214,77,.2);
    border-radius:8px;
    padding:12px;
    margin-bottom:16px;
  }

  .instructions-title{
    font-family:'Press Start 2P', monospace;
    font-size:10px;
    color:var(--gold);
    margin-bottom:8px;
  }

  .instructions-text{
    font-family:Inter, system-ui, Arial;
    font-size:13px;
    color:#a0a8b0;
    line-height:1.6;
  }

  .attempts-counter{
    display:flex;
    flex-direction:column;
    align-items:center;
    gap:6px;
    background:rgba(0,0,0,.3);
    border:1px solid rgba(255,214,77,.2);
    border-radius:8px;
    padding:12px;
    margin-bottom:16px;
  }

  .attempts-label{
    font-family:'Press Start 2P', monospace;
    font-size:9px;
    color:#a0a8b0;
  }

  .attempts-value{
    font-family:'Press Start 2P', monospace;
    font-size:16px;
    color:var(--gold);
  }

  .results-grid{
    display:grid;
    grid-template-columns:1fr;
    gap:6px;
  }

  .result-card{
    background:rgba(255,214,77,.05);
    border:1px solid rgba(255,214,77,.2);
    border-radius:6px;
    padding:8px;
    text-align:center;
  }

  .result-card.best{
    background:rgba(76,175,80,.1);
    border-color:rgba(76,175,80,.4);
  }

  .result-attempt{
    font-family:'Press Start 2P', monospace;
    font-size:9px;
    color:#a0a8b0;
    margin-bottom:6px;
  }

  .result-time{
    font-family:'Press Start 2P', monospace;
    font-size:12px;
    color:var(--gold);
  }

  .game-status{
    text-align:center;
    font-family:'Press Start 2P', monospace;
    font-size:14px;
    padding:16px;
    margin-bottom:20px;
  }

  .status-ready{
    color:#4CAF50;
  }

  .status-go{
    color:#F44336;
  }

  .canvas-chart{
    width:100%;
    height:100%;
    image-rendering:crisp-edges;
  }

  /* Crash Rocket Game Styles */
  .crash-bet-section{
    background:rgba(255,214,77,.05);
    border:1px solid rgba(255,214,77,.2);
    border-radius:8px;
    padding:12px;
    margin-bottom:16px;
  }

  .crash-input{
    width:100%;
    background:rgba(0,0,0,.3);
    border:1px solid rgba(255,214,77,.2);
    border-radius:4px;
    padding:8px;
    color:var(--gold);
    font-family:'Press Start 2P', monospace;
    font-size:11px;
  }

  .crash-input:focus{
    outline:none;
    border-color:var(--gold);
  }

  .crash-info-section{
    background:rgba(0,0,0,.3);
    border:1px solid rgba(255,214,77,.2);
    border-radius:8px;
    padding:12px;
    margin-bottom:16px;
  }

  .crash-stat{
    padding:8px 0;
    border-bottom:1px solid rgba(255,214,77,.1);
  }

  .crash-stat:last-child{
    border-bottom:none;
  }

  .crash-history{
    background:rgba(0,0,0,.3);
    border:1px solid rgba(255,214,77,.2);
    border-radius:8px;
    padding:12px;
  }

  .crash-history-list{
    display:flex;
    flex-wrap:wrap;
    gap:4px;
    margin-top:8px;
  }

  .crash-history-item{
    font-family:'Press Start 2P', monospace;
    font-size:10px;
    padding:6px 8px;
    border-radius:4px;
    background:rgba(0,0,0,.3);
  }

  .crash-history-item.crashed-low{
    color:#F44336;
    border:1px solid rgba(244,67,54,.3);
  }

  .crash-history-item.crashed-med{
    color:#FF9800;
    border:1px solid rgba(255,152,0,.3);
  }

  .crash-history-item.crashed-high{
    color:#4CAF50;
    border:1px solid rgba(76,175,80,.3);
  }

  .crash-game-area{
    display:flex;
    flex-direction:column;
    gap:16px;
  }

  .crash-hash-display{
    background:rgba(0,0,0,.3);
    border:1px solid rgba(255,214,77,.2);
    border-radius:8px;
    padding:12px;
  }

  .crash-rocket-container{
    position:relative;
    height:350px;
    background:linear-gradient(to bottom, rgba(16,20,24,.9), rgba(16,16,32,.9));
    border:2px solid rgba(255,214,77,.2);
    border-radius:8px;
    overflow:hidden;
  }

  .crash-rocket-container.crashed{
    animation:explosion 0.5s ease-out;
    border-color:rgba(244,67,54,.8);
  }

  @keyframes explosion{
    0%{background:rgba(16,20,24,.9);}
    50%{background:rgba(244,67,54,.3);}
    100%{background:rgba(16,20,24,.9);}
  }

  .crash-multiplier-display{
    position:absolute;
    top:20px;
    left:50%;
    transform:translateX(-50%);
    text-align:center;
    z-index:10;
  }

  .crash-multiplier-value{
    font-family:'Press Start 2P', monospace;
    font-size:48px;
    color:var(--gold);
    text-shadow:0 0 20px rgba(255,214,77,.8), 0 4px 8px rgba(0,0,0,.8);
    animation:pulse 2s ease-in-out infinite;
  }

  .crash-multiplier-value.flying{
    animation:flyingPulse 0.3s ease-in-out infinite;
  }

  @keyframes flyingPulse{
    0%, 100%{transform:scale(1);}
    50%{transform:scale(1.1);}
  }

  .crash-status-text{
    font-family:'Press Start 2P', monospace;
    font-size:11px;
    color:#a0a8b0;
    margin-top:8px;
  }

  .crash-rocket{
    position:absolute;
    font-size:40px;
    bottom:20px;
    left:50%;
    transform:translateX(-50%);
    transition:all 0.05s linear;
    z-index:5;
  }

  .crash-rocket.flying{
    animation:rocketShake 0.1s infinite;
  }

  @keyframes rocketShake{
    0%, 100%{transform:translateX(-50%) rotate(-2deg);}
    50%{transform:translateX(-50%) rotate(2deg);}
  }

  .crash-trail-canvas{
    position:absolute;
    top:0;
    left:0;
    width:100%;
    height:100%;
    z-index:1;
  }

  .crash-cashout-btn{
    width:100%;
    padding:16px;
    background:var(--gold);
    border:2px solid var(--gold);
    color:#000;
    font-family:'Press Start 2P', monospace;
    font-size:14px;
    cursor:pointer;
    border-radius:8px;
    transition:all 0.2s;
  }

  .crash-cashout-btn:hover:not(:disabled){
    background:rgba(255,214,77,.8);
    transform:scale(1.02);
  }

  .crash-cashout-btn:disabled{
    background:rgba(255,214,77,.2);
    border-color:rgba(255,214,77,.2);
    color:rgba(255,255,255,.3);
    cursor:not-allowed;
  }

  .crash-game-status{
    text-align:center;
    font-family:'Press Start 2P', monospace;
    font-size:11px;
    color:#a0a8b0;
    padding:12px;
    background:rgba(0,0,0,.3);
    border-radius:8px;
  }

  /* Leaderboard Screen Styles */
  .leaderboard-container{
    display:none;
    width:min(780px,92vw);
    background:rgba(12,16,20,.10);
    border:2px solid rgba(255,214,77,.3);
    border-radius:12px;
    padding:24px;
    backdrop-filter:blur(8px);
  }

  .leaderboard-header{
    display:flex;
    justify-content:space-between;
    align-items:center;
    margin-bottom:24px;
    padding-bottom:16px;
    border-bottom:1px solid rgba(255,214,77,.2);
  }

  .leaderboard-title{
    font-family:'Press Start 2P', monospace;
    font-size:18px;
    color:var(--gold);
  }

  .podium{
    display:grid;
    grid-template-columns:repeat(3, 1fr);
    gap:16px;
    margin-bottom:32px;
    align-items:flex-end;
  }

  .podium-item{
    background:rgba(255,214,77,.05);
    border:2px solid rgba(255,214,77,.2);
    border-radius:8px;
    padding:20px 16px;
    text-align:center;
    transition:all 0.3s;
    position:relative;
  }

  .podium-item.rank-1{
    order:2;
    border-color:var(--gold);
    background:rgba(255,214,77,.15);
    transform:scale(1.1);
  }

  .podium-item.rank-2{
    order:1;
    border-color:rgba(192,192,192,.5);
    background:rgba(192,192,192,.08);
  }

  .podium-item.rank-3{
    order:3;
    border-color:rgba(205,127,50,.5);
    background:rgba(205,127,50,.08);
  }

  .podium-rank{
    position:absolute;
    top:-12px;
    left:50%;
    transform:translateX(-50%);
    width:32px;
    height:32px;
    border-radius:50%;
    display:flex;
    align-items:center;
    justify-content:center;
    font-family:'Press Start 2P', monospace;
    font-size:11px;
    font-weight:bold;
    border:2px solid;
  }

  .rank-1 .podium-rank{
    background:var(--gold);
    border-color:var(--gold-hi);
    color:#000;
    box-shadow:0 0 20px rgba(255,214,77,.6);
  }

  .rank-2 .podium-rank{
    background:#C0C0C0;
    border-color:#E8E8E8;
    color:#000;
  }

  .rank-3 .podium-rank{
    background:#CD7F32;
    border-color:#E4A853;
    color:#000;
  }

  .podium-player{
    font-family:'Press Start 2P', monospace;
    font-size:11px;
    color:var(--gold);
    margin:8px 0 4px;
    overflow:hidden;
    text-overflow:ellipsis;
  }

  .podium-time{
    font-family:'Press Start 2P', monospace;
    font-size:16px;
    color:#4CAF50;
    margin:4px 0;
  }

  .podium-date{
    font-size:9px;
    color:#a0a8b0;
    font-family:Inter, system-ui, Arial;
  }

  .leaderboard-filters{
    display:flex;
    gap:12px;
    margin-bottom:20px;
    flex-wrap:wrap;
  }

  .filter-btn{
    padding:8px 16px;
    background:rgba(255,214,77,.1);
    border:1px solid rgba(255,214,77,.3);
    color:var(--gold);
    font-family:'Press Start 2P', monospace;
    font-size:9px;
    cursor:pointer;
    border-radius:6px;
    transition:all 0.2s;
  }

  .filter-btn.active{
    background:var(--gold);
    color:#000;
    border-color:var(--gold);
  }

  .filter-btn:hover{
    background:rgba(255,214,77,.2);
    transform:translateY(-1px);
  }

  .leaderboard-table{
    background:rgba(0,0,0,.3);
    border:1px solid rgba(255,214,77,.2);
    border-radius:8px;
    overflow:hidden;
  }

  .table-header{
    display:grid;
    grid-template-columns:60px 1fr 120px 140px;
    gap:12px;
    padding:12px 16px;
    background:rgba(255,214,77,.1);
    border-bottom:1px solid rgba(255,214,77,.2);
    font-family:'Press Start 2P', monospace;
    font-size:9px;
    color:var(--gold);
  }

  .table-row{
    display:grid;
    grid-template-columns:60px 1fr 120px 140px;
    gap:12px;
    padding:12px 16px;
    border-bottom:1px solid rgba(255,214,77,.1);
    font-family:'Press Start 2P', monospace;
    font-size:10px;
    transition:all 0.2s;
  }

  .table-row:hover{
    background:rgba(255,214,77,.05);
  }

  .table-row:last-child{
    border-bottom:none;
  }

  .table-row.user-row{
    background:rgba(76,175,80,.1);
    border:1px solid rgba(76,175,80,.3);
  }

  .rank-badge{
    color:#a0a8b0;
    text-align:center;
  }

  .player-name{
    color:#e6ecf1;
    overflow:hidden;
    text-overflow:ellipsis;
  }

  .reaction-time{
    color:#4CAF50;
    text-align:center;
  }

  .entry-date{
    color:#a0a8b0;
    font-size:9px;
    text-align:right;
  }

  .no-data{
    text-align:center;
    padding:40px 20px;
    color:#a0a8b0;
    font-family:'Press Start 2P', monospace;
    font-size:11px;
  }

  .your-best{
    background:rgba(255,214,77,.05);
    border:1px solid rgba(255,214,77,.2);
    border-radius:8px;
    padding:16px;
    margin-bottom:20px;
    text-align:center;
  }

  .your-best-label{
    font-family:'Press Start 2P', monospace;
    font-size:10px;
    color:#a0a8b0;
    margin-bottom:8px;
  }

  .your-best-time{
    font-family:'Press Start 2P', monospace;
    font-size:20px;
    color:var(--gold);
  }

  /* Loading state */
  .loading-spinner{
    display:inline-block;
    width:20px;
    height:20px;
    border:3px solid rgba(255,214,77,.2);
    border-top-color:var(--gold);
    border-radius:50%;
    animation:spin 1s linear infinite;
  }

  @keyframes spin{
    to{transform:rotate(360deg);}
  }

  /* Error message - glassmorphism style */
  .error-msg{
    color:#ff6b6b;
    font-size:12px;
    font-family:Inter, system-ui, Arial;
    margin-top:8px;
    padding:12px 16px;
    background:rgba(12,16,20,0.85);
    border:2px solid rgba(244, 67, 54, 0.5);
    border-radius:8px;
    backdrop-filter:blur(8px);
    box-shadow:0 4px 16px rgba(0,0,0,0.3), 0 0 20px rgba(244, 67, 54, 0.1);
    display:none;
    line-height:1.4;
  }

  .error-msg.show{
    display:block;
    animation:slideDown 0.2s ease-out;
  }

  @keyframes slideDown{
    from{
      opacity:0;
      transform:translateY(-4px);
    }
    to{
      opacity:1;
      transform:translateY(0);
    }
  }

  /* Responsive improvements */
  @media(max-width:600px){
    /* Leaderboard table - improved readability */
    .table-header, .table-row{
      grid-template-columns:50px 1fr 90px;
      font-size:11px;
    }
    .entry-date{
      display:none;
    }
    .podium{
      grid-template-columns:1fr;
    }
    .podium-item.rank-1{
      order:1;
    }
    .podium-item.rank-2{
      order:2;
    }
    .podium-item.rank-3{
      order:3;
    }
    .quest-grid, .inventory-grid{
      grid-template-columns:1fr;
    }

    /* Panel and container sizing */
    .panel{
      width:96vw;
      padding:20px 16px;
      max-height:88vh;
      overflow-y:auto;
    }
    .dashboard-container, .quest-container, .leaderboard-container, .game-container, .inventory-container, .campaign-container{
      width:96vw;
      padding:16px 12px;
      max-height:88vh;
      overflow-y:auto;
    }

    /* Typography adjustments - improved readability */
    .panel-title, .dashboard-title, .quest-title, .leaderboard-title, .game-title, .inventory-title{
      font-size:16px;
    }
    .warrior-subtitle{
      font-size:11px;
    }
    .input-label{
      font-size:12px;
    }
    .warrior-input{
      font-size:14px;
      padding:14px 16px;
    }

    /* Buttons - better touch targets (minimum 44px height) */
    .btn-submit, .back-btn, .action-btn{
      font-size:12px;
      padding:16px 20px;
      min-height:48px;
    }
    .sell-button{
      font-size:14px;
      padding:20px;
      min-height:52px;
    }

    /* Dashboard stats grid */
    .stats-grid{
      grid-template-columns:1fr;
      gap:14px;
    }
    .stat-value{
      font-size:20px;
    }
    .stat-label{
      font-size:11px;
    }

    /* Quest tabs - better touch targets */
    .quest-tabs{
      flex-wrap:wrap;
      gap:10px;
    }
    .quest-tab{
      font-size:10px;
      padding:12px 16px;
      min-height:44px;
    }

    /* Quest cards */
    .quest-card{
      padding:16px;
    }
    .quest-name{
      font-size:11px;
      line-height:1.4;
    }
    .quest-desc{
      font-size:13px;
      line-height:1.5;
    }

    /* Game layout - stack vertically on mobile */
    .game-layout{
      grid-template-columns:1fr;
      gap:16px;
    }

    /* Chart game */
    .chart-container{
      height:250px;
    }
    .price-display{
      font-size:16px;
      top:12px;
      right:12px;
    }
    .instructions-title{
      font-size:12px;
    }
    .instructions-text{
      font-size:13px;
      line-height:1.5;
    }

    /* Footer */
    .footer{
      right:10px;
      bottom:10px;
      font-size:11px;
      gap:10px;
    }
    .footer svg{
      width:16px;
      height:16px;
    }

    /* Page container */
    .page-container{
      padding:20px 12px;
    }
    .page-container.bottom-aligned{
      padding-bottom:30px;
    }

    /* Shop grid */
    .shop-grid{
      grid-template-columns:1fr;
      gap:16px;
    }

    /* Results grid */
    .results-grid{
      grid-template-columns:repeat(auto-fit, minmax(70px, 1fr));
      gap:10px;
    }
    .result-item{
      padding:10px;
      font-size:12px;
    }

    /* Coming soon overlay */
    .coming-soon-overlay{
      font-size:18px;
      padding:16px;
    }

    /* Dashboard header - stack on mobile */
    .dashboard-header{
      flex-direction:column;
      align-items:flex-start;
      gap:16px;
    }
    .dashboard-header > div:last-child{
      width:100%;
      justify-content:space-between;
      gap:8px !important;
      flex-wrap:wrap;
    }

    /* Game disclaimer - better mobile formatting */
    .game-disclaimer{
      font-size:11px;
      padding:14px;
      line-height:1.5;
    }

    /* Breadcrumb improvements */
    .breadcrumb{
      font-size:11px;
      flex-wrap:wrap;
    }

    /* Attempts counter */
    .attempts-counter{
      font-size:12px;
    }

    /* Game status */
    .game-status, .crash-game-status{
      font-size:13px;
      padding:12px;
    }
  }

  /* Quest System Styles */
  .quest-container{
    display:none;
    width:min(720px,92vw);
    background:rgba(12,16,20,.10);
    border:2px solid rgba(255,214,77,.3);
    border-radius:12px;
    padding:24px;
    backdrop-filter:blur(8px);
  }

  .quest-header{
    display:flex;
    justify-content:space-between;
    align-items:center;
    margin-bottom:24px;
    padding-bottom:16px;
    border-bottom:1px solid rgba(255,214,77,.2);
  }

  .quest-title{
    font-family:'Press Start 2P', monospace;
    font-size:18px;
    color:var(--gold);
  }

  .quest-tabs{
    display:flex;
    gap:12px;
    margin-bottom:20px;
  }

  .quest-tab{
    padding:10px 20px;
    background:rgba(255,214,77,.1);
    border:1px solid rgba(255,214,77,.3);
    color:var(--gold);
    font-family:'Press Start 2P', monospace;
    font-size:10px;
    cursor:pointer;
    border-radius:6px;
    transition:all 0.2s;
  }

  .quest-tab.active{
    background:var(--gold);
    color:#000;
  }

  .quest-tab.locked{
    opacity:0.5;
    cursor:not-allowed;
    filter:blur(1px);
  }

  .quest-grid{
    display:grid;
    grid-template-columns:repeat(auto-fill, minmax(320px, 1fr));
    gap:16px;
    margin-bottom:20px;
    position:relative;
  }

  .quest-grid.locked{
    filter:blur(2px);
    opacity:0.4;
    pointer-events:none;
    user-select:none;
  }

  .quest-grid-wrapper{
    position:relative;
  }

  @keyframes pulse{
    0%, 100%{ opacity:1; transform:scale(1); }
    50%{ opacity:0.7; transform:scale(1.05); }
  }

  .quest-card{
    background:rgba(255,214,77,.05);
    border:1px solid rgba(255,214,77,.2);
    border-radius:8px;
    padding:16px;
    transition:all 0.2s;
  }

  .quest-card:hover{
    border-color:var(--gold);
    background:rgba(255,214,77,.1);
  }

  .quest-card.completed{
    background:rgba(76,175,80,.1);
    border-color:rgba(76,175,80,.3);
    opacity:1 !important;
    visibility:visible !important;
  }

  .quest-name{
    font-family:'Press Start 2P', monospace;
    font-size:11px;
    color:var(--gold);
    margin-bottom:8px;
  }

  .quest-desc{
    font-family:Inter, system-ui, Arial;
    font-size:12px;
    color:#a0a8b0;
    margin-bottom:12px;
    line-height:1.5;
  }

  .quest-progress{
    margin-bottom:10px;
  }

  .progress-bar{
    width:100%;
    height:8px;
    background:rgba(0,0,0,.4);
    border-radius:4px;
    overflow:hidden;
  }

  .progress-fill{
    height:100%;
    background:linear-gradient(90deg, var(--gold), var(--gold-hi));
    transition:width 0.3s;
  }

  .progress-text{
    font-family:'Press Start 2P', monospace;
    font-size:9px;
    color:#a0a8b0;
    margin-top:4px;
  }

  .quest-reward{
    display:flex;
    align-items:center;
    gap:8px;
    font-family:'Press Start 2P', monospace;
    font-size:10px;
    color:#4CAF50;
  }

  .quest-icon{
    font-size:16px;
  }

  /* Inventory System Styles */
  .inventory-container{
    display:none;
    width:min(600px,92vw);
    max-height:85vh;
    overflow-y:auto;
    background:linear-gradient(135deg, rgba(20,25,30,.95) 0%, rgba(12,16,20,.98) 100%);
    border:2px solid rgba(255,214,77,.4);
    border-radius:16px;
    padding:24px;
    backdrop-filter:blur(12px);
    box-shadow:0 8px 32px rgba(0,0,0,.5), inset 0 1px 0 rgba(255,214,77,.1);
  }

  .inventory-header{
    display:flex;
    justify-content:space-between;
    align-items:center;
    margin-bottom:24px;
    padding-bottom:16px;
    border-bottom:2px solid rgba(255,214,77,.3);
  }

  .inventory-title{
    font-family:'Press Start 2P', monospace;
    font-size:18px;
    color:var(--gold);
    text-shadow:0 0 10px rgba(255,214,77,.3);
  }

  .gc-display{
    font-family:'Press Start 2P', monospace;
    font-size:14px;
    color:#4CAF50;
  }

  .inventory-grid{
    display:grid;
    grid-template-columns:repeat(4, 1fr);
    gap:12px;
    margin-bottom:20px;
    padding:16px;
    background:rgba(0,0,0,.3);
    border-radius:12px;
    border:1px solid rgba(255,214,77,.15);
  }

  .inventory-slot{
    aspect-ratio:1;
    background:linear-gradient(145deg, rgba(30,35,40,.8) 0%, rgba(20,25,30,.9) 100%);
    border:2px solid rgba(255,214,77,.25);
    border-radius:8px;
    display:flex;
    flex-direction:column;
    align-items:center;
    justify-content:center;
    cursor:pointer;
    transition:all 0.2s ease;
    padding:8px;
    position:relative;
    box-shadow:inset 0 1px 0 rgba(255,255,255,.05), 0 2px 4px rgba(0,0,0,.3);
  }

  .inventory-slot:hover{
    border-color:var(--gold);
    background:linear-gradient(145deg, rgba(255,214,77,.15) 0%, rgba(255,214,77,.05) 100%);
    transform:translateY(-2px);
    box-shadow:0 4px 12px rgba(255,214,77,.2);
  }

  .inventory-slot.empty{
    opacity:0.4;
    cursor:default;
  }

  .inventory-slot.empty:hover{
    transform:none;
    box-shadow:inset 0 1px 0 rgba(255,255,255,.05), 0 2px 4px rgba(0,0,0,.3);
    background:linear-gradient(145deg, rgba(30,35,40,.8) 0%, rgba(20,25,30,.9) 100%);
    border-color:rgba(255,214,77,.25);
  }

  .inventory-slot.invite-code{
    border-color:rgba(34,197,94,.5);
    background:linear-gradient(145deg, rgba(34,197,94,.15) 0%, rgba(20,25,30,.9) 100%);
  }

  .inventory-slot.invite-code:hover{
    border-color:#22c55e;
    box-shadow:0 4px 12px rgba(34,197,94,.3);
  }

  .item-icon{
    font-size:28px;
    margin-bottom:6px;
  }

  .item-name{
    font-family:'Press Start 2P', monospace;
    font-size:7px;
    color:#e6ecf1;
    text-align:center;
    line-height:1.3;
  }

  .item-count{
    position:absolute;
    bottom:4px;
    right:4px;
    background:rgba(0,0,0,.8);
    padding:2px 4px;
    border-radius:3px;
    font-family:'Press Start 2P', monospace;
    font-size:9px;
    color:var(--gold);
  }

  .inventory-section-title{
    font-family:'Press Start 2P', monospace;
    font-size:10px;
    color:var(--gold);
    margin-bottom:12px;
    padding-left:4px;
    opacity:0.8;
  }

  .shop-section{
    position:relative;
    margin-top:30px;
    padding-top:20px;
    border-top:1px solid rgba(255,214,77,.2);
    min-height:200px;
  }

  .shop-title{
    font-family:'Press Start 2P', monospace;
    font-size:14px;
    color:var(--gold);
    margin-bottom:16px;
  }

  .shop-grid{
    display:grid;
    grid-template-columns:repeat(auto-fill, minmax(200px, 1fr));
    gap:16px;
  }

  .shop-item{
    background:rgba(255,214,77,.05);
    border:1px solid rgba(255,214,77,.2);
    border-radius:8px;
    padding:16px;
    text-align:center;
    transition:all 0.2s;
  }

  .shop-item:hover{
    border-color:var(--gold);
    background:rgba(255,214,77,.1);
  }

  .shop-item .item-icon{
    font-size:48px;
    margin-bottom:8px;
  }

  .shop-item-name{
    font-family:'Press Start 2P', monospace;
    font-size:11px;
    color:var(--gold);
    margin-bottom:8px;
  }

  .shop-item-desc{
    font-family:Inter, system-ui, Arial;
    font-size:11px;
    color:#a0a8b0;
    margin-bottom:12px;
  }

  .shop-item-price{
    font-family:'Press Start 2P', monospace;
    font-size:12px;
    color:#4CAF50;
    margin-bottom:12px;
  }

  .buy-btn{
    width:100%;
    padding:8px;
    background:var(--gold);
    border:2px solid var(--gold);
    color:#000;
    font-family:'Press Start 2P', monospace;
    font-size:10px;
    cursor:pointer;
    border-radius:6px;
    transition:all 0.2s;
  }

  .buy-btn:hover:not(:disabled){
    background:var(--gold-hi);
    transform:translateY(-2px);
  }

  .buy-btn:disabled{
    background:rgba(100,100,100,.3);
    border-color:rgba(100,100,100,.2);
    color:rgba(255,255,255,.3);
    cursor:not-allowed;
  }

  /* ===== CUSTOM MODAL SYSTEM - Glassmorphism Design ===== */
  .modal-overlay{
    position:fixed;
    inset:0;
    background:rgba(0,0,0,0.85);
    backdrop-filter:blur(12px);
    display:none;
    align-items:center;
    justify-content:center;
    z-index:9999;
    animation:fadeIn 0.3s ease-out;
  }

  .modal-overlay.show{
    display:flex;
  }

  .modal-container{
    background:rgba(12,16,20,0.95);
    border:2px solid rgba(255,214,77,0.4);
    border-radius:16px;
    max-width:420px;
    width:90%;
    max-height:90vh;
    display:flex;
    flex-direction:column;
    box-shadow:
      0 24px 80px rgba(0,0,0,0.8),
      0 0 60px rgba(255,214,77,0.15),
      inset 0 1px 0 rgba(255,255,255,0.05);
    animation:modalSlideIn 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
    overflow:hidden;
    backdrop-filter:blur(20px);
  }

  @keyframes modalSlideIn{
    0%{
      opacity:0;
      transform:scale(0.95) translateY(-20px);
    }
    100%{
      opacity:1;
      transform:scale(1) translateY(0);
    }
  }

  .modal-logo{
    display:block;
    width:56px;
    height:56px;
    margin:0 auto 16px;
    filter:drop-shadow(0 4px 12px rgba(255,214,77,0.3));
  }

  .modal-header{
    display:flex;
    flex-direction:column;
    align-items:center;
    padding:28px 24px 20px;
    border-bottom:1px solid rgba(255,255,255,0.1);
    background:transparent;
    position:relative;
  }

  .modal-header-row{
    display:flex;
    justify-content:space-between;
    align-items:center;
    width:100%;
    position:absolute;
    top:16px;
    left:0;
    right:0;
    padding:0 16px;
  }

  .modal-title{
    font-family:'Press Start 2P', monospace;
    font-size:12px;
    color:var(--gold);
    text-shadow:0 2px 8px rgba(255,214,77,0.3);
    text-align:center;
    margin-top:8px;
  }

  .modal-close{
    background:rgba(255,255,255,0.1);
    border:none;
    color:#888;
    font-size:20px;
    line-height:1;
    cursor:pointer;
    padding:0;
    width:32px;
    height:32px;
    display:flex;
    align-items:center;
    justify-content:center;
    transition:all 0.2s;
    border-radius:8px;
    position:absolute;
    right:16px;
    top:16px;
  }

  .modal-close:hover{
    background:rgba(255,255,255,0.2);
    color:#fff;
  }

  .modal-body{
    padding:24px;
    font-family:Inter, system-ui, Arial;
    font-size:14px;
    line-height:1.6;
    color:#e6ecf1;
    white-space:pre-wrap;
    text-align:center;
    overflow-y:auto;
    flex:1;
  }

  .modal-actions{
    display:flex;
    gap:12px;
    padding:20px 24px;
    background:rgba(0,0,0,0.2);
    border-top:1px solid rgba(255,255,255,0.1);
  }

  .modal-btn{
    flex:1;
    padding:12px 24px;
    font-family:'Press Start 2P', monospace;
    font-size:9px;
    border:2px solid;
    border-radius:8px;
    cursor:pointer;
    transition:all 0.2s;
    text-transform:uppercase;
  }

  .modal-btn-primary{
    background:var(--gold);
    border-color:var(--gold-hi);
    color:#000;
    box-shadow:0 4px 12px rgba(255,214,77,0.3);
  }

  .modal-btn-primary:hover{
    background:var(--gold-hi);
    transform:translateY(-2px);
    box-shadow:0 6px 20px rgba(255,214,77,0.5);
  }

  .modal-btn-primary:active{
    transform:translateY(0);
  }

  .modal-btn-secondary{
    background:transparent;
    border-color:rgba(255,255,255,0.2);
    color:#e6ecf1;
  }

  .modal-btn-secondary:hover{
    background:rgba(255,255,255,0.1);
    border-color:rgba(255,255,255,0.3);
  }

  /* ===== TOAST NOTIFICATION SYSTEM ===== */
  .toast-container{
    position:fixed;
    top:20px;
    right:20px;
    z-index:10000;
    display:flex;
    flex-direction:column;
    gap:12px;
    pointer-events:none;
  }

  .toast{
    background:rgba(12,16,20,0.95);
    border:2px solid;
    border-radius:12px;
    padding:16px 20px;
    min-width:300px;
    max-width:420px;
    box-shadow:
      0 8px 32px rgba(0,0,0,0.6),
      inset 0 1px 0 rgba(255,255,255,0.05);
    display:flex;
    align-items:center;
    gap:12px;
    pointer-events:auto;
    animation:toastSlideIn 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
    backdrop-filter:blur(12px);
  }

  .toast.removing{
    animation:toastSlideOut 0.3s ease-out forwards;
  }

  @keyframes toastSlideIn{
    0%{
      opacity:0;
      transform:translateX(400px);
    }
    100%{
      opacity:1;
      transform:translateX(0);
    }
  }

  @keyframes toastSlideOut{
    0%{
      opacity:1;
      transform:translateX(0) scale(1);
    }
    100%{
      opacity:0;
      transform:translateX(400px) scale(0.8);
    }
  }

  .toast-icon{
    font-size:24px;
    line-height:1;
    flex-shrink:0;
  }

  .toast-content{
    flex:1;
  }

  .toast-title{
    font-family:'Press Start 2P', monospace;
    font-size:10px;
    margin-bottom:4px;
    line-height:1.4;
  }

  .toast-message{
    font-family:Inter, system-ui, Arial;
    font-size:13px;
    color:#a0a8b0;
    line-height:1.4;
  }

  .toast-success{
    border-color:rgba(76,175,80,0.6);
    box-shadow:
      0 8px 32px rgba(0,0,0,0.6),
      0 0 20px rgba(76,175,80,0.15),
      inset 0 1px 0 rgba(255,255,255,0.05);
  }

  .toast-success .toast-title{
    color:#4CAF50;
  }

  .toast-error{
    border-color:rgba(244,67,54,0.6);
    box-shadow:
      0 8px 32px rgba(0,0,0,0.6),
      0 0 20px rgba(244,67,54,0.15),
      inset 0 1px 0 rgba(255,255,255,0.05);
  }

  .toast-error .toast-title{
    color:#ff6b6b;
  }

  .toast-warning{
    border-color:rgba(255,152,0,0.6);
    box-shadow:
      0 8px 32px rgba(0,0,0,0.6),
      0 0 20px rgba(255,152,0,0.15),
      inset 0 1px 0 rgba(255,255,255,0.05);
  }

  .toast-warning .toast-title{
    color:#FF9800;
  }

  .toast-info{
    border-color:rgba(255,214,77,0.6);
    box-shadow:
      0 8px 32px rgba(0,0,0,0.6),
      0 0 20px rgba(255,214,77,0.15),
      inset 0 1px 0 rgba(255,255,255,0.05);
  }

  .toast-info .toast-title{
    color:var(--gold);
  }

  /* ===== LOADING OVERLAY ===== */
  .loading-overlay{
    position:fixed;
    inset:0;
    background:rgba(0,0,0,0.85);
    backdrop-filter:blur(8px);
    display:flex;
    flex-direction:column;
    align-items:center;
    justify-content:center;
    z-index:9998;
    animation:fadeIn 0.2s ease-out;
  }

  .loading-spinner{
    position:relative;
    width:80px;
    height:80px;
  }

  .spinner-ring{
    position:absolute;
    width:100%;
    height:100%;
    border:4px solid transparent;
    border-top-color:var(--gold);
    border-radius:50%;
    animation:spinnerRotate 1.2s cubic-bezier(0.5, 0, 0.5, 1) infinite;
  }

  .spinner-ring:nth-child(1){
    animation-delay:-0.45s;
    border-top-color:rgba(255,214,77,1);
  }

  .spinner-ring:nth-child(2){
    animation-delay:-0.3s;
    border-top-color:rgba(255,214,77,0.6);
  }

  .spinner-ring:nth-child(3){
    animation-delay:-0.15s;
    border-top-color:rgba(255,214,77,0.3);
  }

  @keyframes spinnerRotate{
    0%{
      transform:rotate(0deg);
    }
    100%{
      transform:rotate(360deg);
    }
  }

  .loading-text{
    margin-top:24px;
    font-family:'Press Start 2P', monospace;
    font-size:12px;
    color:var(--gold);
    text-shadow:0 0 10px rgba(255,214,77,0.5);
    animation:pulse 2s ease-in-out infinite;
  }

  /* ===== PULSE EFFECTS ===== */
  @keyframes pulse{
    0%, 100%{
      opacity:1;
      transform:scale(1);
    }
    50%{
      opacity:0.7;
      transform:scale(1.05);
    }
  }

  .pulse{
    animation:pulse 2s ease-in-out infinite;
  }

  @keyframes pulseGlow{
    0%, 100%{
      box-shadow:0 0 5px rgba(255,214,77,0.3), 0 0 10px rgba(255,214,77,0.2);
    }
    50%{
      box-shadow:0 0 20px rgba(255,214,77,0.6), 0 0 40px rgba(255,214,77,0.3);
    }
  }

  .pulse-glow{
    animation:pulseGlow 2s ease-in-out infinite;
  }

  .quest-card.claimable{
    animation:pulseGlow 2s ease-in-out infinite;
    cursor:pointer;
  }

  /* ===== ENHANCED HOVER EFFECTS ===== */
  .btn-submit, .action-btn, .back-btn, .filter-btn{
    transition:all 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);
    position:relative;
    overflow:hidden;
  }

  .btn-submit::before, .action-btn::before, .back-btn::before{
    content:'';
    position:absolute;
    top:50%;
    left:50%;
    width:0;
    height:0;
    border-radius:50%;
    background:rgba(255,255,255,0.2);
    transform:translate(-50%, -50%);
    transition:width 0.6s, height 0.6s;
  }

  .btn-submit:active::before, .action-btn:active::before, .back-btn:active::before{
    width:300px;
    height:300px;
  }

  .dashboard-stat{
    transition:all 0.3s ease;
  }

  .dashboard-stat:hover{
    transform:translateY(-4px) scale(1.02);
    border-color:var(--gold);
    box-shadow:0 8px 24px rgba(255,214,77,0.2);
  }

  .quest-card{
    transition:all 0.3s ease;
    transform-origin:center;
  }

  .quest-card:hover:not(.claimable){
    transform:translateY(-4px);
    box-shadow:0 8px 24px rgba(255,214,77,0.2);
  }

  .leaderboard-entry{
    transition:all 0.2s ease;
  }

  .leaderboard-entry:hover{
    background:rgba(255,214,77,0.05);
    transform:translateX(4px);
  }

  .shop-item{
    transition:all 0.3s ease;
  }

  .shop-item:hover{
    transform:translateY(-4px) scale(1.02);
    border-color:var(--gold);
    box-shadow:0 8px 24px rgba(255,214,77,0.2);
  }

  .inventory-item{
    transition:all 0.3s ease;
  }

  .inventory-item:hover{
    transform:scale(1.05) rotate(2deg);
    box-shadow:0 8px 24px rgba(255,214,77,0.3);
  }

  .podium-item{
    transition:all 0.3s ease;
  }

  .podium-item:hover{
    transform:translateY(-8px) scale(1.03);
    box-shadow:0 12px 32px rgba(255,214,77,0.3);
  }

  /* Button press effect */
  .btn-submit:active, .action-btn:active, .back-btn:active{
    transform:scale(0.95);
  }

  /* Fade in animation */
  @keyframes fadeIn{
    0%{
      opacity:0;
    }
    100%{
      opacity:1;
    }
  }

  @keyframes slideInUp{
    from{
      opacity:0;
      transform:translateY(20px);
    }
    to{
      opacity:1;
      transform:translateY(0);
    }
  }

  /* Card entrance animations */
  .dashboard-card{
    animation:slideInUp 0.4s ease-out forwards;
    opacity:0;
  }

  .dashboard-cards-row .dashboard-card:nth-child(1){animation-delay:0.1s;}
  .dashboard-cards-row .dashboard-card:nth-child(2){animation-delay:0.2s;}

  .stats-grid .stat-card{
    animation:slideInUp 0.3s ease-out forwards;
    opacity:0;
  }

  .stats-grid .stat-card:nth-child(1){animation-delay:0.05s;}
  .stats-grid .stat-card:nth-child(2){animation-delay:0.1s;}
  .stats-grid .stat-card:nth-child(3){animation-delay:0.15s;}
  .stats-grid .stat-card:nth-child(4){animation-delay:0.2s;}

  .quest-card{
    animation:slideInUp 0.4s ease-out forwards;
    opacity:0;
  }

  .quest-card:nth-child(1){animation-delay:0.1s;}
  .quest-card:nth-child(2){animation-delay:0.15s;}
  .quest-card:nth-child(3){animation-delay:0.2s;}
  .quest-card:nth-child(4){animation-delay:0.25s;}
  .quest-card:nth-child(5){animation-delay:0.3s;}
  .quest-card:nth-child(6){animation-delay:0.35s;}

  .market-bar{
    animation:slideInUp 0.4s ease-out forwards;
    opacity:0;
    animation-delay:0.25s;
  }

  /* Mobile responsive for new elements */
  @media(max-width:600px){
    /* Card layout - single column on mobile */
    .dashboard-cards-row{
      grid-template-columns:1fr;
      gap:16px;
    }

    .dashboard-card{
      padding:18px;
      margin-bottom:16px;
    }

    .card-title{
      font-size:12px;
      line-height:1.4;
    }

    .card-subtitle{
      font-size:11px;
    }

    .card-description{
      font-size:12px;
      line-height:1.5;
    }

    /* Market bar mobile optimization */
    .market-bar{
      padding:16px 20px !important;
      flex-direction:column;
      gap:12px;
      text-align:center;
    }

    .market-bar > div:first-child{
      flex-direction:column;
      gap:8px;
      width:100%;
    }

    .market-bar .action-btn{
      width:100%;
    }

    /* Toast notifications */
    .toast-container{
      top:10px;
      right:10px;
      left:10px;
    }

    .toast{
      min-width:unset;
      width:100%;
      font-size:12px;
    }

    .toast-title{
      font-size:11px;
    }

    /* Modals */
    .modal-container{
      width:94%;
      max-width:unset;
      padding:20px;
    }

    .modal-title{
      font-size:14px;
      line-height:1.4;
    }

    .modal-message{
      font-size:13px;
      line-height:1.5;
    }

    .modal-btn{
      font-size:12px;
      padding:14px 20px;
      min-height:48px;
    }

    /* Loading spinner */
    .loading-spinner{
      width:60px;
      height:60px;
    }

    .loading-text{
      font-size:12px;
    }

    /* Crash game mobile optimizations */
    .crash-rocket-container{
      height:250px;
    }

    .crash-multiplier-value{
      font-size:32px;
    }

    .crash-status-text{
      font-size:13px;
    }

    .crash-cashout-btn{
      font-size:14px;
      padding:18px;
      min-height:52px;
    }

    .crash-input{
      font-size:14px;
      padding:14px;
    }

    /* Mines game mobile */
    .mines-grid{
      gap:8px;
    }

    .mine-cell{
      font-size:18px;
      min-height:50px;
    }

    /* Blackjack mobile */
    .bj-card{
      width:50px;
      height:70px;
      font-size:18px;
    }

    .bj-hand-value{
      font-size:14px;
    }

    /* Oven game mobile */
    .oven-display{
      font-size:40px;
      padding:30px;
    }

    .oven-progress-bar{
      height:16px;
    }

    .oven-stat-value{
      font-size:16px;
    }

    .oven-stat-label{
      font-size:10px;
    }

    /* Farm game mobile */
    .farm-btn{
      width:140px;
      height:140px;
      font-size:16px;
    }

    .farm-result{
      font-size:14px;
    }

    /* Inventory items */
    .inventory-item{
      padding:14px;
    }

    .item-name{
      font-size:11px;
    }

    .item-description{
      font-size:12px;
    }

    /* Shop items */
    .shop-item{
      padding:16px;
    }

    .shop-item-title{
      font-size:12px;
    }

    .shop-item-desc{
      font-size:12px;
    }

    .shop-item-price{
      font-size:14px;
    }

    /* Stat cards in dashboard header */
    .stat-card{
      padding:10px 14px !important;
    }

    .stat-card .stat-value{
      font-size:16px !important;
    }

    .stat-card .stat-label{
      font-size:10px !important;
    }

    /* Logout button */
    .logout-btn{
      font-size:10px;
      padding:10px 12px;
      min-height:44px;
    }

    /* Input bar - stack vertically on mobile for better UX */
    .bar{
      flex-direction:column;
      gap:12px;
    }

    .btn-submit{
      width:100%;
      padding:14px 20px;
      font-size:13px;
    }

    .input-field{
      width:100%;
    }

    /* Input group spacing */
    .input-group{
      margin-bottom:20px;
    }

    .helper{
      margin-top:16px;
      font-size:12px;
    }

    /* Stat cards in header - reduce size to prevent overflow */
    .dashboard-header .stat-card{
      padding:6px 10px !important;
    }

    .dashboard-header .stat-label{
      font-size:9px !important;
    }

    .dashboard-header .stat-value{
      font-size:14px !important;
    }

    /* User info */
    .user-name{
      font-size:16px;
    }

    .user-stats{
      font-size:11px;
    }

    /* Brand title adjustments */
    .brand .title{
      font-size:20px;
    }

    .brand .slogan{
      font-size:9px;
    }
  }

  /* Extra small mobile devices (iPhone SE, etc.) */
  @media(max-width:375px){
    .brand .title{
      font-size:18px;
    }

    .panel-title, .dashboard-title, .quest-title, .leaderboard-title, .game-title, .inventory-title{
      font-size:14px;
    }

    .dashboard-header{
      gap:12px;
    }

    .stat-card{
      padding:6px 10px !important;
    }

    .dashboard-header .stat-card{
      padding:5px 8px !important;
    }

    .dashboard-header .stat-label{
      font-size:8px !important;
    }

    .dashboard-header .stat-value{
      font-size:13px !important;
    }

    .logout-btn{
      font-size:9px;
      padding:8px 10px;
    }

    .btn-submit{
      padding:14px 18px;
      font-size:12px;
    }

    .market-bar{
      padding:14px 16px !important;
    }

    .game-disclaimer{
      font-size:10px;
      padding:12px;
    }

    /* Tighter panel padding */
    .panel{
      padding:16px 12px;
    }

    .dashboard-container{
      padding:12px 10px;
    }
  }

  /* Landscape orientation on mobile */
  @media(max-width:900px) and (orientation:landscape){
    .brand .title{
      font-size:16px;
    }

    .brand .slogan{
      font-size:8px;
    }

    .panel, .dashboard-container, .quest-container, .leaderboard-container, .game-container, .inventory-container, .campaign-container{
      max-height:85vh;
    }

    .chart-container{
      height:200px;
    }

    .crash-rocket-container{
      height:200px;
    }

    .oven-display{
      font-size:32px;
      padding:20px;
    }

    .farm-btn{
      width:120px;
      height:120px;
    }
  }
</style>
</head>
<body>
  <!-- Background always visible with continuous animation -->
  <div class="bg">
    <img src="assets/bg-wildy.png" alt="Wilderness background">
  </div>

  <!-- Particle effects canvas -->
  <canvas class="particles-canvas" id="particlesCanvas"></canvas>

  <!-- CRT Scanlines overlay -->
  <div class="scanlines"></div>

  <!-- Brand always visible with continuous animation -->
  <div class="brand">
    <div class="title">
      <svg class="brand-logo" width="40" height="40" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
        <polygon points="50,5 90,27.5 90,72.5 50,95 10,72.5 10,27.5"
                 fill="none"
                 stroke="url(#logoGradient)"
                 stroke-width="4"/>
        <circle cx="40" cy="50" r="10" fill="#22c55e"/>
        <circle cx="60" cy="50" r="10" fill="#ef4444"/>
        <defs>
          <linearGradient id="logoGradient" x1="0%" y1="0%" x2="0%" y2="100%">
            <stop offset="0%" style="stop-color:#FFD64D;stop-opacity:1" />
            <stop offset="50%" style="stop-color:#D4AF37;stop-opacity:1" />
            <stop offset="100%" style="stop-color:#D4A033;stop-opacity:1" />
          </linearGradient>
        </defs>
      </svg>
      <span class="brand-text">DUEL PVP</span>
    </div>
    <div class="slogan">
      Real Time<span class="slogan-divider"></span>Real Skill<span class="slogan-divider"></span>Real Rewards
    </div>
  </div>

  <!-- Single page container that swaps content -->
  <main class="page-container bottom-aligned" id="pageContainer" role="main" aria-label="Main content">
    <!-- Initial page content -->
    <section class="panel panel-transparent fade-in-delayed" id="panelContent">
      <div class="panel-header">
        <div class="sys">Belcome to the arena<span class="blink">.</span></div>
        <div class="sub-text">Enter your exclusive access code to begin</div>
      </div>

      <div class="input-group">
        <label class="input-label" for="code">Access Code</label>
        <div class="bar">
          <input id="code" class="input-field" type="text" placeholder="XXXX-XXXX-XXXX" autocomplete="off" aria-label="Enter access code" aria-required="true">
          <button class="btn-submit" id="joinBtn" aria-label="Join with access code">JOIN</button>
        </div>
      </div>

      <div class="helper">
        Already have an account? <a id="loginLink" role="button" tabindex="0" aria-label="Sign in to existing account">Sign in</a>
      </div>
    </section>

    <!-- Dashboard content (hidden initially) -->
    <div class="dashboard-content" id="dashboardContent" role="region" aria-label="User dashboard">
      <div class="dashboard-header">
        <div class="user-info">
          <div class="user-name" id="userName" aria-label="User name">Champion</div>
          <div class="user-stats" aria-label="User level and rank">Level 0 • Falafel Enjoyer</div>
        </div>
        <div style="display:flex;align-items:center;gap:20px;">
          <div class="stat-card" style="margin:0;padding:8px 16px;">
            <div class="stat-label" style="font-size:10px;">RANK</div>
            <div class="stat-value" style="font-size:16px;" id="dashboardRank">--</div>
          </div>
          <div class="stat-card" style="margin:0;padding:8px 16px;">
            <div class="stat-label" style="font-size:10px;">GC BALANCE</div>
            <div class="stat-value" style="font-size:16px;" id="dashboardGCBalance">0</div>
          </div>
          <button class="logout-btn" id="logoutBtn" aria-label="Logout from account">LOGOUT</button>
        </div>
      </div>

      <div class="stats-grid">
        <div class="stat-card" style="cursor:pointer;display:flex;align-items:center;justify-content:center;" id="viewLeaderboardBtn">
          <div class="stat-label" style="margin:0;">LEADERBOARD</div>
        </div>
        <div class="stat-card" style="cursor:pointer;display:flex;align-items:center;justify-content:center;position:relative;" id="viewQuestsBtn">
          <div class="stat-label" style="margin:0;">QUESTS</div>
          <span style="position:absolute;top:-5px;right:-5px;background:#ff4444;color:white;font-size:12px;font-weight:bold;width:20px;height:20px;border-radius:50%;display:flex;align-items:center;justify-content:center;box-shadow:0 2px 4px rgba(0,0,0,0.3);">!</span>
        </div>
        <div class="stat-card" style="cursor:pointer;display:flex;align-items:center;justify-content:center;" id="viewInventoryBtn">
          <div class="stat-label" style="margin:0;">INVENTORY</div>
        </div>
      </div>

      <!-- Market Bar (hidden - kept for compatibility) -->
      <div class="market-bar" id="viewShopBtn" style="display:none;"></div>

      <!-- Campaign Banner -->
      <div class="campaign-banner" id="campaignBanner" onclick="swapContent('campaign')" style="cursor:pointer;">
        <div class="campaign-banner-header">
          <div class="campaign-banner-icon"></div>
          <div class="campaign-banner-text">WHO WANTS TO BE A MILLIONAIRE</div>
          <div class="campaign-banner-info"></div>
        </div>
        <div class="campaign-progress">
          <div class="campaign-progress-text">
            <span id="campaignCurrentGC">0</span> / 1,000,000 GC
          </div>
          <div class="campaign-progress-bar">
            <div class="campaign-progress-fill" id="campaignProgressFill" style="width:0%"></div>
          </div>
          <div class="campaign-time-remaining" id="campaignTimeRemaining">Campaign Active - Click to Play!</div>
        </div>
      </div>

      <!-- About Section -->
      <div class="campaign-earn-section">
        <div class="campaign-earn-title">ABOUT</div>

        <!-- Main Description -->
        <div style="background:rgba(0,0,0,0.5);border:2px solid rgba(255,214,77,0.4);border-radius:12px;padding:28px;margin-bottom:24px;box-shadow:0 4px 12px rgba(0,0,0,0.3);">
          <div style="font-family:'Press Start 2P',monospace;font-size:11px;color:#FFD700;margin-bottom:20px;text-align:center;letter-spacing:1px;">FULLY ON-CHAIN MMO</div>
          <div style="font-family:'Courier New',monospace;font-size:14px;line-height:2;color:#ffffff;text-align:left;padding:0 12px;text-shadow:0 1px 3px rgba(0,0,0,0.8);">
            <strong style="color:#FFD700;">Duel PVP</strong> combines classic MMO progression with idle game mechanics. Build your empire while you sleep, or actively dominate the arena—the choice is yours.
            <br><br>
            <strong style="color:#4CAF50;">Every game state, transaction, and mechanic lives on the blockchain.</strong>
            <br>
            No centralized servers. No hidden RNG. Trustless, transparent, verifiable by anyone.
          </div>
        </div>

        <!-- Two Paths -->
        <div style="font-family:'Press Start 2P',monospace;font-size:11px;color:#FFD700;margin-bottom:20px;text-align:center;letter-spacing:1px;">
          CHOOSE YOUR PATH:
        </div>

        <div class="campaign-cards-row">
          <!-- Left: Cultivator (green like DeFi) -->
          <div class="campaign-card invest">
            <div class="campaign-card-title">THE CULTIVATOR</div>
            <div style="font-family:'Courier New',monospace;font-size:14px;line-height:1.7;color:#ffffff;text-align:center;margin-bottom:16px;text-shadow:0 2px 4px rgba(0,0,0,0.8);">
              <strong style="color:#4CAF50;">Low-risk, steady growth.</strong><br><br>
              Farm resources, control markets, hire warriors to fight for you.<br>
              Build wealth through strategic resource management.
            </div>
          </div>

          <!-- Right: Warrior (red like Gambling) -->
          <div class="campaign-card gamble">
            <div class="campaign-card-title">THE WARRIOR</div>
            <div style="font-family:'Courier New',monospace;font-size:14px;line-height:1.7;color:#ffffff;text-align:center;margin-bottom:16px;text-shadow:0 2px 4px rgba(0,0,0,0.8);">
              <strong style="color:#F44336;">High-risk, high-reward.</strong><br><br>
              Raid dungeons, slay legendary bosses, dominate the PVP arena.<br>
              Earn through combat prowess and fearless execution.
            </div>
          </div>
        </div>

        <div style="text-align:center;margin-top:20px;">
          <span style="color:#FFD700;font-size:13px;font-family:'Courier New',monospace;">Launch planned 2026 (subject to change)</span>
        </div>
      </div>

    </div>

    <!-- Campaign content (hidden initially) -->
    <div class="campaign-container" id="campaignContent" role="region" aria-label="Millionaire campaign">
      <div class="campaign-header">
        <div class="campaign-title">WHO WANTS TO BE A MILLIONAIRE</div>
        <button class="back-btn" id="backFromCampaignBtn" aria-label="Back to dashboard">BACK</button>
      </div>

      <!-- Breadcrumb -->
      <div class="breadcrumb">
        <span class="breadcrumb-item" onclick="showDashboard()">Dashboard</span>
        <span class="breadcrumb-separator">›</span>
        <span class="breadcrumb-item active">Campaign</span>
      </div>

      <!-- Progress Section -->
      <div class="campaign-progress-section">
        <div class="campaign-progress-header">
          <div class="campaign-progress-title">CAMPAIGN PROGRESS</div>
          <div class="campaign-progress-percentage" id="campaignProgressPercentage">0%</div>
        </div>
        <div class="campaign-progress-bar-large">
          <div class="campaign-progress-fill-large" id="campaignProgressFillLarge" style="width:0%"></div>
        </div>
        <div class="campaign-progress-info">
          <span id="campaignCurrentGCPage">0</span> / 1,000,000 GC
        </div>
      </div>

      <!-- Campaign Info -->
      <div class="campaign-info-section">
        <div class="campaign-info-title">CAMPAIGN RULES</div>
        <div class="campaign-info-content">
          <div class="campaign-info-item">
            <span class="campaign-info-bullet">•</span>
            <span>Reach 1,000,000 GC to qualify for Founder's Sword mint eligibility</span>
          </div>
          <div class="campaign-info-item">
            <span class="campaign-info-bullet">•</span>
            <span>Earn GC through gambling, farming, and staking</span>
          </div>
          <div class="campaign-info-item">
            <span class="campaign-info-bullet">•</span>
            <span>All GC accumulates toward your campaign total</span>
          </div>
          <div class="campaign-info-item">
            <span class="campaign-info-bullet">•</span>
            <span>Campaign ends when all Founder's Swords are distributed</span>
          </div>
        </div>

        <div class="campaign-disclaimer-section" style="background:rgba(255,69,0,0.1);border:2px solid rgba(255,69,0,0.3);border-radius:8px;padding:16px;margin-top:16px;">
          <div style="font-family:'Press Start 2P',monospace;font-size:10px;color:#FF4500;margin-bottom:12px;text-align:center;">IMPORTANT DISCLAIMER</div>
          <div style="font-family:'Courier New',monospace;font-size:12px;line-height:1.7;color:#e0e8f0;">
            <strong>This pre-launch campaign is NOT the main game.</strong> These mechanics are for fun only. Campaign GC is temporary and has no monetary value.
            <br><br>
            <strong>The actual Duel PVP game launching in 2026 will be a fully on-chain MMO</strong> with completely different mechanics, progression systems, and gameplay. Think RuneScape meets blockchain - not a casino.
            <br><br>
            Campaign GC does not carry over to the main game.
          </div>
        </div>
      </div>

      <!-- Time Remaining -->
      <div class="campaign-time-section">
        <div class="campaign-time-label">TIME REMAINING</div>
        <div class="campaign-time-value" id="campaignTimeRemainingPage">Ends when all Founder's Swords are claimed</div>
      </div>

      <!-- Ways to Earn GC Section -->
      <div class="campaign-earn-section">
        <div class="campaign-earn-title">WAYS TO EARN GC</div>

        <!-- Two-column card layout -->
        <div class="campaign-cards-row">
          <!-- Left: DeFi -->
          <div class="campaign-card invest">
            <div class="campaign-card-title">DEFI</div>
            <div class="campaign-card-content">
              <button class="action-btn btn-invest" id="openOvenBtn" aria-label="Open Staking" style="width:100%;margin-bottom:12px;">STAKING</button>
              <button class="action-btn btn-invest" id="openFarmBtn" aria-label="Open Airdrop Farm" style="width:100%;margin-bottom:12px;">FARM</button>
              <button class="action-btn btn-invest" disabled style="width:100%;margin-bottom:12px;opacity:0.5;cursor:not-allowed;">SWAP</button>
              <button class="action-btn btn-invest" disabled style="width:100%;opacity:0.5;cursor:not-allowed;">YIELD FARMING</button>
            </div>
          </div>

          <!-- Right: Gambling -->
          <div class="campaign-card gamble">
            <div class="campaign-card-title">GAMBLING</div>
            <div class="campaign-card-content">
              <button class="action-btn btn-gamble" id="playCrashBtn" aria-label="Play crash rocket game" style="width:100%;margin-bottom:12px;">CRASH</button>
              <button class="action-btn btn-gamble" id="playMinesBtn" aria-label="Play mines game" style="width:100%;margin-bottom:12px;">MINES</button>
              <button class="action-btn btn-gamble" id="playBlackjackBtn" aria-label="Play blackjack game" style="width:100%;margin-bottom:12px;">BLACKJACK</button>
              <button class="action-btn btn-gamble" disabled style="width:100%;opacity:0.5;cursor:not-allowed;">TRADING SIM</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Leaderboard content (hidden initially) -->
    <div class="leaderboard-container" id="leaderboardContent" role="region" aria-label="Global leaderboard">
      <div class="leaderboard-header">
        <div class="leaderboard-title">GLOBAL LEADERBOARD</div>
        <button class="back-btn" id="backFromLeaderboardBtn" aria-label="Back to dashboard">BACK</button>
      </div>

      <!-- Breadcrumb -->
      <div class="breadcrumb">
        <span class="breadcrumb-item" onclick="showDashboard()">Dashboard</span>
        <span class="breadcrumb-separator">›</span>
        <span class="breadcrumb-item active">Leaderboard</span>
      </div>

      <div style="text-align:center;padding:16px 20px;margin-bottom:16px;background:rgba(212,175,55,0.1);border:1px solid rgba(212,175,55,0.3);border-radius:8px;">
        <span style="color:#FFD700;font-family:'Courier New',monospace;font-size:13px;">Climb the leaderboard for a chance to mint one of 1,500 Founder's Swords</span>
      </div>

      <div class="your-best" id="yourBestSection" style="display:none;">
        <div class="your-best-label">YOUR RANK</div>
        <div class="your-best-time" id="yourBestTime">#-- | -- GC</div>
      </div>

      <div class="leaderboard-table">
        <div class="table-header">
          <div>RANK</div>
          <div>PLAYER</div>
          <div>GC BALANCE</div>
          <div class="entry-date">WALLET</div>
        </div>
        <div id="leaderboardTableBody">
          <!-- Table rows will be generated here -->
        </div>
      </div>

      <!-- Empty state for leaderboard -->
      <div id="leaderboardEmpty" class="empty-state" style="display:none;">
        <div class="empty-state-icon"></div>
        <div class="empty-state-title">No Records Yet</div>
        <div class="empty-state-message">Be the first to appear on the leaderboard! Complete games to set your record.</div>
      </div>
    </div>

    <!-- Quest content (hidden initially) -->
    <div class="quest-container" id="questContent" role="region" aria-label="Quest log">
      <div class="quest-header">
        <div class="quest-title">QUEST LOG</div>
        <button class="back-btn" id="backFromQuestsBtn" aria-label="Back to dashboard">BACK</button>
      </div>

      <!-- Breadcrumb -->
      <div class="breadcrumb">
        <span class="breadcrumb-item" onclick="showDashboard()">Dashboard</span>
        <span class="breadcrumb-separator">›</span>
        <span class="breadcrumb-item active">Quests</span>
      </div>

      <div style="text-align:center;padding:16px 20px;margin-bottom:16px;background:rgba(212,175,55,0.1);border:1px solid rgba(212,175,55,0.3);border-radius:8px;">
        <span style="color:#FFD700;font-family:'Courier New',monospace;font-size:13px;">Climb the leaderboard for a chance to mint one of 1,500 Founder's Swords</span>
      </div>

      <div class="quest-tabs">
        <button class="quest-tab active" data-quest-tab="daily" onclick="switchQuestTab(this, 'daily')">DAILY QUESTS</button>
        <button class="quest-tab" data-quest-tab="weekly" disabled style="opacity:0.5;cursor:not-allowed;">WEEKLY QUESTS</button>
        <button class="quest-tab" data-quest-tab="special" disabled style="opacity:0.5;cursor:not-allowed;">SPECIAL QUESTS</button>
        <button class="quest-tab" data-quest-tab="completed" onclick="switchQuestTab(this, 'completed')">COMPLETED</button>
      </div>

      <div class="quest-grid-wrapper">
        <div id="comingSoonOverlay" class="coming-soon-overlay blink" style="display:none;">COMING SOON</div>
        <div id="questGrid" class="quest-grid">
          <!-- Quest cards will be generated here -->
        </div>

        <!-- Empty state for quests -->
        <div id="questsEmpty" class="empty-state" style="display:none;">
          <div class="empty-state-icon">📋</div>
          <div class="empty-state-title">No Quests Available</div>
          <div class="empty-state-message">Check back later for new quests to complete and earn rewards!</div>
        </div>
      </div>
    </div>

    <!-- Inventory content (hidden initially) -->
    <div class="inventory-container" id="inventoryContent" role="region" aria-label="Inventory">
      <div class="inventory-header">
        <div class="inventory-title">INVENTORY</div>
        <button class="back-btn" id="backFromInventoryBtn" aria-label="Back to dashboard">BACK</button>
      </div>

      <!-- Breadcrumb -->
      <div class="breadcrumb">
        <span class="breadcrumb-item" onclick="showDashboard()">Dashboard</span>
        <span class="breadcrumb-separator">›</span>
        <span class="breadcrumb-item active">Inventory</span>
      </div>

      <div class="inventory-section-title">INVITE CODES</div>
      <div class="inventory-grid" id="inventoryGrid">
        <!-- Inventory slots will be generated here -->
      </div>

      <!-- Empty state for inventory -->
      <div id="inventoryEmpty" class="empty-state" style="display:none;">
        <div class="empty-state-icon">🎒</div>
        <div class="empty-state-title">Empty Inventory</div>
        <div class="empty-state-message">Your inventory is empty. Visit the Market to purchase items and powerups!</div>
      </div>
    </div>

    <!-- Shop content (hidden initially) -->
    <div class="inventory-container" id="shopContent" role="region" aria-label="Market">
      <div class="inventory-header">
        <div class="inventory-title">MARKET</div>
        <div>
          <div class="gc-display" id="gcDisplayShop">GC: 0</div>
          <button class="back-btn" id="backFromShopBtn" aria-label="Back to dashboard" style="margin-top:8px;">BACK</button>
        </div>
      </div>

      <!-- Breadcrumb -->
      <div class="breadcrumb">
        <span class="breadcrumb-item" onclick="showDashboard()">Dashboard</span>
        <span class="breadcrumb-separator">›</span>
        <span class="breadcrumb-item active">Market</span>
      </div>

      <div class="coming-soon-wrapper disabled" style="position:relative;">
        <div class="shop-grid" id="shopGrid">
          <!-- Placeholder shop items for proper layout -->
          <div class="shop-item">
            <div class="item-icon">🗡️</div>
            <div class="shop-item-name">BRONZE SWORD</div>
            <div class="shop-item-desc">A sturdy starter weapon</div>
            <div class="shop-item-price">1,000 GC</div>
          </div>
          <div class="shop-item">
            <div class="item-icon">🛡️</div>
            <div class="shop-item-name">IRON SHIELD</div>
            <div class="shop-item-desc">Basic defense equipment</div>
            <div class="shop-item-price">1,500 GC</div>
          </div>
          <div class="shop-item">
            <div class="item-icon">⚔️</div>
            <div class="shop-item-name">STEEL BLADE</div>
            <div class="shop-item-desc">Improved attack power</div>
            <div class="shop-item-price">2,500 GC</div>
          </div>
          <div class="shop-item">
            <div class="item-icon">🏹</div>
            <div class="shop-item-name">HUNTER BOW</div>
            <div class="shop-item-desc">Ranged weapon for distance</div>
            <div class="shop-item-price">3,000 GC</div>
          </div>
          <div class="shop-item">
            <div class="item-icon">🪄</div>
            <div class="shop-item-name">MAGIC STAFF</div>
            <div class="shop-item-desc">Channel mystical energies</div>
            <div class="shop-item-price">4,000 GC</div>
          </div>
          <div class="shop-item">
            <div class="item-icon">💎</div>
            <div class="shop-item-name">RARE GEM</div>
            <div class="shop-item-desc">Valuable collectible item</div>
            <div class="shop-item-price">5,000 GC</div>
          </div>
          <div class="shop-item">
            <div class="item-icon">🎭</div>
            <div class="shop-item-name">MYSTIC MASK</div>
            <div class="shop-item-desc">Enhance your abilities</div>
            <div class="shop-item-price">6,000 GC</div>
          </div>
          <div class="shop-item">
            <div class="item-icon">👑</div>
            <div class="shop-item-name">ROYAL CROWN</div>
            <div class="shop-item-desc">Ultimate prestige item</div>
            <div class="shop-item-price">10,000 GC</div>
          </div>
        </div>
        <div class="coming-soon-overlay">
          <div class="coming-soon-badge">COMING SOON</div>
        </div>
      </div>
    </div>

    <!-- Staking Investment content (hidden initially) -->
    <div class="oven-container" id="ovenContent" role="region" aria-label="Staking investment">
      <div class="oven-header">
        <div class="oven-title">STAKING</div>
        <button class="back-btn" id="backFromOvenBtn" aria-label="Back to dashboard">BACK</button>
      </div>

      <!-- Breadcrumb -->
      <div class="breadcrumb">
        <span class="breadcrumb-item" onclick="showDashboard()">Dashboard</span>
        <span class="breadcrumb-separator">›</span>
        <span class="breadcrumb-item">DeFi</span>
        <span class="breadcrumb-separator">›</span>
        <span class="breadcrumb-item active">Staking</span>
      </div>

      <!-- Main stats display -->
      <div class="oven-stats-row">
        <div class="oven-stat-box">
          <div class="oven-stat-label">YOUR BALANCE</div>
          <div class="oven-stat-value" id="ovenUserBalance">0 GC</div>
        </div>
        <div class="oven-stat-box">
          <div class="oven-stat-label">INVESTED</div>
          <div class="oven-stat-value" id="ovenInvested">0 GC</div>
        </div>
        <div class="oven-stat-box">
          <div class="oven-stat-label">CURRENT VALUE</div>
          <div class="oven-stat-value highlight" id="ovenCurrentValue">0 GC</div>
        </div>
      </div>

      <!-- Timer -->
      <div class="oven-timer-box" id="ovenTimer">
        No active investment
      </div>

      <!-- Deposit section -->
      <div class="oven-action-section">
        <div class="oven-section-title">DEPOSIT</div>
        <div class="oven-input-row">
          <input type="number" class="oven-input" id="ovenDepositAmount" placeholder="Amount" min="1" step="1">
          <button class="action-btn btn-invest" id="ovenDepositBtn">DEPOSIT</button>
        </div>
      </div>

      <!-- Withdraw section -->
      <div class="oven-action-section">
        <div class="oven-section-title">WITHDRAW</div>
        <div class="oven-button-row">
          <button class="action-btn btn-gamble" id="ovenWithdrawBtn">WITHDRAW ALL</button>
        </div>
      </div>

      <!-- Info box -->
      <div class="oven-info">
        <strong>10% Hourly Compound Interest (Continuous)</strong><br>
        Your investment compounds every second at 10% per hour. Watch it grow in real-time! Withdraw anytime.
      </div>

      <!-- Disclaimer for Oven -->
      <div class="game-disclaimer success">
        💡 <strong>Simulated Investment:</strong> This is a campaign feature with simulated returns. All GC earned counts toward your 1M GC goal for the special badge.
      </div>
    </div>

    <!-- Airdrop Farm content (hidden initially) -->
    <div class="oven-container" id="farmContent" role="region" aria-label="Airdrop farm">
      <div class="oven-header">
        <div class="oven-title">🪂 AIRDROP FARM</div>
        <button class="back-btn" id="backFromFarmBtn" aria-label="Back to dashboard">BACK</button>
      </div>

      <!-- Breadcrumb -->
      <div class="breadcrumb">
        <span class="breadcrumb-item" onclick="showDashboard()">Dashboard</span>
        <span class="breadcrumb-separator">›</span>
        <span class="breadcrumb-item">DeFi</span>
        <span class="breadcrumb-separator">›</span>
        <span class="breadcrumb-item active">Farm</span>
      </div>

      <!-- Stats display -->
      <div class="oven-stats-row">
        <div class="oven-stat-box">
          <div class="oven-stat-label">TOTAL FARMED</div>
          <div class="oven-stat-value" id="farmTotalEarned">0 GC</div>
        </div>
        <div class="oven-stat-box">
          <div class="oven-stat-label">TODAY</div>
          <div class="oven-stat-value" id="farmTodayEarned">0 GC</div>
        </div>
        <div class="oven-stat-box">
          <div class="oven-stat-label">CLICKS</div>
          <div class="oven-stat-value" id="farmTotalClicks">0</div>
        </div>
      </div>

      <!-- Main farm button area -->
      <div class="farm-button-container">
        <button class="farm-btn" id="farmClickBtn">
          <div class="farm-btn-text">FARM</div>
        </button>
        <div class="farm-cooldown" id="farmCooldown" style="display:none;">
          <div class="farm-cooldown-text">Next click in <span id="farmCooldownTimer">5</span>s</div>
          <div class="farm-cooldown-bar">
            <div class="farm-cooldown-fill" id="farmCooldownFill"></div>
          </div>
        </div>
      </div>

      <!-- Result display -->
      <div class="farm-result" id="farmResult"></div>

      <!-- Info -->
      <div class="oven-info">
        <strong>Click to Farm Airdrops!</strong><br>
        Click every 5 seconds for a chance to earn GC. Keep farming for 3 days to maximize your rewards!
      </div>

      <!-- Disclaimer for Farm -->
      <div class="game-disclaimer info">
        ⚠️ <strong>Campaign Event:</strong> 3-day farming challenge. Campaign tokens only • Not exchangeable • Counts toward 1M GC goal
      </div>
    </div>

    <!-- Reaction Game content (hidden initially) -->
    <div class="game-container" id="gameContent" role="region" aria-label="Memecoin trading simulator">
      <div class="game-header">
        <div class="game-title">📈 MEMECOIN TRADING SIMULATOR</div>
        <button class="back-btn" id="backToDashBtn" aria-label="Back to dashboard">BACK</button>
      </div>

      <!-- Breadcrumb -->
      <div class="breadcrumb">
        <span class="breadcrumb-item" onclick="showDashboard()">Dashboard</span>
        <span class="breadcrumb-separator">›</span>
        <span class="breadcrumb-item">Skills</span>
        <span class="breadcrumb-separator">›</span>
        <span class="breadcrumb-item active">Memecoin Trading Simulator</span>
      </div>

      <div class="game-layout">
        <!-- Left sidebar with instructions -->
        <div class="game-sidebar">
          <div class="instructions">
            <div class="instructions-title">HOW TO PLAY</div>
            <div class="instructions-text">
              Watch the memecoin chart pump and dump! When it turns RED and starts crashing, hit SELL as fast as you can!
              React under 1000ms to earn 300 GC. Free to play, unlimited attempts!
            </div>
          </div>

          <div class="attempts-counter">
            <span class="attempts-label">BEST TIME</span>
            <span class="attempts-value" id="attemptsLeft">-- ms</span>
          </div>

          <div class="results-grid" id="resultsGrid">
            <!-- Results will be added here dynamically -->
          </div>
        </div>

        <!-- Main game area -->
        <div class="game-main">
          <div class="game-status" id="gameStatus">Click START to begin</div>

          <div class="chart-container" id="chartContainer">
            <canvas class="canvas-chart" id="chartCanvas"></canvas>
            <div class="price-display" id="priceDisplay">$42,156</div>
          </div>

          <button class="sell-button" id="sellButton" disabled>SELL</button>

          <div class="action-buttons" style="margin-top:16px;">
            <button class="action-btn btn-primary" id="startGameBtn">START TRADE</button>
            <button class="action-btn btn-secondary" id="resetGameBtn">RESET STATS</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Crash Rocket Game content (hidden initially) -->
    <div class="game-container" id="crashContent" role="region" aria-label="Crash rocket game">
      <div class="game-header">
        <div class="game-title">ROCKET CRASH</div>
        <button class="back-btn" id="backFromCrashBtn" aria-label="Back to dashboard">BACK</button>
      </div>

      <!-- Breadcrumb -->
      <div class="breadcrumb">
        <span class="breadcrumb-item" onclick="showDashboard()">Dashboard</span>
        <span class="breadcrumb-separator">›</span>
        <span class="breadcrumb-item">Gambling</span>
        <span class="breadcrumb-separator">›</span>
        <span class="breadcrumb-item active">Rocket Crash</span>
      </div>

      <div class="game-layout">
        <!-- Left sidebar -->
        <div class="game-sidebar">
          <div class="crash-bet-section">
            <div class="instructions-title">PLACE BET</div>
            <div style="margin-bottom:12px;">
              <label style="font-size:10px;color:#a0a8b0;display:block;margin-bottom:4px;">BET AMOUNT</label>
              <input type="number" id="crashBetAmount" class="crash-input" placeholder="100" min="10" value="100">
              <div style="font-size:9px;color:#a0a8b0;margin-top:4px;">Min: 10 GC • Max: 10,000 GC</div>
            </div>
            <div style="margin-bottom:12px;">
              <label style="font-size:10px;color:#a0a8b0;display:block;margin-bottom:4px;">AUTO CASHOUT (Optional)</label>
              <input type="number" id="crashAutoCashout" class="crash-input" placeholder="2.00" min="1.01" step="0.01">
              <div style="font-size:9px;color:#a0a8b0;margin-top:4px;">Auto-cashout at multiplier</div>
            </div>
            <button class="action-btn btn-primary" id="crashPlaceBetBtn" style="width:100%;">PLACE BET</button>
          </div>

          <div class="crash-info-section">
            <div class="crash-stat">
              <div class="stat-label">YOUR GC</div>
              <div class="stat-value" id="crashGCDisplay">0</div>
            </div>
            <div class="crash-stat">
              <div class="stat-label">CURRENT BET</div>
              <div class="stat-value" id="crashCurrentBet">0</div>
            </div>
            <div class="crash-stat">
              <div class="stat-label">POTENTIAL WIN</div>
              <div class="stat-value" id="crashPotentialWin">0</div>
            </div>
          </div>

          <div class="crash-history" id="crashHistory">
            <div class="instructions-title">CRASH HISTORY</div>
            <div id="crashHistoryList" class="crash-history-list">
              <!-- History items will appear here -->
            </div>
          </div>
        </div>

        <!-- Main game area -->
        <div class="game-main">
          <div class="crash-game-area">
            <!-- Provably Fair Hash Display -->
            <div class="crash-hash-display" id="crashHashDisplay">
              <div style="font-size:9px;color:#a0a8b0;margin-bottom:4px;">PROVABLY FAIR HASH</div>
              <div style="font-family:monospace;font-size:10px;color:var(--gold);word-break:break-all;" id="crashHash">Waiting for next round...</div>
            </div>

            <!-- Rocket Animation Area -->
            <div class="crash-rocket-container" id="crashRocketContainer">
              <div class="crash-multiplier-display" id="crashMultiplierDisplay">
                <div class="crash-multiplier-value" id="crashMultiplierValue">1.00x</div>
                <div class="crash-status-text" id="crashStatusText">Waiting for bets...</div>
              </div>
              <div class="crash-rocket" id="crashRocket">🚀</div>
              <canvas class="crash-trail-canvas" id="crashTrailCanvas"></canvas>
            </div>

            <!-- Cashout Button -->
            <button class="crash-cashout-btn" id="crashCashoutBtn" disabled>CASH OUT</button>

            <!-- Game Status -->
            <div class="crash-game-status" id="crashGameStatus">
              Next round starts in <span id="crashCountdown">3</span>s
            </div>
          </div>
        </div>
      </div>

      <!-- Disclaimer for Crash Game -->
      <div class="game-disclaimer">
        ⚠️ <strong>Campaign Only:</strong> Fake tokens for Millionaire campaign • Not exchangeable • Play responsibly
      </div>
    </div>

    <!-- Mines Game content (hidden initially) -->
    <div class="game-container" id="minesContent" role="region" aria-label="Mines game">
      <div class="game-header">
        <div class="game-title">💣 MINES</div>
        <button class="back-btn" id="backFromMinesBtn" aria-label="Back to dashboard">BACK</button>
      </div>

      <!-- Breadcrumb -->
      <div class="breadcrumb">
        <span class="breadcrumb-item" onclick="showDashboard()">Dashboard</span>
        <span class="breadcrumb-separator">›</span>
        <span class="breadcrumb-item">Gambling</span>
        <span class="breadcrumb-separator">›</span>
        <span class="breadcrumb-item active">Mines</span>
      </div>

      <div class="mines-game-area">
        <!-- Betting Section -->
        <div class="mines-bet-section">
          <div class="mines-bet-row">
            <div class="mines-input-group">
              <label class="mines-label">BET AMOUNT</label>
              <input type="number" class="mines-input" id="minesBetAmount" placeholder="10" min="10" max="10000" value="100">
            </div>
            <div class="mines-input-group">
              <label class="mines-label">MINES</label>
              <select class="mines-input" id="minesCount">
                <option value="3">3 Mines</option>
                <option value="5" selected>5 Mines</option>
                <option value="10">10 Mines</option>
                <option value="15">15 Mines</option>
              </select>
            </div>
          </div>
          <button class="action-btn btn-invest" id="minesStartBtn" style="width:100%;margin-top:12px;">START GAME</button>
          <button class="action-btn btn-gamble" id="minesCashoutBtn" style="width:100%;margin-top:12px;display:none;">CASH OUT</button>
        </div>

        <!-- Stats Display -->
        <div class="mines-stats-display">
          <div class="mines-stat">
            <div class="mines-stat-label">YOUR GC</div>
            <div class="mines-stat-value" id="minesGCDisplay">0</div>
          </div>
          <div class="mines-stat">
            <div class="mines-stat-label">MULTIPLIER</div>
            <div class="mines-stat-value" id="minesMultiplier">0.00x</div>
          </div>
          <div class="mines-stat">
            <div class="mines-stat-label">PROFIT</div>
            <div class="mines-stat-value" id="minesProfit">0 GC</div>
          </div>
          <div class="mines-stat">
            <div class="mines-stat-label">REVEALED</div>
            <div class="mines-stat-value" id="minesRevealed">0 / 25</div>
          </div>
        </div>

        <!-- Mines Grid (5x5) -->
        <div class="mines-grid" id="minesGrid">
          <!-- Grid tiles will be generated by JavaScript -->
        </div>

        <!-- Game Info -->
        <div class="mines-info">
          Click tiles to reveal. Avoid the mines! Cash out anytime to secure your winnings.
        </div>
      </div>

      <!-- Disclaimer for Mines Game -->
      <div class="game-disclaimer">
        ⚠️ <strong>Campaign Only:</strong> Fake tokens for Millionaire campaign • Not exchangeable • Play responsibly
      </div>
    </div>

    <!-- Blackjack Game content (hidden initially) -->
    <div class="game-container" id="blackjackContent" role="region" aria-label="Blackjack game">
      <div class="game-header">
        <div class="game-title">♠️ BLACKJACK</div>
        <button class="back-btn" id="backFromBlackjackBtn" aria-label="Back to dashboard">BACK</button>
      </div>

      <!-- Breadcrumb -->
      <div class="breadcrumb">
        <span class="breadcrumb-item" onclick="showDashboard()">Dashboard</span>
        <span class="breadcrumb-separator">›</span>
        <span class="breadcrumb-item">Gambling</span>
        <span class="breadcrumb-separator">›</span>
        <span class="breadcrumb-item active">Blackjack</span>
      </div>

      <div class="blackjack-game-area">
        <!-- Betting Section -->
        <div class="blackjack-bet-section">
          <div class="blackjack-bet-row">
            <div class="blackjack-input-group">
              <label class="blackjack-label">BET AMOUNT</label>
              <input type="number" class="blackjack-input" id="blackjackBetAmount" placeholder="10" min="10" max="10000" value="100">
            </div>
            <button class="action-btn btn-invest" id="blackjackDealBtn" style="flex:1;">DEAL</button>
          </div>
        </div>

        <!-- Stats Display -->
        <div class="blackjack-stats-display">
          <div class="blackjack-stat">
            <div class="blackjack-stat-label">YOUR GC</div>
            <div class="blackjack-stat-value" id="blackjackGCDisplay">0</div>
          </div>
          <div class="blackjack-stat">
            <div class="blackjack-stat-label">YOUR HAND</div>
            <div class="blackjack-stat-value" id="blackjackPlayerValue">0</div>
          </div>
          <div class="blackjack-stat">
            <div class="blackjack-stat-label">DEALER HAND</div>
            <div class="blackjack-stat-value" id="blackjackDealerValue">0</div>
          </div>
          <div class="blackjack-stat">
            <div class="blackjack-stat-label">BET</div>
            <div class="blackjack-stat-value" id="blackjackCurrentBet">0 GC</div>
          </div>
        </div>

        <!-- Game Table -->
        <div class="blackjack-table">
          <!-- Dealer's Hand -->
          <div class="blackjack-hand-section">
            <div class="blackjack-hand-title">DEALER</div>
            <div class="blackjack-cards" id="blackjackDealerCards">
              <!-- Cards will be added here -->
            </div>
          </div>

          <!-- Player's Hand -->
          <div class="blackjack-hand-section player">
            <div class="blackjack-hand-title">YOU</div>
            <div class="blackjack-cards" id="blackjackPlayerCards">
              <!-- Cards will be added here -->
            </div>
          </div>
        </div>

        <!-- Action Buttons -->
        <div class="blackjack-actions" id="blackjackActions" style="display:none;">
          <button class="action-btn btn-invest" id="blackjackHitBtn">HIT</button>
          <button class="action-btn btn-gamble" id="blackjackStandBtn">STAND</button>
        </div>

        <!-- Game Info -->
        <div class="blackjack-info" id="blackjackGameInfo">
          Place your bet and click DEAL to start. Get closer to 21 than the dealer without going over!
        </div>
      </div>

      <!-- Disclaimer for Blackjack Game -->
      <div class="game-disclaimer">
        ⚠️ <strong>Campaign Only:</strong> Fake tokens for Millionaire campaign • Not exchangeable • Play responsibly
      </div>
    </div>
  </main>

  <!-- Custom Modal System -->
  <div class="modal-overlay" id="modalOverlay">
    <div class="modal-container">
      <div class="modal-header">
        <button class="modal-close" id="modalClose" aria-label="Close modal">&times;</button>
        <img src="duelpvp-logo.svg" alt="Duel PVP" class="modal-logo">
        <div class="modal-title" id="modalTitle">Confirmation</div>
      </div>
      <div class="modal-body" id="modalBody">
        Are you sure?
      </div>
      <div class="modal-actions" id="modalActions">
        <button class="modal-btn modal-btn-secondary" id="modalCancelBtn">CANCEL</button>
        <button class="modal-btn modal-btn-primary" id="modalConfirmBtn">CONFIRM</button>
      </div>
    </div>
  </div>

  <!-- Toast Notification Container -->
  <div class="toast-container" id="toastContainer"></div>

  <!-- Loading Overlay -->
  <div class="loading-overlay" id="loadingOverlay" style="display:none;">
    <div class="loading-spinner">
      <div class="spinner-ring"></div>
      <div class="spinner-ring"></div>
      <div class="spinner-ring"></div>
    </div>
    <div class="loading-text" id="loadingText">Loading...</div>
  </div>

  <div class="footer">
    <span>© 2025 Duel PVP</span>
    <a href="https://x.com/Duelpvp" target="_blank" rel="noopener noreferrer" aria-label="Follow us on X">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
        <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/>
      </svg>
    </a>
  </div>

  <script>
    // ===== SUPABASE CLIENT =====
    const SUPABASE_URL = 'https://smgqccnggmyreacjyyil.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNtZ3FjY25nZ215cmVhY2p5eWlsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI5ODIwNDgsImV4cCI6MjA3ODU1ODA0OH0.y1AeyXkKCdVvE3JUIlCyDl6p12TFrgMkEiUocUB4YMI';

    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
      auth: {
        autoRefreshToken: true,
        persistSession: true,
        detectSessionInUrl: false
      }
    });

    // ===== WALLET CONNECTION =====
    let web3Provider = null;
    let selectedWalletType = null;

    // Detect available wallets
    function getAvailableWallets() {
      const wallets = [];

      if (window.ethereum) {
        if (window.ethereum.isMetaMask) {
          wallets.push({ id: 'metamask', name: 'MetaMask', icon: '🦊' });
        } else if (window.ethereum.isCoinbaseWallet) {
          wallets.push({ id: 'coinbase', name: 'Coinbase Wallet', icon: '🔵' });
        } else if (window.ethereum.isTrust) {
          wallets.push({ id: 'trust', name: 'Trust Wallet', icon: '🛡️' });
        } else {
          wallets.push({ id: 'injected', name: 'Browser Wallet', icon: '🔗' });
        }
      }

      return wallets;
    }

    // Show wallet selection modal - Redesigned with glassmorphism
    function showWalletSelector() {
      return new Promise((resolve, reject) => {
        // Always show all wallet options
        const walletOptions = [
          { id: 'metamask', name: 'MetaMask', icon: '🦊', check: () => window.ethereum?.isMetaMask },
          { id: 'rabby', name: 'Rabby', icon: '🐰', check: () => window.ethereum?.isRabby },
          { id: 'coinbase', name: 'Coinbase Wallet', icon: '🔵', check: () => window.ethereum?.isCoinbaseWallet },
          { id: 'trust', name: 'Trust Wallet', icon: '🛡️', check: () => window.ethereum?.isTrust },
          { id: 'walletconnect', name: 'WalletConnect', icon: '🔗', check: () => false, comingSoon: true }
        ];

        // Create custom wallet selector overlay
        const overlay = document.createElement('div');
        overlay.id = 'wallet-selector-overlay';
        overlay.innerHTML = `
          <div class="wallet-selector-modal">
            <button class="wallet-selector-close" id="wallet-close-btn">&times;</button>

            <div class="wallet-selector-header">
              <img src="duelpvp-logo.svg" alt="Duel PVP" class="wallet-selector-logo">
              <h2 class="wallet-selector-title">Connect Wallet</h2>
              <p class="wallet-selector-subtitle">Choose your preferred wallet to continue</p>
            </div>

            <div class="wallet-selector-options">
              ${walletOptions.map(w => {
                const isAvailable = w.check();
                const isComingSoon = w.comingSoon;
                return `
                  <button class="wallet-option ${!isAvailable && !isComingSoon ? 'unavailable' : ''} ${isComingSoon ? 'coming-soon' : ''}"
                          data-wallet="${w.id}"
                          ${!isAvailable ? 'data-unavailable="true"' : ''}
                          ${isComingSoon ? 'data-coming-soon="true"' : ''}>
                    <span class="wallet-option-icon">${w.icon}</span>
                    <span class="wallet-option-name">${w.name}</span>
                    ${isComingSoon ? '<span class="wallet-option-badge">SOON</span>' : ''}
                    ${!isAvailable && !isComingSoon ? '<span class="wallet-option-status">Not installed</span>' : ''}
                    ${isAvailable ? '<span class="wallet-option-arrow">→</span>' : ''}
                  </button>
                `;
              }).join('')}
            </div>

            <div class="wallet-selector-footer">
              <p>By connecting, you agree to our <a href="#" onclick="return false;">Terms of Service</a></p>
            </div>
          </div>
        `;

        // Add styles
        const styles = document.createElement('style');
        styles.id = 'wallet-selector-styles';
        styles.textContent = `
          #wallet-selector-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(12px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            animation: walletFadeIn 0.3s ease-out;
          }

          @keyframes walletFadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
          }

          @keyframes walletSlideIn {
            from {
              opacity: 0;
              transform: translateY(-20px) scale(0.95);
            }
            to {
              opacity: 1;
              transform: translateY(0) scale(1);
            }
          }

          .wallet-selector-modal {
            position: relative;
            width: min(420px, 90vw);
            background: rgba(12, 16, 20, 0.95);
            border: 2px solid rgba(255, 214, 77, 0.4);
            border-radius: 16px;
            padding: 32px;
            backdrop-filter: blur(20px);
            box-shadow:
              0 24px 80px rgba(0, 0, 0, 0.8),
              0 0 60px rgba(255, 214, 77, 0.15),
              inset 0 1px 0 rgba(255, 255, 255, 0.05);
            animation: walletSlideIn 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
          }

          .wallet-selector-close {
            position: absolute;
            top: 16px;
            right: 16px;
            width: 32px;
            height: 32px;
            border: none;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            color: #888;
            font-size: 20px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
          }

          .wallet-selector-close:hover {
            background: rgba(255, 255, 255, 0.2);
            color: #fff;
          }

          .wallet-selector-header {
            text-align: center;
            margin-bottom: 28px;
          }

          .wallet-selector-logo {
            width: 72px;
            height: 72px;
            margin-bottom: 16px;
            filter: drop-shadow(0 4px 12px rgba(255, 214, 77, 0.3));
          }

          .wallet-selector-title {
            font-family: 'Press Start 2P', monospace;
            font-size: 14px;
            color: var(--gold);
            margin: 0 0 8px 0;
            text-shadow: 0 2px 8px rgba(255, 214, 77, 0.3);
          }

          .wallet-selector-subtitle {
            font-family: Inter, system-ui, Arial;
            font-size: 13px;
            color: #888;
            margin: 0;
          }

          .wallet-selector-options {
            display: flex;
            flex-direction: column;
            gap: 12px;
          }

          .wallet-option {
            display: flex;
            align-items: center;
            gap: 16px;
            width: 100%;
            padding: 16px 20px;
            background: rgba(255, 255, 255, 0.03);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            color: #e6ecf1;
            font-family: Inter, system-ui, Arial;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
          }

          .wallet-option:hover:not(.unavailable):not(.coming-soon) {
            background: rgba(255, 214, 77, 0.1);
            border-color: var(--gold);
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(255, 214, 77, 0.2);
          }

          .wallet-option.unavailable,
          .wallet-option.coming-soon {
            opacity: 0.5;
            cursor: pointer;
          }

          .wallet-option.unavailable:hover,
          .wallet-option.coming-soon:hover {
            background: rgba(255, 255, 255, 0.05);
            border-color: rgba(255, 255, 255, 0.2);
          }

          .wallet-option-icon {
            font-size: 28px;
            width: 40px;
            text-align: center;
          }

          .wallet-option-name {
            flex: 1;
            text-align: left;
          }

          .wallet-option-badge {
            font-size: 9px;
            font-weight: 700;
            color: #ffc107;
            background: rgba(255, 193, 7, 0.2);
            padding: 4px 8px;
            border-radius: 6px;
            letter-spacing: 0.5px;
          }

          .wallet-option-status {
            font-size: 11px;
            color: #666;
          }

          .wallet-option-arrow {
            font-size: 18px;
            color: var(--gold);
            opacity: 0;
            transform: translateX(-8px);
            transition: all 0.2s ease;
          }

          .wallet-option:hover .wallet-option-arrow {
            opacity: 1;
            transform: translateX(0);
          }

          .wallet-selector-footer {
            margin-top: 24px;
            padding-top: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            text-align: center;
          }

          .wallet-selector-footer p {
            font-family: Inter, system-ui, Arial;
            font-size: 11px;
            color: #666;
            margin: 0;
          }

          .wallet-selector-footer a {
            color: var(--gold);
            text-decoration: none;
          }

          .wallet-selector-footer a:hover {
            text-decoration: underline;
          }
        `;

        document.head.appendChild(styles);
        document.body.appendChild(overlay);

        // Close function
        const closeSelector = () => {
          overlay.remove();
          styles.remove();
          reject(new Error('User cancelled'));
        };

        // Close button handler
        document.getElementById('wallet-close-btn').addEventListener('click', closeSelector);

        // Click outside to close
        overlay.addEventListener('click', (e) => {
          if (e.target === overlay) closeSelector();
        });

        // Escape key to close
        const escHandler = (e) => {
          if (e.key === 'Escape') {
            closeSelector();
            document.removeEventListener('keydown', escHandler);
          }
        };
        document.addEventListener('keydown', escHandler);

        // Wallet option click handlers
        document.querySelectorAll('.wallet-option').forEach(btn => {
          btn.addEventListener('click', () => {
            const walletId = btn.getAttribute('data-wallet');
            const isUnavailable = btn.getAttribute('data-unavailable');
            const isComingSoon = btn.getAttribute('data-coming-soon');

            if (isComingSoon) {
              Toast.info('WalletConnect coming soon!', 'COMING SOON');
              return;
            }

            if (isUnavailable) {
              let installUrl = 'https://metamask.io/download/';
              if (walletId === 'coinbase') installUrl = 'https://www.coinbase.com/wallet';
              if (walletId === 'trust') installUrl = 'https://trustwallet.com/download';

              window.open(installUrl, '_blank');
              return;
            }

            overlay.remove();
            styles.remove();
            document.removeEventListener('keydown', escHandler);
            resolve(walletId);
          });
        });
      });
    }

    // Track if we're in the middle of connecting (to prevent reload)
    let isConnecting = false;
    let walletListenersAdded = false;

    // Connect wallet
    async function connectWallet() {
      const walletId = await showWalletSelector();
      selectedWalletType = walletId;

      if (!window.ethereum) {
        throw new Error('No wallet detected');
      }

      isConnecting = true;
      web3Provider = new ethers.providers.Web3Provider(window.ethereum);

      // Only add event listeners once, and respect isConnecting flag
      if (!walletListenersAdded) {
        walletListenersAdded = true;

        // Handle account/chain changes - but not during initial connection
        window.ethereum.on("accountsChanged", (accounts) => {
          if (isConnecting) return; // Don't reload during connection flow
          if (accounts.length === 0) {
            disconnectWallet();
          } else {
            window.location.reload();
          }
        });

        window.ethereum.on("chainChanged", () => {
          if (isConnecting) return; // Don't reload during connection flow
          window.location.reload();
        });
      }

      return web3Provider;
    }

    // Mark connection as complete (call after successful login/registration)
    function finishWalletConnection() {
      isConnecting = false;
    }

    // Disconnect wallet
    function disconnectWallet() {
      web3Provider = null;
      selectedWalletType = null;
    }

    // Get connected wallet address
    async function getWalletAddress() {
      if (!web3Provider) {
        await connectWallet();
      }

      // Request accounts
      await window.ethereum.request({ method: 'eth_requestAccounts' });

      const signer = web3Provider.getSigner();
      return await signer.getAddress();
    }

    // Sign message with wallet
    async function signMessage(message) {
      if (!web3Provider) {
        await connectWallet();
      }
      const signer = web3Provider.getSigner();
      return await signer.signMessage(message);
    }

    // ===== MODAL SYSTEM =====
    const Modal = {
      overlay: null,
      title: null,
      body: null,
      actions: null,
      confirmBtn: null,
      cancelBtn: null,
      closeBtn: null,
      resolveCallback: null,

      init() {
        this.overlay = document.getElementById('modalOverlay');
        this.title = document.getElementById('modalTitle');
        this.body = document.getElementById('modalBody');
        this.actions = document.getElementById('modalActions');
        this.confirmBtn = document.getElementById('modalConfirmBtn');
        this.cancelBtn = document.getElementById('modalCancelBtn');
        this.closeBtn = document.getElementById('modalClose');

        // Close modal handlers
        this.closeBtn.addEventListener('click', () => this.close(false));
        this.cancelBtn.addEventListener('click', () => this.close(false));
        this.confirmBtn.addEventListener('click', () => this.close(true));

        // Close on overlay click
        this.overlay.addEventListener('click', (e) => {
          if (e.target === this.overlay) this.close(false);
        });

        // Close on ESC key
        document.addEventListener('keydown', (e) => {
          if (e.key === 'Escape' && this.overlay.classList.contains('show')) {
            this.close(false);
          }
        });
      },

      show(options) {
        return new Promise((resolve) => {
          this.resolveCallback = resolve;

          this.title.textContent = options.title || 'Confirmation';

          // Support HTML content
          if (options.html) {
            this.body.innerHTML = options.html;
          } else {
            this.body.textContent = options.message || '';
          }

          // Show/hide action buttons based on type
          if (options.type === 'alert') {
            this.cancelBtn.style.display = 'none';
            this.confirmBtn.textContent = 'OK';
            this.actions.style.display = 'flex';
          } else if (options.type === 'custom') {
            // Hide all action buttons for custom modals
            this.actions.style.display = 'none';
          } else {
            this.cancelBtn.style.display = 'block';
            this.confirmBtn.textContent = options.confirmText || 'CONFIRM';
            this.cancelBtn.textContent = options.cancelText || 'CANCEL';
            this.actions.style.display = 'flex';
          }

          this.overlay.classList.add('show');
        });
      },

      close(confirmed = false) {
        this.overlay.classList.remove('show');
        // Reset actions display
        this.actions.style.display = 'flex';
        if (this.resolveCallback) {
          this.resolveCallback(confirmed);
          this.resolveCallback = null;
        }
      },

      alert(message, title = 'Alert') {
        return this.show({ type: 'alert', message, title });
      },

      confirm(message, title = 'Confirmation') {
        return this.show({ type: 'confirm', message, title });
      }
    };

    // ===== TOAST NOTIFICATION SYSTEM =====
    const Toast = {
      container: null,

      init() {
        this.container = document.getElementById('toastContainer');
      },

      show(options) {
        const toast = document.createElement('div');
        toast.className = `toast toast-${options.type || 'info'}`;

        const icon = this.getIcon(options.type);
        const title = options.title || this.getDefaultTitle(options.type);

        toast.innerHTML = `
          <div class="toast-icon">${icon}</div>
          <div class="toast-content">
            <div class="toast-title">${title}</div>
            ${options.message ? `<div class="toast-message">${options.message}</div>` : ''}
          </div>
        `;

        this.container.appendChild(toast);

        // Auto dismiss after duration
        const duration = options.duration || 3000;
        setTimeout(() => {
          this.remove(toast);
        }, duration);

        return toast;
      },

      remove(toast) {
        toast.classList.add('removing');
        setTimeout(() => {
          if (toast.parentNode) {
            toast.parentNode.removeChild(toast);
          }
        }, 300);
      },

      success(message, title) {
        return this.show({ type: 'success', message, title });
      },

      error(message, title) {
        return this.show({ type: 'error', message, title });
      },

      warning(message, title) {
        return this.show({ type: 'warning', message, title });
      },

      info(message, title) {
        return this.show({ type: 'info', message, title });
      },

      getIcon(type) {
        const icons = {
          success: '✓',
          error: '✕',
          warning: '⚠',
          info: 'ℹ'
        };
        return icons[type] || icons.info;
      },

      getDefaultTitle(type) {
        const titles = {
          success: 'SUCCESS',
          error: 'ERROR',
          warning: 'WARNING',
          info: 'INFO'
        };
        return titles[type] || 'INFO';
      }
    };

    // ===== LOADING OVERLAY =====
    const Loading = {
      overlay: null,
      text: null,

      init() {
        this.overlay = document.getElementById('loadingOverlay');
        this.text = document.getElementById('loadingText');
      },

      show(message = 'Loading...') {
        this.text.textContent = message;
        this.overlay.style.display = 'flex';
      },

      hide() {
        this.overlay.style.display = 'none';
      }
    };

    // Initialize systems on DOM ready
    document.addEventListener('DOMContentLoaded', async () => {
      Modal.init();
      Toast.init();
      Loading.init();

      // Initialize app - check for existing session (Blur-style auto-reconnect)
      await initializeApp();
    });

    // Particle System
    class ParticleSystem {
      constructor(canvas) {
        this.canvas = canvas;
        this.ctx = canvas.getContext('2d');
        this.particles = [];
        this.resize();
        window.addEventListener('resize', () => this.resize());
        this.animate();
      }

      resize() {
        this.canvas.width = window.innerWidth;
        this.canvas.height = window.innerHeight;
      }

      createLavaEmber() {
        // Embers rise from lava areas (bottom 40% of screen, concentrated in center-right where lava is)
        return {
          x: Math.random() * this.canvas.width * 0.7 + this.canvas.width * 0.15, // Center 70% of screen
          y: this.canvas.height - Math.random() * 50, // Start near bottom
          vx: (Math.random() - 0.5) * 0.3, // Slight horizontal drift
          vy: -(Math.random() * 0.8 + 0.3), // Rise upward (slower)
          size: Math.random() * 3 + 1, // 1-4px
          life: 1,
          decay: Math.random() * 0.003 + 0.001, // Fade out slowly
          color: Math.random() > 0.5 ? 'rgba(255,140,60,' : 'rgba(255,100,40,', // Orange/red
          twinkle: Math.random() * Math.PI * 2,
          twinkleSpeed: Math.random() * 0.05 + 0.02,
          type: 'ember'
        };
      }

      createTwinklingStar() {
        // Stars appear in top 30% of screen with size variations
        const sizeRoll = Math.random();
        let size, glowIntensity;

        if (sizeRoll > 0.95) {
          // 5% chance - Large bright star
          size = Math.random() * 1.5 + 2.5; // 2.5-4px
          glowIntensity = 1.2;
        } else if (sizeRoll > 0.7) {
          // 25% chance - Medium star
          size = Math.random() * 1 + 1.5; // 1.5-2.5px
          glowIntensity = 0.9;
        } else {
          // 70% chance - Small star
          size = Math.random() * 0.8 + 0.5; // 0.5-1.3px
          glowIntensity = 0.6;
        }

        return {
          x: Math.random() * this.canvas.width,
          y: Math.random() * this.canvas.height * 0.3, // Top 30%
          vx: 0,
          vy: 0,
          size: size,
          life: 1,
          decay: 0, // Stars don't fade out
          color: 'rgba(255,255,255,',
          twinkle: Math.random() * Math.PI * 2,
          twinkleSpeed: Math.random() * 0.03 + 0.01,
          glowIntensity: glowIntensity,
          type: 'star'
        };
      }

      createShootingStar() {
        // Shooting stars streak across the top half
        const startSide = Math.random() > 0.5 ? 'left' : 'right';
        return {
          x: startSide === 'left' ? 0 : this.canvas.width,
          y: Math.random() * this.canvas.height * 0.4, // Top 40%
          vx: (startSide === 'left' ? 1 : -1) * (Math.random() * 3 + 4), // Fast horizontal
          vy: Math.random() * 0.5 + 0.5, // Slight downward angle
          size: Math.random() * 1 + 1.5, // 1.5-2.5px
          life: 1,
          decay: 0.015, // Fade quickly
          color: 'rgba(255,255,220,',
          tailLength: Math.random() * 40 + 60, // 60-100px tail
          type: 'shooting'
        };
      }

      animate() {
        requestAnimationFrame(() => this.animate());

        // Clear canvas
        this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);

        // Add new particles
        if (Math.random() < 0.15) { // 15% chance each frame for embers
          this.particles.push(this.createLavaEmber());
        }

        // Occasionally add shooting stars (rare)
        if (Math.random() < 0.002) { // 0.2% chance per frame (~1 every 8 seconds)
          this.particles.push(this.createShootingStar());
        }

        // Update and draw particles
        this.particles = this.particles.filter(p => {
          // Update position
          p.x += p.vx;
          p.y += p.vy;

          // Update life
          p.life -= p.decay;

          // Update twinkle (if applicable)
          if (p.twinkle !== undefined) {
            p.twinkle += p.twinkleSpeed;
          }

          // Calculate opacity and draw based on type
          let opacity;

          if (p.type === 'star') {
            opacity = (Math.sin(p.twinkle) * 0.3 + 0.7) * 0.6 * p.glowIntensity;
            this.ctx.shadowBlur = p.size * 8 * p.glowIntensity;
            this.ctx.shadowColor = `rgba(255,255,255,${0.8 * p.glowIntensity})`;
            this.ctx.fillStyle = p.color + opacity + ')';
            this.ctx.beginPath();
            this.ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
            this.ctx.fill();

          } else if (p.type === 'shooting') {
            opacity = p.life;
            // Draw shooting star trail
            const gradient = this.ctx.createLinearGradient(
              p.x, p.y,
              p.x - p.vx * p.tailLength / 5, p.y - p.vy * p.tailLength / 5
            );
            gradient.addColorStop(0, `rgba(255,255,220,${opacity * 0.8})`);
            gradient.addColorStop(0.5, `rgba(255,255,255,${opacity * 0.4})`);
            gradient.addColorStop(1, 'rgba(255,255,255,0)');

            this.ctx.shadowBlur = 15;
            this.ctx.shadowColor = `rgba(255,255,220,${opacity})`;
            this.ctx.strokeStyle = gradient;
            this.ctx.lineWidth = p.size * 2;
            this.ctx.lineCap = 'round';
            this.ctx.beginPath();
            this.ctx.moveTo(p.x, p.y);
            this.ctx.lineTo(p.x - p.vx * 10, p.y - p.vy * 10);
            this.ctx.stroke();

            // Draw bright head
            this.ctx.fillStyle = `rgba(255,255,255,${opacity})`;
            this.ctx.beginPath();
            this.ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
            this.ctx.fill();

          } else { // ember
            opacity = p.life * (Math.sin(p.twinkle) * 0.2 + 0.8);
            this.ctx.shadowBlur = p.size * 8;
            this.ctx.shadowColor = 'rgba(255,140,60,0.6)';
            this.ctx.fillStyle = p.color + opacity + ')';
            this.ctx.beginPath();
            this.ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
            this.ctx.fill();
          }

          // Keep particle if alive and on screen
          if (p.type === 'star') {
            return true; // Stars stay forever
          } else if (p.type === 'shooting') {
            return p.life > 0 && p.x > -100 && p.x < this.canvas.width + 100; // Shooting stars fade or leave screen
          } else {
            return p.life > 0 && p.y > -50; // Embers fade or go off screen
          }
        });

        // Maintain star count
        const starCount = this.particles.filter(p => p.type === 'star').length;
        if (starCount < 40) { // Keep ~40 stars with variations
          this.particles.push(this.createTwinklingStar());
        }
      }
    }

    // Initialize particle system
    const particlesCanvas = document.getElementById('particlesCanvas');
    const particleSystem = new ParticleSystem(particlesCanvas);

    // Single page app logic
    const pageContainer = document.getElementById('pageContainer');
    const panelContent = document.getElementById('panelContent');
    const dashboardContent = document.getElementById('dashboardContent');
    const gameContent = document.getElementById('gameContent');
    const ovenContent = document.getElementById('ovenContent');
    const farmContent = document.getElementById('farmContent');
    const minesContent = document.getElementById('minesContent');
    const blackjackContent = document.getElementById('blackjackContent');
    const leaderboardContent = document.getElementById('leaderboardContent');
    const questContent = document.getElementById('questContent');
    const inventoryContent = document.getElementById('inventoryContent');
    const shopContent = document.getElementById('shopContent');
    const crashContent = document.getElementById('crashContent');
    const campaignContent = document.getElementById('campaignContent');
    const campaignBanner = document.getElementById('campaignBanner');

    // Debug: Check if all elements exist
    console.log('Elements loaded:', {
      pageContainer: !!pageContainer,
      panelContent: !!panelContent,
      dashboardContent: !!dashboardContent,
      gameContent: !!gameContent,
      leaderboardContent: !!leaderboardContent,
      questContent: !!questContent,
      inventoryContent: !!inventoryContent,
      viewLeaderboardBtn: !!document.getElementById('viewLeaderboardBtn')
    });
    
    // Game variables
    let gameState = {
      attempts: [],
      bestTime: null,
      isPlaying: false,
      startTime: null,
      reactionTimer: null,
      chartAnimation: null
    };

    // Temporary registration data
    let tempRegistrationData = {
      walletAddress: '',
      inviteCode: '',
      signature: '',
      termsAccepted: false
    };

    // Helper function to swap content with fade animation
    function swapContent(newContent, data) {
      // Scroll to top immediately when switching content
      pageContainer.scrollTop = 0;
      window.scrollTo(0, 0);

      // Find currently visible element
      const allContainers = [panelContent, dashboardContent, gameContent, ovenContent, farmContent, minesContent, blackjackContent, leaderboardContent, questContent, inventoryContent, shopContent, crashContent, campaignContent];
      const currentVisible = allContainers.find(el => el.style.display !== 'none' && el.style.display !== '');

      // Add fade-out to current visible element
      if (currentVisible) {
        currentVisible.classList.add('fade-out');
        currentVisible.classList.remove('fade-in', 'fade-in-delayed');
      }

      // Wait for fade-out animation, then swap content
      setTimeout(() => {
        if (newContent === 'login') {
          panelContent.style.display = 'block';
          dashboardContent.style.display = 'none';
          gameContent.style.display = 'none';
          leaderboardContent.style.display = 'none';
          questContent.style.display = 'none';
          inventoryContent.style.display = 'none';
          panelContent.classList.remove('panel-transparent');
          pageContainer.classList.remove('bottom-aligned');

          panelContent.innerHTML = `
          <div class="panel-header">
            <div class="sys">Welcome back, champion<span class="blink">.</span></div>
            <div class="sub-text">Connect your wallet to access the arena</div>
          </div>

          <div style="text-align:center;padding:40px 20px;">
            <div style="margin-bottom:20px;">
              <svg width="64" height="64" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                <polygon points="50,5 90,27.5 90,72.5 50,95 10,72.5 10,27.5"
                         fill="none"
                         stroke="url(#walletLoginGradient)"
                         stroke-width="4"/>
                <circle cx="40" cy="50" r="10" fill="#22c55e"/>
                <circle cx="60" cy="50" r="10" fill="#ef4444"/>
                <defs>
                  <linearGradient id="walletLoginGradient" x1="0%" y1="0%" x2="0%" y2="100%">
                    <stop offset="0%" style="stop-color:#FFD64D;stop-opacity:1" />
                    <stop offset="50%" style="stop-color:#D4AF37;stop-opacity:1" />
                    <stop offset="100%" style="stop-color:#D4A033;stop-opacity:1" />
                  </linearGradient>
                </defs>
              </svg>
            </div>
            <div style="font-family:'Press Start 2P',monospace;font-size:12px;color:var(--gold);margin-bottom:12px;">
              WALLET AUTHENTICATION
            </div>
            <div style="font-family:Inter,system-ui,Arial;font-size:14px;color:#a0a8b0;margin-bottom:30px;line-height:1.6;">
              Sign in with your connected wallet.<br>
              Only wallets with existing accounts can login.
            </div>
            <button class="btn-submit" id="walletLoginBtn" style="width:100%;max-width:300px;">
              SIGN IN WITH WALLET
            </button>
          </div>

          <div class="helper">
            Don't have an account? <a id="backLink">Enter access code</a>
          </div>
        `;

        // Re-attach event listeners
        document.getElementById('walletLoginBtn').addEventListener('click', handleWalletLogin);
        const backLink = document.getElementById('backLink');
        backLink.addEventListener('click', () => swapContent('home'));
        backLink.addEventListener('keypress', (e) => {
          if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            swapContent('home');
          }
        });

      } else if (newContent === 'termsAcceptance') {
        panelContent.style.display = 'block';
        dashboardContent.style.display = 'none';
        gameContent.style.display = 'none';
        leaderboardContent.style.display = 'none';
        questContent.style.display = 'none';
        inventoryContent.style.display = 'none';
        pageContainer.classList.add('center-aligned');
        pageContainer.classList.remove('bottom-aligned');
        panelContent.classList.remove('panel-transparent');

        panelContent.innerHTML = `
          <div class="panel-header">
            <div class="warrior-title">TERMS & DISCLAIMER</div>
            <div class="sub-text">Please read and accept to continue</div>
          </div>

          <div style="max-width:500px;margin:0 auto;padding:20px;">
            <div style="background:#1a1a1a;border:1px solid #333;border-radius:8px;padding:20px;margin-bottom:20px;max-height:300px;overflow-y:auto;text-align:left;font-size:13px;line-height:1.6;color:#a0a8b0;">
              <p style="color:var(--gold);font-weight:bold;margin-bottom:10px;">⚠️ IMPORTANT - READ CAREFULLY</p>
              <p style="margin-bottom:10px;">By connecting your wallet and using this service, you acknowledge and agree that:</p>
              <ul style="margin-left:20px;margin-bottom:15px;">
                <li style="margin-bottom:8px;">This is <strong>experimental alpha software</strong> provided "AS IS" without warranties of any kind</li>
                <li style="margin-bottom:8px;">Virtual items (NFTs, GC, tokens) have <strong>NO monetary value</strong> and are <strong>NOT investment vehicles</strong></li>
                <li style="margin-bottom:8px;">This project <strong>may never fully launch</strong>, be completed, or continue development</li>
                <li style="margin-bottom:8px;">The service may be modified, suspended, or <strong>discontinued at any time</strong> without notice</li>
                <li style="margin-bottom:8px;">You are using this platform for <strong>entertainment purposes only</strong> at your own risk</li>
                <li style="margin-bottom:8px;"><strong>No promises or guarantees</strong> are made about future features, updates, or token launches</li>
                <li style="margin-bottom:8px;">All blockchain transactions are <strong>irreversible</strong> and you are solely responsible for your wallet security</li>
                <li style="margin-bottom:8px;">You must be <strong>18 years or older</strong> to use this service</li>
              </ul>
              <p style="font-size:11px;color:#666;">For full terms, see our <a href="#" style="color:var(--gold);">Terms of Service</a> and <a href="#" style="color:var(--gold);">Privacy Policy</a></p>
            </div>

            <div class="input-group" style="margin-bottom:20px;">
              <label style="display:flex;align-items:start;cursor:pointer;font-size:14px;color:#e5e7eb;">
                <input type="checkbox" id="termsCheckbox" style="margin-right:12px;margin-top:4px;width:18px;height:18px;cursor:pointer;">
                <span>I have read and agree to the Terms of Service. I understand this is experimental software, virtual items have no value, and the project may never launch.</span>
              </label>
              <div class="error-msg" id="termsError"></div>
            </div>

            <div style="display:flex;gap:10px;">
              <button class="btn-cancel" id="backToWalletBtn" style="flex:1;">← BACK</button>
              <button class="btn-submit" id="acceptTermsBtn" style="flex:2;">ACCEPT & CONTINUE</button>
            </div>
          </div>
        `;

        // Re-attach event listeners
        document.getElementById('acceptTermsBtn').addEventListener('click', handleTermsAcceptance);
        document.getElementById('backToWalletBtn').addEventListener('click', () => swapContent('home'));
        document.getElementById('termsCheckbox').addEventListener('change', () => clearError('termsError'));

      } else if (newContent === 'nameWarrior') {
        panelContent.style.display = 'block';
        dashboardContent.style.display = 'none';
        gameContent.style.display = 'none';
        leaderboardContent.style.display = 'none';
        questContent.style.display = 'none';
        inventoryContent.style.display = 'none';
        pageContainer.classList.add('center-aligned');
        pageContainer.classList.remove('bottom-aligned');
        panelContent.classList.remove('panel-transparent');

        panelContent.innerHTML = `
          <div class="panel-header">
            <div class="warrior-title">NAME YOUR WARRIOR</div>
            <div class="sub-text">Choose a name that strikes fear into your enemies</div>
          </div>

          <div class="input-group">
            <input id="warriorName" class="warrior-input" type="text" placeholder="Your legend begins here..." maxlength="16" autocomplete="off">
            <div class="error-msg" id="warriorNameError"></div>
          </div>

          <div class="input-group">
            <button class="btn-submit" id="confirmNameBtn" style="width:100%;">ENTER THE ARENA</button>
          </div>
        `;

        panelContent.classList.remove('fade-in', 'warrior-naming');
        void panelContent.offsetWidth;
        panelContent.classList.add('warrior-naming');

        // Re-attach event listeners
        document.getElementById('confirmNameBtn').addEventListener('click', handleNameWarrior);
        document.getElementById('warriorName').addEventListener('input', () => clearError('warriorNameError'));
        document.getElementById('warriorName').addEventListener('keypress', (e) => {
          if (e.key === 'Enter') handleNameWarrior();
        });
        // Auto-focus the input
        setTimeout(() => {
          document.getElementById('warriorName').focus();
        }, 500);

      } else if (newContent === 'walletConnect') {
        panelContent.style.display = 'block';
        dashboardContent.style.display = 'none';
        pageContainer.classList.add('bottom-aligned');
        pageContainer.classList.remove('center-aligned');

        panelContent.innerHTML = `
          <div class="panel-header">
            <div class="warrior-title">CONNECT WALLET</div>
            <div class="sub-text">Sign to verify ownership • No gas fees</div>
          </div>

          <div class="wallet-connect-container" style="text-align:center;padding:40px 20px;">
            <div style="margin-bottom:20px;">
              <svg width="64" height="64" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                <polygon points="50,5 90,27.5 90,72.5 50,95 10,72.5 10,27.5"
                         fill="none"
                         stroke="url(#walletConnectGradient)"
                         stroke-width="4"/>
                <circle cx="40" cy="50" r="10" fill="#22c55e"/>
                <circle cx="60" cy="50" r="10" fill="#ef4444"/>
                <defs>
                  <linearGradient id="walletConnectGradient" x1="0%" y1="0%" x2="0%" y2="100%">
                    <stop offset="0%" style="stop-color:#FFD64D;stop-opacity:1" />
                    <stop offset="50%" style="stop-color:#D4AF37;stop-opacity:1" />
                    <stop offset="100%" style="stop-color:#D4A033;stop-opacity:1" />
                  </linearGradient>
                </defs>
              </svg>
            </div>
            <div style="font-family:'Press Start 2P',monospace;font-size:12px;color:var(--gold);margin-bottom:12px;">
              SECURE AUTHENTICATION
            </div>
            <div style="font-family:Inter,system-ui,Arial;font-size:14px;color:#a0a8b0;margin-bottom:30px;line-height:1.6;">
              Connect your wallet to continue.<br>
              You'll be asked to sign a message to prove ownership.<br>
              <strong style="color:var(--gold);">No transaction, no gas fees.</strong>
            </div>
            <button class="btn-submit" id="connectWalletForRegBtn" style="width:100%;max-width:300px;">
              CONNECT WALLET
            </button>
            <div style="margin-top:20px;">
              <a id="backToCodeLink" style="color:#6b7280;font-size:12px;cursor:pointer;text-decoration:underline;">
                ← Back to code entry
              </a>
            </div>
          </div>
        `;

        // Store the code for later use
        tempRegistrationData.inviteCode = data;

        document.getElementById('connectWalletForRegBtn').addEventListener('click', handleWalletConnectForRegistration);
        document.getElementById('backToCodeLink').addEventListener('click', () => swapContent('home'));

      } else if (newContent === 'home') {
        panelContent.style.display = 'block';
        dashboardContent.style.display = 'none';
        gameContent.style.display = 'none';
        leaderboardContent.style.display = 'none';
        questContent.style.display = 'none';
        inventoryContent.style.display = 'none';
        pageContainer.classList.add('bottom-aligned');
        pageContainer.classList.remove('center-aligned');
        panelContent.classList.add('panel-transparent');

        panelContent.innerHTML = `
          <div class="panel-header">
            <div class="sys">Welcome to the arena<span class="blink">.</span></div>
            <div class="sub-text">Enter your exclusive access code to begin</div>
          </div>

          <div class="input-group">
            <label class="input-label">Access Code</label>
            <div class="bar">
              <input id="code" class="input-field" type="text" placeholder="XXXX-XXXX-XXXX" autocomplete="off">
              <button class="btn-submit" id="joinBtn">JOIN</button>
            </div>
            <div class="error-msg" id="codeError"></div>
          </div>

          <div class="helper">
            Already have an account? <a id="loginLink">Sign in</a>
          </div>
        `;

        // Re-attach event listeners
        document.getElementById('joinBtn').addEventListener('click', handleJoin);
        const loginLink = document.getElementById('loginLink');
        loginLink.addEventListener('click', () => swapContent('login'));
        loginLink.addEventListener('keypress', (e) => {
          if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            swapContent('login');
          }
        });
        // Allow enter key to submit
        document.getElementById('code').addEventListener('keypress', (e) => {
          if (e.key === 'Enter') handleJoin();
        });

      } else if (newContent === 'dashboard') {
        panelContent.style.display = 'none';
        dashboardContent.style.display = 'block';
        if (campaignBanner) campaignBanner.style.display = 'block';
        gameContent.style.display = 'none';
        leaderboardContent.style.display = 'none';
        questContent.style.display = 'none';
        inventoryContent.style.display = 'none';
        shopContent.style.display = 'none';
        pageContainer.classList.remove('center-aligned', 'bottom-aligned', 'top-aligned');
        // Force refresh GC cache and display when loading dashboard
        gcCache.lastFetch = 0;
        updateDashboardStats();
        // Load user's invite code
        loadUserInviteCode();
        // Also directly update GC display to ensure it shows
        (async () => {
          const gp = await getUserGC();
          const displayGP = gp >= 1000000 ? `${(gp/1000000).toFixed(1)}M` : gp >= 1000 ? `${(gp/1000).toFixed(1)}K` : gp;
          document.getElementById('dashboardGCBalance').textContent = displayGP;
          console.log('[Dashboard] GC display updated:', gp);
        })();

      } else if (newContent === 'game') {
        panelContent.style.display = 'none';
        dashboardContent.style.display = 'none';
        gameContent.style.display = 'block';
        leaderboardContent.style.display = 'none';
        questContent.style.display = 'none';
        inventoryContent.style.display = 'none';
        shopContent.style.display = 'none';
        crashContent.style.display = 'none';
        ovenContent.style.display = 'none';
        pageContainer.classList.remove('center-aligned', 'bottom-aligned', 'top-aligned');
        initChart();

      } else if (newContent === 'oven') {
        panelContent.style.display = 'none';
        dashboardContent.style.display = 'none';
        gameContent.style.display = 'none';
        leaderboardContent.style.display = 'none';
        questContent.style.display = 'none';
        inventoryContent.style.display = 'none';
        shopContent.style.display = 'none';
        crashContent.style.display = 'none';
        farmContent.style.display = 'none';
        ovenContent.style.display = 'block';
        pageContainer.classList.remove('center-aligned', 'bottom-aligned', 'top-aligned');
        initOven();

      } else if (newContent === 'farm') {
        panelContent.style.display = 'none';
        dashboardContent.style.display = 'none';
        gameContent.style.display = 'none';
        leaderboardContent.style.display = 'none';
        questContent.style.display = 'none';
        inventoryContent.style.display = 'none';
        shopContent.style.display = 'none';
        crashContent.style.display = 'none';
        ovenContent.style.display = 'none';
        minesContent.style.display = 'none';
        farmContent.style.display = 'block';
        pageContainer.classList.remove('center-aligned', 'bottom-aligned', 'top-aligned');
        initFarm();

      } else if (newContent === 'crash') {
        panelContent.style.display = 'none';
        dashboardContent.style.display = 'none';
        if (campaignBanner) campaignBanner.style.display = 'none';
        gameContent.style.display = 'none';
        leaderboardContent.style.display = 'none';
        questContent.style.display = 'none';
        inventoryContent.style.display = 'none';
        shopContent.style.display = 'none';
        crashContent.style.display = 'block';
        minesContent.style.display = 'none';
        ovenContent.style.display = 'none';
        farmContent.style.display = 'none';
        blackjackContent.style.display = 'none';
        pageContainer.classList.remove('center-aligned', 'bottom-aligned', 'top-aligned');
        initCrashGame();

      } else if (newContent === 'mines') {
        panelContent.style.display = 'none';
        dashboardContent.style.display = 'none';
        if (campaignBanner) campaignBanner.style.display = 'none';
        gameContent.style.display = 'none';
        leaderboardContent.style.display = 'none';
        questContent.style.display = 'none';
        inventoryContent.style.display = 'none';
        shopContent.style.display = 'none';
        crashContent.style.display = 'none';
        ovenContent.style.display = 'none';
        farmContent.style.display = 'none';
        minesContent.style.display = 'block';
        blackjackContent.style.display = 'none';
        pageContainer.classList.remove('center-aligned', 'bottom-aligned', 'top-aligned');
        // Only init grid if not currently playing
        if (!minesGameState.isPlaying) {
          initMinesGame();
        }
        updateMinesGCDisplay();

      } else if (newContent === 'blackjack') {
        panelContent.style.display = 'none';
        dashboardContent.style.display = 'none';
        if (campaignBanner) campaignBanner.style.display = 'none';
        gameContent.style.display = 'none';
        leaderboardContent.style.display = 'none';
        questContent.style.display = 'none';
        inventoryContent.style.display = 'none';
        shopContent.style.display = 'none';
        crashContent.style.display = 'none';
        ovenContent.style.display = 'none';
        farmContent.style.display = 'none';
        minesContent.style.display = 'none';
        blackjackContent.style.display = 'block';
        pageContainer.classList.remove('center-aligned', 'bottom-aligned', 'top-aligned');
        initBlackjack();

      } else if (newContent === 'campaign') {
        panelContent.style.display = 'none';
        dashboardContent.style.display = 'none';
        if (campaignBanner) campaignBanner.style.display = 'none';
        gameContent.style.display = 'none';
        leaderboardContent.style.display = 'none';
        questContent.style.display = 'none';
        inventoryContent.style.display = 'none';
        shopContent.style.display = 'none';
        ovenContent.style.display = 'none';
        farmContent.style.display = 'none';
        crashContent.style.display = 'none';
        minesContent.style.display = 'none';
        blackjackContent.style.display = 'none';
        campaignContent.style.display = 'block';
        pageContainer.classList.remove('center-aligned', 'bottom-aligned', 'top-aligned');
        updateCampaignPage();

      } else if (newContent === 'leaderboard') {
        console.log('Switching to leaderboard...');
        panelContent.style.display = 'none';
        dashboardContent.style.display = 'none';
        gameContent.style.display = 'none';
        leaderboardContent.style.display = 'block';
        questContent.style.display = 'none';
        inventoryContent.style.display = 'none';
        shopContent.style.display = 'none';
        ovenContent.style.display = 'none';
        farmContent.style.display = 'none';
        crashContent.style.display = 'none';
        minesContent.style.display = 'none';
        blackjackContent.style.display = 'none';
        campaignContent.style.display = 'none';
        pageContainer.classList.remove('center-aligned', 'bottom-aligned', 'top-aligned');
        
        console.log('Leaderboard display set to block');
        loadLeaderboard('all');
        console.log('loadLeaderboard called');

      } else if (newContent === 'quests') {
        panelContent.style.display = 'none';
        dashboardContent.style.display = 'none';
        gameContent.style.display = 'none';
        leaderboardContent.style.display = 'none';
        questContent.style.display = 'block';
        inventoryContent.style.display = 'none';
        shopContent.style.display = 'none';
        ovenContent.style.display = 'none';
        farmContent.style.display = 'none';
        crashContent.style.display = 'none';
        minesContent.style.display = 'none';
        blackjackContent.style.display = 'none';
        campaignContent.style.display = 'none';
        pageContainer.classList.remove('center-aligned', 'bottom-aligned', 'top-aligned');
        
        loadQuests('daily');

      } else if (newContent === 'inventory') {
        panelContent.style.display = 'none';
        dashboardContent.style.display = 'none';
        gameContent.style.display = 'none';
        leaderboardContent.style.display = 'none';
        questContent.style.display = 'none';
        inventoryContent.style.display = 'block';
        shopContent.style.display = 'none';
        ovenContent.style.display = 'none';
        farmContent.style.display = 'none';
        crashContent.style.display = 'none';
        minesContent.style.display = 'none';
        blackjackContent.style.display = 'none';
        campaignContent.style.display = 'none';
        pageContainer.classList.remove('center-aligned', 'bottom-aligned', 'top-aligned');
        
        loadInventory();

      } else if (newContent === 'shop') {
        panelContent.style.display = 'none';
        dashboardContent.style.display = 'none';
        gameContent.style.display = 'none';
        leaderboardContent.style.display = 'none';
        questContent.style.display = 'none';
        inventoryContent.style.display = 'none';
        shopContent.style.display = 'block';
        ovenContent.style.display = 'none';
        farmContent.style.display = 'none';
        crashContent.style.display = 'none';
        campaignContent.style.display = 'none';
        minesContent.style.display = 'none';
        blackjackContent.style.display = 'none';
        pageContainer.classList.remove('center-aligned', 'bottom-aligned', 'top-aligned');
        
        loadInventory(); // Load shop items
      }

        // Add fade-in animation to newly visible element
        const newVisible = allContainers.find(el => el.style.display === 'block');
        if (newVisible) {
          newVisible.classList.remove('fade-out', 'fade-in-delayed');
          void newVisible.offsetWidth; // Force reflow
          newVisible.classList.add('fade-in');
        }

        // Scroll to top AFTER content is fully laid out
        requestAnimationFrame(() => {
          requestAnimationFrame(() => {
            pageContainer.scrollTop = 0;
            window.scrollTo({ top: 0, behavior: 'instant' });
          });
        });
      }, currentVisible ? 200 : 0); // 200ms matches fade-out animation duration
    }
    
    // Validation functions
    function validateEmail(email) {
      const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      return re.test(email);
    }

    function validateAccessCode(code) {
      // Format: ABCD1234 (4 letters + 4 digits)
      const re = /^[A-Z]{4}[0-9]{4}$/i;
      return re.test(code);
    }

    function showError(elementId, message) {
      const errorEl = document.getElementById(elementId);
      if (errorEl) {
        errorEl.textContent = message;
        errorEl.classList.add('show');
      }
    }

    function clearError(elementId) {
      const errorEl = document.getElementById(elementId);
      if (errorEl) {
        errorEl.classList.remove('show');
      }
    }

    // Copy text to clipboard
    async function copyToClipboard(text) {
      try {
        if (navigator.clipboard && navigator.clipboard.writeText) {
          await navigator.clipboard.writeText(text);
        } else {
          // Fallback for older browsers
          const textArea = document.createElement('textarea');
          textArea.value = text;
          textArea.style.position = 'fixed';
          textArea.style.left = '-999999px';
          document.body.appendChild(textArea);
          textArea.select();
          document.execCommand('copy');
          document.body.removeChild(textArea);
        }
      } catch (err) {
        console.error('Failed to copy:', err);
        Toast.error('Failed to copy code', 'TRY AGAIN');
      }
    }

    // Event handlers
    async function handleJoin() {
      const codeInput = document.getElementById('code');
      const code = codeInput.value.trim().toUpperCase();

      clearError('codeError');

      if (!code) {
        showError('codeError', 'Please enter an access code');
        return;
      }

      // Validate code format (ABCD1234)
      if (!validateAccessCode(code)) {
        showError('codeError', 'Invalid code format (expected: ABCD1234)');
        return;
      }

      // Validate code exists in database using secure RPC
      Loading.show('Validating access code...');

      try {
        const { data: validationResult, error: validationError } = await supabase
          .rpc('validate_invite_code', { p_code: code });

        if (validationError) {
          Loading.hide();
          console.error('Code validation error:', validationError);
          showError('codeError', 'Failed to validate code');
          return;
        }

        if (!validationResult.valid) {
          Loading.hide();
          showError('codeError', validationResult.error || 'Invalid invite code');
          return;
        }

        // Code is valid, proceed to wallet connect
        Loading.hide();
        swapContent('walletConnect', code);
      } catch (err) {
        Loading.hide();
        console.error('Code validation error:', err);
        showError('codeError', 'Failed to validate code');
      }
    }

    async function handleWalletConnectForRegistration() {
      try {
        Loading.show('Connecting wallet...');

        // Connect wallet using Web3Modal
        const walletAddress = await getWalletAddress();
        console.log('Wallet connected:', walletAddress);

        // Check if wallet already registered using RPC function (bypasses RLS)
        console.log('Checking if wallet registered...');
        const { data: checkData, error: checkError } = await supabase.rpc('login_with_wallet', {
          p_wallet_address: walletAddress.toLowerCase()
        });
        console.log('login_with_wallet check:', { checkData, checkError });

        if (checkError) {
          Loading.hide();
          console.error('login_with_wallet error:', checkError);
          Modal.alert('Failed to check wallet: ' + checkError.message, 'Error');
          return;
        }

        if (checkData && checkData.success) {
          Loading.hide();
          Modal.alert('This wallet is already registered. Please login instead.', 'Wallet Already Registered');
          return;
        }

        // Reserve the invite code for 5 minutes
        console.log('Reserving invite code:', tempRegistrationData.inviteCode);
        const { data: reserveResult, error: reserveError } = await supabase
          .rpc('reserve_invite_code', {
            p_code: tempRegistrationData.inviteCode,
            p_wallet_address: walletAddress.toLowerCase()
          });
        console.log('reserve_invite_code result:', { reserveResult, reserveError });

        if (reserveError) {
          Loading.hide();
          console.error('reserve_invite_code error:', reserveError);
          Modal.alert('Failed to reserve code: ' + reserveError.message, 'Code Error');
          return;
        }

        if (!reserveResult?.success) {
          Loading.hide();
          const errorMsg = reserveResult?.error || 'Failed to reserve code';
          console.error('Code reservation failed:', errorMsg);
          Modal.alert(errorMsg, 'Code Error');
          return;
        }

        // Request signature to verify ownership
        const message = `Sign to register on Duel PVP\nWallet: ${walletAddress}\nCode: ${tempRegistrationData.inviteCode}\nTimestamp: ${Date.now()}`;

        console.log('Requesting signature...');
        const signature = await signMessage(message);
        console.log('Signature received');

        // Store wallet and signature
        tempRegistrationData.walletAddress = walletAddress;
        tempRegistrationData.signature = signature;

        Loading.hide();
        Toast.success('Wallet verified!', 'SUCCESS');

        // Proceed to terms acceptance
        swapContent('termsAcceptance');

      } catch (error) {
        Loading.hide();
        console.error('Wallet connection error:', error);
        if (error.code === 4001) {
          Toast.warning('You cancelled the wallet connection', 'Connection Cancelled');
        } else {
          Modal.alert('Failed to connect wallet: ' + error.message, 'Connection Error');
        }
      }
    }

    async function handleLogin() {
      clearError('emailError');
      clearError('passError');

      const email = document.getElementById('loginEmail').value.trim();
      const password = document.getElementById('loginPass').value.trim();

      // Validate input
      if (!email) {
        showError('emailError', 'Email is required');
        return;
      }

      if (!password) {
        showError('passError', 'Password is required');
        return;
      }

      // Attempt Supabase authentication
      Loading.show('Signing in...');

      const { data: authData, error: authError } = await supabase.auth.signInWithPassword({
        email: email,
        password: password
      });

      if (authError) {
        Loading.hide();
        showError('passError', 'Invalid email or password');
        console.error('Login error:', authError);
        return;
      }

      // Get user data from database
      const { data: userData, error: userError } = await supabase
        .from('users')
        .select('*')
        .eq('email', email)
        .single();

      Loading.hide();

      if (userError || !userData) {
        showError('passError', 'User data not found');
        console.error('User lookup error:', userError);
        return;
      }

      // Store user info in localStorage
      localStorage.setItem('duelpvp_user_id', userData.id);
      localStorage.setItem('duelpvp_email', userData.email);
      localStorage.setItem('duelpvp_display_name', userData.display_name);
      localStorage.setItem('duelpvp_warrior', userData.display_name);

      // Set username in dashboard
      document.getElementById('userName').textContent = userData.display_name.toUpperCase();

      // Initialize GC cache
      await initializeGCCache();
      const gp = await getUserGC();

      Toast.success(`Welcome back, ${userData.display_name}!`, `${gp} GC`);
      swapContent('dashboard');
    }

    // Helper functions for inline error messages
    function showError(elementId, message) {
      const errorElement = document.getElementById(elementId);
      if (errorElement) {
        errorElement.textContent = message;
        errorElement.classList.add('show');
      }
    }

    function clearError(elementId) {
      const errorElement = document.getElementById(elementId);
      if (errorElement) {
        errorElement.textContent = '';
        errorElement.classList.remove('show');
      }
    }

    function clearAllErrors() {
      ['emailError', 'passError', 'passConfirmError', 'codeError', 'warriorNameError'].forEach(clearError);
    }

    async function handleRegister() {
      const email = document.getElementById('registerEmail').value.trim();
      const pass = document.getElementById('registerPass').value.trim();
      const passConfirm = document.getElementById('registerPassConfirm').value.trim();
      const code = document.getElementById('registerCode').value.trim().toUpperCase();

      // Clear all previous errors
      clearAllErrors();

      let hasError = false;

      if (!email) {
        showError('emailError', 'Email is required');
        hasError = true;
      } else if (!validateEmail(email)) {
        showError('emailError', 'Please enter a valid email address');
        hasError = true;
      }

      if (!pass) {
        showError('passError', 'Password is required');
        hasError = true;
      } else if (pass.length < 8) {
        showError('passError', 'Password must be at least 8 characters');
        hasError = true;
      }

      if (!passConfirm) {
        showError('passConfirmError', 'Please confirm your password');
        hasError = true;
      } else if (pass !== passConfirm) {
        showError('passConfirmError', 'Passwords do not match');
        hasError = true;
      }

      if (!code) {
        showError('codeError', 'Access code is required');
        hasError = true;
      }

      if (hasError) return;

      // Check if invite code exists and is unused
      Loading.show('Validating invite code...');

      try {
        const { data: codeData, error: codeError } = await supabase
          .from('codes')
          .select('code, used_by')
          .eq('code', code.toUpperCase().trim())
          .single();

        Loading.hide();

        if (codeError || !codeData) {
          showError('codeError', 'Invalid invite code');
          return;
        }

        if (codeData.used_by) {
          showError('codeError', 'Code already used');
          return;
        }
      } catch (err) {
        Loading.hide();
        console.error('Code validation error:', err);
        showError('codeError', 'Failed to validate code');
        return;
      }

      // Check if email already registered
      const { data: existingUser } = await supabase
        .from('users')
        .select('id')
        .eq('email', email)
        .single();

      if (existingUser) {
        showError('emailError', 'Email already registered');
        return;
      }

      // Store data temporarily and show warrior naming screen
      tempRegistrationData.email = email;
      tempRegistrationData.password = pass;
      tempRegistrationData.inviteCode = code;
      swapContent('nameWarrior');
    }

    function handleTermsAcceptance() {
      const termsCheckbox = document.getElementById('termsCheckbox');

      clearError('termsError');

      if (!termsCheckbox.checked) {
        showError('termsError', 'You must accept the Terms of Service to continue');
        return;
      }

      // Store terms acceptance
      tempRegistrationData.termsAccepted = true;

      // Proceed to warrior naming
      swapContent('nameWarrior');
    }

    async function handleNameWarrior() {
      const warriorName = document.getElementById('warriorName').value.trim();

      // Clear previous errors
      clearError('warriorNameError');

      if (!warriorName) {
        showError('warriorNameError', 'Warrior name is required');
        return;
      }

      if (warriorName.length < 3) {
        showError('warriorNameError', 'Must be at least 3 characters');
        return;
      }

      if (warriorName.length > 16) {
        showError('warriorNameError', 'Must be 16 characters or less');
        return;
      }

      Loading.show('Creating your account...');

      try {
        // Call server-side registration function
        console.log('Calling register_user_with_wallet with:', {
          wallet: tempRegistrationData.walletAddress,
          name: warriorName,
          code: tempRegistrationData.inviteCode
        });

        const { data, error } = await supabase.rpc('register_user_with_wallet', {
          p_wallet_address: tempRegistrationData.walletAddress,
          p_display_name: warriorName,
          p_invite_code: tempRegistrationData.inviteCode
        });

        console.log('register_user_with_wallet response:', { data, error });

        if (error || !data || !data.success) {
          Loading.hide();
          console.error('Registration failed:', { error, data });
          const errorMsg = data?.error || 'Registration failed';

          if (errorMsg.includes('Display name already taken')) {
            showError('warriorNameError', 'Display name already taken');
          } else if (errorMsg.includes('Wallet already registered')) {
            Modal.alert('This wallet is already registered', 'Registration Failed');
          } else {
            Modal.alert(errorMsg, 'Error');
          }
          return;
        }

        const userId = data.user_id;

        // Create anonymous Supabase Auth session
        console.log('Creating anonymous auth for new user...');
        const authResult = await supabase.auth.signInAnonymously({
          options: {
            data: {
              wallet_address: tempRegistrationData.walletAddress,
              display_name: warriorName,
              user_id: userId
            }
          }
        });
        console.log('Registration auth result:', authResult);

        // Explicitly set the session to ensure client uses it immediately for all requests
        if (authResult.data?.session) {
          await supabase.auth.setSession({
            access_token: authResult.data.session.access_token,
            refresh_token: authResult.data.session.refresh_token
          });
          console.log('Registration session explicitly set on Supabase client');
        }

        if (authResult.error) {
          console.error('Failed to create auth session:', authResult.error);
          Loading.hide();
          Modal.alert('Account created but auth session failed: ' + authResult.error.message + '\n\nPlease try logging in with your wallet.', 'Warning');
          swapContent('home');
          return;
        }

        // Link anonymous auth user to new user record
        if (authResult.data?.user) {
          console.log('Linking new user to auth...');
          const linkResult = await supabase.rpc('link_auth_to_user', {
            p_user_id: userId
          });
          console.log('Link result:', linkResult);
        }

        // Verify session is active
        console.log('Verifying registration session...');
        const { data: { session: verifySession } } = await supabase.auth.getSession();
        console.log('Registration session:', verifySession ? 'Active' : 'None');

        if (!verifySession) {
          Loading.hide();
          Modal.alert('Registration complete but session failed. Please login with your wallet.', 'Warning');
          swapContent('home');
          return;
        }

        // Create session (Blur-style)
        createSession(userId, tempRegistrationData.walletAddress, warriorName);
        finishWalletConnection(); // Allow wallet event handlers to reload page now

        // Set username in dashboard
        document.getElementById('userName').textContent = warriorName.toUpperCase();

        // Initialize GC cache and update display
        await initializeGCCache();
        const gp = await getUserGC();
        const displayGC = gp >= 1000000 ? `${(gp/1000000).toFixed(1)}M` : gp >= 1000 ? `${(gp/1000).toFixed(1)}K` : gp;
        document.getElementById('dashboardGCBalance').textContent = displayGC;

        Loading.hide();
        Toast.success(`Welcome, ${warriorName}!`, `${gp} GC`);
        swapContent('dashboard');

        // Clear temp data
        tempRegistrationData = {
          walletAddress: '',
          inviteCode: '',
          signature: '',
          termsAccepted: false
        };
      } catch (e) {
        Loading.hide();
        console.error('Registration error:', e);
        Modal.alert('Error: ' + e.message + '. Check browser console (F12) for details.', 'Registration Failed');
      }
    }

    async function handleLogout() {
      const confirmed = await Modal.confirm('Are you sure you want to logout?', 'Confirm Logout');
      if (!confirmed) return;

      // Sign out from Supabase Auth
      await supabase.auth.signOut();

      // Clear custom session (legacy support)
      clearSession();

      // Clear GC cache
      gcCache.balance = 0;
      gcCache.lastFetch = 0;

      // Reset UI
      dashboardContent.style.display = 'none';
      panelContent.style.display = 'block';
      swapContent('home');

      Toast.info('Logged out successfully', 'GOODBYE');
    }

    // Wallet connection functions
    async function handleConnectWallet() {
      try {
        Loading.show('Connecting wallet...');

        // Connect wallet using Web3Modal
        const walletAddress = await getWalletAddress();

        // Request signature to verify ownership (doesn't touch assets)
        const message = `Verify wallet ownership for Duel PVP\nWallet: ${walletAddress}\nTimestamp: ${Date.now()}`;

        const signature = await signMessage(message);

        // Store wallet address linked to current email
        const email = localStorage.getItem('duelpvp_email');
        const userId = localStorage.getItem('duelpvp_user_id');

        if (email && userId) {
          // Save to localStorage
          localStorage.setItem(`duelpvp_wallet_${email}`, walletAddress);
          localStorage.setItem(`duelpvp_wallet_verified_${email}`, signature);
          localStorage.setItem(`duelpvp_email_${walletAddress.toLowerCase()}`, email);

          // Save to Supabase database
          const { error: updateError } = await supabase
            .from('users')
            .update({ wallet_address: walletAddress })
            .eq('id', userId);

          if (updateError) {
            console.error('Failed to save wallet to database:', updateError);
            Loading.hide();
            Toast.warning('Wallet connected locally but not saved to database', 'PARTIAL SUCCESS');
            updateWalletDisplay(walletAddress);
          } else {
            updateWalletDisplay(walletAddress);
            Loading.hide();
            Toast.success(`Wallet ${walletAddress.substring(0, 6)}...${walletAddress.substring(38)} linked to your account`, 'WALLET CONNECTED');
          }
        } else {
          Loading.hide();
          Modal.alert('No email found. Please login first.', 'Login Required');
        }
      } catch (error) {
        Loading.hide();
        console.error('Wallet connection error:', error);
        if (error.code === 4001) {
          Toast.warning('You cancelled the wallet connection request', 'Connection Cancelled');
        } else {
          Modal.alert('Failed to connect wallet: ' + error.message, 'Connection Error');
        }
      }
    }

    function updateWalletDisplay(address = null) {
      // Wallet connection card removed - wallet is now required for registration
      // This function is kept for compatibility but does nothing
      return;
    }

    function handleDisconnectWallet() {
      const email = localStorage.getItem('duelpvp_email');
      if (email) {
        const wallet = localStorage.getItem(`duelpvp_wallet_${email}`);
        if (wallet) {
          localStorage.removeItem(`duelpvp_wallet_${email}`);
          localStorage.removeItem(`duelpvp_wallet_verified_${email}`);
          localStorage.removeItem(`duelpvp_email_${wallet.toLowerCase()}`);
        }
        updateWalletDisplay();
        Toast.info('Wallet disconnected from your account', 'DISCONNECTED');
      }
    }

    // =====================================================
    // SESSION MANAGEMENT (Blur-style)
    // =====================================================

    const SESSION_KEY = 'duelpvp.auth';
    const SESSION_DURATION = 30 * 24 * 60 * 60 * 1000; // 30 days

    function createSession(userId, walletAddress, displayName) {
      const session = {
        version: "1",
        userId: userId,
        walletAddress: walletAddress.toLowerCase(),
        displayName: displayName,
        issuedAt: Date.now(),
        expiresAt: Date.now() + SESSION_DURATION
      };

      localStorage.setItem(SESSION_KEY, JSON.stringify(session));
      // Also store userId directly for backward compatibility
      localStorage.setItem('duelpvp_user_id', userId);

      // Also cache GC for navbar (Blur-style)
      const gcCacheKey = `duelpvp.cache.gc`;
      localStorage.setItem(gcCacheKey, JSON.stringify({
        [walletAddress.toLowerCase()]: 0 // Will be updated by initializeGCCache
      }));

      console.log('Session created for', displayName);
    }

    function getSession() {
      try {
        const sessionData = localStorage.getItem(SESSION_KEY);
        if (!sessionData) return null;
        return JSON.parse(sessionData);
      } catch (e) {
        console.error('Failed to parse session:', e);
        return null;
      }
    }

    function clearSession() {
      // Clear all duelpvp.* keys (Blur-style namespacing)
      Object.keys(localStorage).forEach(key => {
        if (key.startsWith('duelpvp.') || key.startsWith('duelpvp_')) {
          localStorage.removeItem(key);
        }
      });
      console.log('Session cleared');
    }

    function isSessionValid(session) {
      if (!session) return false;
      if (!session.userId || !session.walletAddress) return false;
      if (Date.now() > session.expiresAt) {
        console.log('Session expired');
        return false;
      }
      return true;
    }

    // Helper to get current user ID from session
    function getCurrentUserId() {
      const session = getSession();
      if (session?.userId) return session.userId;

      // Backwards compatibility - check old localStorage key
      return localStorage.getItem('duelpvp_user_id') || null;
    }

    // Helper to get current wallet address from session
    function getCurrentWalletAddress() {
      const session = getSession();
      if (session?.walletAddress) return session.walletAddress;

      // Backwards compatibility - check old localStorage key
      return localStorage.getItem('duelpvp_wallet') || null;
    }

    async function checkWalletConnection(expectedAddress) {
      try {
        if (!window.ethereum) return false;

        const accounts = await window.ethereum.request({ method: 'eth_accounts' });
        if (accounts.length === 0) return false;

        const connectedAddresses = accounts.map(a => a.toLowerCase());
        return connectedAddresses.includes(expectedAddress.toLowerCase());
      } catch (e) {
        console.error('Failed to check wallet connection:', e);
        return false;
      }
    }

    async function initializeApp() {
      console.log('Initializing app...');

      // Check for existing Supabase auth session first
      const { data: { session: supabaseSession } } = await supabase.auth.getSession();
      console.log('Supabase session:', supabaseSession ? 'Found' : 'None');

      const session = getSession();

      if (!session) {
        console.log('No localStorage session found, showing home screen');
        return; // Show home screen by default
      }

      if (!isSessionValid(session)) {
        console.log('Session invalid or expired, clearing');
        clearSession();
        await supabase.auth.signOut();
        return; // Show home screen
      }

      // Blur-style: Trust valid session without requiring wallet reconnection
      // Wallet will be reconnected when needed for transactions
      console.log('Valid session found, skipping wallet check for auto-login');

      // Verify user still exists in database using RPC (bypasses RLS)
      const { data: loginData, error } = await supabase.rpc('login_with_wallet', {
        p_wallet_address: session.walletAddress
      });

      if (error || !loginData || !loginData.success) {
        console.log('User not found in database, clearing session');
        clearSession();
        await supabase.auth.signOut();
        return;
      }

      // Extract user data from RPC response
      const userData = {
        id: loginData.user_id,
        display_name: loginData.display_name,
        gc_balance: loginData.gc_balance,
        auth_user_id: loginData.auth_user_id
      };

      // Restore Supabase auth session if missing - create new anonymous session
      if (!supabaseSession) {
        console.log('No Supabase session, creating new anonymous session for auto-login');
        const authResult = await supabase.auth.signInAnonymously({
          options: {
            data: {
              wallet_address: session.walletAddress,
              display_name: userData.display_name,
              user_id: userData.id
            }
          }
        });

        if (authResult.error) {
          console.error('Failed to create auth session:', authResult.error);
          clearSession();
          Toast.info('Session expired. Please login again.', 'SESSION EXPIRED');
          return;
        }

        // Set the session explicitly
        if (authResult.data?.session) {
          await supabase.auth.setSession({
            access_token: authResult.data.session.access_token,
            refresh_token: authResult.data.session.refresh_token
          });
        }
      }

      // Verify Supabase session matches user
      if (supabaseSession && userData.auth_user_id && supabaseSession.user.id !== userData.auth_user_id) {
        console.log('Supabase session mismatch, clearing');
        clearSession();
        await supabase.auth.signOut();
        return;
      }

      // Session is valid! Auto-login
      console.log('Valid session found, auto-logging in as', session.displayName);

      // Set UI
      document.getElementById('userName').textContent = session.displayName.toUpperCase();

      // Initialize GC cache and update display
      await initializeGCCache();
      const gp = await getUserGC();
      const displayGC = gp >= 1000000 ? `${(gp/1000000).toFixed(1)}M` : gp >= 1000 ? `${(gp/1000).toFixed(1)}K` : gp;
      document.getElementById('dashboardGCBalance').textContent = displayGC;

      // Auto-redirect to dashboard
      swapContent('dashboard');
      Toast.success(`Welcome back, ${session.displayName}!`, `${gp} GC`);
    }

    async function handleWalletLogin() {
      try {
        Loading.show('Connecting to wallet...');

        // Connect wallet using Web3Modal
        const walletAddress = (await getWalletAddress()).toLowerCase();

        // Check if wallet exists in database using RPC function (bypasses RLS)
        const { data: loginData, error: loginError } = await supabase.rpc('login_with_wallet', {
          p_wallet_address: walletAddress
        });

        console.log('login_with_wallet response:', { loginData, loginError });

        if (loginError || !loginData || !loginData.success) {
          Loading.hide();
          Modal.alert('This wallet is not registered. Please sign up with an invite code first.', 'Wallet Not Found');
          return;
        }

        // Extract user data from RPC response
        const userData = {
          id: loginData.user_id,
          display_name: loginData.display_name,
          gc_balance: loginData.gc_balance,
          auth_user_id: loginData.auth_user_id
        };

        // Verify ownership with signature
        const message = `Sign in to Duel PVP\nWallet: ${walletAddress}\nTimestamp: ${Date.now()}`;

        const signature = await signMessage(message);

        // Create Supabase Auth session using anonymous authentication
        Loading.show('Creating secure session...');

        // Check if user already has an auth session linked
        let authResult;
        if (userData.auth_user_id) {
          // Try to get existing session (may have been created before)
          const { data: { session } } = await supabase.auth.getSession();
          if (session && session.user.id === userData.auth_user_id) {
            authResult = { data: { user: session.user }, error: null };
          }
        }

        // If no existing session, create new anonymous auth session
        if (!authResult || authResult.error) {
          console.log('Creating new anonymous auth session...');
          authResult = await supabase.auth.signInAnonymously({
            options: {
              data: {
                wallet_address: walletAddress,
                display_name: userData.display_name,
                user_id: userData.id
              }
            }
          });
          console.log('Anonymous auth result:', authResult);

          // Explicitly set the session to ensure client uses it immediately for all requests
          if (authResult.data?.session) {
            await supabase.auth.setSession({
              access_token: authResult.data.session.access_token,
              refresh_token: authResult.data.session.refresh_token
            });
            console.log('Session explicitly set on Supabase client');
          }

          // Link anonymous auth user to existing user record
          if (authResult.data?.user) {
            console.log('Linking auth user to database user...');
            const linkResult = await supabase.rpc('link_auth_to_user', {
              p_user_id: userData.id
            });
            console.log('Link result:', linkResult);
          }
        }

        if (authResult.error) {
          console.error('Auth session error:', authResult.error);
          Loading.hide();
          Modal.alert('Failed to create auth session: ' + authResult.error.message + '\n\nPlease ensure anonymous authentication is enabled in Supabase dashboard.', 'Authentication Error');
          return;
        }

        if (!authResult.data?.user) {
          console.error('No auth user created');
          Loading.hide();
          Modal.alert('Failed to create auth session. Please check browser console.', 'Authentication Error');
          return;
        }

        // Verify session is active and client is using it
        console.log('Verifying session is active...');
        const { data: { session: verifySession } } = await supabase.auth.getSession();
        console.log('Session verification:', verifySession ? 'Active' : 'None');

        if (!verifySession) {
          console.error('Session not active after creation');
          Loading.hide();
          Modal.alert('Session creation failed. Please try again.', 'Authentication Error');
          return;
        }

        // Store user info in localStorage (legacy support)
        createSession(userData.id, walletAddress, userData.display_name);
        finishWalletConnection(); // Allow wallet event handlers to reload page now

        document.getElementById('userName').textContent = userData.display_name.toUpperCase();

        // Check NFT holder status and auto-complete quests
        await checkNFTHolderQuests(walletAddress);

        // Initialize GC cache and update display
        await initializeGCCache();
        const gp = await getUserGC();
        const displayGC = gp >= 1000000 ? `${(gp/1000000).toFixed(1)}M` : gp >= 1000 ? `${(gp/1000).toFixed(1)}K` : gp;
        document.getElementById('dashboardGCBalance').textContent = displayGC;

        Loading.hide();
        Toast.success(`Welcome back, ${userData.display_name}!`, `${gp} GC`);
        swapContent('dashboard');

      } catch (error) {
        Loading.hide();
        console.error('Wallet login error:', error);
        if (error.code === 4001) {
          Toast.warning('You cancelled the signature request', 'Signature Cancelled');
        } else {
          Modal.alert('Failed to login with wallet: ' + error.message, 'Login Failed');
        }
      }
    }

    // Dashboard stats update
    async function updateDashboardStats() {
      try {
        // Get user ID from session or old localStorage format
        const session = getSession();
        const userId = session?.userId || localStorage.getItem('duelpvp_user_id');

        if (!userId) return;

        // Get user's total games played (scores table may not exist yet)
        let userScores = [];
        const { data: scoresData, error: scoresError } = await supabase
          .from('scores')
          .select('time_ms, created_at')
          .eq('user_id', userId)
          .order('created_at', { ascending: false });

        if (scoresError) {
          // Scores table doesn't exist yet - that's okay, continue with other stats
          console.log('Scores table not available:', scoresError.message);
        } else {
          userScores = scoresData || [];
        }

        // Get user's GC from users table
        const { data: userData, error: userError } = await supabase
          .from('users')
          .select('gc_balance, win_streak, total_wins')
          .eq('id', userId)
          .single();

        if (userError) {
          console.error('Failed to load user data:', userError);
        }

        // Calculate rank using RPC function (bypasses RLS)
        let userRank = 0;
        const userGC = userData?.gc_balance ?? 0;

        // Use get_user_rank RPC if available, otherwise try direct count
        const { data: rankData, error: rankError } = await supabase
          .rpc('get_user_rank', { p_user_id: userId });

        console.log('Rank calculation:', { userGC, rankData, rankError });

        if (!rankError && rankData && rankData[0]?.rank) {
          userRank = rankData[0].rank;
        } else {
          // Fallback: try direct count (may fail with RLS)
          const { count } = await supabase
            .from('users')
            .select('*', { count: 'exact', head: true })
            .gt('gc_balance', userGC);

          if (count !== null) {
            userRank = count + 1;
          }
        }

        // Calculate stats
        const totalWins = userData?.total_wins || userScores?.length || 0;
        const streak = userData?.win_streak || 0;
        const totalGP = userData?.gc_balance || 0;

        // Update UI
        document.getElementById('dashboardRank').textContent = userRank > 0 ? `#${userRank}` : '--';

        // Update GC using secure getUserGC function (supports both database and localStorage)
        const displayGP = await getUserGC();
        document.getElementById('dashboardGCBalance').textContent = displayGP >= 1000000 ? `${(displayGP/1000000).toFixed(1)}M` : displayGP >= 1000 ? `${(displayGP/1000).toFixed(1)}K` : displayGP;

      } catch (e) {
        console.error('Failed to update dashboard stats:', e);
      }

      // Update wallet display
      updateWalletDisplay();

      // Load dashboard inventory
      loadDashboardInventory();
    }

    async function loadDashboardInventory() {
      const userId = localStorage.getItem('duelpvp_user_id');
      const email = localStorage.getItem('duelpvp_email');
      const dashboardItemsGrid = document.getElementById('dashboardItemsGrid');

      if (!dashboardItemsGrid) return;

      // Get inventory from localStorage (for now - can be migrated to Supabase later)
      const inventory = JSON.parse(localStorage.getItem(`duelpvp_inventory_${email}`) || '[]');

      // Get user's invite codes using RPC function
      let inviteCodes = [];
      if (userId) {
        const { data } = await supabase
          .rpc('get_user_invite_codes', { p_user_id: userId });

        if (data && data.length > 0) {
          inviteCodes = data.map(c => ({
            code: c.code,
            used: c.used,
            used_at: c.used_at
          }));
        }
      }

      // Combine inventory items and codes
      const allItems = [];

      // Add invite codes first (show up to 4)
      inviteCodes.slice(0, 4).forEach(code => {
        allItems.push({
          type: 'invite_code',
          icon: `<img src="duelpvp-logo.svg" alt="Invite Code" style="width:24px;height:24px;display:inline-block;vertical-align:middle;">`,
          name: code.used_by ? 'USED CODE' : 'INVITE CODE',
          desc: code.used_by
            ? `This code was used on ${new Date(code.used_at).toLocaleDateString()}`
            : 'Share this code with friends to invite them to the arena!',
          code: code.code,
          itemType: 'Invite Code',
          used: !!code.used_by
        });
      });

      // Add shop items from inventory
      inventory.forEach(item => {
        const shopItem = SHOP_ITEMS.find(si => si.id === item.id);
        if (shopItem) {
          allItems.push({
            type: 'shop_item',
            icon: shopItem.icon,
            name: shopItem.name,
            desc: shopItem.desc,
            itemType: shopItem.type,
            count: item.count || 1
          });
        }
      });

      // Fill remaining slots with empty slots (show 8 slots total)
      const slotsToShow = 8;
      while (allItems.length < slotsToShow) {
        allItems.push({ type: 'empty' });
      }

      // Render items
      dashboardItemsGrid.innerHTML = '';
      allItems.slice(0, slotsToShow).forEach(item => {
        const slot = document.createElement('div');
        slot.className = item.type === 'empty' ? 'dashboard-item-slot empty' : 'dashboard-item-slot';

        if (item.type === 'empty') {
          slot.innerHTML = `
            <div class="dashboard-item-icon">—</div>
          `;
        } else {
          slot.innerHTML = `
            <div class="dashboard-item-icon">${item.icon}</div>
            <div class="dashboard-item-name">${item.name}</div>
            ${item.count > 1 ? `<div class="dashboard-item-count">${item.count}</div>` : ''}
            <div class="dashboard-item-tooltip">
              <div class="tooltip-name">${item.name}</div>
              <div class="tooltip-desc">${item.desc}</div>
              <div class="tooltip-type">${item.itemType || 'Item'}</div>
              ${item.code ? `<div class="tooltip-desc" style="margin-top:4px;color:var(--gold);font-family:'Press Start 2P';font-size:9px;">${item.code}</div>` : ''}
            </div>
          `;

          // Add click-to-copy for unused invite codes
          if (item.type === 'invite_code' && !item.used) {
            slot.style.cursor = 'pointer';
            slot.addEventListener('click', () => {
              copyToClipboard(item.code);
              Toast.success(`Code ${item.code} copied!`, 'SHARE WITH FRIENDS');
            });
          }
        }

        dashboardItemsGrid.appendChild(slot);
      });
    }

    // Leaderboard functions
    async function loadLeaderboard(filter = 'all') {
      console.log('loadLeaderboard called');
      try {
        const userId = localStorage.getItem('duelpvp_user_id');

        Loading.show('Loading leaderboard...');

        // Get leaderboard using secure RPC function
        const { data: leaderboard, error } = await supabase
          .rpc('get_leaderboard', { p_limit: 100 });

        Loading.hide();

        if (error) {
          console.error('Leaderboard error:', error);
          throw error;
        }

        console.log('Loaded leaderboard:', leaderboard?.length || 0, 'entries');

        // Show user's rank if they're logged in
        if (userId) {
          const userEntry = leaderboard?.find(entry => entry.display_name === localStorage.getItem('duelpvp_display_name'));
          if (userEntry) {
            document.getElementById('yourBestSection').style.display = 'block';
            document.getElementById('yourBestTime').textContent = `#${userEntry.rank} | ${userEntry.gc_balance?.toLocaleString() || 0} GC`;
          } else {
            // User is not in top 100, get their actual rank
            const { data: userRankData } = await supabase
              .rpc('get_user_rank', { p_user_id: userId });

            if (userRankData && userRankData.rank) {
              document.getElementById('yourBestSection').style.display = 'block';
              document.getElementById('yourBestTime').textContent = `#${userRankData.rank} | ${userRankData.user_gc_balance?.toLocaleString() || 0} GC`;
            } else {
              document.getElementById('yourBestSection').style.display = 'none';
            }
          }
        } else {
          document.getElementById('yourBestSection').style.display = 'none';
        }

        // Render table
        renderLeaderboardTable(leaderboard || [], userId);

      } catch (e) {
        Loading.hide();
        console.error('Failed to load leaderboard:', e);
        document.getElementById('leaderboardTableBody').innerHTML = '<div class="no-data">Error loading leaderboard</div>';
      }
    }

    function renderLeaderboardTable(leaderboard, currentUserId) {
      const tbody = document.getElementById('leaderboardTableBody');
      tbody.innerHTML = '';

      if (leaderboard.length === 0) {
        tbody.innerHTML = '<div class="no-data">No warriors yet. Be the first!</div>';
        return;
      }

      leaderboard.forEach((entry) => {
        const rank = entry.rank || '?';
        const playerName = entry.display_name || 'Unknown';
        const gpBalance = entry.gc_balance?.toLocaleString() || '0';
        const walletShort = entry.wallet_address ?
          `${entry.wallet_address.substring(0, 6)}...${entry.wallet_address.substring(entry.wallet_address.length - 4)}` :
          'No wallet';
        const isCurrentUser = entry.id === currentUserId;

        // Highlight top 3 differently
        let rankBadgeClass = 'rank-badge';
        if (rank === 1) rankBadgeClass += ' rank-gold';
        else if (rank === 2) rankBadgeClass += ' rank-silver';
        else if (rank === 3) rankBadgeClass += ' rank-bronze';

        const row = document.createElement('div');
        row.className = isCurrentUser ? 'table-row user-row' : 'table-row';
        row.innerHTML = `
          <div class="${rankBadgeClass}">#${rank}</div>
          <div class="player-name">${playerName.toUpperCase()}${isCurrentUser ? ' (YOU)' : ''}</div>
          <div class="reaction-time" style="color:var(--gold);font-weight:700;">${gpBalance} GC</div>
          <div class="entry-date" style="font-family:monospace;font-size:11px;">${walletShort}</div>
        `;
        tbody.appendChild(row);
      });
    }

    // Game functions
    function initChart() {
      const canvas = document.getElementById('chartCanvas');
      const ctx = canvas.getContext('2d');
      canvas.width = canvas.offsetWidth;
      canvas.height = canvas.offsetHeight;
      drawChart(ctx, false);
    }
    
    function drawChart(ctx, chartData = null) {
      const canvas = ctx.canvas;
      const w = canvas.width;
      const h = canvas.height;

      // Clear canvas
      ctx.clearRect(0, 0, w, h);

      // Draw grid
      ctx.strokeStyle = 'rgba(255,214,77,0.1)';
      ctx.lineWidth = 1;
      ctx.setLineDash([2, 4]);

      // Horizontal lines
      for (let i = 0; i < 5; i++) {
        ctx.beginPath();
        ctx.moveTo(0, (h / 5) * i);
        ctx.lineTo(w, (h / 5) * i);
        ctx.stroke();
      }

      // Vertical lines
      for (let i = 0; i < 10; i++) {
        ctx.beginPath();
        ctx.moveTo((w / 10) * i, 0);
        ctx.lineTo((w / 10) * i, h);
        ctx.stroke();
      }

      ctx.setLineDash([]);

      // If no chartData provided, draw empty/static chart
      if (!chartData) {
        const points = [];
        let currentPrice = 40000;
        const numPoints = 50;

        for (let i = 0; i < numPoints; i++) {
          const change = (Math.random() - 0.48) * 300;
          currentPrice += change;
          points.push({
            x: (w / numPoints) * i,
            y: h - (currentPrice - 38000) / 50
          });
        }

        ctx.strokeStyle = '#4CAF50';
        ctx.lineWidth = 3;
        ctx.beginPath();
        points.forEach((point, i) => {
          if (i === 0) ctx.moveTo(point.x, point.y);
          else ctx.lineTo(point.x, point.y);
        });
        ctx.stroke();
        return;
      }

      // Draw animated chart
      const isRed = chartData.hasCrashed;
      const points = chartData.points;

      // Draw line
      ctx.strokeStyle = isRed ? '#F44336' : '#4CAF50';
      ctx.lineWidth = 3;
      ctx.beginPath();
      points.forEach((point, i) => {
        if (i === 0) ctx.moveTo(point.x, point.y);
        else ctx.lineTo(point.x, point.y);
      });
      ctx.stroke();

      // Draw fill
      ctx.fillStyle = isRed ? 'rgba(244,67,54,0.1)' : 'rgba(76,175,80,0.1)';
      ctx.beginPath();
      ctx.moveTo(points[0].x, points[0].y);
      points.forEach(point => ctx.lineTo(point.x, point.y));
      ctx.lineTo(points[points.length - 1].x, h);
      ctx.lineTo(points[0].x, h);
      ctx.closePath();
      ctx.fill();
    }
    
    function startGame() {
      const chartContainer = document.getElementById('chartContainer');
      const sellButton = document.getElementById('sellButton');
      const gameStatus = document.getElementById('gameStatus');
      const canvas = document.getElementById('chartCanvas');
      const ctx = canvas.getContext('2d');
      const w = canvas.width;
      const h = canvas.height;

      // Reset state
      chartContainer.className = 'chart-container green';
      sellButton.disabled = false; // Enable immediately
      gameStatus.textContent = 'Watch for the dump...';
      gameStatus.className = 'game-status status-ready';
      drawChart(ctx, null);

      // Game parameters - HIGHLY RANDOMIZED FOR VARIETY
      // Random duration with weighted distribution (favors longer but allows early crashes)
      const durationRoll = Math.random();
      let totalDuration;
      if (durationRoll < 0.15) {
        // 15% chance: Early crash (1-2.5 seconds)
        totalDuration = 1000 + Math.random() * 1500;
      } else if (durationRoll < 0.85) {
        // 70% chance: Normal/Long (2.5-6 seconds) - more exciting
        totalDuration = 2500 + Math.random() * 3500;
      } else {
        // 15% chance: Very long (6-9 seconds) - maximum suspense
        totalDuration = 6000 + Math.random() * 3000;
      }

      // Peak time is more variable: sometimes early (20%), sometimes very late (90%)
      const peakTime = totalDuration * (0.2 + Math.random() * 0.7); // Peak at 20%-90% of duration
      const startPrice = 38000 + Math.random() * 4000; // Random start 38k-42k
      const peakPrice = startPrice + 6000 + Math.random() * 8000; // Rise 6000-14000
      const crashPrice = startPrice - (2000 + Math.random() * 3000); // Random crash depth
      const riseShape = 0.5 + Math.random() * 0.8; // Random rise curve (0.5-1.3)
      const crashShape = 1.5 + Math.random() * 1.5; // Random crash steepness (1.5-3.0)

      gameState.isPlaying = true;
      gameState.hasCrashed = false;
      gameState.peakReached = false;
      gameState.startTime = performance.now();
      gameState.peakTime = gameState.startTime + peakTime;
      gameState.endTime = gameState.startTime + totalDuration;

      const numPoints = 80;

      function animateChart() {
        if (!gameState.isPlaying && !gameState.hasCrashed) return;

        const now = performance.now();
        const elapsed = now - gameState.startTime;
        const progress = Math.min(elapsed / totalDuration, 1);

        // Calculate current price based on phase
        let currentPrice;
        const pointsToShow = Math.floor(progress * numPoints);

        if (elapsed < peakTime) {
          // Rising phase - random curve shape
          const riseProgress = elapsed / peakTime;
          currentPrice = startPrice + (peakPrice - startPrice) * Math.pow(riseProgress, riseShape);
        } else {
          // Crashing phase - random steepness
          if (!gameState.peakReached) {
            gameState.peakReached = true;
            chartContainer.className = 'chart-container red';
            gameStatus.textContent = 'CRASH!';
            gameStatus.className = 'game-status status-go';
          }
          gameState.hasCrashed = true;
          const crashProgress = (elapsed - peakTime) / (totalDuration - peakTime);
          currentPrice = peakPrice - (peakPrice - crashPrice) * Math.pow(crashProgress, crashShape);
        }

        // Generate smooth points
        const points = [];
        for (let i = 0; i <= pointsToShow; i++) {
          const t = i / numPoints;
          const pointElapsed = t * totalDuration;
          let price;

          if (pointElapsed < peakTime) {
            const riseProgress = pointElapsed / peakTime;
            price = startPrice + (peakPrice - startPrice) * Math.pow(riseProgress, riseShape);
          } else {
            const crashProgress = (pointElapsed - peakTime) / (totalDuration - peakTime);
            price = peakPrice - (peakPrice - crashPrice) * Math.pow(crashProgress, crashShape);
          }

          points.push({
            x: (w / numPoints) * i,
            y: h - ((price - 34000) / 110)
          });
        }

        // Draw chart
        drawChart(ctx, {
          points: points,
          hasCrashed: gameState.hasCrashed
        });

        // Continue animation or end
        if (progress < 1) {
          gameState.chartAnimation = requestAnimationFrame(animateChart);
        } else {
          // Auto-sell if didn't click
          if (gameState.isPlaying) {
            handleSell();
          }
        }
      }

      animateChart();
    }
    
    async function handleSell() {
      if (!gameState.isPlaying) return;

      const now = performance.now();
      const sellButton = document.getElementById('sellButton');
      const gameStatus = document.getElementById('gameStatus');

      // Check if clicked before peak - TOO EARLY
      if (now < gameState.peakTime) {
        gameState.isPlaying = false;
        gameState.attempts.push(-1); // -1 indicates early click

        sellButton.disabled = true;
        gameStatus.textContent = 'TOO EARLY! Wait for the dump!';
        gameStatus.className = 'game-status status-go';

        // Cancel animation
        if (gameState.chartAnimation) {
          cancelAnimationFrame(gameState.chartAnimation);
        }

        // Update best time display
        updateBestTimeDisplay();
        updateResultsGrid();
        return;
      }

      // Clicked after peak - calculate reaction time
      const reactionTime = now - gameState.peakTime;
      gameState.attempts.push(reactionTime);
      gameState.isPlaying = false;

      // Update best time
      if (gameState.bestTime === null || reactionTime < gameState.bestTime) {
        gameState.bestTime = reactionTime;
      }

      // Award GC for fast reactions
      if (reactionTime < 1000) {
        await updateUserGC(300, 'reaction');
        Toast.success('Fast hands! +300 GC', 'PROFIT');
        gameStatus.textContent = `${reactionTime.toFixed(0)}ms - +300 GC!`;
        gameStatus.className = 'game-status';
        gameStatus.style.color = '#4CAF50';
      } else {
        gameStatus.textContent = `${reactionTime.toFixed(0)}ms - Too slow!`;
        gameStatus.className = 'game-status';
        gameStatus.style.color = '#a0a8b0';
      }

      // Update UI
      sellButton.disabled = true;

      // Cancel animation
      if (gameState.chartAnimation) {
        cancelAnimationFrame(gameState.chartAnimation);
      }

      // Update displays
      updateBestTimeDisplay();
      updateResultsGrid();
    }

    function updateBestTimeDisplay() {
      const bestTimeEl = document.getElementById('attemptsLeft');
      if (gameState.bestTime) {
        bestTimeEl.textContent = `${gameState.bestTime.toFixed(0)} ms`;
        bestTimeEl.style.color = gameState.bestTime < 1000 ? '#4CAF50' : '#a0a8b0';
      } else {
        bestTimeEl.textContent = '-- ms';
        bestTimeEl.style.color = '#a0a8b0';
      }
    }

    function updateResultsGrid() {
      const grid = document.getElementById('resultsGrid');
      grid.innerHTML = '';

      // Show last 5 attempts
      const recentAttempts = gameState.attempts.slice(-5);
      const validAttempts = recentAttempts.filter(t => t >= 0);
      const bestTime = validAttempts.length > 0 ? Math.min(...validAttempts) : null;

      recentAttempts.forEach((time, index) => {
        const actualIndex = gameState.attempts.length - recentAttempts.length + index;
        const card = document.createElement('div');
        const isBest = time >= 0 && time === bestTime;
        card.className = isBest ? 'result-card best' : 'result-card';

        if (time === -1) {
          // Too early
          card.innerHTML = `
            <div class="result-attempt">TRY ${actualIndex + 1}</div>
            <div class="result-time" style="color:#F44336">TOO EARLY</div>
          `;
        } else {
          const gpEarned = time < 1000 ? '+300 GC' : '0 GC';
          const color = time < 1000 ? '#4CAF50' : '#a0a8b0';
          card.innerHTML = `
            <div class="result-attempt">TRY ${actualIndex + 1}</div>
            <div class="result-time">${time.toFixed(0)}ms</div>
            <div class="result-time" style="color:${color};font-size:11px;">${gpEarned}</div>
          `;
        }
        grid.appendChild(card);
      });
    }

    async function saveScoreToSupabase(userId, timeMs) {
      try {
        // Save score to database
        const { error: scoreError } = await supabase
          .from('scores')
          .insert({
            user_id: userId,
            time_ms: Math.round(timeMs),
            game_type: 'reaction'
          });

        if (scoreError) {
          console.error('Failed to save score:', scoreError);
          Toast.error('Failed to save score', 'ERROR');
          return;
        }

        // Update quest progress
        await updateQuestProgress('daily_play_3');
        await updateQuestProgress('weekly_play_20');

        // Check for fast time quests (close to peak)
        if (timeMs < 300) {
          await updateQuestProgress('daily_fast_time');
        }
        if (timeMs < 200) {
          await updateQuestProgress('weekly_sub_250');
        }

        // Auto-complete login quest on first game
        await updateQuestProgress('daily_login');

        Toast.success('Score saved!', 'SUCCESS');

      } catch (e) {
        console.error('Error saving score:', e);
      }
    }

    function endGame() {
      const validAttempts = gameState.attempts.filter(t => t >= 0);
      const bestTime = validAttempts.length > 0 ? Math.min(...validAttempts) : null;

      if (bestTime !== null) {
        document.getElementById('gameStatus').textContent = `Game Over! Best: +${bestTime.toFixed(0)}ms`;
      } else {
        document.getElementById('gameStatus').textContent = `Game Over! All attempts disqualified`;
      }

      // Save score to Supabase
      if (bestTime !== null) {
        const userId = localStorage.getItem('duelpvp_user_id');

        if (userId) {
          saveScoreToSupabase(userId, bestTime);
        }
      }
    }
    
    function resetGame() {
      gameState = {
        attempts: [],
        bestTime: null,
        isPlaying: false,
        startTime: null,
        reactionTimer: null,
        chartAnimation: null
      };

      // Clear any running timers
      if (gameState.reactionTimer) clearTimeout(gameState.reactionTimer);
      if (gameState.chartAnimation) cancelAnimationFrame(gameState.chartAnimation);

      // Reset UI
      document.getElementById('chartContainer').className = 'chart-container';
      document.getElementById('sellButton').disabled = true;
      document.getElementById('gameStatus').textContent = 'Click START TRADE to begin';
      document.getElementById('gameStatus').style.color = '#a0a8b0';
      updateBestTimeDisplay();
      document.getElementById('resultsGrid').innerHTML = '';
      
      const canvas = document.getElementById('chartCanvas');
      const ctx = canvas.getContext('2d');
      drawChart(ctx, false);
    }

    // Crash Game Logic
    let crashGameState = {
      phase: 'waiting', // waiting, betting, flying, crashed
      currentMultiplier: 1.00,
      crashPoint: 0,
      seed: '',
      hash: '',
      betAmount: 0,
      autoCashout: 0,
      hashedIn: false,
      startTime: 0,
      countdown: 3, // Reduced from 5 to 3 seconds between rounds
      history: []
    };

    async function initCrashGame() {
      // Load history from localStorage
      const savedHistory = localStorage.getItem('crash_history');
      if (savedHistory) {
        crashGameState.history = JSON.parse(savedHistory);
        updateCrashHistory();
      }

      // Update GC display
      updateCrashGCDisplay();

      // Setup canvas
      const canvas = document.getElementById('crashTrailCanvas');
      canvas.width = canvas.offsetWidth;
      canvas.height = canvas.offsetHeight;

      // Event listeners
      document.getElementById('crashPlaceBetBtn').addEventListener('click', placeCrashBet);
      document.getElementById('crashCashoutBtn').addEventListener('click', crashCashout);

      // Start game loop
      startCrashRound();
    }

    async function updateCrashGCDisplay() {
      const gp = await getUserGC();
      document.getElementById('crashGCDisplay').textContent = gp;
      document.getElementById('crashCurrentBet').textContent = crashGameState.betAmount;

      if (crashGameState.betAmount > 0 && crashGameState.phase === 'flying') {
        const potential = Math.floor(crashGameState.betAmount * crashGameState.currentMultiplier);
        document.getElementById('crashPotentialWin').textContent = potential;
      } else {
        document.getElementById('crashPotentialWin').textContent = '0';
      }
    }

    function generateCrashPoint() {
      // Generate provably fair crash point
      const seed = Math.random().toString(36).substring(2) + Date.now().toString(36);
      const hash = SHA256(seed);

      // Convert hash to crash point (simplified version)
      const hexValue = hash.substring(0, 8);
      const intValue = parseInt(hexValue, 16);

      // Formula: 10% PLAYER EDGE (110% RTP) - players win over time!
      const result = (1.10 * Math.pow(2, 32)) / (Math.pow(2, 32) - intValue);
      const crashPoint = Math.max(1.00, Math.min(100, result));

      return { seed, hash, crashPoint };
    }

    // Simple SHA-256 implementation
    function SHA256(str) {
      return Array.from(str).reduce((hash, char) => {
        return ((hash << 5) - hash) + char.charCodeAt(0) | 0;
      }, 0).toString(16).padStart(8, '0').repeat(8);
    }

    async function startCrashRound() {
      // Reset state
      crashGameState.phase = 'waiting';
      crashGameState.currentMultiplier = 1.00;
      crashGameState.hashedIn = false;
      crashGameState.betAmount = 0; // Reset bet for new round
      crashGameState.countdown = 3; // Reduced from 5 to 3 seconds

      // Generate crash point for next round
      const { seed, hash, crashPoint } = generateCrashPoint();
      crashGameState.seed = seed;
      crashGameState.hash = hash;
      crashGameState.crashPoint = crashPoint;

      console.log('[Crash Game] New round started. Crash point:', crashPoint);

      // Display hash
      document.getElementById('crashHash').textContent = hash.substring(0, 32) + '...';
      document.getElementById('crashStatusText').textContent = 'Waiting for bets...';
      document.getElementById('crashMultiplierValue').textContent = '1.00x';

      // Enable bet button
      document.getElementById('crashPlaceBetBtn').disabled = false;
      document.getElementById('crashPlaceBetBtn').textContent = 'PLACE BET';

      // Update GC display
      updateCrashGCDisplay();

      // Countdown phase
      const countdownInterval = setInterval(() => {
        crashGameState.countdown--;
        const countdownEl = document.getElementById('crashCountdown');
        if (countdownEl) {
          countdownEl.textContent = crashGameState.countdown;
        }
        document.getElementById('crashGameStatus').innerHTML = `Next round starts in <span id="crashCountdown">${crashGameState.countdown}</span>s`;

        if (crashGameState.countdown <= 0) {
          clearInterval(countdownInterval);
          startFlying();
        }
      }, 1000);
    }

    function startFlying() {
      crashGameState.phase = 'flying';
      crashGameState.startTime = Date.now();

      document.getElementById('crashStatusText').textContent = 'Flying!';
      document.getElementById('crashGameStatus').textContent = 'Cash out before it crashes!';
      document.getElementById('crashPlaceBetBtn').disabled = true;

      const rocket = document.getElementById('crashRocket');
      const multiplierEl = document.getElementById('crashMultiplierValue');

      rocket.classList.add('flying');
      multiplierEl.classList.add('flying');

      // Enable cashout if player has bet
      if (crashGameState.betAmount > 0) {
        document.getElementById('crashCashoutBtn').disabled = false;
      }

      flyingLoop();
    }

    function flyingLoop() {
      if (crashGameState.phase !== 'flying') return;

      const elapsed = (Date.now() - crashGameState.startTime) / 1000;
      crashGameState.currentMultiplier = 1 + (elapsed * 0.3); // Increases 0.3x per second

      // Update display
      document.getElementById('crashMultiplierValue').textContent = crashGameState.currentMultiplier.toFixed(2) + 'x';
      updateCrashGCDisplay();

      // Move rocket up
      const rocket = document.getElementById('crashRocket');
      const progress = Math.min(0.9, elapsed / 10); // 10 seconds to reach top
      const bottom = 20 + (progress * 300); // Move from bottom:20px to bottom:320px
      rocket.style.bottom = bottom + 'px';

      // Draw trail
      drawCrashTrail();

      // Check for crash
      if (crashGameState.currentMultiplier >= crashGameState.crashPoint) {
        crash();
        return;
      }

      // Check auto-cashout
      if (crashGameState.autoCashout > 0 && crashGameState.currentMultiplier >= crashGameState.autoCashout && crashGameState.betAmount > 0) {
        crashCashout();
        return;
      }

      requestAnimationFrame(flyingLoop);
    }

    function drawCrashTrail() {
      const canvas = document.getElementById('crashTrailCanvas');
      const ctx = canvas.getContext('2d');

      const rocket = document.getElementById('crashRocket');
      const rocketRect = rocket.getBoundingClientRect();
      const containerRect = canvas.getBoundingClientRect();

      const x = rocketRect.left - containerRect.left + (rocketRect.width / 2);
      const y = rocketRect.top - containerRect.top + (rocketRect.height / 2);

      // Add glow trail
      ctx.fillStyle = `rgba(255, 214, 77, ${0.1 + Math.random() * 0.1})`;
      ctx.beginPath();
      ctx.arc(x, y + 20, 5 + Math.random() * 3, 0, Math.PI * 2);
      ctx.fill();

      // Fade existing trail
      ctx.fillStyle = 'rgba(16, 20, 24, 0.05)';
      ctx.fillRect(0, 0, canvas.width, canvas.height);
    }

    function crash() {
      crashGameState.phase = 'crashed';

      const rocket = document.getElementById('crashRocket');
      const container = document.getElementById('crashRocketContainer');
      const multiplierEl = document.getElementById('crashMultiplierValue');

      rocket.classList.remove('flying');
      multiplierEl.classList.remove('flying');
      container.classList.add('crashed');

      document.getElementById('crashStatusText').textContent = 'CRASHED!';
      document.getElementById('crashStatusText').style.color = '#F44336';
      document.getElementById('crashMultiplierValue').textContent = crashGameState.crashPoint.toFixed(2) + 'x';
      document.getElementById('crashGameStatus').textContent = `Crashed at ${crashGameState.crashPoint.toFixed(2)}x`;
      document.getElementById('crashCashoutBtn').disabled = true;

      // If player had bet and didn't cash out, they lose
      if (crashGameState.betAmount > 0) {
        Toast.error(`Lost ${crashGameState.betAmount} GC at ${crashGameState.crashPoint.toFixed(2)}x`, 'CRASHED');
        crashGameState.betAmount = 0;
        updateCrashGCDisplay();
        updateDashboardStats();
      }

      // Add to history
      addToCrashHistory(crashGameState.crashPoint);

      console.log('[Crash Game] Crashed at', crashGameState.crashPoint.toFixed(2) + 'x', '- restarting in 2 seconds...');

      // Reset rocket position and start new round
      setTimeout(() => {
        console.log('[Crash Game] Starting new round...');
        rocket.style.bottom = '20px';
        container.classList.remove('crashed');
        document.getElementById('crashStatusText').style.color = '#a0a8b0';

        // Clear canvas
        const canvas = document.getElementById('crashTrailCanvas');
        const ctx = canvas.getContext('2d');
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        // Start new round
        startCrashRound();
      }, 2000); // Reduced from 3000ms to 2000ms
    }

    async function placeCrashBet() {
      if (crashGameState.phase !== 'waiting') {
        Toast.error('Wait for next round', 'TOO LATE');
        return;
      }

      const betInput = document.getElementById('crashBetAmount');
      const betAmount = parseInt(betInput.value);
      const autoCashoutInput = document.getElementById('crashAutoCashout');
      const autoCashout = parseFloat(autoCashoutInput.value) || 0;

      const gp = await getUserGC();

      if (isNaN(betAmount) || betAmount < 10) {
        Toast.error('Minimum bet is 10 GC', 'INVALID BET');
        return;
      }

      if (betAmount > 10000) {
        Toast.error('Maximum bet is 10,000 GC', 'INVALID BET');
        return;
      }

      if (betAmount > gp) {
        Toast.error('Insufficient GC', 'INSUFFICIENT FUNDS');
        return;
      }

      // Deduct bet from balance
      await updateUserGC(-betAmount, 'crash');
      crashGameState.betAmount = betAmount;
      crashGameState.autoCashout = autoCashout;
      crashGameState.hashedIn = true;

      updateCrashGCDisplay();
      updateDashboardStats();

      Toast.success(`Bet placed: ${betAmount} GC`, 'BET PLACED');
      document.getElementById('crashPlaceBetBtn').disabled = true;
      document.getElementById('crashPlaceBetBtn').textContent = 'BET PLACED';
    }

    async function crashCashout() {
      if (crashGameState.phase !== 'flying' || crashGameState.betAmount <= 0) {
        return;
      }

      const winAmount = Math.floor(crashGameState.betAmount * crashGameState.currentMultiplier);
      const profit = winAmount - crashGameState.betAmount;

      // Add winnings to balance
      await updateUserGC(winAmount, 'crash');

      Toast.success(`Cashed out at ${crashGameState.currentMultiplier.toFixed(2)}x! Won ${winAmount} GC (+${profit})`, 'CASHED OUT');

      crashGameState.betAmount = 0;
      updateCrashGCDisplay();
      updateDashboardStats();

      document.getElementById('crashCashoutBtn').disabled = true;
    }

    function addToCrashHistory(crashPoint) {
      crashGameState.history.unshift(crashPoint);
      if (crashGameState.history.length > 20) {
        crashGameState.history = crashGameState.history.slice(0, 20);
      }
      localStorage.setItem('crash_history', JSON.stringify(crashGameState.history));
      updateCrashHistory();
    }

    function updateCrashHistory() {
      const historyList = document.getElementById('crashHistoryList');
      historyList.innerHTML = '';

      crashGameState.history.forEach(point => {
        const item = document.createElement('div');
        item.className = 'crash-history-item';

        if (point < 2) {
          item.classList.add('crashed-low');
        } else if (point < 5) {
          item.classList.add('crashed-med');
        } else {
          item.classList.add('crashed-high');
        }

        item.textContent = point.toFixed(2) + 'x';
        historyList.appendChild(item);
      });
    }

    // ========== QUEST SYSTEM - REBUILT FROM SCRATCH ==========

    // Quest definitions
    const QUESTS = {
      daily: [
        {id: 'first_login', name: 'First Steps', desc: 'Log in for the first time', target: 1, reward: 500, icon: '🗡️', type: 'regular'},
        {id: 'invite_used', name: 'Recruit Warriors', desc: 'Have 3 friends use your invite codes', target: 3, reward: 1500, icon: '👥', type: 'regular', action: 'openInventory'},
        {id: 'like_retweet', name: 'Like & Retweet', desc: 'Like and retweet our post on X', target: 1, reward: 500, icon: '❤️', type: 'manual'},
        {id: 'twitter_follow', name: 'Follow Us', desc: 'Follow @Duelpvp on X', target: 1, reward: 500, icon: '➕', type: 'manual'},
        {id: 'bunnz_holder', name: 'BAD BUNNZ Holder', desc: 'Own a BAD BUNNZ NFT', target: 1, reward: 500, icon: '🐰', type: 'nft'},
        {id: 'fluffle_holder', name: 'FLUFFLE Holder', desc: 'Own a FLUFFLE NFT', target: 1, reward: 2500, icon: '🐇', type: 'nft'},
        {id: 'megalio_holder', name: 'MEGALIO Holder', desc: 'Own a MEGALIO NFT', target: 1, reward: 2000, icon: '🦁', type: 'nft'}
      ],
      weekly: [],
      special: []
    };

    // Tab switching
    function switchQuestTab(tab, questType) {
      document.querySelectorAll('.quest-tab').forEach(t => t.classList.remove('active'));
      tab.classList.add('active');
      loadQuests(questType);
    }

    // Main quest loader - uses server-side quest system
    async function loadQuests(type) {
      const questGrid = document.getElementById('questGrid');
      const comingSoonOverlay = document.getElementById('comingSoonOverlay');

      if (!questGrid) {
        console.error('Quest grid not found');
        return;
      }

      // Get user ID
      const session = getSession();
      const userId = session?.userId || localStorage.getItem('duelpvp_user_id');

      if (!userId) {
        questGrid.innerHTML = '<div class="no-data">Please log in to view quests</div>';
        return;
      }

      // Handle locked tabs
      if (type === 'weekly' || type === 'special') {
        questGrid.classList.add('locked');
        if (comingSoonOverlay) comingSoonOverlay.style.display = 'flex';
        questGrid.innerHTML = '<div class="no-data">Coming Soon</div>';
        return;
      } else {
        questGrid.classList.remove('locked');
        if (comingSoonOverlay) comingSoonOverlay.style.display = 'none';
        questGrid.style.opacity = '1';
        questGrid.style.filter = 'none';
        questGrid.style.pointerEvents = 'auto';
      }

      // Show loading
      questGrid.innerHTML = '<div class="no-data">Loading quests...</div>';

      try {
        // Fetch quests from server-side RPC
        const { data: questData, error: questError } = await supabase
          .rpc('get_user_quests', { p_user_id: userId });

        if (questError) {
          console.error('Quest load error:', questError);
          questGrid.innerHTML = '<div class="no-data">Error loading quests</div>';
          return;
        }

        // Filter quests based on tab type
        let questList = questData || [];
        if (type === 'completed') {
          questList = questList.filter(q => q.is_claimed);
        } else {
          // Show unclaimed quests
          questList = questList.filter(q => !q.is_claimed);
        }

        // Clear and render
        questGrid.innerHTML = '';

        if (questList.length === 0) {
          questGrid.innerHTML = '<div class="no-data">No quests available</div>';
          return;
        }

        // Quest icons - use logo for invite codes
        const questIcons = {
          'first_steps': '🎯',
          'invite_3_friends': '<img src="duelpvp-logo.svg" alt="Invite" style="width:20px;height:20px;vertical-align:middle;">',
          'fluffle_holder': '🐰',
          'bunnz_holder': '🔥',
          'megalio_holder': '🦁',
          'like_retweet': '❤️',
          'twitter_follow': '➕',
          'post_wallet': '💳'
        };

        // Render each quest
        questList.forEach(quest => {
          const isComplete = quest.is_completed;
          const isClaimed = quest.is_claimed;
          const icon = questIcons[quest.id] || '⭐';

          const card = document.createElement('div');
          card.className = 'quest-card' + (isComplete ? ' completed' : '') + (isComplete && !isClaimed ? ' claimable' : '');
          card.style.opacity = '1';
          card.style.visibility = 'visible';
          card.style.display = 'block';

          let html;

          // Simplified display for claimed quests
          if (isClaimed) {
            html = `
              <div class="quest-name"><span class="quest-icon">${icon}</span> ${quest.name}</div>
              <div style="text-align:center;padding:16px 0;color:#4CAF50;font-family:'Press Start 2P',monospace;font-size:12px;">
                +${quest.gc_reward} GC CLAIMED
              </div>
            `;
          } else {
            // Full display for unclaimed quests
            html = `
              <div class="quest-name"><span class="quest-icon">${icon}</span> ${quest.name}</div>
              <div class="quest-desc">${quest.description}</div>
              <div class="quest-progress">
            `;

            // Progress bar
            const pct = Math.min(100, (quest.progress / quest.target_count) * 100);
            html += `
              <div class="progress-bar"><div class="progress-fill" style="width:${pct}%"></div></div>
              <div class="progress-text">${quest.progress} / ${quest.target_count}</div>
            `;

            // Action button
            if (isComplete) {
              html += `<button class="action-btn btn-primary" style="width:100%;margin-top:8px;" onclick="claimQuestReward('${quest.id}')">CLAIM ${quest.gc_reward} GC</button>`;
            } else if (quest.id === 'invite_3_friends') {
              html += `<button class="action-btn btn-secondary" style="width:100%;margin-top:8px;" onclick="showInventory()">VIEW INVITE CODES</button>`;
            } else if (quest.id === 'like_retweet') {
              html += `<button class="action-btn btn-secondary" style="width:100%;margin-top:8px;" onclick="openLikeRetweetQuest()">START QUEST</button>`;
            } else if (quest.id === 'twitter_follow') {
              html += `<button class="action-btn btn-secondary" style="width:100%;margin-top:8px;" onclick="openTwitterFollowQuest()">START QUEST</button>`;
            } else if (quest.id === 'post_wallet') {
              html += `<button class="action-btn btn-secondary" style="width:100%;margin-top:8px;" onclick="openPostWalletQuest()">START QUEST</button>`;
            }

            html += `</div>`;
            html += `<div class="quest-reward">${quest.gc_reward} GC</div>`;
          }

          card.innerHTML = html;
          questGrid.appendChild(card);
        });

      } catch (err) {
        console.error('Quest system error:', err);
        questGrid.innerHTML = '<div class="no-data">Error loading quests</div>';
      }
    }

    // Claim quest reward
    async function claimQuestReward(questId) {
      const session = getSession();
      const userId = session?.userId || localStorage.getItem('duelpvp_user_id');

      Loading.show('Claiming reward...');

      try {
        const { data, error } = await supabase.rpc('claim_quest_reward', {
          p_quest_id: questId,
          p_user_id: userId
        });

        Loading.hide();

        if (error || !data?.success) {
          console.error('Claim error:', error || data?.error);
          Toast.error(data?.error || 'Failed to claim reward', 'ERROR');
          return;
        }

        // Clear GC cache and update display
        gcCache.lastFetch = 0;
        const newGP = await getUserGC();
        updateGCDisplay(newGP, data.reward);

        Toast.success(`+${data.reward} GC earned!`, 'QUEST COMPLETED');

        // Reload current tab
        const activeTab = document.querySelector('.quest-tab.active');
        const tabType = activeTab ? activeTab.getAttribute('data-quest-tab') : 'daily';
        loadQuests(tabType);

      } catch (err) {
        Loading.hide();
        console.error('Claim error:', err);
        Toast.error('An error occurred', 'ERROR');
      }
    }

    // Check NFT holder status on login
    async function checkNFTHolderQuests(walletAddress) {
      try {
        const { error } = await supabase.rpc('check_nft_holder_quests', {
          p_wallet_address: walletAddress.toLowerCase()
        });
        if (error) console.error('NFT check error:', error);
      } catch (err) {
        console.error('NFT check failed:', err);
      }
    }

    // Update quest progress
    async function updateQuestProgress(questId, amount = 1) {
      const session = getSession();
      const userId = session?.userId || localStorage.getItem('duelpvp_user_id');

      try {
        const { error } = await supabase.rpc('update_quest_progress', {
          p_quest_id: questId,
          p_increment: amount,
          p_user_id: userId
        });
        if (error) console.error('Progress update error:', error);
      } catch (err) {
        console.error('Progress update failed:', err);
      }
    }

    // X post sharing quest
    async function openSharePostQuest() {
      // Open the specific X post to retweet
      const postUrl = 'https://x.com/Duelpvp/status/1991226071639798202';
      window.open(postUrl, '_blank');

      // Show modal to submit retweet link
      const modalHtml = `
        <div style="text-align:center;">
          <p style="margin-bottom:16px;color:#e6ecf1;font-size:12px;">
            1. Retweet our post on X<br>
            2. Copy the link to your retweet<br>
            3. Paste it below to complete the quest
          </p>
          <input type="text" id="retweetLinkInput" placeholder="Paste your retweet link here..."
            style="width:100%;padding:12px;background:rgba(0,0,0,.4);border:2px solid rgba(255,214,77,.3);border-radius:8px;color:#e6ecf1;font-family:monospace;font-size:12px;margin-bottom:16px;">
          <div style="background:rgba(255,193,7,.1);border:1px solid rgba(255,193,7,.3);border-radius:8px;padding:12px;margin-bottom:16px;">
            <p style="color:#ffc107;font-size:10px;margin:0;">
              Note: Your submission will be manually verified. GC will be granted immediately but may be revoked if the retweet is not valid.
            </p>
          </div>
        </div>
      `;

      const confirmed = await Modal.show({ html: modalHtml, title: 'Retweet Quest', type: 'confirm' });
      if (!confirmed) return;

      const retweetLink = document.getElementById('retweetLinkInput')?.value?.trim();
      if (!retweetLink) {
        Toast.error('Please paste your retweet link', 'ERROR');
        return;
      }

      // Validate it looks like an X/Twitter link
      if (!retweetLink.includes('x.com/') && !retweetLink.includes('twitter.com/')) {
        Toast.error('Please paste a valid X/Twitter link', 'ERROR');
        return;
      }

      Loading.show('Submitting...');

      try {
        const session = getSession();
        const userId = session?.userId || localStorage.getItem('duelpvp_user_id');

        // Store the submission for manual review
        const { error: submitError } = await supabase
          .from('quest_submissions')
          .insert({
            user_id: userId,
            quest_id: 'share_post',
            submission_data: { retweet_url: retweetLink },
            status: 'pending'
          });

        if (submitError) {
          console.error('Submission error:', submitError);
          // Continue anyway - we'll still grant the GC
        }

        // Update quest progress
        await updateQuestProgress('share_post', 1);

        Loading.hide();
        Toast.success('+500 GC earned! (Subject to verification)', 'QUEST SUBMITTED');

        // Reload quests
        const activeTab = document.querySelector('.quest-tab.active');
        const tabType = activeTab ? activeTab.getAttribute('data-quest-tab') : 'daily';
        loadQuests(tabType);

      } catch (err) {
        Loading.hide();
        console.error('Quest submission error:', err);
        Toast.error('Failed to submit', 'ERROR');
      }
    }

    // Like & Retweet quest
    async function openLikeRetweetQuest() {
      // Open the specific X post to like and retweet
      const postUrl = 'https://x.com/Duelpvp/status/1991226071639798202';
      window.open(postUrl, '_blank');

      // Show modal to submit link
      const modalHtml = `
        <div style="text-align:center;">
          <p style="margin-bottom:16px;color:#e6ecf1;font-size:12px;">
            1. Like and retweet our post on X<br>
            2. Copy the link to your retweet<br>
            3. Paste it below to complete the quest
          </p>
          <input type="text" id="likeRetweetLinkInput" placeholder="Paste your retweet link here..."
            style="width:100%;padding:12px;background:rgba(0,0,0,.4);border:2px solid rgba(255,214,77,.3);border-radius:8px;color:#e6ecf1;font-family:monospace;font-size:12px;margin-bottom:16px;">
          <div style="background:rgba(255,193,7,.1);border:1px solid rgba(255,193,7,.3);border-radius:8px;padding:12px;margin-bottom:16px;">
            <p style="color:#ffc107;font-size:10px;margin:0;">
              Note: Your submission will be manually verified. GC will be granted immediately but may be revoked if the like/retweet is not valid.
            </p>
          </div>
        </div>
      `;

      const confirmed = await Modal.show({ html: modalHtml, title: 'Like & Retweet Quest', type: 'confirm' });
      if (!confirmed) return;

      const likeRetweetLink = document.getElementById('likeRetweetLinkInput')?.value?.trim();
      if (!likeRetweetLink) {
        Toast.error('Please paste your retweet link', 'ERROR');
        return;
      }

      // Validate it looks like an X/Twitter link
      if (!likeRetweetLink.includes('x.com/') && !likeRetweetLink.includes('twitter.com/')) {
        Toast.error('Please paste a valid X/Twitter link', 'ERROR');
        return;
      }

      Loading.show('Submitting...');

      try {
        const session = getSession();
        const userId = session?.userId || localStorage.getItem('duelpvp_user_id');

        // Complete and claim the quest in one call
        const { data, error } = await supabase.rpc('complete_manual_quest', {
          p_quest_id: 'like_retweet',
          p_user_id: userId
        });

        Loading.hide();

        if (error || !data?.success) {
          console.error('Quest error:', error || data?.error);
          Toast.error(data?.error || 'Failed to complete quest', 'ERROR');
        } else {
          // Clear GC cache and update display
          gcCache.lastFetch = 0;
          const newGC = await getUserGC();
          updateGCDisplay(newGC, data.reward);
          Toast.success(`+${data.reward} GC earned!`, 'QUEST COMPLETED');
        }

        // Reload quests
        const activeTab = document.querySelector('.quest-tab.active');
        const tabType = activeTab ? activeTab.getAttribute('data-quest-tab') : 'daily';
        loadQuests(tabType);

      } catch (err) {
        Loading.hide();
        console.error('Quest submission error:', err);
        Toast.error('Failed to submit', 'ERROR');
      }
    }

    // Twitter Follow quest
    async function openTwitterFollowQuest() {
      // Open the Duelpvp X profile to follow
      const profileUrl = 'https://x.com/Duelpvp';
      window.open(profileUrl, '_blank');

      // Show modal to submit X account link
      const modalHtml = `
        <div style="text-align:center;">
          <p style="margin-bottom:16px;color:#e6ecf1;font-size:12px;">
            1. Follow @Duelpvp on X<br>
            2. Copy the link to your X profile<br>
            3. Paste it below to verify you're following
          </p>
          <input type="text" id="twitterFollowLinkInput" placeholder="Paste your X profile link here..."
            style="width:100%;padding:12px;background:rgba(0,0,0,.4);border:2px solid rgba(255,214,77,.3);border-radius:8px;color:#e6ecf1;font-family:monospace;font-size:12px;margin-bottom:16px;">
          <div style="background:rgba(255,193,7,.1);border:1px solid rgba(255,193,7,.3);border-radius:8px;padding:12px;margin-bottom:16px;">
            <p style="color:#ffc107;font-size:10px;margin:0;">
              Note: Your submission will be manually verified. GC will be granted immediately but may be revoked if you are not following.
            </p>
          </div>
        </div>
      `;

      const confirmed = await Modal.show({ html: modalHtml, title: 'Follow Quest', type: 'confirm' });
      if (!confirmed) return;

      const twitterFollowLink = document.getElementById('twitterFollowLinkInput')?.value?.trim();
      if (!twitterFollowLink) {
        Toast.error('Please paste your X profile link', 'ERROR');
        return;
      }

      // Validate it looks like an X/Twitter link
      if (!twitterFollowLink.includes('x.com/') && !twitterFollowLink.includes('twitter.com/')) {
        Toast.error('Please paste a valid X/Twitter profile link', 'ERROR');
        return;
      }

      Loading.show('Submitting...');

      try {
        const session = getSession();
        const userId = session?.userId || localStorage.getItem('duelpvp_user_id');

        // Complete and claim the quest in one call
        const { data, error } = await supabase.rpc('complete_manual_quest', {
          p_quest_id: 'twitter_follow',
          p_user_id: userId
        });

        Loading.hide();

        if (error || !data?.success) {
          console.error('Quest error:', error || data?.error);
          Toast.error(data?.error || 'Failed to complete quest', 'ERROR');
        } else {
          // Clear GC cache and update display
          gcCache.lastFetch = 0;
          const newGC = await getUserGC();
          updateGCDisplay(newGC, data.reward);
          Toast.success(`+${data.reward} GC earned!`, 'QUEST COMPLETED');
        }

        // Reload quests
        const activeTab = document.querySelector('.quest-tab.active');
        const tabType = activeTab ? activeTab.getAttribute('data-quest-tab') : 'daily';
        loadQuests(tabType);

      } catch (err) {
        Loading.hide();
        console.error('Quest submission error:', err);
        Toast.error('Failed to submit', 'ERROR');
      }
    }

    // Post Wallet quest
    async function openPostWalletQuest() {
      // Open the specific tweet to post wallet under
      const tweetUrl = 'https://x.com/Duelpvp/status/1991529218593943677?s=20';
      window.open(tweetUrl, '_blank');

      // Show modal to submit tweet reply link
      const modalHtml = `
        <div style="text-align:center;">
          <p style="margin-bottom:16px;color:#e6ecf1;font-size:12px;">
            1. Post your EVM wallet address as a reply to our tweet<br>
            2. Copy the link to your reply<br>
            3. Paste it below to complete the quest
          </p>
          <input type="text" id="walletReplyLinkInput" placeholder="Paste your tweet reply link here..."
            style="width:100%;padding:12px;background:rgba(0,0,0,.4);border:2px solid rgba(255,214,77,.3);border-radius:8px;color:#e6ecf1;font-family:monospace;font-size:12px;margin-bottom:16px;">
          <div style="background:rgba(255,193,7,.1);border:1px solid rgba(255,193,7,.3);border-radius:8px;padding:12px;margin-bottom:16px;">
            <p style="color:#ffc107;font-size:10px;margin:0;">
              Note: Your submission will be manually verified. GC will be granted immediately but may be revoked if the wallet address is not posted under the tweet.
            </p>
          </div>
        </div>
      `;

      const confirmed = await Modal.show({ html: modalHtml, title: 'Post Wallet Quest', type: 'confirm' });
      if (!confirmed) return;

      const walletReplyLink = document.getElementById('walletReplyLinkInput')?.value?.trim();
      if (!walletReplyLink) {
        Toast.error('Please paste your tweet reply link', 'ERROR');
        return;
      }

      // Validate it looks like an X/Twitter link
      if (!walletReplyLink.includes('x.com/') && !walletReplyLink.includes('twitter.com/')) {
        Toast.error('Please paste a valid X/Twitter link', 'ERROR');
        return;
      }

      Loading.show('Submitting...');

      try {
        const session = getSession();
        const userId = session?.userId || localStorage.getItem('duelpvp_user_id');

        // Complete and claim the quest in one call
        const { data, error } = await supabase.rpc('complete_manual_quest', {
          p_quest_id: 'post_wallet',
          p_user_id: userId
        });

        Loading.hide();

        if (error || !data?.success) {
          console.error('Quest error:', error || data?.error);
          Toast.error(data?.error || 'Failed to complete quest', 'ERROR');
        } else {
          // Clear GC cache and update display
          gcCache.lastFetch = 0;
          const newGC = await getUserGC();
          updateGCDisplay(newGC, data.reward);
          Toast.success(`+${data.reward} GC earned!`, 'QUEST COMPLETED');
        }

        // Reload quests
        const activeTab = document.querySelector('.quest-tab.active');
        const tabType = activeTab ? activeTab.getAttribute('data-quest-tab') : 'daily';
        loadQuests(tabType);

      } catch (err) {
        Loading.hide();
        console.error('Quest submission error:', err);
        Toast.error('Failed to submit', 'ERROR');
      }
    }

    // Inventory and Shop System
    const SHOP_ITEMS = [
      {id: 'sword_bronze', name: 'Bronze Sword', desc: 'A sturdy starter weapon', price: 1000, icon: '🗡️', type: 'weapon'},
      {id: 'sword_iron', name: 'Iron Sword', desc: 'Sharper than bronze', price: 2500, icon: '⚔️', type: 'weapon'},
      {id: 'sword_steel', name: 'Steel Sword', desc: 'Forged with precision', price: 5000, icon: '🗡️', type: 'weapon'},
      {id: 'armor_leather', name: 'Leather Armor', desc: 'Basic protection', price: 1500, icon: '🛡️', type: 'armor'},
      {id: 'armor_chain', name: 'Chain Mail', desc: 'Medium protection', price: 3500, icon: '🛡️', type: 'armor'},
      {id: 'armor_plate', name: 'Plate Armor', desc: 'Heavy protection', price: 7500, icon: '🛡️', type: 'armor'},
      {id: 'potion_health', name: 'Health Potion', desc: 'Restores vitality', price: 500, icon: '🧪', type: 'consumable'},
      {id: 'potion_speed', name: 'Speed Potion', desc: 'Boosts reflexes', price: 750, icon: '⚗️', type: 'consumable'},
      {id: 'cape_red', name: 'Red Cape', desc: 'Show off your style', price: 2000, icon: '🎽', type: 'cosmetic'},
      {id: 'cape_blue', name: 'Blue Cape', desc: 'Cool and collected', price: 2000, icon: '🎽', type: 'cosmetic'},
      {id: 'pet_dog', name: 'War Hound', desc: 'A loyal companion', price: 10000, icon: '🐕', type: 'pet'},
      {id: 'pet_dragon', name: 'Baby Dragon', desc: 'Rare and powerful', price: 50000, icon: '🐉', type: 'pet'}
    ];

    // Show inventory screen
    function showInventory() {
      swapContent('inventory');
    }

    async function loadInventory() {
      const session = getSession();
      const userId = session?.userId;

      if (!userId) {
        console.warn('No user ID found, skipping inventory load');
        return;
      }

      console.log('Loading inventory for user:', userId);

      // Get user's invite codes using RPC function (only returns unused codes)
      const { data: codesData, error: codesError } = await supabase
        .rpc('get_user_invite_codes', { p_user_id: userId });

      console.log('Codes response:', { codesData, codesError });

      if (codesError) {
        console.error('Failed to get codes:', codesError);
      }

      // Map invite codes (only unused ones are returned)
      let inviteCodes = codesData && codesData.length > 0
        ? codesData.map(c => ({
            code: c.code,
            created_at: c.created_at
          }))
        : [];

      // Render inventory
      const inventoryGrid = document.getElementById('inventoryGrid');
      inventoryGrid.innerHTML = '';

      // Show 3 slots for invite codes (user gets 3 codes)
      const numSlots = 3;
      for (let i = 0; i < numSlots; i++) {
        const item = inviteCodes[i];
        const slot = document.createElement('div');

        if (item) {
          // Invite code item (only unused codes shown)
          slot.className = 'inventory-slot invite-code';
          slot.innerHTML = `
            <div class="item-icon">
              <img src="duelpvp-logo.svg" alt="Invite Code" style="width:28px;height:28px;">
            </div>
            <div class="item-name">${item.code}</div>
          `;
          // Tooltip
          slot.title = `Invite Code\nClick to copy!\nShare this code with friends!`;

          // Add click-to-copy
          slot.style.cursor = 'pointer';
          slot.addEventListener('click', () => {
            copyToClipboard(item.code);
            Toast.success(`Code ${item.code} copied!`, 'SHARE WITH FRIENDS');
          });
        } else {
          // Empty slot (code was used)
          slot.className = 'inventory-slot empty';
          slot.innerHTML = '<div style="opacity:0.3;font-size:10px;">USED</div>';
        }

        inventoryGrid.appendChild(slot);
      }

      // Get user data for shop
      const { data: userData } = await supabase
        .from('users')
        .select('points')
        .eq('id', userId)
        .single();

      const gp = userData?.points || 0;

      // Render shop
      const shopGrid = document.getElementById('shopGrid');
      shopGrid.innerHTML = '';

      SHOP_ITEMS.forEach(item => {
        const shopCard = document.createElement('div');
        shopCard.className = 'shop-item';
        shopCard.innerHTML = `
          <div class="item-icon">${item.icon}</div>
          <div class="shop-item-name">${item.name}</div>
          <div class="shop-item-desc">${item.desc}</div>
          <div class="shop-item-price">${item.price.toLocaleString()} GC</div>
          <button class="buy-btn" ${gp < item.price ? 'disabled' : ''}>BUY</button>
        `;

        const buyBtn = shopCard.querySelector('.buy-btn');
        buyBtn.addEventListener('click', () => buyItem(item));

        shopGrid.appendChild(shopCard);
      });
    }

    function buyItem(item) {
      const email = localStorage.getItem('duelpvp_email') || 'anonymous';
      let gp = parseInt(localStorage.getItem('duelpvp_gc') || '0');
      let inventory = JSON.parse(localStorage.getItem(`duelpvp_inventory_${email}`) || '[]');

      if (gp < item.price) {
        Modal.alert('Not enough GC! Complete quests or play games to earn more.', 'Insufficient Funds');
        return;
      }

      // Check if inventory is full
      if (inventory.length >= 28 && !inventory.find(i => i.id === item.id && item.type === 'consumable')) {
        Modal.alert('Your inventory is full! Maximum 28 items can be held.', 'Inventory Full');
        return;
      }

      // Deduct GC
      gp -= item.price;
      localStorage.setItem('duelpvp_gc', gp.toString());

      // Add to inventory
      if (item.type === 'consumable') {
        const existing = inventory.find(i => i.id === item.id);
        if (existing) {
          existing.count++;
        } else {
          inventory.push({id: item.id, count: 1});
        }
      } else {
        inventory.push({id: item.id, count: 1});
      }

      localStorage.setItem(`duelpvp_inventory_${email}`, JSON.stringify(inventory));

      // Update quest progress
      updateQuestProgress('weekly_shop');

      // Reload
      loadInventory();
      Toast.success(`${item.icon} ${item.name} added to inventory!`, 'ITEM PURCHASED');
    }

    // ===============================================
    // STAKING SYSTEM (SERVER-SIDE SECURE)
    // ===============================================
    // All calculations happen server-side to prevent cheating

    // ===============================================
    // GC BALANCE SYSTEM (SECURE - DATABASE BACKED)
    // ===============================================

    // Cache for GC balance to reduce database queries
    let gcCache = {
      balance: 0,
      lastFetch: 0,
      cacheTime: 5000 // Cache for 5 seconds
    };

    // Helper functions for GC
    async function getUserGC() {
      // Get user ID from session or old localStorage format
      const session = getSession();
      const userId = session?.userId || localStorage.getItem('duelpvp_user_id');

      // Fallback to localStorage for test mode
      if (!userId || userId.startsWith('test-')) {
        return parseInt(localStorage.getItem('duelpvp_gc')) || 0;
      }

      // Check cache first
      const now = Date.now();
      if (gcCache.lastFetch && (now - gcCache.lastFetch < gcCache.cacheTime)) {
        return gcCache.balance;
      }

      try {
        // Fetch GC directly from users table (most reliable method)
        const { data: userData, error: userError } = await supabase
          .from('users')
          .select('gc_balance')
          .eq('id', userId)
          .single();

        console.log('getUserGC result:', { userData, userError, userId });

        if (!userError && userData) {
          const balance = userData.gc_balance || 0;
          gcCache.balance = balance;
          gcCache.lastFetch = now;
          return balance;
        }

        // If direct fetch failed, try RPC as fallback
        const { data, error } = await supabase
          .rpc('get_user_gc', { p_user_id: userId });

        console.log('get_user_gc RPC result:', { data, error });

        if (error) {
          console.error('Failed to fetch GC:', error);
          return parseInt(localStorage.getItem('duelpvp_gc')) || 0;
        }

        gcCache.balance = data || 0;
        gcCache.lastFetch = now;
        return data || 0;
      } catch (e) {
        console.error('Error getting GC:', e);
        return parseInt(localStorage.getItem('duelpvp_gc')) || 0;
      }
    }

    function getUserLevel() {
      const gp = gcCache.balance || parseInt(localStorage.getItem('duelpvp_gc')) || 0;
      // Calculate level based on GC (every 50,000 GC = 1 level)
      return Math.floor(gp / 50000) + 1;
    }

    async function updateUserGC(amount, gameType = null) {
      // Get user ID from session or old localStorage format
      const session = getSession();
      const userId = session?.userId || localStorage.getItem('duelpvp_user_id');

      // Fallback to localStorage for test mode
      if (!userId || userId.startsWith('test-')) {
        const currentGP = parseInt(localStorage.getItem('duelpvp_gc')) || 0;
        const newGP = currentGP + amount;

        // Prevent negative balance even in test mode
        if (newGP < 0) {
          Toast.error('Insufficient balance', 'TRANSACTION FAILED');
          return currentGP;
        }

        localStorage.setItem('duelpvp_gc', newGP.toString());

        // Update UI
        updateGCDisplay(newGP, amount);
        return newGP;
      }

      try {
        // Debug: Check session state before RPC call
        const { data: { session: currentSession } } = await supabase.auth.getSession();
        console.log('[GP Update] Session check before RPC:', {
          hasSession: !!currentSession,
          userId: currentSession?.user?.id,
          tokenPreview: currentSession?.access_token?.substring(0, 20) + '...'
        });

        // Try secure JWT-based function first
        const transactionType = amount > 0 ? 'game_win' : 'game_loss';
        console.log('[GP Update] Calling secure_update_gp with:', { amount, transactionType, gameType });
        let result = await supabase.rpc('secure_update_gp', {
          p_amount: amount,
          p_transaction_type: transactionType,
          p_game_type: gameType
        });
        console.log('[GP Update] RPC result:', result);

        // If secure function fails, fallback to old function
        if (result.error) {
          console.log('Secure update failed, using fallback:', result.error);
          result = await supabase.rpc('update_user_gp', {
            p_user_id: userId,
            p_amount: amount
          });
        }

        const { data, error } = result;

        if (error) {
          console.error('Failed to update GC:', error);

          // If database function doesn't exist, fall back to localStorage with validation
          if (error.message && error.message.includes('function') && error.message.includes('does not exist')) {
            Toast.error('Database not configured! Using localStorage fallback.', 'WARNING');

            const currentGP = parseInt(localStorage.getItem('duelpvp_gc')) || 0;
            const newGP = currentGP + amount;

            // Prevent negative balance
            if (newGP < 0) {
              Toast.error('Insufficient balance', 'TRANSACTION FAILED');
              return currentGP;
            }

            localStorage.setItem('duelpvp_gc', newGP.toString());
            gcCache.balance = newGP;
            gcCache.lastFetch = Date.now();
            updateGCDisplay(newGP, amount);
            return newGP;
          }

          Toast.error('Failed to update balance', 'ERROR');
          return gcCache.balance;
        }

        // Check if update was successful
        if (!data || data.length === 0 || !data[0].success) {
          const message = data && data[0] ? data[0].message : 'Update failed';
          Toast.error(message, 'TRANSACTION FAILED');
          return gcCache.balance;
        }

        const newBalance = data[0].new_balance;

        // Update cache
        gcCache.balance = newBalance;
        gcCache.lastFetch = Date.now();

        // Update UI
        updateGCDisplay(newBalance, amount);

        return newBalance;
      } catch (e) {
        console.error('Error updating GC:', e);
        Toast.error('Connection error', 'ERROR');
        return gcCache.balance;
      }
    }

    // Create gold particle effect
    function createGoldParticles(element, count = 12) {
      if (!element) return;

      const rect = element.getBoundingClientRect();
      const centerX = rect.left + rect.width / 2;
      const centerY = rect.top + rect.height / 2;

      for (let i = 0; i < count; i++) {
        const particle = document.createElement('div');
        particle.className = 'gold-particle';
        particle.style.left = centerX + 'px';
        particle.style.top = centerY + 'px';

        // Random direction
        const angle = (Math.PI * 2 * i) / count;
        const distance = 60 + Math.random() * 40;
        const tx = Math.cos(angle) * distance;
        const ty = Math.sin(angle) * distance - 20; // Slight upward bias

        particle.style.setProperty('--tx', tx + 'px');
        particle.style.setProperty('--ty', ty + 'px');

        document.body.appendChild(particle);

        // Remove after animation
        setTimeout(() => particle.remove(), 800);
      }
    }

    // Helper function to update GC displays across the UI
    function updateGCDisplay(newGP, changeAmount) {
      // Update dashboard display if visible with animation
      const dashboardGPEl = document.getElementById('dashboardGCBalance');
      if (dashboardGPEl) {
        const displayGP = newGP;
        const formattedGP = displayGP >= 1000000 ? `${(displayGP/1000000).toFixed(1)}M` : displayGP >= 1000 ? `${(displayGP/1000).toFixed(1)}K` : displayGP;

        // Apply animation
        dashboardGPEl.classList.remove('gp-change', 'gp-increase', 'gp-decrease');
        void dashboardGPEl.offsetWidth; // Trigger reflow
        dashboardGPEl.classList.add('gp-change');

        if (changeAmount > 0) {
          dashboardGPEl.classList.add('gp-increase');
          // Trigger gold particles on GC gain
          createGoldParticles(dashboardGPEl);
        } else if (changeAmount < 0) {
          dashboardGPEl.classList.add('gp-decrease');
        }

        dashboardGPEl.textContent = formattedGP;

        // Remove animation classes after animation completes
        setTimeout(() => {
          dashboardGPEl.classList.remove('gp-change', 'gp-increase', 'gp-decrease');
        }, 300);
      }

      // Update campaign progress
      const campaignCurrentGC = document.getElementById('campaignCurrentGC');
      const campaignProgressFill = document.getElementById('campaignProgressFill');
      if (campaignCurrentGC && campaignProgressFill) {
        campaignCurrentGC.textContent = newGP.toLocaleString();
        const progress = Math.min((newGP / 1000000) * 100, 100);
        campaignProgressFill.style.width = progress + '%';
      }
    }

    // Initialize GC cache on login/page load
    async function initializeGCCache() {
      // Get user ID from session or old localStorage format
      const session = getSession();
      const userId = session?.userId || localStorage.getItem('duelpvp_user_id');
      if (userId && !userId.startsWith('test-')) {
        await getUserGC(); // This will populate the cache
      }
    }

    // Load and display user's invite code
    async function loadUserInviteCode() {
      const inviteCodeEl = document.getElementById('userInviteCode');
      if (!inviteCodeEl) return;

      const session = getSession();
      const userId = session?.userId;
      if (!userId) {
        inviteCodeEl.textContent = 'No code yet';
        return;
      }

      try {
        const { data, error } = await supabase
          .rpc('get_user_invite_codes', { p_user_id: userId });

        if (error) {
          console.error('Error loading invite code:', error);
          inviteCodeEl.textContent = 'Error loading';
          return;
        }

        // Find first unused code
        const unusedCode = data && data.find(c => !c.used);
        if (unusedCode) {
          inviteCodeEl.textContent = unusedCode.code;
        } else {
          inviteCodeEl.textContent = 'All codes used';
        }
      } catch (err) {
        console.error('Failed to load invite code:', err);
        inviteCodeEl.textContent = 'Error';
      }
    }

    // Update campaign page with current stats
    async function updateCampaignPage() {
      const currentGP = await getUserGC();

      // Update current GC on page
      const currentGPPageEl = document.getElementById('campaignCurrentGCPage');
      if (currentGPPageEl) {
        currentGPPageEl.textContent = currentGP.toLocaleString();
      }

      // Update progress bar and percentage
      const progress = Math.min((currentGP / 1000000) * 100, 100);
      const progressFillEl = document.getElementById('campaignProgressFillLarge');
      if (progressFillEl) {
        progressFillEl.style.width = progress + '%';
      }

      const progressPercentageEl = document.getElementById('campaignProgressPercentage');
      if (progressPercentageEl) {
        progressPercentageEl.textContent = progress.toFixed(1) + '%';
      }
    }

    // ===============================================
    // SERVER-SIDE STAKING SYSTEM (OVEN)
    // ===============================================
    let ovenUpdateInterval = null;

    async function initOven() {
      await updateOvenDisplay();
      startOvenAutoUpdate();
    }

    async function updateOvenDisplay() {
      try {
        // Get user balance
        const userGP = await getUserGC();
        const balanceEl = document.getElementById('ovenUserBalance');
        if (balanceEl) balanceEl.textContent = Math.floor(userGP).toLocaleString() + ' GC';

        // Get staking info from server
        const { data, error } = await supabase.rpc('get_stake_value');

        if (error) {
          console.error('Failed to get stake value:', error);
          document.getElementById('ovenInvested').textContent = '0 GC';
          document.getElementById('ovenCurrentValue').textContent = '0 GC';
          document.getElementById('ovenTimer').textContent = 'No active investment';
          return;
        }

        const principal = data?.principal || 0;
        const currentValue = data?.current_value || 0;
        const profit = data?.profit || 0;
        const apy = data?.apy || 0;

        // Update display
        document.getElementById('ovenInvested').textContent = principal.toLocaleString() + ' GC';
        document.getElementById('ovenCurrentValue').textContent = currentValue.toLocaleString() + ' GC';

        if (principal > 0) {
          // Show APY and profit
          document.getElementById('ovenTimer').textContent =
            `Profit: +${profit.toLocaleString()} GC | APY: ${apy > 1000000 ? '>1,000,000' : apy.toLocaleString()}%`;
        } else {
          document.getElementById('ovenTimer').textContent = 'No active investment';
        }
      } catch (e) {
        console.error('Error updating oven display:', e);
      }
    }

    function startOvenAutoUpdate() {
      // Clear existing interval
      if (ovenUpdateInterval) {
        clearInterval(ovenUpdateInterval);
      }

      // Update display every 2 seconds to show live compounding
      ovenUpdateInterval = setInterval(async () => {
        await updateOvenDisplay();
      }, 2000);
    }

    async function depositToOven() {
      const amount = parseInt(document.getElementById('ovenDepositAmount').value);

      if (isNaN(amount) || amount <= 0) {
        Toast.error('Please enter a valid amount', 'INVALID');
        return;
      }

      Loading.show();

      try {
        // Call server-side deposit function
        const { data, error } = await supabase.rpc('stake_deposit', {
          p_amount: amount
        });

        Loading.hide();

        if (error) {
          console.error('Deposit error:', error);
          Toast.error('Failed to deposit: ' + error.message, 'ERROR');
          return;
        }

        if (!data.success) {
          Toast.error(data.message, 'DEPOSIT FAILED');
          return;
        }

        // Success!
        document.getElementById('ovenDepositAmount').value = '';
        Toast.success(`Deposited ${amount.toLocaleString()} GC to staking!`, 'DEPOSIT');

        // Refresh display and GC cache
        gcCache.lastFetch = 0;
        await updateOvenDisplay();

      } catch (e) {
        Loading.hide();
        console.error('Deposit exception:', e);
        Toast.error('An error occurred during deposit', 'ERROR');
      }
    }

    async function withdrawFromOven() {
      Loading.show();

      try {
        // Get current value first
        const { data: valueData } = await supabase.rpc('get_stake_value');

        const currentValue = valueData?.current_value || 0;

        if (currentValue <= 0) {
          Loading.hide();
          Toast.error('No investment to withdraw', 'NO INVESTMENT');
          return;
        }

        Loading.hide();

        // Confirm withdrawal
        const confirmed = await Modal.confirm(
          `Withdraw ${currentValue.toLocaleString()} GC from staking?`,
          'Confirm Withdrawal'
        );
        if (!confirmed) return;

        Loading.show();

        // Call server-side withdraw function
        const { data, error } = await supabase.rpc('stake_withdraw');

        Loading.hide();

        if (error) {
          console.error('Withdraw error:', error);
          Toast.error('Failed to withdraw: ' + error.message, 'ERROR');
          return;
        }

        if (!data.success) {
          Toast.error(data.message, 'WITHDRAW FAILED');
          return;
        }

        // Success!
        Toast.success(`Withdrawn ${data.amount_withdrawn.toLocaleString()} GC!`, 'WITHDRAW');

        // Refresh display and GC cache
        gcCache.lastFetch = 0;
        await updateOvenDisplay();

      } catch (e) {
        Loading.hide();
        console.error('Withdraw exception:', e);
        Toast.error('An error occurred during withdrawal', 'ERROR');
      }
    }

    // ===============================================
    // AIRDROP FARM SYSTEM
    // ===============================================

    let farmState = {
      totalEarned: 0,
      todayEarned: 0,
      totalClicks: 0,
      lastClickTime: null,
      lastResetDate: null,
      cooldownActive: false,
      cooldownInterval: null
    };

    function loadFarmState() {
      const saved = localStorage.getItem('duelpvp_farm');
      if (saved) {
        try {
          const data = JSON.parse(saved);
          farmState = { ...farmState, ...data };

          // Reset daily stats if new day
          const today = new Date().toDateString();
          if (farmState.lastResetDate !== today) {
            farmState.todayEarned = 0;
            farmState.lastResetDate = today;
            saveFarmState();
          }
        } catch (e) {
          console.error('Failed to load farm state:', e);
        }
      } else {
        // Initialize with today's date
        farmState.lastResetDate = new Date().toDateString();
        saveFarmState();
      }
    }

    function saveFarmState() {
      localStorage.setItem('duelpvp_farm', JSON.stringify(farmState));
    }

    function updateFarmDisplay() {
      const totalEl = document.getElementById('farmTotalEarned');
      const todayEl = document.getElementById('farmTodayEarned');
      const clicksEl = document.getElementById('farmTotalClicks');

      if (totalEl) totalEl.textContent = Math.floor(farmState.totalEarned).toLocaleString() + ' GC';
      if (todayEl) todayEl.textContent = Math.floor(farmState.todayEarned).toLocaleString() + ' GC';
      if (clicksEl) clicksEl.textContent = farmState.totalClicks.toLocaleString();
    }

    function initFarm() {
      loadFarmState();
      updateFarmDisplay();

      // Check if cooldown should still be active
      if (farmState.lastClickTime) {
        const timeSince = Date.now() - farmState.lastClickTime;
        if (timeSince < 5000) {
          startFarmCooldown(5000 - timeSince);
        }
      }
    }

    function getRandomReward() {
      const rand = Math.random() * 100;

      // 80% chance: 0 GC
      if (rand < 80) {
        return { amount: 0, tier: 'miss' };
      }
      // 15% chance: 20 GC
      else if (rand < 95) {
        return { amount: 20, tier: 'common' };
      }
      // 4% chance: 150 GC
      else if (rand < 99) {
        return { amount: 150, tier: 'rare' };
      }
      // 1% chance: 1500 GC
      else {
        return { amount: 1500, tier: 'jackpot' };
      }
    }

    function clickFarm() {
      if (farmState.cooldownActive) return;

      const reward = getRandomReward();
      const resultEl = document.getElementById('farmResult');
      const btn = document.getElementById('farmClickBtn');

      // Update stats
      farmState.totalClicks++;
      if (reward.amount > 0) {
        farmState.totalEarned += reward.amount;
        farmState.todayEarned += reward.amount;
        updateUserGC(reward.amount, 'farm');
      }
      farmState.lastClickTime = Date.now();
      saveFarmState();
      updateFarmDisplay();

      // Show result with animation
      resultEl.className = 'farm-result';
      if (reward.tier === 'miss') {
        resultEl.textContent = '✕ 0 GC';
        resultEl.classList.add('flash-red');
      } else if (reward.tier === 'common') {
        resultEl.textContent = '✓ +' + reward.amount + ' GC';
        resultEl.classList.add('flash-green');
      } else if (reward.tier === 'rare') {
        resultEl.textContent = '✓ +' + reward.amount + ' GC';
        resultEl.classList.add('flash-green');
      } else {
        resultEl.textContent = '🎉 ✓ +' + reward.amount + ' GC 🎉';
        resultEl.classList.add('flash-gold');
      }

      // Clear result after animation
      setTimeout(() => {
        resultEl.className = 'farm-result';
        resultEl.textContent = '';
      }, 3000);

      // Start cooldown
      startFarmCooldown(5000);
    }

    function startFarmCooldown(duration) {
      farmState.cooldownActive = true;
      const btn = document.getElementById('farmClickBtn');
      const cooldownEl = document.getElementById('farmCooldown');
      const timerEl = document.getElementById('farmCooldownTimer');
      const fillEl = document.getElementById('farmCooldownFill');

      if (btn) btn.disabled = true;
      if (cooldownEl) cooldownEl.style.display = 'block';

      let remaining = duration;
      const startTime = Date.now();

      if (farmState.cooldownInterval) clearInterval(farmState.cooldownInterval);

      farmState.cooldownInterval = setInterval(() => {
        const elapsed = Date.now() - startTime;
        remaining = Math.max(0, duration - elapsed);
        const seconds = Math.ceil(remaining / 1000);
        const progress = ((duration - remaining) / duration) * 100;

        if (timerEl) timerEl.textContent = seconds;
        if (fillEl) fillEl.style.width = progress + '%';

        if (remaining <= 0) {
          clearInterval(farmState.cooldownInterval);
          farmState.cooldownActive = false;
          if (btn) btn.disabled = false;
          if (cooldownEl) cooldownEl.style.display = 'none';
          if (fillEl) fillEl.style.width = '0%';
        }
      }, 100);
    }

    // ===============================================
    // MINES GAME SYSTEM
    // ===============================================

    let minesGameState = {
      isPlaying: false,
      betAmount: 0,
      minesCount: 5,
      revealedCount: 0,
      grid: [],
      minePositions: [],
      multiplier: 0
    };

    function initMinesGame() {
      // Prevent re-initialization during active game
      if (minesGameState.isPlaying) {
        console.log('[Mines] Cannot reinitialize grid during active game');
        return;
      }

      const grid = document.getElementById('minesGrid');
      grid.innerHTML = '';

      // Create 5x5 grid
      for (let i = 0; i < 25; i++) {
        const tile = document.createElement('div');
        tile.className = 'mines-tile';
        tile.dataset.index = i;
        tile.dataset.clicked = 'false'; // Track if tile has been clicked
        tile.addEventListener('click', function handleClick() {
          // Immediately remove listener to prevent double-firing
          tile.removeEventListener('click', handleClick);
          handleMinesTileClick(i);
        }, { once: true }); // Use 'once' option as additional safety
        grid.appendChild(tile);
      }
    }

    async function updateMinesGCDisplay() {
      const gp = await getUserGC();
      document.getElementById('minesGCDisplay').textContent = gp;
    }

    async function startMinesGame() {
      const betAmount = parseInt(document.getElementById('minesBetAmount').value);
      const minesCount = parseInt(document.getElementById('minesCount').value);
      const userGP = await getUserGC();

      // Validation
      if (isNaN(betAmount) || betAmount < 10) {
        Toast.error('Minimum bet is 10 GC', 'INVALID BET');
        return;
      }

      if (betAmount > 10000) {
        Toast.error('Maximum bet is 10,000 GC', 'INVALID BET');
        return;
      }

      if (betAmount > userGP) {
        Toast.error('Insufficient GC', 'INSUFFICIENT FUNDS');
        return;
      }

      // Deduct bet
      updateUserGC(-betAmount, 'mines');
      updateMinesGCDisplay();

      // Reset grid BEFORE setting isPlaying to true
      initMinesGame();

      // Initialize game state
      minesGameState = {
        isPlaying: true,
        betAmount: betAmount,
        minesCount: minesCount,
        revealedCount: 0,
        grid: new Array(25).fill(false),
        minePositions: generateMinePositions(minesCount),
        multiplier: 1.0
      };

      // Update UI
      document.getElementById('minesStartBtn').style.display = 'none';
      document.getElementById('minesCashoutBtn').style.display = 'block';
      document.getElementById('minesBetAmount').disabled = true;
      document.getElementById('minesCount').disabled = true;

      updateMinesStats();

      Toast.success(`Game started with ${minesCount} mines!`, 'MINES');
    }

    function generateMinePositions(count) {
      const positions = [];
      while (positions.length < count) {
        const pos = Math.floor(Math.random() * 25);
        if (!positions.includes(pos)) {
          positions.push(pos);
        }
      }
      return positions;
    }

    function handleMinesTileClick(index) {
      if (!minesGameState.isPlaying) return;
      if (minesGameState.grid[index]) return; // Already revealed

      const tile = document.querySelector(`.mines-tile[data-index="${index}"]`);

      // Additional safety: check if tile was already clicked
      if (tile.dataset.clicked === 'true') {
        console.log('[Mines] Tile already clicked, ignoring');
        return;
      }

      // Mark as clicked and revealed IMMEDIATELY
      tile.dataset.clicked = 'true';
      minesGameState.grid[index] = true;

      // Check if mine
      if (minesGameState.minePositions.includes(index)) {
        // Hit a mine!
        tile.classList.add('mine');
        tile.textContent = '💣';

        // Reveal all mines
        minesGameState.minePositions.forEach(pos => {
          const mineTile = document.querySelector(`.mines-tile[data-index="${pos}"]`);
          if (pos !== index) {
            mineTile.classList.add('mine');
            mineTile.textContent = '💣';
          }
        });

        // Disable all tiles
        document.querySelectorAll('.mines-tile').forEach(t => t.classList.add('disabled'));

        // Game over
        endMinesGame(false);
        Toast.error(`Hit a mine! Lost ${minesGameState.betAmount} GC`, 'GAME OVER');
      } else {
        // Safe tile!
        tile.classList.add('revealed');
        tile.textContent = '💎';
        minesGameState.revealedCount++;

        // Calculate multiplier
        const safeTiles = 25 - minesGameState.minesCount;
        const revealed = minesGameState.revealedCount;
        minesGameState.multiplier = calculateMinesMultiplier(revealed, safeTiles, minesGameState.minesCount);

        updateMinesStats();

        // Check if won (all safe tiles revealed)
        if (minesGameState.revealedCount >= safeTiles) {
          endMinesGame(true);
          const profit = Math.floor(minesGameState.betAmount * minesGameState.multiplier);
          Toast.success(`Perfect game! Won ${profit} GC!`, 'VICTORY');
        }
      }
    }

    function calculateMinesMultiplier(revealed, totalSafe, minesCount) {
      // Simple multiplier calculation
      // More revealed = higher multiplier
      // More mines = higher multiplier growth
      const baseMultiplier = 1.0;
      const growthRate = 1 + (minesCount / 25);
      return baseMultiplier + (revealed * 0.2 * growthRate);
    }

    function cashoutMines() {
      if (!minesGameState.isPlaying) return;

      const profit = Math.floor(minesGameState.betAmount * minesGameState.multiplier);
      updateUserGC(profit, 'mines');
      updateMinesGCDisplay();

      // Reveal all tiles
      for (let i = 0; i < 25; i++) {
        const tile = document.querySelector(`.mines-tile[data-index="${i}"]`);
        if (minesGameState.minePositions.includes(i)) {
          tile.classList.add('mine');
          tile.textContent = '💣';
        } else if (!minesGameState.grid[i]) {
          tile.classList.add('revealed');
          tile.textContent = '💎';
        }
        tile.classList.add('disabled');
      }

      endMinesGame(true);
      Toast.success(`Cashed out ${profit} GC at ${minesGameState.multiplier.toFixed(2)}x!`, 'CASHOUT');
    }

    function endMinesGame(won) {
      minesGameState.isPlaying = false;

      // Update UI
      document.getElementById('minesStartBtn').style.display = 'block';
      document.getElementById('minesCashoutBtn').style.display = 'none';
      document.getElementById('minesBetAmount').disabled = false;
      document.getElementById('minesCount').disabled = false;

      // Reset after delay
      setTimeout(() => {
        initMinesGame();
        minesGameState.multiplier = 0;
        minesGameState.revealedCount = 0;
        updateMinesStats();
      }, 3000);
    }

    function updateMinesStats() {
      document.getElementById('minesMultiplier').textContent = minesGameState.multiplier.toFixed(2) + 'x';
      const profit = Math.floor(minesGameState.betAmount * minesGameState.multiplier);
      document.getElementById('minesProfit').textContent = profit + ' GC';
      document.getElementById('minesRevealed').textContent = `${minesGameState.revealedCount} / ${25 - minesGameState.minesCount}`;
    }

    // ===============================================
    // BLACKJACK GAME SYSTEM
    // ===============================================

    let blackjackGameState = {
      isPlaying: false,
      betAmount: 0,
      playerCards: [],
      dealerCards: [],
      deck: [],
      dealerHiddenCard: null
    };

    const suits = ['♠', '♥', '♣', '♦'];
    const values = ['A', '2', '3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K'];

    function createDeck() {
      const deck = [];
      for (let suit of suits) {
        for (let value of values) {
          deck.push({ suit, value });
        }
      }
      return shuffle(deck);
    }

    function shuffle(deck) {
      for (let i = deck.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [deck[i], deck[j]] = [deck[j], deck[i]];
      }
      return deck;
    }

    function getCardValue(card) {
      if (card.value === 'A') return 11;
      if (['J', 'Q', 'K'].includes(card.value)) return 10;
      return parseInt(card.value);
    }

    function calculateHandValue(cards) {
      let value = 0;
      let aces = 0;

      for (let card of cards) {
        const cardVal = getCardValue(card);
        value += cardVal;
        if (card.value === 'A') aces++;
      }

      // Adjust for aces
      while (value > 21 && aces > 0) {
        value -= 10;
        aces--;
      }

      return value;
    }

    function createCardElement(card, hidden = false) {
      const cardDiv = document.createElement('div');
      cardDiv.className = 'blackjack-card';

      if (hidden) {
        cardDiv.classList.add('hidden');
        cardDiv.textContent = '?';
        return cardDiv;
      }

      const isRed = card.suit === '♥' || card.suit === '♦';
      cardDiv.classList.add(isRed ? 'red' : 'black');

      cardDiv.innerHTML = `
        <div>${card.suit}</div>
        <div class="blackjack-card-value">${card.value}</div>
      `;

      return cardDiv;
    }

    async function updateBlackjackGPDisplay() {
      const gp = await getUserGC();
      document.getElementById('blackjackGCDisplay').textContent = gp;
      if (blackjackGameState && blackjackGameState.betAmount) {
        document.getElementById('blackjackCurrentBet').textContent = blackjackGameState.betAmount + ' GC';
      }
    }

    async function initBlackjack() {
      const gp = await getUserGC();
      document.getElementById('blackjackGCDisplay').textContent = gp;
    }

    async function dealBlackjack() {
      const betAmount = parseInt(document.getElementById('blackjackBetAmount').value);
      const userGP = await getUserGC();

      // Validation
      if (isNaN(betAmount) || betAmount < 10) {
        Toast.error('Minimum bet is 10 GC', 'INVALID BET');
        return;
      }

      if (betAmount > 10000) {
        Toast.error('Maximum bet is 10,000 GC', 'INVALID BET');
        return;
      }

      if (betAmount > userGP) {
        Toast.error('Insufficient GC', 'INSUFFICIENT FUNDS');
        return;
      }

      // Deduct bet
      updateUserGC(-betAmount, 'blackjack');

      // Initialize game
      blackjackGameState = {
        isPlaying: true,
        betAmount: betAmount,
        playerCards: [],
        dealerCards: [],
        deck: createDeck(),
        dealerHiddenCard: null
      };

      // Deal initial cards
      blackjackGameState.playerCards.push(blackjackGameState.deck.pop());
      blackjackGameState.dealerCards.push(blackjackGameState.deck.pop());
      blackjackGameState.playerCards.push(blackjackGameState.deck.pop());
      blackjackGameState.dealerHiddenCard = blackjackGameState.deck.pop();

      // Update UI
      updateBlackjackDisplay();
      updateBlackjackGPDisplay();
      document.getElementById('blackjackActions').style.display = 'flex';
      document.getElementById('blackjackDealBtn').disabled = true;
      document.getElementById('blackjackBetAmount').disabled = true;

      // Check for natural blackjack (player has 21 with 2 cards)
      const playerValue = calculateHandValue(blackjackGameState.playerCards);
      if (playerValue === 21 && blackjackGameState.playerCards.length === 2) {
        // Player has blackjack! Peek at dealer's hidden card
        setTimeout(() => checkDealerBlackjack(), 500);
      }
    }

    async function blackjackHit() {
      if (!blackjackGameState.isPlaying) return;

      // Deal card to player
      blackjackGameState.playerCards.push(blackjackGameState.deck.pop());
      updateBlackjackDisplay();

      const playerValue = calculateHandValue(blackjackGameState.playerCards);

      // Check for bust
      if (playerValue > 21) {
        await endBlackjack('bust');
      }
    }

    function checkDealerBlackjack() {
      if (!blackjackGameState.isPlaying) return;

      // Reveal dealer's hidden card to check for blackjack
      blackjackGameState.dealerCards.push(blackjackGameState.dealerHiddenCard);
      blackjackGameState.dealerHiddenCard = null;
      updateBlackjackDisplay();

      const dealerValue = calculateHandValue(blackjackGameState.dealerCards);

      setTimeout(async () => {
        if (dealerValue === 21) {
          // Both have blackjack - push
          await endBlackjack('push');
        } else {
          // Player has blackjack, dealer doesn't - player wins 3:2
          await endBlackjack('blackjack');
        }
      }, 800);
    }

    function blackjackStand() {
      if (!blackjackGameState.isPlaying) return;

      // Reveal dealer's hidden card
      blackjackGameState.dealerCards.push(blackjackGameState.dealerHiddenCard);
      blackjackGameState.dealerHiddenCard = null;
      updateBlackjackDisplay();

      // Dealer must hit until 17 or higher
      const dealerPlay = () => {
        const dealerValue = calculateHandValue(blackjackGameState.dealerCards);

        if (dealerValue < 17) {
          setTimeout(() => {
            blackjackGameState.dealerCards.push(blackjackGameState.deck.pop());
            updateBlackjackDisplay();
            dealerPlay();
          }, 800);
        } else {
          // Determine winner
          setTimeout(async () => {
            await determineBlackjackWinner();
          }, 500);
        }
      };

      dealerPlay();
    }

    async function determineBlackjackWinner() {
      const playerValue = calculateHandValue(blackjackGameState.playerCards);
      const dealerValue = calculateHandValue(blackjackGameState.dealerCards);

      if (dealerValue > 21) {
        await endBlackjack('dealerBust');
      } else if (playerValue > dealerValue) {
        await endBlackjack('win');
      } else if (playerValue < dealerValue) {
        await endBlackjack('lose');
      } else {
        await endBlackjack('push');
      }
    }

    async function endBlackjack(result) {
      blackjackGameState.isPlaying = false;

      let message = '';
      let winAmount = 0;

      switch(result) {
        case 'bust':
          message = `Bust! Lost ${blackjackGameState.betAmount} GC`;
          Toast.error(message, 'BUST');
          break;
        case 'blackjack':
          // Natural blackjack pays 3:2 (1.5x the bet, plus original bet returned = 2.5x total)
          winAmount = Math.floor(blackjackGameState.betAmount * 2.5);
          message = `BLACKJACK! Won ${winAmount} GC`;
          await updateUserGC(winAmount, 'blackjack');
          await updateBlackjackGPDisplay();
          Toast.success(message, 'BLACKJACK');
          break;
        case 'dealerBust':
          winAmount = blackjackGameState.betAmount * 2;
          message = `Dealer bust! Won ${winAmount} GC`;
          await updateUserGC(winAmount, 'blackjack');
          await updateBlackjackGPDisplay();
          Toast.success(message, 'WIN');
          break;
        case 'win':
          winAmount = blackjackGameState.betAmount * 2;
          message = `You win! Won ${winAmount} GC`;
          await updateUserGC(winAmount, 'blackjack');
          await updateBlackjackGPDisplay();
          Toast.success(message, 'WIN');
          break;
        case 'lose':
          message = `Dealer wins! Lost ${blackjackGameState.betAmount} GC`;
          Toast.error(message, 'LOSE');
          break;
        case 'push':
          winAmount = blackjackGameState.betAmount;
          message = `Push! Bet returned`;
          await updateUserGC(winAmount, 'blackjack');
          await updateBlackjackGPDisplay();
          Toast.info(message, 'PUSH');
          break;
      }

      // Update info display
      document.getElementById('blackjackGameInfo').textContent = message;

      // Reset UI
      document.getElementById('blackjackActions').style.display = 'none';

      setTimeout(() => {
        resetBlackjack();
      }, 3000);
    }

    function resetBlackjack() {
      document.getElementById('blackjackPlayerCards').innerHTML = '';
      document.getElementById('blackjackDealerCards').innerHTML = '';
      document.getElementById('blackjackPlayerValue').textContent = '0';
      document.getElementById('blackjackDealerValue').textContent = '0';
      document.getElementById('blackjackCurrentBet').textContent = '0 GC';
      document.getElementById('blackjackGameInfo').textContent = 'Place your bet and click DEAL to start. Get closer to 21 than the dealer without going over!';
      document.getElementById('blackjackDealBtn').disabled = false;
      document.getElementById('blackjackBetAmount').disabled = false;
    }

    function updateBlackjackDisplay() {
      // Update player cards
      const playerCardsDiv = document.getElementById('blackjackPlayerCards');
      playerCardsDiv.innerHTML = '';
      blackjackGameState.playerCards.forEach(card => {
        playerCardsDiv.appendChild(createCardElement(card));
      });

      // Update dealer cards
      const dealerCardsDiv = document.getElementById('blackjackDealerCards');
      dealerCardsDiv.innerHTML = '';
      blackjackGameState.dealerCards.forEach(card => {
        dealerCardsDiv.appendChild(createCardElement(card));
      });

      // Add hidden card if exists
      if (blackjackGameState.dealerHiddenCard) {
        dealerCardsDiv.appendChild(createCardElement(null, true));
      }

      // Update values
      const playerValue = calculateHandValue(blackjackGameState.playerCards);
      document.getElementById('blackjackPlayerValue').textContent = playerValue;

      const dealerValue = blackjackGameState.dealerHiddenCard
        ? calculateHandValue(blackjackGameState.dealerCards)
        : calculateHandValue(blackjackGameState.dealerCards);
      document.getElementById('blackjackDealerValue').textContent = dealerValue;

      document.getElementById('blackjackCurrentBet').textContent = blackjackGameState.betAmount + ' GC';
    }

    // Initial event listeners
    document.getElementById('joinBtn').addEventListener('click', handleJoin);
    document.getElementById('loginLink').addEventListener('click', () => swapContent('login'));
    document.getElementById('logoutBtn').addEventListener('click', handleLogout);

    // Only add listener if button exists (Trading Sim is disabled)
    const playReactionBtn = document.getElementById('playReactionBtn');
    if (playReactionBtn) {
      playReactionBtn.addEventListener('click', () => {
        console.log('Play Reaction clicked');
        swapContent('game');
      });
    }

    document.getElementById('playCrashBtn').addEventListener('click', () => {
      console.log('Play Crash clicked');
      swapContent('crash');
    });
    document.getElementById('playMinesBtn').addEventListener('click', () => {
      console.log('Play Mines clicked');
      swapContent('mines');
    });
    document.getElementById('playBlackjackBtn').addEventListener('click', () => {
      console.log('Play Blackjack clicked');
      swapContent('blackjack');
    });
    document.getElementById('openOvenBtn').addEventListener('click', () => {
      console.log('Open Oven clicked');
      swapContent('oven');
    });
    document.getElementById('backFromOvenBtn').addEventListener('click', () => swapContent('campaign'));
    document.getElementById('ovenDepositBtn').addEventListener('click', depositToOven);
    document.getElementById('ovenWithdrawBtn').addEventListener('click', withdrawFromOven);
    document.getElementById('openFarmBtn').addEventListener('click', () => {
      console.log('Open Farm clicked');
      swapContent('farm');
    });
    document.getElementById('backFromFarmBtn').addEventListener('click', () => swapContent('campaign'));
    document.getElementById('farmClickBtn').addEventListener('click', clickFarm);
    document.getElementById('viewLeaderboardBtn').addEventListener('click', () => {
      console.log('View Leaderboard clicked');
      swapContent('leaderboard');
    });
    document.getElementById('backToDashBtn').addEventListener('click', () => swapContent('dashboard'));
    document.getElementById('backFromCrashBtn').addEventListener('click', () => swapContent('campaign'));
    document.getElementById('backFromMinesBtn').addEventListener('click', () => swapContent('campaign'));
    document.getElementById('minesStartBtn').addEventListener('click', startMinesGame);
    document.getElementById('minesCashoutBtn').addEventListener('click', cashoutMines);
    document.getElementById('backFromBlackjackBtn').addEventListener('click', () => swapContent('campaign'));
    document.getElementById('blackjackDealBtn').addEventListener('click', dealBlackjack);
    document.getElementById('blackjackHitBtn').addEventListener('click', blackjackHit);
    document.getElementById('blackjackStandBtn').addEventListener('click', blackjackStand);
    document.getElementById('backFromLeaderboardBtn').addEventListener('click', () => swapContent('dashboard'));
    document.getElementById('backFromQuestsBtn').addEventListener('click', () => swapContent('dashboard'));
    document.getElementById('backFromInventoryBtn').addEventListener('click', () => swapContent('dashboard'));
    document.getElementById('backFromShopBtn').addEventListener('click', () => swapContent('dashboard'));
    document.getElementById('viewQuestsBtn').addEventListener('click', () => swapContent('quests'));
    document.getElementById('viewInventoryBtn').addEventListener('click', () => swapContent('inventory'));
    document.getElementById('viewShopBtn').addEventListener('click', () => swapContent('shop'));
    document.getElementById('startGameBtn').addEventListener('click', startGame);
    document.getElementById('sellButton').addEventListener('click', handleSell);
    document.getElementById('resetGameBtn').addEventListener('click', resetGame);

    // Invite code handlers
    document.getElementById('copyInviteCodeBtn').addEventListener('click', async () => {
      const codeText = document.getElementById('userInviteCode').textContent;
      if (codeText && codeText !== 'Loading...' && codeText !== 'No code') {
        try {
          await navigator.clipboard.writeText(codeText);
          Toast.success('Invite code copied!', 'Share it with friends');
        } catch (err) {
          // Fallback for older browsers
          const textArea = document.createElement('textarea');
          textArea.value = codeText;
          document.body.appendChild(textArea);
          textArea.select();
          document.execCommand('copy');
          document.body.removeChild(textArea);
          Toast.success('Invite code copied!', 'Share it with friends');
        }
      }
    });

    // Campaign banner and page handlers
    const campaignBannerElement = document.getElementById('campaignBanner');
    if (campaignBannerElement) {
      campaignBannerElement.addEventListener('click', () => {
        console.log('Campaign banner clicked!');
        swapContent('campaign');
      });
    } else {
      console.error('Campaign banner element not found!');
    }
    document.getElementById('backFromCampaignBtn').addEventListener('click', () => swapContent('dashboard'));

    // Leaderboard filter buttons
    document.querySelectorAll('.filter-btn').forEach(btn => {
      btn.addEventListener('click', function() {
        const filter = this.getAttribute('data-filter');
        handleFilterChange(filter);
      });
    });


    // Add keyboard navigation support
    document.addEventListener('keydown', (e) => {
      // ESC key to go back
      if (e.key === 'Escape') {
        if (gameContent.style.display === 'block') {
          swapContent('dashboard');
        } else if (leaderboardContent.style.display === 'block') {
          swapContent('dashboard');
        } else if (questContent.style.display === 'block') {
          swapContent('dashboard');
        } else if (inventoryContent.style.display === 'block') {
          swapContent('dashboard');
        } else if (shopContent.style.display === 'block') {
          swapContent('dashboard');
        }
      }
    });

    // Helper function for breadcrumb navigation
    function showDashboard() {
      swapContent('dashboard');
    }

    // Make DUEL PVP logo clickable when logged in
    const brandTitle = document.querySelector('.brand .title');
    if (brandTitle) {
      brandTitle.addEventListener('click', () => {
        const savedEmail = localStorage.getItem('duelpvp_email');
        if (savedEmail) {
          swapContent('dashboard');
        }
      });
    }

    // Check if user is already logged in
    try {
      const savedEmail = localStorage.getItem('duelpvp_email');
      if (savedEmail) {
        document.getElementById('userName').textContent = savedEmail.split('@')[0].toUpperCase();
        if (brandTitle) brandTitle.style.cursor = 'pointer';
      }
    } catch (e) {}
  </script>
</body>
</html>
