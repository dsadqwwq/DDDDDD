<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Duel PVP – Enter the Arena</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
<style>
  :root{
    --gold:#FFD64D;
    --gold-hi:#FFF3A3;
    --bg:#0b0f12;

    /* Glow position */
    --glow-x: 80%;
    --glow-y: 32%;
    --glow-w: 211px;
    --glow-h: 366px;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:var(--bg);color:#e6ecf1;font-family:Inter,system-ui,Segoe UI,Roboto,Arial}
  
  /* Background with continuous animation */
  .bg{position:fixed;inset:0;overflow:hidden;z-index:0}
  .bg img{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;image-rendering:pixelated;filter:contrast(1.04) saturate(1.02)}

  /* Enhanced multi-layer lava glow animations */
  @keyframes lavaPulse{
    0%,100% { opacity:.25; filter:brightness(1.0) saturate(1.0); }
    20%     { opacity:.45; filter:brightness(1.25) saturate(1.2); }
    40%     { opacity:.35; filter:brightness(1.15) saturate(1.1); }
    60%     { opacity:.55; filter:brightness(1.35) saturate(1.3); }
    80%     { opacity:.30; filter:brightness(1.1) saturate(1.05); }
  }
  
  @keyframes lavaFlicker{
    0%,100% { opacity:0.3; }
    50%     { opacity:0.7; }
  }

  /* Primary glow layer */
  .bg::after{
    content:""; position:absolute; inset:0; pointer-events:none;
    background:
      /* Core bright glow */
      radial-gradient( circle 220px at var(--glow-x) var(--glow-y),
        rgba(255,180,80,.8), rgba(255,140,60,.4) 30%, rgba(255,100,40,.2) 50%, transparent 70%),
      /* Secondary warm glow */
      radial-gradient( ellipse 280px 400px at var(--glow-x) var(--glow-y),
        rgba(255,200,120,.5), rgba(255,160,80,.25) 40%, rgba(255,120,60,.1) 60%, transparent 80%),
      /* Outer ambient glow */
      radial-gradient( circle 350px at var(--glow-x) var(--glow-y),
        rgba(255,220,180,.2), rgba(255,180,140,.1) 50%, transparent 75%);
    mix-blend-mode: screen;
    animation: lavaPulse 6s ease-in-out infinite;
  }
  
  /* Additional flicker layer for more dynamic effect */
  .bg::before{
    content:""; position:absolute; inset:0; pointer-events:none;
    background:
      radial-gradient( circle 180px at var(--glow-x) var(--glow-y),
        rgba(255,220,180,.6), rgba(255,160,100,.2) 40%, transparent 60%);
    mix-blend-mode: color-dodge;
    animation: lavaFlicker 3s ease-in-out infinite;
  }

  /* Particle system canvas */
  .particles-canvas{
    position:fixed;
    inset:0;
    width:100%;
    height:100%;
    pointer-events:none;
    z-index:2;
  }

  /* CRT Scanlines overlay */
  .scanlines{
    position:fixed;
    inset:0;
    width:100%;
    height:100%;
    pointer-events:none;
    z-index:10;
    background:repeating-linear-gradient(
      0deg,
      rgba(0,0,0,0) 0px,
      rgba(0,0,0,0.08) 1px,
      rgba(0,0,0,0) 2px
    );
    opacity:0.4;
  }

  /* Enhanced brand design */
  .brand{
    position:fixed; 
    left:24px; 
    top:24px; 
    z-index:6;
  }
  
  .brand .title{
    font-family:'Press Start 2P', monospace;
    font-size:32px;
    letter-spacing:.08em;
    margin-bottom:12px;
    /* Multi-layer text effects */
    background: linear-gradient(180deg, var(--gold-hi) 0%, var(--gold) 50%, #D4A033 100%);
    -webkit-background-clip: text;
    background-clip: text;
    -webkit-text-fill-color: transparent;
    filter: drop-shadow(2px 2px 0px #000) 
            drop-shadow(0 0 20px rgba(255,214,77,.4))
            drop-shadow(0 0 40px rgba(255,214,77,.2));
    position: relative;
  }
  
  /* 3D effect for title */
  .brand .title::before{
    content: 'DUEL PVP';
    position: absolute;
    left: 3px;
    top: 3px;
    z-index: -1;
    background: linear-gradient(180deg, #8B6914 0%, #5C440E 100%);
    -webkit-background-clip: text;
    background-clip: text;
    -webkit-text-fill-color: transparent;
    filter: blur(0.5px);
  }

  /* Enhanced slogan with better styling */
  .brand .slogan{
    font-family: Inter, system-ui, Segoe UI, Roboto, Arial;
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.15em;
    color: #ffffff;
    opacity: 0.9;
    animation: sloganFade 8s ease-in-out infinite;
    position: relative;
    padding-left: 2px;
  }
  
  /* Divider dots between slogan parts */
  .slogan-divider{
    display: inline-block;
    width: 4px;
    height: 4px;
    background: var(--gold);
    border-radius: 50%;
    margin: 0 8px 1px;
    opacity: 0.6;
    box-shadow: 0 0 6px rgba(255,214,77,.5);
  }

  @keyframes sloganFade{
    0%, 100% { 
      opacity: 0.4; 
      filter: blur(0.5px);
    }
    50% { 
      opacity: 1; 
      filter: blur(0px) drop-shadow(0 0 8px rgba(255,255,255,.3));
    }
  }

  /* Center aligned for warrior naming screen */
  .page-container.center-aligned{
    align-items:center;
    padding-bottom:20px;
  }

  /* Page container */
  .page-container{position:fixed;inset:0;display:grid;place-items:center center;padding:20px;overflow-y:auto; z-index:4}
  
  /* Modern panel styles matching dashboard */
  .panel{
    position:relative;
    width:min(520px,92vw);
    background:rgba(12,16,20,.10);
    border:2px solid rgba(255,214,77,.3);
    border-radius:12px;
    padding:32px 28px;
    backdrop-filter:blur(8px);
    box-shadow:0 8px 32px rgba(0,0,0,.4), inset 0 1px 0 rgba(255,255,255,.05);
  }

  /* Extra transparent for access code screen */
  .panel-transparent{
    background:rgba(12,16,20,.03);
  }

  .panel-header{
    text-align:center;
    margin-bottom:28px;
    padding-bottom:20px;
    border-bottom:1px solid rgba(255,214,77,.15);
  }

  .sys{
    font-family:'Press Start 2P', monospace;
    font-size:16px;
    color:var(--gold);
    text-shadow:0 0 20px rgba(255,214,77,.5);
    margin-bottom:8px;
  }
  
  .sub-text{
    font-family:Inter,system-ui,Segoe UI,Roboto,Arial;
    font-size:13px;
    color:#a0a8b0;
    margin-top:8px;
  }
  
  /* Continuous blink animation */
  .blink{animation:blinkDot 1s infinite}
  @keyframes blinkDot{0%,50%{opacity:1}50.1%,100%{opacity:0}}

  .input-group{
    margin-bottom:16px;
  }

  .input-label{
    display:block;
    font-family:'Press Start 2P', monospace;
    font-size:10px;
    color:#a0a8b0;
    margin-bottom:8px;
    text-transform:uppercase;
  }

  .bar{display:flex;gap:12px;align-items:stretch;}
  
  .input-field{
    flex:1;
    padding:12px 14px;
    background:rgba(0,0,0,.4);
    border:1px solid rgba(255,214,77,.2);
    border-radius:8px;
    color:#e6ecf1;
    font-family:'Press Start 2P', monospace;
    font-size:11px;
    transition:all 0.2s;
  }
  
  .input-field:focus{
    outline:none;
    border-color:var(--gold);
    background:rgba(0,0,0,.6);
    box-shadow:0 0 0 2px rgba(255,214,77,.1);
  }
  
  .input-field::placeholder{
    color:rgba(160,168,176,.5);
  }

  .btn-submit{
    padding:12px 24px;
    background:var(--gold);
    border:2px solid var(--gold);
    border-radius:8px;
    color:#000;
    font-family:'Press Start 2P', monospace;
    font-size:11px;
    font-weight:bold;
    cursor:pointer;
    transition:all 0.15s cubic-bezier(0.4, 0, 0.2, 1);
    white-space:nowrap;
    position:relative;
    box-shadow:
      0 1px 2px rgba(0,0,0,.4),
      0 4px 8px rgba(0,0,0,.2),
      inset 0 1px 0 rgba(255,255,255,.3);
  }

  .btn-submit:hover{
    background:var(--gold-hi);
    transform:translateY(-2px);
    box-shadow:
      0 2px 4px rgba(0,0,0,.4),
      0 6px 16px rgba(255,214,77,.4),
      inset 0 1px 0 rgba(255,255,255,.4);
  }

  .btn-submit:active{
    transform:translateY(1px);
    box-shadow:
      0 0 2px rgba(0,0,0,.4),
      0 2px 4px rgba(0,0,0,.2),
      inset 0 2px 4px rgba(0,0,0,.2);
  }

  .helper{
    margin-top:20px;
    text-align:center;
    font-family:Inter,system-ui,Segoe UI,Roboto,Arial;
    font-size:13px;
    color:#a0a8b0;
  }
  
  .helper a{
    color:var(--gold);
    text-decoration:none;
    cursor:pointer;
    transition:color 0.2s;
    font-family:'Press Start 2P', monospace;
    font-size:10px;
  }
  
  .helper a:hover{
    color:var(--gold-hi);
    text-shadow:0 0 8px rgba(255,214,77,.5);
  }
  
  /* Decorative elements */
  .panel::before{
    content:'';
    position:absolute;
    top:-1px;
    left:50%;
    transform:translateX(-50%);
    width:100px;
    height:1px;
    background:linear-gradient(90deg, transparent, var(--gold), transparent);
    opacity:0.8;
  }

  .footer{position:fixed;right:20px;bottom:16px;font-size:12px;opacity:.85; z-index:3}

  /* Warrior naming screen */
  .warrior-naming{
    animation: warriorEntrance 0.8s cubic-bezier(0.34, 1.56, 0.64, 1);
  }

  @keyframes warriorEntrance{
    0%{
      opacity:0;
      transform:scale(0.8) translateY(-30px);
      filter:blur(10px);
    }
    50%{
      opacity:0.5;
      transform:scale(1.05) translateY(5px);
      filter:blur(2px);
    }
    100%{
      opacity:1;
      transform:scale(1) translateY(0);
      filter:blur(0);
    }
  }

  .warrior-title{
    font-family:'Press Start 2P', monospace;
    font-size:16px;
    color:var(--gold);
    text-align:center;
    margin-bottom:24px;
    animation:titleGlow 2s ease-in-out infinite;
    text-shadow:0 0 20px rgba(255,214,77,.6);
  }

  @keyframes titleGlow{
    0%,100%{
      text-shadow:0 0 20px rgba(255,214,77,.6), 0 0 30px rgba(255,214,77,.3);
      filter:brightness(1);
    }
    50%{
      text-shadow:0 0 30px rgba(255,214,77,.8), 0 0 50px rgba(255,214,77,.5);
      filter:brightness(1.2);
    }
  }

  .warrior-input{
    width:100%;
    padding:16px;
    background:rgba(0,0,0,.5);
    border:2px solid rgba(255,214,77,.3);
    border-radius:8px;
    color:#e6ecf1;
    font-family:'Press Start 2P', monospace;
    font-size:14px;
    text-align:center;
    transition:all 0.3s;
    margin-bottom:24px;
    letter-spacing:0.1em;
  }

  .warrior-input:focus{
    outline:none;
    border-color:var(--gold);
    background:rgba(0,0,0,.7);
    box-shadow:0 0 0 3px rgba(255,214,77,.2), 0 0 30px rgba(255,214,77,.3);
    transform:scale(1.02);
  }

  .warrior-input::placeholder{
    color:#6b7280;
    font-family:Inter, system-ui, Segoe UI, Roboto, Arial;
    font-size:13px;
    letter-spacing:0.05em;
  }

  /* Dashboard specific styles */
  .dashboard-content{
    display:none;
    width:min(720px,92vw);
    background:rgba(12,16,20,.10);
    border:2px solid rgba(255,214,77,.3);
    border-radius:12px;
    padding:24px;
    backdrop-filter:blur(8px);
  }

  .dashboard-header{
    display:flex;
    justify-content:space-between;
    align-items:center;
    margin-bottom:24px;
    padding-bottom:16px;
    border-bottom:1px solid rgba(255,214,77,.2);
  }

  .user-info{font-family:'Press Start 2P', monospace;}
  .user-name{color:var(--gold);font-size:16px;margin-bottom:4px;}
  .user-stats{color:#a0a8b0;font-size:10px;}

  .logout-btn{
    padding:8px 12px;
    background:rgba(255,214,77,.1);
    border:1px solid var(--gold);
    color:var(--gold);
    font-family:'Press Start 2P', monospace;
    font-size:10px;
    cursor:pointer;
    border-radius:4px;
    transition:all 0.2s;
  }
  .logout-btn:hover{background:rgba(255,214,77,.2);}

  .stats-grid{
    display:grid;
    grid-template-columns:repeat(auto-fit, minmax(200px, 1fr));
    gap:16px;
    margin-bottom:24px;
  }

  .stat-card{
    background:rgba(255,214,77,.05);
    border:1px solid rgba(255,214,77,.2);
    border-radius:8px;
    padding:16px;
    text-align:center;
  }

  .stat-label{
    font-family:'Press Start 2P', monospace;
    font-size:10px;
    color:#a0a8b0;
    margin-bottom:8px;
  }

  .stat-value{
    font-family:'Press Start 2P', monospace;
    font-size:18px;
    color:var(--gold);
  }

  .recent-matches{
    background:rgba(0,0,0,.3);
    border:1px solid rgba(255,214,77,.2);
    border-radius:8px;
    padding:16px;
  }

  .section-title{
    font-family:'Press Start 2P', monospace;
    font-size:12px;
    color:var(--gold);
    margin-bottom:12px;
  }

  .match-list{
    display:flex;
    flex-direction:column;
    gap:8px;
  }

  .match-item{
    display:flex;
    justify-content:space-between;
    align-items:center;
    padding:8px;
    background:rgba(255,214,77,.02);
    border:1px solid rgba(255,214,77,.1);
    border-radius:4px;
    font-family:'Press Start 2P', monospace;
    font-size:10px;
  }

  .match-result{
    padding:2px 6px;
    border-radius:3px;
    font-size:9px;
  }
  .win{background:rgba(76,175,80,.3);color:#4CAF50;}
  .loss{background:rgba(244,67,54,.3);color:#F44336;}

  .action-buttons{
    display:flex;
    gap:12px;
    margin-top:24px;
  }

  .action-btn{
    flex:1;
    padding:12px;
    font-family:'Press Start 2P', monospace;
    font-size:11px;
    border-radius:8px;
    cursor:pointer;
    transition:all 0.15s cubic-bezier(0.4, 0, 0.2, 1);
    border:2px solid;
    position:relative;
  }

  .btn-primary{
    background:var(--gold);
    border-color:var(--gold);
    color:#000;
    box-shadow:
      0 1px 2px rgba(0,0,0,.4),
      0 4px 8px rgba(0,0,0,.2),
      inset 0 1px 0 rgba(255,255,255,.3);
  }
  .btn-primary:hover{
    background:var(--gold-hi);
    transform:translateY(-2px);
    box-shadow:
      0 2px 4px rgba(0,0,0,.4),
      0 6px 16px rgba(255,214,77,.4),
      inset 0 1px 0 rgba(255,255,255,.4);
  }
  .btn-primary:active{
    transform:translateY(1px);
    box-shadow:
      0 0 2px rgba(0,0,0,.4),
      0 2px 4px rgba(0,0,0,.2),
      inset 0 2px 4px rgba(0,0,0,.2);
  }

  .btn-secondary{
    background:transparent;
    border-color:rgba(255,214,77,.5);
    color:var(--gold);
    box-shadow:
      0 1px 2px rgba(0,0,0,.3),
      inset 0 1px 0 rgba(255,214,77,.1);
  }
  .btn-secondary:hover{
    background:rgba(255,214,77,.1);
    transform:translateY(-2px);
    box-shadow:
      0 2px 4px rgba(0,0,0,.3),
      0 4px 12px rgba(255,214,77,.15),
      inset 0 1px 0 rgba(255,214,77,.2);
  }
  .btn-secondary:active{
    transform:translateY(1px);
    box-shadow:
      0 0 2px rgba(0,0,0,.3),
      inset 0 1px 3px rgba(0,0,0,.2);
  }

  /* Page transitions */
  .fade-in{
    animation: fadeIn 0.25s ease-out;
  }
  @keyframes fadeIn{
    from{opacity:0;transform:translateY(10px);}
    to{opacity:1;transform:translateY(0);}
  }

  .fade-in-delayed{
    opacity: 0;
    animation: fadeInDelayed 0.5s ease-out 1s forwards;
  }
  @keyframes fadeInDelayed{
    from{opacity:0;transform:translateY(20px);}
    to{opacity:1;transform:translateY(0);}
  }

  .fade-out{
    animation: fadeOut 0.2s ease-in forwards;
  }
  @keyframes fadeOut{
    from{opacity:1;transform:translateY(0);}
    to{opacity:0;transform:translateY(-10px);}
  }

  /* Reaction Game Styles */
  .game-container{
    display:none;
    width:min(680px,92vw);
    background:rgba(12,16,20,.10);
    border:2px solid rgba(255,214,77,.3);
    border-radius:12px;
    padding:24px;
    backdrop-filter:blur(8px);
  }

  .game-header{
    display:flex;
    justify-content:space-between;
    align-items:center;
    margin-bottom:24px;
    padding-bottom:16px;
    border-bottom:1px solid rgba(255,214,77,.2);
  }

  .game-title{
    font-family:'Press Start 2P', monospace;
    font-size:18px;
    color:var(--gold);
  }

  .back-btn{
    padding:8px 12px;
    background:rgba(255,214,77,.1);
    border:1px solid var(--gold);
    color:var(--gold);
    font-family:'Press Start 2P', monospace;
    font-size:10px;
    cursor:pointer;
    border-radius:4px;
    transition:all 0.2s;
  }
  .back-btn:hover{background:rgba(255,214,77,.2);}

  .game-area{
    background:rgba(0,0,0,.5);
    border:1px solid rgba(255,214,77,.2);
    border-radius:8px;
    padding:24px;
    margin-bottom:20px;
  }

  .chart-container{
    width:100%;
    height:240px;
    background:rgba(16,20,24,.8);
    border:2px solid rgba(255,214,77,.1);
    border-radius:8px;
    position:relative;
    overflow:hidden;
    margin-bottom:20px;
    transition:all 0.2s;
  }

  .chart-container.green{
    border-color:rgba(76,175,80,.5);
    background:rgba(16,24,16,.8);
  }

  .chart-container.red{
    border-color:rgba(244,67,54,.8);
    background:rgba(24,16,16,.9);
    animation:redPulse 0.5s ease-out;
  }

  @keyframes redPulse{
    0%{box-shadow:0 0 0 0 rgba(244,67,54,.8);}
    100%{box-shadow:0 0 30px 10px rgba(244,67,54,0);}
  }

  .chart-line{
    position:absolute;
    bottom:0;
    left:0;
    right:0;
    height:60%;
    overflow:hidden;
  }

  .price-display{
    position:absolute;
    top:20px;
    right:20px;
    font-family:'Press Start 2P', monospace;
    font-size:18px;
    color:#4CAF50;
    text-shadow:0 0 10px currentColor;
    transition:all 0.2s;
  }

  .red .price-display{
    color:#F44336;
  }

  .sell-button{
    width:100%;
    padding:20px;
    font-family:'Press Start 2P', monospace;
    font-size:16px;
    background:#F44336;
    border:2px solid #D32F2F;
    color:#fff;
    border-radius:8px;
    cursor:pointer;
    transition:all 0.2s;
    text-transform:uppercase;
    letter-spacing:0.1em;
  }

  .sell-button:hover:not(:disabled){
    background:#D32F2F;
    transform:translateY(-2px);
    box-shadow:0 4px 20px rgba(244,67,54,.4);
  }

  .sell-button:active:not(:disabled){
    transform:translateY(0);
  }

  .sell-button:disabled{
    background:rgba(100,100,100,.3);
    border-color:rgba(100,100,100,.2);
    color:rgba(255,255,255,.3);
    cursor:not-allowed;
  }

  .instructions{
    background:rgba(255,214,77,.05);
    border:1px solid rgba(255,214,77,.2);
    border-radius:8px;
    padding:16px;
    margin-bottom:20px;
  }

  .instructions-title{
    font-family:'Press Start 2P', monospace;
    font-size:12px;
    color:var(--gold);
    margin-bottom:12px;
  }

  .instructions-text{
    font-family:Inter, system-ui, Arial;
    font-size:13px;
    color:#a0a8b0;
    line-height:1.6;
  }

  .attempts-counter{
    display:flex;
    justify-content:space-between;
    align-items:center;
    background:rgba(0,0,0,.3);
    border:1px solid rgba(255,214,77,.2);
    border-radius:8px;
    padding:12px 16px;
    margin-bottom:20px;
  }

  .attempts-label{
    font-family:'Press Start 2P', monospace;
    font-size:11px;
    color:#a0a8b0;
  }

  .attempts-value{
    font-family:'Press Start 2P', monospace;
    font-size:14px;
    color:var(--gold);
  }

  .results-grid{
    display:grid;
    grid-template-columns:repeat(5, 1fr);
    gap:8px;
    margin-bottom:16px;
  }

  .result-card{
    background:rgba(255,214,77,.05);
    border:1px solid rgba(255,214,77,.2);
    border-radius:6px;
    padding:12px;
    text-align:center;
  }

  .result-card.best{
    background:rgba(76,175,80,.1);
    border-color:rgba(76,175,80,.4);
  }

  .result-attempt{
    font-family:'Press Start 2P', monospace;
    font-size:9px;
    color:#a0a8b0;
    margin-bottom:6px;
  }

  .result-time{
    font-family:'Press Start 2P', monospace;
    font-size:12px;
    color:var(--gold);
  }

  .game-status{
    text-align:center;
    font-family:'Press Start 2P', monospace;
    font-size:14px;
    padding:16px;
    margin-bottom:20px;
  }

  .status-ready{
    color:#4CAF50;
  }

  .status-go{
    color:#F44336;
  }

  .canvas-chart{
    width:100%;
    height:100%;
    image-rendering:crisp-edges;
  }

  /* Leaderboard Screen Styles */
  .leaderboard-container{
    display:none;
    width:min(780px,92vw);
    background:rgba(12,16,20,.10);
    border:2px solid rgba(255,214,77,.3);
    border-radius:12px;
    padding:24px;
    backdrop-filter:blur(8px);
  }

  .leaderboard-header{
    display:flex;
    justify-content:space-between;
    align-items:center;
    margin-bottom:24px;
    padding-bottom:16px;
    border-bottom:1px solid rgba(255,214,77,.2);
  }

  .leaderboard-title{
    font-family:'Press Start 2P', monospace;
    font-size:18px;
    color:var(--gold);
  }

  .podium{
    display:grid;
    grid-template-columns:repeat(3, 1fr);
    gap:16px;
    margin-bottom:32px;
    align-items:flex-end;
  }

  .podium-item{
    background:rgba(255,214,77,.05);
    border:2px solid rgba(255,214,77,.2);
    border-radius:8px;
    padding:20px 16px;
    text-align:center;
    transition:all 0.3s;
    position:relative;
  }

  .podium-item.rank-1{
    order:2;
    border-color:var(--gold);
    background:rgba(255,214,77,.15);
    transform:scale(1.1);
  }

  .podium-item.rank-2{
    order:1;
    border-color:rgba(192,192,192,.5);
    background:rgba(192,192,192,.08);
  }

  .podium-item.rank-3{
    order:3;
    border-color:rgba(205,127,50,.5);
    background:rgba(205,127,50,.08);
  }

  .podium-rank{
    position:absolute;
    top:-12px;
    left:50%;
    transform:translateX(-50%);
    width:32px;
    height:32px;
    border-radius:50%;
    display:flex;
    align-items:center;
    justify-content:center;
    font-family:'Press Start 2P', monospace;
    font-size:11px;
    font-weight:bold;
    border:2px solid;
  }

  .rank-1 .podium-rank{
    background:var(--gold);
    border-color:var(--gold-hi);
    color:#000;
    box-shadow:0 0 20px rgba(255,214,77,.6);
  }

  .rank-2 .podium-rank{
    background:#C0C0C0;
    border-color:#E8E8E8;
    color:#000;
  }

  .rank-3 .podium-rank{
    background:#CD7F32;
    border-color:#E4A853;
    color:#000;
  }

  .podium-player{
    font-family:'Press Start 2P', monospace;
    font-size:11px;
    color:var(--gold);
    margin:8px 0 4px;
    overflow:hidden;
    text-overflow:ellipsis;
  }

  .podium-time{
    font-family:'Press Start 2P', monospace;
    font-size:16px;
    color:#4CAF50;
    margin:4px 0;
  }

  .podium-date{
    font-size:9px;
    color:#a0a8b0;
    font-family:Inter, system-ui, Arial;
  }

  .leaderboard-filters{
    display:flex;
    gap:12px;
    margin-bottom:20px;
    flex-wrap:wrap;
  }

  .filter-btn{
    padding:8px 16px;
    background:rgba(255,214,77,.1);
    border:1px solid rgba(255,214,77,.3);
    color:var(--gold);
    font-family:'Press Start 2P', monospace;
    font-size:9px;
    cursor:pointer;
    border-radius:6px;
    transition:all 0.2s;
  }

  .filter-btn.active{
    background:var(--gold);
    color:#000;
    border-color:var(--gold);
  }

  .filter-btn:hover{
    background:rgba(255,214,77,.2);
    transform:translateY(-1px);
  }

  .leaderboard-table{
    background:rgba(0,0,0,.3);
    border:1px solid rgba(255,214,77,.2);
    border-radius:8px;
    overflow:hidden;
  }

  .table-header{
    display:grid;
    grid-template-columns:60px 1fr 120px 140px;
    gap:12px;
    padding:12px 16px;
    background:rgba(255,214,77,.1);
    border-bottom:1px solid rgba(255,214,77,.2);
    font-family:'Press Start 2P', monospace;
    font-size:9px;
    color:var(--gold);
  }

  .table-row{
    display:grid;
    grid-template-columns:60px 1fr 120px 140px;
    gap:12px;
    padding:12px 16px;
    border-bottom:1px solid rgba(255,214,77,.1);
    font-family:'Press Start 2P', monospace;
    font-size:10px;
    transition:all 0.2s;
  }

  .table-row:hover{
    background:rgba(255,214,77,.05);
  }

  .table-row:last-child{
    border-bottom:none;
  }

  .table-row.user-row{
    background:rgba(76,175,80,.1);
    border:1px solid rgba(76,175,80,.3);
  }

  .rank-badge{
    color:#a0a8b0;
    text-align:center;
  }

  .player-name{
    color:#e6ecf1;
    overflow:hidden;
    text-overflow:ellipsis;
  }

  .reaction-time{
    color:#4CAF50;
    text-align:center;
  }

  .entry-date{
    color:#a0a8b0;
    font-size:9px;
    text-align:right;
  }

  .no-data{
    text-align:center;
    padding:40px 20px;
    color:#a0a8b0;
    font-family:'Press Start 2P', monospace;
    font-size:11px;
  }

  .your-best{
    background:rgba(255,214,77,.05);
    border:1px solid rgba(255,214,77,.2);
    border-radius:8px;
    padding:16px;
    margin-bottom:20px;
    text-align:center;
  }

  .your-best-label{
    font-family:'Press Start 2P', monospace;
    font-size:10px;
    color:#a0a8b0;
    margin-bottom:8px;
  }

  .your-best-time{
    font-family:'Press Start 2P', monospace;
    font-size:20px;
    color:var(--gold);
  }

  /* Loading state */
  .loading-spinner{
    display:inline-block;
    width:20px;
    height:20px;
    border:3px solid rgba(255,214,77,.2);
    border-top-color:var(--gold);
    border-radius:50%;
    animation:spin 1s linear infinite;
  }

  @keyframes spin{
    to{transform:rotate(360deg);}
  }

  /* Error message */
  .error-msg{
    color:#F44336;
    font-size:11px;
    font-family:Inter, system-ui, Arial;
    margin-top:4px;
    display:none;
  }

  .error-msg.show{
    display:block;
  }

  /* Responsive improvements */
  @media(max-width:600px){
    .table-header, .table-row{
      grid-template-columns:50px 1fr 90px;
      font-size:8px;
    }
    .entry-date{
      display:none;
    }
    .podium{
      grid-template-columns:1fr;
    }
    .podium-item.rank-1{
      order:1;
    }
    .podium-item.rank-2{
      order:2;
    }
    .podium-item.rank-3{
      order:3;
    }
    .quest-grid, .inventory-grid{
      grid-template-columns:1fr;
    }
  }

  /* Quest System Styles */
  .quest-container{
    display:none;
    width:min(720px,92vw);
    background:rgba(12,16,20,.10);
    border:2px solid rgba(255,214,77,.3);
    border-radius:12px;
    padding:24px;
    backdrop-filter:blur(8px);
  }

  .quest-header{
    display:flex;
    justify-content:space-between;
    align-items:center;
    margin-bottom:24px;
    padding-bottom:16px;
    border-bottom:1px solid rgba(255,214,77,.2);
  }

  .quest-title{
    font-family:'Press Start 2P', monospace;
    font-size:18px;
    color:var(--gold);
  }

  .quest-tabs{
    display:flex;
    gap:12px;
    margin-bottom:20px;
  }

  .quest-tab{
    padding:10px 20px;
    background:rgba(255,214,77,.1);
    border:1px solid rgba(255,214,77,.3);
    color:var(--gold);
    font-family:'Press Start 2P', monospace;
    font-size:10px;
    cursor:pointer;
    border-radius:6px;
    transition:all 0.2s;
  }

  .quest-tab.active{
    background:var(--gold);
    color:#000;
  }

  .quest-grid{
    display:grid;
    grid-template-columns:repeat(auto-fill, minmax(320px, 1fr));
    gap:16px;
    margin-bottom:20px;
  }

  .quest-card{
    background:rgba(255,214,77,.05);
    border:1px solid rgba(255,214,77,.2);
    border-radius:8px;
    padding:16px;
    transition:all 0.2s;
  }

  .quest-card:hover{
    border-color:var(--gold);
    background:rgba(255,214,77,.1);
  }

  .quest-card.completed{
    background:rgba(76,175,80,.1);
    border-color:rgba(76,175,80,.3);
  }

  .quest-name{
    font-family:'Press Start 2P', monospace;
    font-size:11px;
    color:var(--gold);
    margin-bottom:8px;
  }

  .quest-desc{
    font-family:Inter, system-ui, Arial;
    font-size:12px;
    color:#a0a8b0;
    margin-bottom:12px;
    line-height:1.5;
  }

  .quest-progress{
    margin-bottom:10px;
  }

  .progress-bar{
    width:100%;
    height:8px;
    background:rgba(0,0,0,.4);
    border-radius:4px;
    overflow:hidden;
  }

  .progress-fill{
    height:100%;
    background:linear-gradient(90deg, var(--gold), var(--gold-hi));
    transition:width 0.3s;
  }

  .progress-text{
    font-family:'Press Start 2P', monospace;
    font-size:9px;
    color:#a0a8b0;
    margin-top:4px;
  }

  .quest-reward{
    display:flex;
    align-items:center;
    gap:8px;
    font-family:'Press Start 2P', monospace;
    font-size:10px;
    color:#4CAF50;
  }

  .quest-icon{
    font-size:16px;
  }

  /* Inventory System Styles */
  .inventory-container{
    display:none;
    width:min(820px,92vw);
    background:rgba(12,16,20,.10);
    border:2px solid rgba(255,214,77,.3);
    border-radius:12px;
    padding:24px;
    backdrop-filter:blur(8px);
  }

  .inventory-header{
    display:flex;
    justify-content:space-between;
    align-items:center;
    margin-bottom:24px;
    padding-bottom:16px;
    border-bottom:1px solid rgba(255,214,77,.2);
  }

  .inventory-title{
    font-family:'Press Start 2P', monospace;
    font-size:18px;
    color:var(--gold);
  }

  .gp-display{
    font-family:'Press Start 2P', monospace;
    font-size:14px;
    color:#4CAF50;
  }

  .inventory-grid{
    display:grid;
    grid-template-columns:repeat(auto-fill, minmax(100px, 1fr));
    gap:12px;
    margin-bottom:20px;
  }

  .inventory-slot{
    aspect-ratio:1;
    background:rgba(0,0,0,.4);
    border:2px solid rgba(255,214,77,.2);
    border-radius:8px;
    display:flex;
    flex-direction:column;
    align-items:center;
    justify-content:center;
    cursor:pointer;
    transition:all 0.2s;
    padding:8px;
    position:relative;
  }

  .inventory-slot:hover{
    border-color:var(--gold);
    background:rgba(255,214,77,.1);
  }

  .inventory-slot.empty{
    opacity:0.3;
  }

  .item-icon{
    font-size:32px;
    margin-bottom:4px;
  }

  .item-name{
    font-family:'Press Start 2P', monospace;
    font-size:8px;
    color:#e6ecf1;
    text-align:center;
  }

  .item-count{
    position:absolute;
    bottom:4px;
    right:4px;
    background:rgba(0,0,0,.8);
    padding:2px 4px;
    border-radius:3px;
    font-family:'Press Start 2P', monospace;
    font-size:9px;
    color:var(--gold);
  }

  .shop-section{
    margin-top:30px;
    padding-top:20px;
    border-top:1px solid rgba(255,214,77,.2);
  }

  .shop-title{
    font-family:'Press Start 2P', monospace;
    font-size:14px;
    color:var(--gold);
    margin-bottom:16px;
  }

  .shop-grid{
    display:grid;
    grid-template-columns:repeat(auto-fill, minmax(200px, 1fr));
    gap:16px;
  }

  .shop-item{
    background:rgba(255,214,77,.05);
    border:1px solid rgba(255,214,77,.2);
    border-radius:8px;
    padding:16px;
    text-align:center;
    transition:all 0.2s;
  }

  .shop-item:hover{
    border-color:var(--gold);
    background:rgba(255,214,77,.1);
  }

  .shop-item .item-icon{
    font-size:48px;
    margin-bottom:8px;
  }

  .shop-item-name{
    font-family:'Press Start 2P', monospace;
    font-size:11px;
    color:var(--gold);
    margin-bottom:8px;
  }

  .shop-item-desc{
    font-family:Inter, system-ui, Arial;
    font-size:11px;
    color:#a0a8b0;
    margin-bottom:12px;
  }

  .shop-item-price{
    font-family:'Press Start 2P', monospace;
    font-size:12px;
    color:#4CAF50;
    margin-bottom:12px;
  }

  .buy-btn{
    width:100%;
    padding:8px;
    background:var(--gold);
    border:2px solid var(--gold);
    color:#000;
    font-family:'Press Start 2P', monospace;
    font-size:10px;
    cursor:pointer;
    border-radius:6px;
    transition:all 0.2s;
  }

  .buy-btn:hover:not(:disabled){
    background:var(--gold-hi);
    transform:translateY(-2px);
  }

  .buy-btn:disabled{
    background:rgba(100,100,100,.3);
    border-color:rgba(100,100,100,.2);
    color:rgba(255,255,255,.3);
    cursor:not-allowed;
  }
</style>
</head>
<body>
  <!-- Background always visible with continuous animation -->
  <div class="bg">
    <img src="assets/bg-wildy.png" alt="Wilderness background">
  </div>

  <!-- Particle effects canvas -->
  <canvas class="particles-canvas" id="particlesCanvas"></canvas>

  <!-- CRT Scanlines overlay -->
  <div class="scanlines"></div>

  <!-- Brand always visible with continuous animation -->
  <div class="brand">
    <div class="title">DUEL PVP</div>
    <div class="slogan">
      Real Time<span class="slogan-divider"></span>Real Skill<span class="slogan-divider"></span>Real Rewards
    </div>
  </div>

  <!-- Single page container that swaps content -->
  <main class="page-container" id="pageContainer" role="main" aria-label="Main content">
    <!-- Initial page content -->
    <section class="panel panel-transparent fade-in-delayed" id="panelContent">
      <div class="panel-header">
        <div class="sys">Welcome to the arena<span class="blink">.</span></div>
        <div class="sub-text">Enter your exclusive access code to begin</div>
      </div>

      <div class="input-group">
        <label class="input-label" for="code">Access Code</label>
        <div class="bar">
          <input id="code" class="input-field" type="text" placeholder="XXXX-XXXX-XXXX" autocomplete="off" aria-label="Enter access code" aria-required="true">
          <button class="btn-submit" id="joinBtn" aria-label="Join with access code">JOIN</button>
        </div>
      </div>

      <div class="helper">
        Already have an account? <a id="loginLink" role="button" tabindex="0" aria-label="Sign in to existing account">Sign in</a>
      </div>
    </section>

    <!-- Dashboard content (hidden initially) -->
    <div class="dashboard-content" id="dashboardContent" role="region" aria-label="User dashboard">
      <div class="dashboard-header">
        <div class="user-info">
          <div class="user-name" id="userName" aria-label="User name">Champion</div>
          <div class="user-stats" aria-label="User level and rank">Level 87 • Wilderness Elite</div>
        </div>
        <button class="logout-btn" id="logoutBtn" aria-label="Logout from account">LOGOUT</button>
      </div>

      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-label">TOTAL WINS</div>
          <div class="stat-value">342</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">WIN STREAK</div>
          <div class="stat-value">7</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">RANK</div>
          <div class="stat-value">#127</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">GP EARNED</div>
          <div class="stat-value">2.3M</div>
        </div>
      </div>

      <div class="recent-matches">
        <div class="section-title">RECENT BATTLES</div>
        <div class="match-list">
          <div class="match-item">
            <span>vs. DragonSlayer99</span>
            <span class="match-result win">WIN</span>
          </div>
          <div class="match-item">
            <span>vs. PkMaster420</span>
            <span class="match-result win">WIN</span>
          </div>
          <div class="match-item">
            <span>vs. IronDefender</span>
            <span class="match-result loss">LOSS</span>
          </div>
          <div class="match-item">
            <span>vs. RuneKnight</span>
            <span class="match-result win">WIN</span>
          </div>
        </div>
      </div>

      <div class="action-buttons">
        <button class="action-btn btn-primary" id="playReactionBtn" aria-label="Play reaction game">PLAY REACTION</button>
        <button class="action-btn btn-secondary" id="viewLeaderboardBtn" aria-label="View global leaderboard">VIEW LEADERBOARD</button>
      </div>

      <div class="action-buttons" style="margin-top:12px;">
        <button class="action-btn btn-secondary" id="viewQuestsBtn" aria-label="View quests">VIEW QUESTS</button>
        <button class="action-btn btn-secondary" id="viewInventoryBtn" aria-label="View inventory and shop">INVENTORY & SHOP</button>
      </div>
    </div>

    <!-- Leaderboard content (hidden initially) -->
    <div class="leaderboard-container" id="leaderboardContent" role="region" aria-label="Global leaderboard">
      <div class="leaderboard-header">
        <div class="leaderboard-title">GLOBAL LEADERBOARD</div>
        <button class="back-btn" id="backFromLeaderboardBtn" aria-label="Back to dashboard">BACK</button>
      </div>

      <div class="your-best" id="yourBestSection" style="display:none;">
        <div class="your-best-label">YOUR BEST TIME</div>
        <div class="your-best-time" id="yourBestTime">-- ms</div>
      </div>

      <div class="leaderboard-filters" id="leaderboardFilters" role="group" aria-label="Filter leaderboard by time period">
        <button class="filter-btn active" data-filter="all" aria-label="Show all time scores" aria-pressed="true">ALL TIME</button>
        <button class="filter-btn" data-filter="today" aria-label="Show today's scores" aria-pressed="false">TODAY</button>
        <button class="filter-btn" data-filter="week" aria-label="Show this week's scores" aria-pressed="false">THIS WEEK</button>
        <button class="filter-btn" data-filter="month" aria-label="Show this month's scores" aria-pressed="false">THIS MONTH</button>
      </div>

      <div class="podium" id="podium">
        <!-- Top 3 will be generated here -->
      </div>

      <div class="leaderboard-table">
        <div class="table-header">
          <div>RANK</div>
          <div>PLAYER</div>
          <div>TIME</div>
          <div class="entry-date">DATE</div>
        </div>
        <div id="leaderboardTableBody">
          <!-- Table rows will be generated here -->
        </div>
      </div>
    </div>

    <!-- Quest content (hidden initially) -->
    <div class="quest-container" id="questContent" role="region" aria-label="Quest log">
      <div class="quest-header">
        <div class="quest-title">QUEST LOG</div>
        <button class="back-btn" id="backFromQuestsBtn" aria-label="Back to dashboard">BACK</button>
      </div>

      <div class="quest-tabs">
        <button class="quest-tab active" data-quest-tab="daily">DAILY QUESTS</button>
        <button class="quest-tab" data-quest-tab="weekly">WEEKLY QUESTS</button>
        <button class="quest-tab" data-quest-tab="completed">COMPLETED</button>
      </div>

      <div id="questGrid" class="quest-grid">
        <!-- Quest cards will be generated here -->
      </div>
    </div>

    <!-- Inventory content (hidden initially) -->
    <div class="inventory-container" id="inventoryContent" role="region" aria-label="Inventory and shop">
      <div class="inventory-header">
        <div class="inventory-title">INVENTORY</div>
        <div>
          <div class="gp-display" id="gpDisplay">GP: 0</div>
          <button class="back-btn" id="backFromInventoryBtn" aria-label="Back to dashboard" style="margin-top:8px;">BACK</button>
        </div>
      </div>

      <div class="inventory-grid" id="inventoryGrid">
        <!-- Inventory slots will be generated here -->
      </div>

      <div class="shop-section">
        <div class="shop-title">GP SHOP</div>
        <div class="shop-grid" id="shopGrid">
          <!-- Shop items will be generated here -->
        </div>
      </div>
    </div>

    <!-- Reaction Game content (hidden initially) -->
    <div class="game-container" id="gameContent" role="region" aria-label="Reaction game">
      <div class="game-header">
        <div class="game-title">REACTION TRADER</div>
        <button class="back-btn" id="backToDashBtn" aria-label="Back to dashboard">BACK</button>
      </div>

      <div class="instructions">
        <div class="instructions-title">HOW TO PLAY</div>
        <div class="instructions-text">
          Watch the chart closely. When it turns RED and starts dropping, hit SELL as fast as you can! 
          You have 5 attempts. Your best time will be recorded on the leaderboard.
        </div>
      </div>

      <div class="attempts-counter">
        <span class="attempts-label">ATTEMPTS REMAINING</span>
        <span class="attempts-value" id="attemptsLeft">5 / 5</span>
      </div>

      <div class="results-grid" id="resultsGrid">
        <!-- Results will be added here dynamically -->
      </div>

      <div class="game-area">
        <div class="game-status" id="gameStatus">Click START to begin</div>
        
        <div class="chart-container" id="chartContainer">
          <canvas class="canvas-chart" id="chartCanvas"></canvas>
          <div class="price-display" id="priceDisplay">$42,156</div>
        </div>

        <button class="sell-button" id="sellButton" disabled>SELL</button>
      </div>

      <div class="action-buttons" style="margin-top:20px;">
        <button class="action-btn btn-primary" id="startGameBtn">START GAME</button>
        <button class="action-btn btn-secondary" id="resetGameBtn">RESET</button>
      </div>
    </div>
  </main>

  <div class="footer">© 2025 Duel PVP</div>

  <script>
    // Particle System
    class ParticleSystem {
      constructor(canvas) {
        this.canvas = canvas;
        this.ctx = canvas.getContext('2d');
        this.particles = [];
        this.resize();
        window.addEventListener('resize', () => this.resize());
        this.animate();
      }

      resize() {
        this.canvas.width = window.innerWidth;
        this.canvas.height = window.innerHeight;
      }

      createLavaEmber() {
        // Embers rise from lava areas (bottom 40% of screen, concentrated in center-right where lava is)
        return {
          x: Math.random() * this.canvas.width * 0.7 + this.canvas.width * 0.15, // Center 70% of screen
          y: this.canvas.height - Math.random() * 50, // Start near bottom
          vx: (Math.random() - 0.5) * 0.3, // Slight horizontal drift
          vy: -(Math.random() * 0.8 + 0.3), // Rise upward (slower)
          size: Math.random() * 3 + 1, // 1-4px
          life: 1,
          decay: Math.random() * 0.003 + 0.001, // Fade out slowly
          color: Math.random() > 0.5 ? 'rgba(255,140,60,' : 'rgba(255,100,40,', // Orange/red
          twinkle: Math.random() * Math.PI * 2,
          twinkleSpeed: Math.random() * 0.05 + 0.02,
          type: 'ember'
        };
      }

      createTwinklingStar() {
        // Stars appear in top 30% of screen with size variations
        const sizeRoll = Math.random();
        let size, glowIntensity;

        if (sizeRoll > 0.95) {
          // 5% chance - Large bright star
          size = Math.random() * 1.5 + 2.5; // 2.5-4px
          glowIntensity = 1.2;
        } else if (sizeRoll > 0.7) {
          // 25% chance - Medium star
          size = Math.random() * 1 + 1.5; // 1.5-2.5px
          glowIntensity = 0.9;
        } else {
          // 70% chance - Small star
          size = Math.random() * 0.8 + 0.5; // 0.5-1.3px
          glowIntensity = 0.6;
        }

        return {
          x: Math.random() * this.canvas.width,
          y: Math.random() * this.canvas.height * 0.3, // Top 30%
          vx: 0,
          vy: 0,
          size: size,
          life: 1,
          decay: 0, // Stars don't fade out
          color: 'rgba(255,255,255,',
          twinkle: Math.random() * Math.PI * 2,
          twinkleSpeed: Math.random() * 0.03 + 0.01,
          glowIntensity: glowIntensity,
          type: 'star'
        };
      }

      createShootingStar() {
        // Shooting stars streak across the top half
        const startSide = Math.random() > 0.5 ? 'left' : 'right';
        return {
          x: startSide === 'left' ? 0 : this.canvas.width,
          y: Math.random() * this.canvas.height * 0.4, // Top 40%
          vx: (startSide === 'left' ? 1 : -1) * (Math.random() * 3 + 4), // Fast horizontal
          vy: Math.random() * 0.5 + 0.5, // Slight downward angle
          size: Math.random() * 1 + 1.5, // 1.5-2.5px
          life: 1,
          decay: 0.015, // Fade quickly
          color: 'rgba(255,255,220,',
          tailLength: Math.random() * 40 + 60, // 60-100px tail
          type: 'shooting'
        };
      }

      animate() {
        requestAnimationFrame(() => this.animate());

        // Clear canvas
        this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);

        // Add new particles
        if (Math.random() < 0.15) { // 15% chance each frame for embers
          this.particles.push(this.createLavaEmber());
        }

        // Occasionally add shooting stars (rare)
        if (Math.random() < 0.002) { // 0.2% chance per frame (~1 every 8 seconds)
          this.particles.push(this.createShootingStar());
        }

        // Update and draw particles
        this.particles = this.particles.filter(p => {
          // Update position
          p.x += p.vx;
          p.y += p.vy;

          // Update life
          p.life -= p.decay;

          // Update twinkle (if applicable)
          if (p.twinkle !== undefined) {
            p.twinkle += p.twinkleSpeed;
          }

          // Calculate opacity and draw based on type
          let opacity;

          if (p.type === 'star') {
            opacity = (Math.sin(p.twinkle) * 0.3 + 0.7) * 0.6 * p.glowIntensity;
            this.ctx.shadowBlur = p.size * 8 * p.glowIntensity;
            this.ctx.shadowColor = `rgba(255,255,255,${0.8 * p.glowIntensity})`;
            this.ctx.fillStyle = p.color + opacity + ')';
            this.ctx.beginPath();
            this.ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
            this.ctx.fill();

          } else if (p.type === 'shooting') {
            opacity = p.life;
            // Draw shooting star trail
            const gradient = this.ctx.createLinearGradient(
              p.x, p.y,
              p.x - p.vx * p.tailLength / 5, p.y - p.vy * p.tailLength / 5
            );
            gradient.addColorStop(0, `rgba(255,255,220,${opacity * 0.8})`);
            gradient.addColorStop(0.5, `rgba(255,255,255,${opacity * 0.4})`);
            gradient.addColorStop(1, 'rgba(255,255,255,0)');

            this.ctx.shadowBlur = 15;
            this.ctx.shadowColor = `rgba(255,255,220,${opacity})`;
            this.ctx.strokeStyle = gradient;
            this.ctx.lineWidth = p.size * 2;
            this.ctx.lineCap = 'round';
            this.ctx.beginPath();
            this.ctx.moveTo(p.x, p.y);
            this.ctx.lineTo(p.x - p.vx * 10, p.y - p.vy * 10);
            this.ctx.stroke();

            // Draw bright head
            this.ctx.fillStyle = `rgba(255,255,255,${opacity})`;
            this.ctx.beginPath();
            this.ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
            this.ctx.fill();

          } else { // ember
            opacity = p.life * (Math.sin(p.twinkle) * 0.2 + 0.8);
            this.ctx.shadowBlur = p.size * 8;
            this.ctx.shadowColor = 'rgba(255,140,60,0.6)';
            this.ctx.fillStyle = p.color + opacity + ')';
            this.ctx.beginPath();
            this.ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
            this.ctx.fill();
          }

          // Keep particle if alive and on screen
          if (p.type === 'star') {
            return true; // Stars stay forever
          } else if (p.type === 'shooting') {
            return p.life > 0 && p.x > -100 && p.x < this.canvas.width + 100; // Shooting stars fade or leave screen
          } else {
            return p.life > 0 && p.y > -50; // Embers fade or go off screen
          }
        });

        // Maintain star count
        const starCount = this.particles.filter(p => p.type === 'star').length;
        if (starCount < 40) { // Keep ~40 stars with variations
          this.particles.push(this.createTwinklingStar());
        }
      }
    }

    // Initialize particle system
    const particlesCanvas = document.getElementById('particlesCanvas');
    const particleSystem = new ParticleSystem(particlesCanvas);

    // Single page app logic
    const pageContainer = document.getElementById('pageContainer');
    const panelContent = document.getElementById('panelContent');
    const dashboardContent = document.getElementById('dashboardContent');
    const gameContent = document.getElementById('gameContent');
    const leaderboardContent = document.getElementById('leaderboardContent');
    const questContent = document.getElementById('questContent');
    const inventoryContent = document.getElementById('inventoryContent');

    // Debug: Check if all elements exist
    console.log('Elements loaded:', {
      pageContainer: !!pageContainer,
      panelContent: !!panelContent,
      dashboardContent: !!dashboardContent,
      gameContent: !!gameContent,
      leaderboardContent: !!leaderboardContent,
      questContent: !!questContent,
      inventoryContent: !!inventoryContent,
      viewLeaderboardBtn: !!document.getElementById('viewLeaderboardBtn')
    });
    
    // Game variables
    let gameState = {
      attempts: [],
      currentAttempt: 0,
      maxAttempts: 5,
      isPlaying: false,
      startTime: null,
      reactionTimer: null,
      chartAnimation: null
    };

    // Temporary registration data
    let tempRegistrationData = {
      email: '',
      warriorName: ''
    };

    // Helper function to swap content with fade animation
    function swapContent(newContent, data) {
      // Find currently visible element
      const allContainers = [panelContent, dashboardContent, gameContent, leaderboardContent, questContent, inventoryContent];
      const currentVisible = allContainers.find(el => el.style.display !== 'none' && el.style.display !== '');

      // Add fade-out to current visible element
      if (currentVisible) {
        currentVisible.classList.add('fade-out');
        currentVisible.classList.remove('fade-in', 'fade-in-delayed');
      }

      // Wait for fade-out animation, then swap content
      setTimeout(() => {
        if (newContent === 'login') {
          panelContent.style.display = 'block';
          dashboardContent.style.display = 'none';
          gameContent.style.display = 'none';
          leaderboardContent.style.display = 'none';
          questContent.style.display = 'none';
          inventoryContent.style.display = 'none';
          panelContent.classList.remove('panel-transparent');

          panelContent.innerHTML = `
          <div class="panel-header">
            <div class="sys">Welcome back, champion<span class="blink">.</span></div>
            <div class="sub-text">Enter your credentials to access the arena</div>
          </div>

          <div class="input-group">
            <label class="input-label">Email Address</label>
            <input id="loginEmail" class="input-field" type="email" placeholder="name@example.com" autocomplete="email">
            <div class="error-msg" id="emailError"></div>
          </div>

          <div class="input-group">
            <label class="input-label">Password</label>
            <div class="bar">
              <input id="loginPass" class="input-field" type="password" placeholder="Enter your password" autocomplete="current-password">
              <button class="btn-submit" id="loginBtn">LOG IN</button>
            </div>
            <div class="error-msg" id="passError"></div>
          </div>

          <div class="helper">
            Don't have access? <a id="backLink">Get access code</a>
          </div>
        `;

        // Re-attach event listeners
        document.getElementById('loginBtn').addEventListener('click', handleLogin);
        const backLink = document.getElementById('backLink');
        backLink.addEventListener('click', () => swapContent('home'));
        backLink.addEventListener('keypress', (e) => {
          if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            swapContent('home');
          }
        });
        // Allow enter key to submit
        document.getElementById('loginPass').addEventListener('keypress', (e) => {
          if (e.key === 'Enter') handleLogin();
        });

      } else if (newContent === 'register') {
        panelContent.style.display = 'block';
        dashboardContent.style.display = 'none';
        gameContent.style.display = 'none';
        leaderboardContent.style.display = 'none';
        questContent.style.display = 'none';
        inventoryContent.style.display = 'none';
        pageContainer.classList.remove('center-aligned');
        panelContent.classList.remove('panel-transparent');

        panelContent.innerHTML = `
          <div class="panel-header">
            <div class="sys">Create your account<span class="blink">.</span></div>
            <div class="sub-text">Join the arena and prove your worth</div>
          </div>

          <div class="input-group">
            <label class="input-label">Email Address</label>
            <input id="registerEmail" class="input-field" type="email" placeholder="name@example.com" autocomplete="email">
          </div>

          <div class="input-group">
            <label class="input-label">Password</label>
            <input id="registerPass" class="input-field" type="password" placeholder="Enter your password" autocomplete="new-password">
          </div>

          <div class="input-group">
            <label class="input-label">Confirm Password</label>
            <input id="registerPassConfirm" class="input-field" type="password" placeholder="Confirm your password" autocomplete="new-password">
          </div>

          <div class="input-group">
            <label class="input-label">Access Code</label>
            <div class="bar">
              <input id="registerCode" class="input-field" type="text" placeholder="XXXX-XXXX-XXXX" autocomplete="off" value="${data || ''}">
              <button class="btn-submit" id="registerBtn">CREATE ACCOUNT</button>
            </div>
          </div>

          <div class="helper">
            Already have an account? <a id="loginLinkFromReg" role="button" tabindex="0">Sign in</a>
          </div>
        `;

        // Re-attach event listeners
        document.getElementById('registerBtn').addEventListener('click', handleRegister);
        const loginLinkFromReg = document.getElementById('loginLinkFromReg');
        loginLinkFromReg.addEventListener('click', () => swapContent('login'));
        loginLinkFromReg.addEventListener('keypress', (e) => {
          if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            swapContent('login');
          }
        });
        // Allow enter key to submit
        document.getElementById('registerPassConfirm').addEventListener('keypress', (e) => {
          if (e.key === 'Enter') handleRegister();
        });

      } else if (newContent === 'nameWarrior') {
        panelContent.style.display = 'block';
        dashboardContent.style.display = 'none';
        gameContent.style.display = 'none';
        leaderboardContent.style.display = 'none';
        questContent.style.display = 'none';
        inventoryContent.style.display = 'none';
        pageContainer.classList.add('center-aligned');
        panelContent.classList.remove('panel-transparent');

        panelContent.innerHTML = `
          <div class="panel-header">
            <div class="warrior-title">NAME YOUR WARRIOR</div>
            <div class="sub-text">Choose a name that strikes fear into your enemies</div>
          </div>

          <div class="input-group">
            <input id="warriorName" class="warrior-input" type="text" placeholder="Enter warrior name" maxlength="16" autocomplete="off">
          </div>

          <div class="input-group">
            <button class="btn-submit" id="confirmNameBtn" style="width:100%;">ENTER THE ARENA</button>
          </div>
        `;

        panelContent.classList.remove('fade-in', 'warrior-naming');
        void panelContent.offsetWidth;
        panelContent.classList.add('warrior-naming');

        // Re-attach event listeners
        document.getElementById('confirmNameBtn').addEventListener('click', handleNameWarrior);
        document.getElementById('warriorName').addEventListener('keypress', (e) => {
          if (e.key === 'Enter') handleNameWarrior();
        });
        // Auto-focus the input
        setTimeout(() => {
          document.getElementById('warriorName').focus();
        }, 500);

      } else if (newContent === 'home') {
        panelContent.style.display = 'block';
        dashboardContent.style.display = 'none';
        gameContent.style.display = 'none';
        leaderboardContent.style.display = 'none';
        questContent.style.display = 'none';
        inventoryContent.style.display = 'none';
        panelContent.classList.add('panel-transparent');

        panelContent.innerHTML = `
          <div class="panel-header">
            <div class="sys">Welcome to the arena<span class="blink">.</span></div>
            <div class="sub-text">Enter your exclusive access code to begin</div>
          </div>

          <div class="input-group">
            <label class="input-label">Access Code</label>
            <div class="bar">
              <input id="code" class="input-field" type="text" placeholder="XXXX-XXXX-XXXX" autocomplete="off">
              <button class="btn-submit" id="joinBtn">JOIN</button>
            </div>
            <div class="error-msg" id="codeError"></div>
          </div>

          <div class="helper">
            Already have an account? <a id="loginLink">Sign in</a>
          </div>
        `;

        // Re-attach event listeners
        document.getElementById('joinBtn').addEventListener('click', handleJoin);
        const loginLink = document.getElementById('loginLink');
        loginLink.addEventListener('click', () => swapContent('login'));
        loginLink.addEventListener('keypress', (e) => {
          if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            swapContent('login');
          }
        });
        // Allow enter key to submit
        document.getElementById('code').addEventListener('keypress', (e) => {
          if (e.key === 'Enter') handleJoin();
        });

      } else if (newContent === 'dashboard') {
        panelContent.style.display = 'none';
        dashboardContent.style.display = 'block';
        gameContent.style.display = 'none';
        leaderboardContent.style.display = 'none';
        questContent.style.display = 'none';
        inventoryContent.style.display = 'none';
        updateDashboardStats();

      } else if (newContent === 'game') {
        panelContent.style.display = 'none';
        dashboardContent.style.display = 'none';
        gameContent.style.display = 'block';
        leaderboardContent.style.display = 'none';
        questContent.style.display = 'none';
        inventoryContent.style.display = 'none';
        initChart();

      } else if (newContent === 'leaderboard') {
        console.log('Switching to leaderboard...');
        panelContent.style.display = 'none';
        dashboardContent.style.display = 'none';
        gameContent.style.display = 'none';
        leaderboardContent.style.display = 'block';
        questContent.style.display = 'none';
        inventoryContent.style.display = 'none';
        console.log('Leaderboard display set to block');
        loadLeaderboard('all');
        console.log('loadLeaderboard called');

      } else if (newContent === 'quests') {
        panelContent.style.display = 'none';
        dashboardContent.style.display = 'none';
        gameContent.style.display = 'none';
        leaderboardContent.style.display = 'none';
        questContent.style.display = 'block';
        inventoryContent.style.display = 'none';
        loadQuests('daily');

      } else if (newContent === 'inventory') {
        panelContent.style.display = 'none';
        dashboardContent.style.display = 'none';
        gameContent.style.display = 'none';
        leaderboardContent.style.display = 'none';
        questContent.style.display = 'none';
        inventoryContent.style.display = 'block';
        loadInventory();
      }

        // Add fade-in animation to newly visible element
        const newVisible = allContainers.find(el => el.style.display === 'block');
        if (newVisible) {
          newVisible.classList.remove('fade-out', 'fade-in-delayed');
          void newVisible.offsetWidth; // Force reflow
          newVisible.classList.add('fade-in');
        }
      }, currentVisible ? 200 : 0); // 200ms matches fade-out animation duration
    }
    
    // Validation functions
    function validateEmail(email) {
      const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      return re.test(email);
    }

    function validateAccessCode(code) {
      // Format: XXXX-XXXX-XXXX (alphanumeric)
      const re = /^[A-Z0-9]{4}-[A-Z0-9]{4}-[A-Z0-9]{4}$/i;
      return re.test(code);
    }

    function showError(elementId, message) {
      const errorEl = document.getElementById(elementId);
      if (errorEl) {
        errorEl.textContent = message;
        errorEl.classList.add('show');
      }
    }

    function clearError(elementId) {
      const errorEl = document.getElementById(elementId);
      if (errorEl) {
        errorEl.classList.remove('show');
      }
    }

    // Event handlers
    function handleJoin() {
      const codeInput = document.getElementById('code');
      const code = codeInput.value.trim();

      clearError('codeError');

      if (!code) {
        showError('codeError', 'Please enter an access code');
        return;
      }

      // Accept any code - no validation required
      swapContent('register', code);
    }

    function handleLogin() {
      const emailInput = document.getElementById('loginEmail');
      const passInput = document.getElementById('loginPass');
      const email = emailInput.value.trim();
      const pass = passInput.value.trim();

      clearError('emailError');
      clearError('passError');

      let hasError = false;

      if (!email) {
        showError('emailError', 'Email is required');
        hasError = true;
      } else if (!validateEmail(email)) {
        showError('emailError', 'Invalid email format');
        hasError = true;
      }

      if (!pass) {
        showError('passError', 'Password is required');
        hasError = true;
      } else if (pass.length < 6) {
        showError('passError', 'Password must be at least 6 characters');
        hasError = true;
      }

      if (hasError) return;

      // Store email and show dashboard
      try {
        localStorage.setItem('duelpvp_email', email);
        // Try to load warrior name, fall back to email
        const warriorName = localStorage.getItem('duelpvp_warrior');
        document.getElementById('userName').textContent = (warriorName || email.split('@')[0]).toUpperCase();
      } catch (e) {
        showError('passError', 'Failed to save login. Check browser settings.');
        return;
      }

      swapContent('dashboard');
    }

    function handleRegister() {
      const email = document.getElementById('registerEmail').value.trim();
      const pass = document.getElementById('registerPass').value.trim();
      const passConfirm = document.getElementById('registerPassConfirm').value.trim();
      const code = document.getElementById('registerCode').value.trim();

      if (!email || !pass || !passConfirm || !code) {
        alert('Please fill in all fields');
        return;
      }

      if (!validateEmail(email)) {
        alert('Please enter a valid email address');
        return;
      }

      if (pass !== passConfirm) {
        alert('Passwords do not match');
        return;
      }

      if (pass.length < 8) {
        alert('Password must be at least 8 characters');
        return;
      }

      // Store email temporarily and show warrior naming screen
      tempRegistrationData.email = email;
      swapContent('nameWarrior');
    }

    function handleNameWarrior() {
      const warriorName = document.getElementById('warriorName').value.trim();

      if (!warriorName) {
        alert('Please enter a warrior name');
        return;
      }

      if (warriorName.length < 3) {
        alert('Warrior name must be at least 3 characters');
        return;
      }

      if (warriorName.length > 16) {
        alert('Warrior name must be 16 characters or less');
        return;
      }

      // Store warrior name and email
      tempRegistrationData.warriorName = warriorName;
      try {
        localStorage.setItem('duelpvp_email', tempRegistrationData.email);
        localStorage.setItem('duelpvp_warrior', warriorName);
        document.getElementById('userName').textContent = warriorName.toUpperCase();
      } catch (e) {
        alert('Failed to save registration. Check browser settings.');
        return;
      }

      swapContent('dashboard');
    }

    function handleLogout() {
      dashboardContent.style.display = 'none';
      panelContent.style.display = 'block';
      swapContent('home');
    }

    // Dashboard stats update
    function updateDashboardStats() {
      try {
        const email = localStorage.getItem('duelpvp_email') || 'anonymous';
        const scores = JSON.parse(localStorage.getItem('duelpvp_scores') || '[]');

        // Filter user's scores
        const userScores = scores.filter(s => s.email === email);

        // Calculate stats
        const totalWins = userScores.length;
        const bestTime = userScores.length > 0 ? Math.min(...userScores.map(s => s.time)) : 0;

        // Get user rank
        const allBestTimes = {};
        scores.forEach(s => {
          if (!allBestTimes[s.email] || s.time < allBestTimes[s.email]) {
            allBestTimes[s.email] = s.time;
          }
        });
        const rankedUsers = Object.entries(allBestTimes).sort((a, b) => a[1] - b[1]);
        const userRank = rankedUsers.findIndex(u => u[0] === email) + 1;

        // Calculate win streak (last consecutive wins)
        let streak = 0;
        for (let i = userScores.length - 1; i >= 0; i--) {
          if (userScores[i].time < 500) { // Consider <500ms as good
            streak++;
          } else {
            break;
          }
        }

        // Calculate total GP earned (100 GP per win, bonus for fast times)
        let totalGP = 0;
        userScores.forEach(s => {
          totalGP += 100; // Base GP
          if (s.time < 300) totalGP += 50; // Speed bonus
          if (s.time < 200) totalGP += 100; // Elite bonus
        });

        // Update UI
        document.querySelector('.stat-card:nth-child(1) .stat-value').textContent = totalWins;
        document.querySelector('.stat-card:nth-child(2) .stat-value').textContent = streak;
        document.querySelector('.stat-card:nth-child(3) .stat-value').textContent = userRank > 0 ? `#${userRank}` : '--';
        document.querySelector('.stat-card:nth-child(4) .stat-value').textContent = totalGP >= 1000000 ? `${(totalGP/1000000).toFixed(1)}M` : `${(totalGP/1000).toFixed(1)}K`;

      } catch (e) {
        console.error('Failed to update dashboard stats:', e);
      }
    }

    // Leaderboard functions
    function loadLeaderboard(filter) {
      console.log('loadLeaderboard called with filter:', filter);
      try {
        const email = localStorage.getItem('duelpvp_email') || 'anonymous';
        let scores = JSON.parse(localStorage.getItem('duelpvp_scores') || '[]');
        console.log('Loaded scores:', scores.length, 'entries');

        // Filter by time period
        const now = new Date();
        if (filter === 'today') {
          const todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate());
          scores = scores.filter(s => new Date(s.date) >= todayStart);
        } else if (filter === 'week') {
          const weekStart = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
          scores = scores.filter(s => new Date(s.date) >= weekStart);
        } else if (filter === 'month') {
          const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
          scores = scores.filter(s => new Date(s.date) >= monthStart);
        }

        // Get best time per player
        const bestTimes = {};
        scores.forEach(s => {
          if (!bestTimes[s.email] || s.time < bestTimes[s.email].time) {
            bestTimes[s.email] = s;
          }
        });

        // Convert to array and sort
        const leaderboard = Object.values(bestTimes).sort((a, b) => a.time - b.time);

        // Show user's best time
        const userBest = leaderboard.find(s => s.email === email);
        if (userBest) {
          document.getElementById('yourBestSection').style.display = 'block';
          document.getElementById('yourBestTime').textContent = `${userBest.time.toFixed(0)}ms`;
        } else {
          document.getElementById('yourBestSection').style.display = 'none';
        }

        // Render podium (top 3)
        renderPodium(leaderboard.slice(0, 3));

        // Render table
        renderLeaderboardTable(leaderboard, email);

      } catch (e) {
        console.error('Failed to load leaderboard:', e);
        document.getElementById('leaderboardTableBody').innerHTML = '<div class="no-data">Error loading leaderboard</div>';
      }
    }

    function renderPodium(topThree) {
      const podium = document.getElementById('podium');
      podium.innerHTML = '';

      if (topThree.length === 0) {
        podium.innerHTML = '<div class="no-data" style="grid-column: 1/-1;">No scores yet. Be the first!</div>';
        return;
      }

      topThree.forEach((score, index) => {
        const rank = index + 1;
        const playerName = score.email.split('@')[0];
        const date = new Date(score.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });

        const podiumItem = document.createElement('div');
        podiumItem.className = `podium-item rank-${rank}`;
        podiumItem.innerHTML = `
          <div class="podium-rank">${rank}</div>
          <div class="podium-player">${playerName.toUpperCase()}</div>
          <div class="podium-time">${score.time.toFixed(0)}ms</div>
          <div class="podium-date">${date}</div>
        `;
        podium.appendChild(podiumItem);
      });

      // Add empty slots if less than 3
      for (let i = topThree.length; i < 3; i++) {
        const podiumItem = document.createElement('div');
        podiumItem.className = `podium-item rank-${i + 1}`;
        podiumItem.innerHTML = `
          <div class="podium-rank">${i + 1}</div>
          <div class="podium-player">---</div>
          <div class="podium-time">--ms</div>
          <div class="podium-date">No entry</div>
        `;
        podium.appendChild(podiumItem);
      }
    }

    function renderLeaderboardTable(leaderboard, currentEmail) {
      const tbody = document.getElementById('leaderboardTableBody');
      tbody.innerHTML = '';

      if (leaderboard.length === 0) {
        tbody.innerHTML = '<div class="no-data">No scores recorded yet</div>';
        return;
      }

      leaderboard.forEach((score, index) => {
        const rank = index + 1;
        const playerName = score.email.split('@')[0];
        const date = new Date(score.date).toLocaleDateString('en-US', {
          month: 'short',
          day: 'numeric',
          year: 'numeric'
        });
        const isCurrentUser = score.email === currentEmail;

        const row = document.createElement('div');
        row.className = isCurrentUser ? 'table-row user-row' : 'table-row';
        row.innerHTML = `
          <div class="rank-badge">#${rank}</div>
          <div class="player-name">${playerName.toUpperCase()}${isCurrentUser ? ' (YOU)' : ''}</div>
          <div class="reaction-time">${score.time.toFixed(0)}ms</div>
          <div class="entry-date">${date}</div>
        `;
        tbody.appendChild(row);
      });
    }

    function handleFilterChange(filter) {
      // Update active button
      document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.classList.remove('active');
        btn.setAttribute('aria-pressed', 'false');
      });
      event.target.classList.add('active');
      event.target.setAttribute('aria-pressed', 'true');

      // Reload leaderboard
      loadLeaderboard(filter);
    }
    
    // Game functions
    function initChart() {
      const canvas = document.getElementById('chartCanvas');
      const ctx = canvas.getContext('2d');
      canvas.width = canvas.offsetWidth;
      canvas.height = canvas.offsetHeight;
      drawChart(ctx, false);
    }
    
    function drawChart(ctx, isRed = false) {
      const canvas = ctx.canvas;
      const w = canvas.width;
      const h = canvas.height;
      
      // Clear canvas
      ctx.clearRect(0, 0, w, h);
      
      // Draw grid
      ctx.strokeStyle = 'rgba(255,214,77,0.1)';
      ctx.lineWidth = 1;
      ctx.setLineDash([2, 4]);
      
      // Horizontal lines
      for (let i = 0; i < 5; i++) {
        ctx.beginPath();
        ctx.moveTo(0, (h / 5) * i);
        ctx.lineTo(w, (h / 5) * i);
        ctx.stroke();
      }
      
      // Vertical lines
      for (let i = 0; i < 10; i++) {
        ctx.beginPath();
        ctx.moveTo((w / 10) * i, 0);
        ctx.lineTo((w / 10) * i, h);
        ctx.stroke();
      }
      
      ctx.setLineDash([]);
      
      // Generate random chart data
      const points = [];
      const numPoints = 50;
      let currentPrice = 42156;
      
      for (let i = 0; i < numPoints; i++) {
        const change = (Math.random() - 0.48) * 500;
        currentPrice += change;
        points.push({
          x: (w / numPoints) * i,
          y: h - (currentPrice - 40000) / 50
        });
      }
      
      // Draw line
      ctx.strokeStyle = isRed ? '#F44336' : '#4CAF50';
      ctx.lineWidth = 3;
      ctx.beginPath();
      points.forEach((point, i) => {
        if (i === 0) ctx.moveTo(point.x, point.y);
        else ctx.lineTo(point.x, point.y);
      });
      ctx.stroke();
      
      // Draw fill
      ctx.fillStyle = isRed ? 'rgba(244,67,54,0.1)' : 'rgba(76,175,80,0.1)';
      ctx.beginPath();
      ctx.moveTo(points[0].x, points[0].y);
      points.forEach(point => ctx.lineTo(point.x, point.y));
      ctx.lineTo(points[points.length - 1].x, h);
      ctx.lineTo(points[0].x, h);
      ctx.closePath();
      ctx.fill();
      
      // Animate if red
      if (isRed && gameState.chartAnimation) {
        cancelAnimationFrame(gameState.chartAnimation);
      }
      
      if (isRed) {
        let dropAmount = 0;
        const animate = () => {
          dropAmount += 2;
          ctx.clearRect(0, 0, w, h);
          
          // Redraw with dropping effect
          ctx.strokeStyle = '#F44336';
          ctx.lineWidth = 3;
          ctx.beginPath();
          points.forEach((point, i) => {
            const dropY = Math.min(point.y + dropAmount * (i / numPoints), h - 10);
            if (i === 0) ctx.moveTo(point.x, dropY);
            else ctx.lineTo(point.x, dropY);
          });
          ctx.stroke();
          
          if (dropAmount < 100) {
            gameState.chartAnimation = requestAnimationFrame(animate);
          }
        };
        animate();
      }
    }
    
    function startGame() {
      if (gameState.currentAttempt >= gameState.maxAttempts) {
        alert('All attempts used! Click RESET to play again.');
        return;
      }
      
      const chartContainer = document.getElementById('chartContainer');
      const sellButton = document.getElementById('sellButton');
      const gameStatus = document.getElementById('gameStatus');
      const canvas = document.getElementById('chartCanvas');
      const ctx = canvas.getContext('2d');
      
      // Reset state
      chartContainer.className = 'chart-container green';
      sellButton.disabled = true;
      gameStatus.textContent = 'Get ready...';
      gameStatus.className = 'game-status status-ready';
      drawChart(ctx, false);
      
      // Random delay between 2-6 seconds
      const delay = 2000 + Math.random() * 4000;
      
      gameState.reactionTimer = setTimeout(() => {
        // Turn red and enable sell
        chartContainer.className = 'chart-container red';
        sellButton.disabled = false;
        gameStatus.textContent = 'SELL NOW!';
        gameStatus.className = 'game-status status-go';
        drawChart(ctx, true);
        
        // Start timing
        gameState.startTime = performance.now();
        gameState.isPlaying = true;
      }, delay);
    }
    
    function handleSell() {
      if (!gameState.isPlaying || !gameState.startTime) return;
      
      const reactionTime = performance.now() - gameState.startTime;
      gameState.attempts.push(reactionTime);
      gameState.currentAttempt++;
      gameState.isPlaying = false;
      
      // Update UI
      const sellButton = document.getElementById('sellButton');
      sellButton.disabled = true;
      document.getElementById('gameStatus').textContent = `Time: ${reactionTime.toFixed(0)}ms`;
      
      // Update attempts counter
      const remaining = gameState.maxAttempts - gameState.currentAttempt;
      document.getElementById('attemptsLeft').textContent = `${remaining} / ${gameState.maxAttempts}`;
      
      // Update results grid
      updateResultsGrid();
      
      // Clear timer
      if (gameState.reactionTimer) {
        clearTimeout(gameState.reactionTimer);
      }
      
      // Check if game is over
      if (gameState.currentAttempt >= gameState.maxAttempts) {
        endGame();
      }
    }
    
    function updateResultsGrid() {
      const grid = document.getElementById('resultsGrid');
      grid.innerHTML = '';
      
      const bestTime = Math.min(...gameState.attempts);
      
      gameState.attempts.forEach((time, index) => {
        const card = document.createElement('div');
        card.className = time === bestTime ? 'result-card best' : 'result-card';
        card.innerHTML = `
          <div class="result-attempt">TRY ${index + 1}</div>
          <div class="result-time">${time.toFixed(0)}ms</div>
        `;
        grid.appendChild(card);
      });
    }
    
    function endGame() {
      const bestTime = Math.min(...gameState.attempts);
      document.getElementById('gameStatus').textContent = `Game Over! Best: ${bestTime.toFixed(0)}ms`;

      // Save to "database" (localStorage for now)
      try {
        const email = localStorage.getItem('duelpvp_email') || 'anonymous';
        const scores = JSON.parse(localStorage.getItem('duelpvp_scores') || '[]');
        scores.push({
          email,
          time: bestTime,
          date: new Date().toISOString()
        });
        localStorage.setItem('duelpvp_scores', JSON.stringify(scores));

        // Update quest progress
        updateQuestProgress('daily_play_3');
        updateQuestProgress('weekly_play_20');

        // Check for fast time quests
        if (bestTime < 300) {
          updateQuestProgress('daily_fast_time');
        }
        if (bestTime < 250) {
          updateQuestProgress('weekly_sub_250');
        }

        // Auto-complete login quest on first game
        updateQuestProgress('daily_login');

      } catch (e) {}
    }
    
    function resetGame() {
      gameState = {
        attempts: [],
        currentAttempt: 0,
        maxAttempts: 5,
        isPlaying: false,
        startTime: null,
        reactionTimer: null,
        chartAnimation: null
      };
      
      // Clear any running timers
      if (gameState.reactionTimer) clearTimeout(gameState.reactionTimer);
      if (gameState.chartAnimation) cancelAnimationFrame(gameState.chartAnimation);
      
      // Reset UI
      document.getElementById('chartContainer').className = 'chart-container';
      document.getElementById('sellButton').disabled = true;
      document.getElementById('gameStatus').textContent = 'Click START to begin';
      document.getElementById('attemptsLeft').textContent = '5 / 5';
      document.getElementById('resultsGrid').innerHTML = '';
      
      const canvas = document.getElementById('chartCanvas');
      const ctx = canvas.getContext('2d');
      drawChart(ctx, false);
    }

    // Quest System Data and Functions
    const QUESTS = {
      daily: [
        {id: 'daily_play_3', name: 'Speed Demon', desc: 'Play 3 reaction games', target: 3, reward: 500, icon: '⚡'},
        {id: 'daily_fast_time', name: 'Lightning Reflexes', desc: 'Get a time under 300ms', target: 1, reward: 750, icon: '⏱️'},
        {id: 'daily_streak_3', name: 'On Fire', desc: 'Win 3 games in a row', target: 3, reward: 600, icon: '🔥'},
        {id: 'daily_login', name: 'Daily Warrior', desc: 'Login to the arena', target: 1, reward: 250, icon: '🗡️'}
      ],
      weekly: [
        {id: 'weekly_play_20', name: 'Arena Regular', desc: 'Play 20 reaction games', target: 20, reward: 2500, icon: '🎮'},
        {id: 'weekly_top_10', name: 'Elite Fighter', desc: 'Reach top 10 on leaderboard', target: 1, reward: 5000, icon: '🏆'},
        {id: 'weekly_sub_250', name: 'Reflex Master', desc: 'Get 5 times under 250ms', target: 5, reward: 3000, icon: '⚡'},
        {id: 'weekly_shop', name: 'Merchant', desc: 'Buy 3 items from shop', target: 3, reward: 1500, icon: '🛒'}
      ]
    };

    function loadQuests(type) {
      const questGrid = document.getElementById('questGrid');
      const email = localStorage.getItem('duelpvp_email') || 'anonymous';
      let questProgress = JSON.parse(localStorage.getItem(`duelpvp_quests_${email}`) || '{}');

      // Reset daily quests if needed
      const lastDaily = localStorage.getItem(`duelpvp_last_daily_${email}`);
      const today = new Date().toDateString();
      if (lastDaily !== today) {
        Object.keys(questProgress).forEach(key => {
          if (key.startsWith('daily_')) delete questProgress[key];
        });
        localStorage.setItem(`duelpvp_last_daily_${email}`, today);
      }

      questGrid.innerHTML = '';
      const quests = type === 'completed'
        ? [...QUESTS.daily, ...QUESTS.weekly].filter(q => (questProgress[q.id] || 0) >= q.target)
        : QUESTS[type] || QUESTS.daily;

      quests.forEach(quest => {
        const progress = questProgress[quest.id] || 0;
        const completed = progress >= quest.target;
        const claimed = questProgress[`${quest.id}_claimed`] || false;

        const card = document.createElement('div');
        card.className = `quest-card ${completed ? 'completed' : ''}`;
        card.innerHTML = `
          <div class="quest-name"><span class="quest-icon">${quest.icon}</span> ${quest.name}</div>
          <div class="quest-desc">${quest.desc}</div>
          <div class="quest-progress">
            <div class="progress-bar">
              <div class="progress-fill" style="width:${Math.min(100, (progress/quest.target)*100)}%"></div>
            </div>
            <div class="progress-text">${progress} / ${quest.target}</div>
          </div>
          <div class="quest-reward">
            💰 ${quest.reward} GP ${completed && !claimed ? '• <span style="color:var(--gold)">CLAIM!</span>' : completed ? '✓ CLAIMED' : ''}
          </div>
        `;

        if (completed && !claimed) {
          card.style.cursor = 'pointer';
          card.addEventListener('click', () => claimQuestReward(quest.id, quest.reward));
        }

        questGrid.appendChild(card);
      });

      if (quests.length === 0) {
        questGrid.innerHTML = '<div class="no-data">No quests available</div>';
      }
    }

    function claimQuestReward(questId, reward) {
      const email = localStorage.getItem('duelpvp_email') || 'anonymous';
      let questProgress = JSON.parse(localStorage.getItem(`duelpvp_quests_${email}`) || '{}');

      if (questProgress[`${questId}_claimed`]) return;

      questProgress[`${questId}_claimed`] = true;
      localStorage.setItem(`duelpvp_quests_${email}`, JSON.stringify(questProgress));

      // Add GP
      let gp = parseInt(localStorage.getItem(`duelpvp_gp_${email}`) || '0');
      gp += reward;
      localStorage.setItem(`duelpvp_gp_${email}`, gp.toString());

      // Reload quests
      const activeTab = document.querySelector('.quest-tab.active').getAttribute('data-quest-tab');
      loadQuests(activeTab);

      // Show notification
      alert(`Quest completed! +${reward} GP`);
    }

    function updateQuestProgress(questId, amount = 1) {
      const email = localStorage.getItem('duelpvp_email') || 'anonymous';
      let questProgress = JSON.parse(localStorage.getItem(`duelpvp_quests_${email}`) || '{}');
      questProgress[questId] = (questProgress[questId] || 0) + amount;
      localStorage.setItem(`duelpvp_quests_${email}`, JSON.stringify(questProgress));
    }

    // Inventory and Shop System
    const SHOP_ITEMS = [
      {id: 'sword_bronze', name: 'Bronze Sword', desc: 'A sturdy starter weapon', price: 1000, icon: '🗡️', type: 'weapon'},
      {id: 'sword_iron', name: 'Iron Sword', desc: 'Sharper than bronze', price: 2500, icon: '⚔️', type: 'weapon'},
      {id: 'sword_steel', name: 'Steel Sword', desc: 'Forged with precision', price: 5000, icon: '🗡️', type: 'weapon'},
      {id: 'armor_leather', name: 'Leather Armor', desc: 'Basic protection', price: 1500, icon: '🛡️', type: 'armor'},
      {id: 'armor_chain', name: 'Chain Mail', desc: 'Medium protection', price: 3500, icon: '🛡️', type: 'armor'},
      {id: 'armor_plate', name: 'Plate Armor', desc: 'Heavy protection', price: 7500, icon: '🛡️', type: 'armor'},
      {id: 'potion_health', name: 'Health Potion', desc: 'Restores vitality', price: 500, icon: '🧪', type: 'consumable'},
      {id: 'potion_speed', name: 'Speed Potion', desc: 'Boosts reflexes', price: 750, icon: '⚗️', type: 'consumable'},
      {id: 'cape_red', name: 'Red Cape', desc: 'Show off your style', price: 2000, icon: '🎽', type: 'cosmetic'},
      {id: 'cape_blue', name: 'Blue Cape', desc: 'Cool and collected', price: 2000, icon: '🎽', type: 'cosmetic'},
      {id: 'pet_dog', name: 'War Hound', desc: 'A loyal companion', price: 10000, icon: '🐕', type: 'pet'},
      {id: 'pet_dragon', name: 'Baby Dragon', desc: 'Rare and powerful', price: 50000, icon: '🐉', type: 'pet'}
    ];

    function loadInventory() {
      const email = localStorage.getItem('duelpvp_email') || 'anonymous';
      const gp = parseInt(localStorage.getItem(`duelpvp_gp_${email}`) || '0');
      const inventory = JSON.parse(localStorage.getItem(`duelpvp_inventory_${email}`) || '[]');

      // Update GP display
      document.getElementById('gpDisplay').textContent = `GP: ${gp.toLocaleString()}`;

      // Render inventory
      const inventoryGrid = document.getElementById('inventoryGrid');
      inventoryGrid.innerHTML = '';

      // Show first 28 slots (like RuneScape)
      for (let i = 0; i < 28; i++) {
        const item = inventory[i];
        const slot = document.createElement('div');
        slot.className = item ? 'inventory-slot' : 'inventory-slot empty';

        if (item) {
          const shopItem = SHOP_ITEMS.find(si => si.id === item.id);
          slot.innerHTML = `
            <div class="item-icon">${shopItem.icon}</div>
            <div class="item-name">${shopItem.name}</div>
            ${item.count > 1 ? `<div class="item-count">${item.count}</div>` : ''}
          `;
        } else {
          slot.innerHTML = '<div style="opacity:0.3">━</div>';
        }

        inventoryGrid.appendChild(slot);
      }

      // Render shop
      const shopGrid = document.getElementById('shopGrid');
      shopGrid.innerHTML = '';

      SHOP_ITEMS.forEach(item => {
        const shopCard = document.createElement('div');
        shopCard.className = 'shop-item';
        shopCard.innerHTML = `
          <div class="item-icon">${item.icon}</div>
          <div class="shop-item-name">${item.name}</div>
          <div class="shop-item-desc">${item.desc}</div>
          <div class="shop-item-price">💰 ${item.price.toLocaleString()} GP</div>
          <button class="buy-btn" ${gp < item.price ? 'disabled' : ''}>BUY</button>
        `;

        const buyBtn = shopCard.querySelector('.buy-btn');
        buyBtn.addEventListener('click', () => buyItem(item));

        shopGrid.appendChild(shopCard);
      });
    }

    function buyItem(item) {
      const email = localStorage.getItem('duelpvp_email') || 'anonymous';
      let gp = parseInt(localStorage.getItem(`duelpvp_gp_${email}`) || '0');
      let inventory = JSON.parse(localStorage.getItem(`duelpvp_inventory_${email}`) || '[]');

      if (gp < item.price) {
        alert('Not enough GP!');
        return;
      }

      // Check if inventory is full
      if (inventory.length >= 28 && !inventory.find(i => i.id === item.id && item.type === 'consumable')) {
        alert('Inventory full!');
        return;
      }

      // Deduct GP
      gp -= item.price;
      localStorage.setItem(`duelpvp_gp_${email}`, gp.toString());

      // Add to inventory
      if (item.type === 'consumable') {
        const existing = inventory.find(i => i.id === item.id);
        if (existing) {
          existing.count++;
        } else {
          inventory.push({id: item.id, count: 1});
        }
      } else {
        inventory.push({id: item.id, count: 1});
      }

      localStorage.setItem(`duelpvp_inventory_${email}`, JSON.stringify(inventory));

      // Update quest progress
      updateQuestProgress('weekly_shop');

      // Reload
      loadInventory();
      alert(`Purchased ${item.name}!`);
    }

    // Initial event listeners
    document.getElementById('joinBtn').addEventListener('click', handleJoin);
    document.getElementById('loginLink').addEventListener('click', () => swapContent('login'));
    document.getElementById('logoutBtn').addEventListener('click', handleLogout);
    document.getElementById('playReactionBtn').addEventListener('click', () => {
      console.log('Play Reaction clicked');
      swapContent('game');
    });
    document.getElementById('viewLeaderboardBtn').addEventListener('click', () => {
      console.log('View Leaderboard clicked');
      swapContent('leaderboard');
    });
    document.getElementById('backToDashBtn').addEventListener('click', () => swapContent('dashboard'));
    document.getElementById('backFromLeaderboardBtn').addEventListener('click', () => swapContent('dashboard'));
    document.getElementById('backFromQuestsBtn').addEventListener('click', () => swapContent('dashboard'));
    document.getElementById('backFromInventoryBtn').addEventListener('click', () => swapContent('dashboard'));
    document.getElementById('viewQuestsBtn').addEventListener('click', () => swapContent('quests'));
    document.getElementById('viewInventoryBtn').addEventListener('click', () => swapContent('inventory'));
    document.getElementById('startGameBtn').addEventListener('click', startGame);
    document.getElementById('sellButton').addEventListener('click', handleSell);
    document.getElementById('resetGameBtn').addEventListener('click', resetGame);

    // Leaderboard filter buttons
    document.querySelectorAll('.filter-btn').forEach(btn => {
      btn.addEventListener('click', function() {
        const filter = this.getAttribute('data-filter');
        handleFilterChange(filter);
      });
    });

    // Quest tab switching
    document.querySelectorAll('.quest-tab').forEach(tab => {
      tab.addEventListener('click', function() {
        document.querySelectorAll('.quest-tab').forEach(t => t.classList.remove('active'));
        this.classList.add('active');
        const questType = this.getAttribute('data-quest-tab');
        loadQuests(questType);
      });
    });

    // Add keyboard navigation support
    document.addEventListener('keydown', (e) => {
      // ESC key to go back
      if (e.key === 'Escape') {
        if (gameContent.style.display === 'block') {
          swapContent('dashboard');
        } else if (leaderboardContent.style.display === 'block') {
          swapContent('dashboard');
        } else if (questContent.style.display === 'block') {
          swapContent('dashboard');
        } else if (inventoryContent.style.display === 'block') {
          swapContent('dashboard');
        }
      }
    });

    // Check if user is already logged in
    try {
      const savedEmail = localStorage.getItem('duelpvp_email');
      if (savedEmail) {
        document.getElementById('userName').textContent = savedEmail.split('@')[0].toUpperCase();
        // Optionally auto-login: swapContent('dashboard');
      }
    } catch (e) {}
  </script>
</body>
</html>
